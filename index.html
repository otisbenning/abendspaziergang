<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√∂lner Abendspaziergang</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        line-height: 1.6;
        overflow-x: hidden;
    }

    .container {
        max-width: 100vw;
        margin: 0 auto;
        min-height: 100vh;
        background: white;
        box-shadow: 0 0 30px rgba(0,0,0,0.3);
    }

    header {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .progress-container {
        background: rgba(255,255,255,0.2);
        height: 8px;
        border-radius: 4px;
        margin-top: 1rem;
        overflow: hidden;
    }

    .progress-bar {
        background: #fbbf24;
        height: 100%;
        width: 0%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .live-message {
        background: #059669;
        color: white;
        padding: 1rem;
        margin: 0.5rem;
        border-radius: 8px;
        animation: slideIn 0.5s ease;
        border-left: 4px solid #047857;
    }

    .main-content {
        padding: 0;
    }

    .tab-container {
        display: flex;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        position: sticky;
        top: 132px;
        z-index: 999;
        overflow-x: auto;
    }

    .tab {
        flex: 1;
        padding: 1rem 0.5rem;
        text-align: center;
        cursor: pointer;
        background: transparent;
        border: none;
        font-weight: 600;
        color: #64748b;
        transition: all 0.3s;
        font-size: 0.9rem;
        white-space: nowrap;
        min-width: 100px;
    }

    .tab.active {
        background: white;
        color: #dc2626;
        border-bottom: 3px solid #dc2626;
    }

    .tab-content {
        display: none;
        padding: 1.5rem;
        min-height: calc(100vh - 200px);
    }

    .tab-content.active {
        display: block;
    }

    .station-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #dc2626;
        cursor: pointer;
        transition: all 0.3s;
    }

    .station-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .station-card.completed {
        border-left-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }

    .station-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .station-number {
        background: #dc2626;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .station-number.completed {
        background: #10b981;
    }

    .station-title {
        flex: 1;
        font-size: 1.3rem;
        font-weight: bold;
        color: #1f2937;
    }

    .station-subtitle {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .station-details {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #e5e7eb;
    }

    .station-details.active {
        display: block;
    }

    .detail-section {
        margin-bottom: 1.5rem;
    }

    .detail-section h4 {
        color: #dc2626;
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
    }

    .detail-section h4::before {
        content: "‚ñ∂";
        margin-right: 0.5rem;
        color: #dc2626;
    }

    .photo-challenge {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
        border-left: 4px solid #6366f1;
    }

    .photo-challenge h4 {
        color: #4f46e5;
        margin-bottom: 1rem;
        font-size: 1.2rem;
    }

    .photo-upload-area {
        border: 3px dashed #a5b4fc;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        margin: 1rem 0;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(255,255,255,0.5);
    }

    .photo-upload-area:hover {
        border-color: #6366f1;
        background: rgba(255,255,255,0.8);
    }

    .photo-upload-area.has-photo {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .photo-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .ai-rating {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1rem 0;
        text-align: center;
        border: 2px solid #10b981;
    }

    .rating-score {
        font-size: 3rem;
        font-weight: bold;
        color: #059669;
        margin-bottom: 0.5rem;
    }

    .rating-text {
        color: #047857;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .rating-details {
        background: #f0fdf4;
        padding: 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #065f46;
    }

    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .gallery-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .gallery-image:hover {
        transform: scale(1.05);
    }

    .gallery-item {
        text-align: center;
    }

    .gallery-item small {
        display: block;
        margin-top: 0.5rem;
        color: #6b7280;
        font-size: 0.8rem;
    }

    .btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        font-size: 1rem;
        margin-top: 1rem;
        touch-action: manipulation;
    }

    .btn:hover {
        background: #991b1b;
        transform: translateY(-2px);
    }

    .btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: #6b7280;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .score-display {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin: 1rem 0;
        border: 2px solid #8b5cf6;
    }

    .score-number {
        font-size: 2rem;
        font-weight: bold;
        color: #5b21b6;
    }

    .score-label {
        color: #7c3aed;
        margin-top: 0.5rem;
    }

    .team-ranking {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .team-rank-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        background: #f8fafc;
    }

    .team-rank-item.highlight {
        background: #fef3c7;
        border: 2px solid #f59e0b;
    }

    .rank-position {
        background: #6b7280;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
    }

    .rank-position.gold {
        background: #f59e0b;
    }

    .rank-position.silver {
        background: #6b7280;
    }

    .rank-position.bronze {
        background: #d97706;
    }

    #map {
        height: 400px;
        width: 100%;
        border-radius: 10px;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .location-info {
        background: #f0f9ff;
        border: 2px solid #0ea5e9;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .distance-info {
        font-weight: bold;
        color: #0369a1;
        margin-bottom: 0.5rem;
    }

    .team-selector {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .team-option {
        display: flex;
        align-items: center;
        padding: 0.8rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
        touch-action: manipulation;
    }

    .team-option:hover {
        background: #f3f4f6;
    }

    .team-option.selected {
        background: #dbeafe;
        border: 2px solid #3b82f6;
    }

    .team-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 1rem;
    }

    .chat-container {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-height: 400px;
        overflow-y: auto;
    }

    .chat-message {
        padding: 0.5rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        background: #f8fafc;
        border-left: 3px solid #3b82f6;
    }

    .chat-message.own {
        background: #dbeafe;
        border-left-color: #1d4ed8;
        margin-left: 2rem;
    }

    .chat-input-container {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
    }

    .chat-send {
        padding: 0.8rem 1.5rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        touch-action: manipulation;
    }

    .success-message {
        background: #10b981;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        text-align: center;
        animation: slideIn 0.5s ease;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #059669;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.5s ease;
    }

    .notification.error {
        background: #dc2626;
    }

    .hidden {
        display: none !important;
    }

    .file-input {
        display: none;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #dc2626;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }

    .debug-info {
        position: fixed;
        top: 50px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        max-width: 200px;
        z-index: 9999;
    }

    @keyframes slideIn {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .container {
            box-shadow: none;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        .tab {
            font-size: 0.8rem;
            padding: 0.8rem 0.3rem;
        }
        
        .tab-content {
            padding: 1rem;
        }
        
        .station-card {
            padding: 1rem;
        }
        
        .image-gallery {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <header>
            <h1>üèõÔ∏è K√∂lner Abendspaziergang</h1>
            <p class="subtitle">Entdecke 2000 Jahre Stadtgeschichte</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </header>

```
    <div class="main-content">
        <div class="tab-container">
            <button class="tab active" onclick="TourApp.showTab('overview', this)">üó∫Ô∏è √úbersicht</button>
            <button class="tab" onclick="TourApp.showTab('stations', this)">üìç Stationen</button>
            <button class="tab" onclick="TourApp.showTab('ranking', this)">üèÜ Ranking</button>
            <button class="tab" onclick="TourApp.showTab('chat', this)">üí¨ Chat</button>
            <button class="tab" onclick="TourApp.showTab('map', this)">üó∫Ô∏è Karte</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="score-display">
                <div class="score-number" id="totalScore">0</div>
                <div class="score-label">Foto-Punkte gesammelt</div>
            </div>

            <div class="team-selector" id="teamSelector">
                <h3 style="margin-bottom: 1rem; color: #374151;">üì∏ W√§hle dein Team:</h3>
                <div class="team-option" onclick="TourApp.selectTeam('red', 'üî¥ Team R√∂mer', this)">
                    <div class="team-color" style="background: #dc2626;"></div>
                    <span>üî¥ Team R√∂mer</span>
                </div>
                <div class="team-option" onclick="TourApp.selectTeam('blue', 'üîµ Team Gaffeln', this)">
                    <div class="team-color" style="background: #2563eb;"></div>
                    <span>üîµ Team Gaffeln</span>
                </div>
                <div class="team-option" onclick="TourApp.selectTeam('green', 'üü¢ Team Hanseat', this)">
                    <div class="team-color" style="background: #059669;"></div>
                    <span>üü¢ Team Hanseat</span>
                </div>
                <div class="team-option" onclick="TourApp.selectTeam('yellow', 'üü° Team Modern', this)">
                    <div class="team-color" style="background: #d97706;"></div>
                    <span>üü° Team Modern</span>
                </div>
            </div>

            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">üìã Tour-Informationen</h3>
                <p><strong>‚è∞ Dauer:</strong> ca. 3,5 Stunden</p>
                <p><strong>üìç Start:</strong> Heumarkt, 19:30 Uhr</p>
                <p><strong>üéØ Ziel:</strong> Alte Bastion</p>
                <p><strong>üë• Teilnehmer:</strong> 15-25 Personen</p>
                <p><strong>üì∏ Ziel:</strong> Sammle die besten Foto-Punkte!</p>
            </div>

            <button class="btn" onclick="TourApp.startTour()">üöÄ Tour starten</button>
        </div>

        <!-- Stations Tab -->
        <div id="stations" class="tab-content">
            <div id="stationsList">
                <!-- Stations will be generated here -->
            </div>
        </div>

        <!-- Ranking Tab -->
        <div id="ranking" class="tab-content">
            <div class="team-ranking">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">üèÜ Live-Ranking</h3>
                <div id="rankingList">
                    <!-- Ranking will be generated here -->
                </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">üì∏ KI-Punktesystem</h3>
                <ul style="margin-left: 1.5rem; color: #4b5563;">
                    <li><strong>Technische Qualit√§t:</strong> Sch√§rfe, Belichtung, Komposition (0-40 Punkte)</li>
                    <li><strong>Kreativit√§t:</strong> Perspective, Originalit√§t (0-30 Punkte)</li>
                    <li><strong>Stadtbezug:</strong> Erkannte Sehensw√ºrdigkeiten (0-20 Punkte)</li>
                    <li><strong>Personen/Gruppenfoto:</strong> Bonus f√ºr Teamarbeit (+10 Punkte)</li>
                </ul>
            </div>
        </div>

        <!-- Chat Tab -->
        <div id="chat" class="tab-content">
            <div class="chat-container" id="chatContainer">
                <div class="chat-message">
                    <strong>System:</strong> Willkommen im Tour-Chat! üëã
                    <span class="timestamp">jetzt</span>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht eingeben..." maxlength="200">
                <button class="chat-send" onclick="TourApp.sendMessage()">Senden</button>
            </div>
            <div style="margin-top: 1rem; text-align: center; color: #6b7280; font-size: 0.9rem;">
                üí° Chat funktioniert zwischen allen Ger√§ten mit derselben Tour-ID
            </div>
        </div>

        <!-- Map Tab -->
        <div id="map-tab" class="tab-content">
            <div class="location-info">
                <div class="distance-info" id="distanceInfo">üìç Standort wird ermittelt...</div>
                <p>üí° Tipp: Erlaube Standortzugriff f√ºr Navigation</p>
            </div>
            <div id="map"></div>
            <button class="btn" onclick="TourApp.centerOnUser()">üìç Zu meinem Standort</button>
        </div>
    </div>
</div>

<!-- Debug Info (nur im Entwicklungsmodus) -->
<div id="debugInfo" class="debug-info hidden">
    Debug Info: OK
</div>

<!-- External Libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<script>
// Global error handler
window.onerror = function(msg, url, line, col, error) {
    console.error('Error:', msg, 'at', line + ':' + col);
    TourApp.showError('Ein Fehler ist aufgetreten. Bitte Seite neu laden.');
    return false;
};

// Main Tour Application
const TourApp = {
    // App State
    state: {
        currentStation: 0,
        completedStations: [],
        totalScore: 0,
        selectedTeam: null,
        teamName: '',
        userLocation: null,
        map: null,
        markers: [],
        uploadedPhotos: [],
        userName: 'Tourist_' + Math.random().toString(36).substr(2, 5),
        tourId: 'cologne-tour-' + new Date().toISOString().split('T')[0],
        chatInitialized: false,
        debugMode: false
    },

    // Station Data
    stations: [
        {
            id: 1,
            title: "Heumarkt",
            subtitle: "Wo alles anfing: 2000 Jahre Migration und Handel",
            lat: 50.9356, lng: 6.9611,
            description: "Start der Tour am historischen Heumarkt, einem der geschichtstr√§chtigsten Orte K√∂lns.",
            photoChallenge: "Mache ein Foto von dir oder deinem Team vor dem Reiterstandbild - zeigt dabei mit Handbewegungen, wie H√§ndler fr√ºher ihre Waren angepriesen haben k√∂nnten!",
            mainText: `Die Stadt ist ca. 2.000 Jahre alt. CCAA - Colonia Claudia Ara Agrippinensium - wurde 50 n. Chr. von den R√∂mern gegr√ºndet, mithilfe der germanischen Ubier. Das war √ºbrigens eine der ersten erfolgreichen Integration zweier Kulturen in Europa. 
```

Hier auf dem Heumarkt stehen wir an einem der ehemaligen Einfallstore zur Stadt. Die Markmannsgasse runter, links von der heutigen Deutzer Br√ºcke, befand sich von 1822 bis 1915 die einzige Schiffsbr√ºcke √ºber den Rhein - 42 schwimmende Boote, die √ºber 30 Mal t√§glich f√ºr Schiffe ge√∂ffnet wurden.

Das ‚ÄúStapelrecht‚Äù von 1259 bis 1804 war ein 545 Jahre g√ºltiges Handelsprivileg. Alle Waren auf Schiffen, die an K√∂ln vorbeifahren wollten, mussten drei Tage hier angeboten werden.`, images: [ { url: "https://images.unsplash.com/photo-1568667256549-094345857637?w=400", title: "Heumarkt heute", description: "Moderne Aufnahme des historischen Platzes" }, { url: "https://images.unsplash.com/photo-1590736969955-71cc94901144?w=400", title: "K√∂lner Architektur", description: "Typische Rheinische Bauweise" }, { url: "https://images.unsplash.com/photo-1551622656-fa4fa96b5faf?w=400", title: "Rheinufer", description: "Blick auf den historischen Handelsweg" } ] }, { id: 2, title: "K√∂lner Dom", subtitle: "Das ewige Bauprojekt und die Verkehrsrevolution", lat: 50.9413, lng: 6.9583, description: "K√∂lns Wahrzeichen und die l√§ngste Baustelle der Welt.", photoChallenge: "Bildet mit eurem Team eine 'menschliche Kathedrale' vor dem Dom - streckt die Arme hoch und formt gotische B√∂gen nach!", mainText: `Der Dom wird seit fast 800 Jahren gebaut - etwas l√§nger als der BER. Die Grundsteinlegung 1248 war K√∂lns Versuch, Paris und andere Gro√üst√§dte zu beeindrucken. K√∂ln war immer reich, aber auch provinziell.

1248-1330 wurden Grundmauern und der Chor fertiggestellt. Dann ging das Geld aus. Fast 300 Jahre stand nur ein riesiger Kran auf dem unvollendeten Turm - eines der ersten gro√üen ‚Äúpaused projects‚Äù der Geschichte.

Erst die Romantik des 19. Jahrhunderts und preu√üisches Geld vollendeten den Dom 1880. Der Hauptbahnhof entstand 1894 als einer der modernsten Europas.`, images: [ { url: "https://images.unsplash.com/photo-1571115764595-644a1f56a55c?w=400", title: "K√∂lner Dom", description: "Die ber√ºhmten Zwillingst√ºrme" }, { url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400", title: "Dom Innenraum", description: "Gotische Architektur" }, { url: "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=400", title: "Dom bei Nacht", description: "Beleuchtetes Wahrzeichen" } ] }, { id: 3, title: "Altstadt", subtitle: "Macht, Rebellion und eine gro√üe Liebesgeschichte", lat: 50.9369, lng: 6.9572, description: "Das historische Rathaus und die ber√ºhmte Jan-und-Griet-Geschichte.", photoChallenge: "Fotografiert euch am historischen Rathaus und stellt eine romantische Szene nach: Eine Person kniet, eine steht stolz daneben.", mainText: `Der Rathaus-Turm zeigt wichtige Pers√∂nlichkeiten der K√∂lner Geschichte. 1945 zerst√∂rt und wieder aufgebaut. Da auch die Figuren zerst√∂rt waren, w√§hlte eine Kommission neue aus - von √ºber 100 Kandidaten. Alle m√§nnlich.

Oben am Turm seht ihr den ‚ÄúPlatz-Jabbeck‚Äù - er streckt Autorit√§ten die Zunge raus. So viel Respekt hatten die K√∂lner f√ºr die Obrigkeit.

Die Altstadt erz√§hlt eine der gr√∂√üten deutschen Liebesgeschichten: Jan ist ein armer Knecht, Griet arbeitet auch dort. Er mag sie, sie ihn nicht. Der Krieg beginnt, Jan zieht aus, kommt als ber√ºhmter General zur√ºck.`, images: [ { url: "https://images.unsplash.com/photo-1544892504-5ad7a122b56f?w=400", title: "K√∂lner Altstadt", description: "Historische Gassen" }, { url: "https://images.unsplash.com/photo-1517840901100-8179e982acb7?w=400", title: "Rheinpromenade", description: "Spazierweg mit Domblick" }, { url: "https://images.unsplash.com/photo-1567696911980-2eed69651dd7?w=400", title: "Historisches Rathaus", description: "Gotisches Bauwerk" } ] }, { id: 4, title: "Gro√ü St. Martin", subtitle: "Romanische Kirche und Klostergeschichte", lat: 50.9347, lng: 6.9597, description: "Eine der zw√∂lf gro√üen romanischen Kirchen K√∂lns.", photoChallenge: "Macht ein Foto der imposanten Kircht√ºrme und zeigt dabei mittelalterliche Gebetshaltungen!", mainText: `Gro√ü St. Martin ist eine der beeindruckendsten romanischen Kirchen K√∂lns. Der markante Vierungsturm pr√§gt seit dem 12. Jahrhundert die Silhouette der Altstadt.

Die Kirche wurde auf r√∂mischen Fundamenten errichtet - arch√§ologische Ausgrabungen zeigen die Kontinuit√§t der Besiedlung √ºber 2000 Jahre. Im Mittelalter war hier eines der m√§chtigsten Benediktinerkl√∂ster der Region.

Der Turm diente auch als Orientierungspunkt f√ºr Rheinschiffe und H√§ndler - ein fr√ºher ‚ÄúLeuchtturm‚Äù des Handels.`, images: [ { url: "https://images.unsplash.com/photo-1518709268805-4e9042af2e96?w=400", title: "Gro√ü St. Martin", description: "Romanischer Kirchenbau" }, { url: "https://images.unsplash.com/photo-1573052905904-34ad8c27f0d4?w=400", title: "Altstadt Panorama", description: "Kircht√ºrme der Altstadt" }, { url: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400", title: "Rheinufer", description: "Blick auf die Kirchen" } ] }, { id: 5, title: "Fischmarkt", subtitle: "Handel, Handwerk und B√ºrgerstolz", lat: 50.9378, lng: 6.9589, description: "Mittelpunkt des mittelalterlichen Handels.", photoChallenge: "Zeigt mit euren H√§nden, wie mittelalterliche H√§ndler ihre Waren pr√§sentiert haben - seid kreativ mit Gesten!", mainText: `Der Fischmarkt war im Mittelalter das kommerzielle Herz K√∂lns. Hier wurde nicht nur Fisch verkauft, sondern alle wichtigen Handelsg√ºter der Region.

Die K√∂lner B√ºrger entwickelten hier ihre ber√ºhmte Unabh√§ngigkeit. 1074 erhielt K√∂ln bereits wichtige Stadtrechte - 500 Jahre bevor andere deutsche St√§dte folgten.

Die Zunftordnungen vom Fischmarkt dienten als Vorbild f√ºr ganz Europa. Handwerksmeister aus K√∂ln gr√ºndeten in vielen anderen St√§dten √§hnliche Organisationen.`,
images: [
{ url: ‚Äúhttps://images.unsplash.com/photo-1578916171728-46686eac8d58?w=400‚Äù, title: ‚ÄúAlter Markt K√∂ln‚Äù, description: ‚ÄúHistorischer Marktplatz‚Äù },
{ url: ‚Äúhttps://images.unsplash.com/photo-1574790398664-0cb3c99c3711?w=400‚Äù, title: ‚ÄúK√∂lner H√§user‚Äù, description: ‚ÄúTypische Architektur‚Äù },
{ url: ‚Äúhttps://images.unsplash.com/photo-1587474260584-136574528ed5?w=400‚Äù, title: ‚ÄúRheinischer Markt‚Äù, description: ‚ÄúHandelstradition‚Äù }
]
}
],

```
    // Initialize the app
    init() {
        try {
            this.log('Initializing Tour App...');
            this.loadState();
            this.generateStationsList();
            this.updateUI();
            this.initGeolocation();
            this.initChat();
            
            // Setup event listeners
            document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendMessage();
                }
            });
            
            this.log('Tour App initialized successfully');
        } catch (error) {
            this.log('Error initializing app:', error);
            this.showError('Fehler beim Laden der App. Bitte Seite neu laden.');
        }
    },

    // Debug logging
    log(message, data = null) {
        if (this.state.debugMode) {
            console.log('[TourApp]', message, data);
        }
    },

    // Error handling
    showError(message) {
        this.showNotification(message, 'error');
    },

    // Show notifications
    showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 4000);
    },

    // Tab Management
    showTab(tabName, tabElement) {
        try {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const targetTab = document.getElementById(tabName === 'map' ? 'map-tab' : tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // Tab-specific actions
            if (tabName === 'map') {
                setTimeout(() => this.initMap(), 100);
            } else if (tabName === 'ranking') {
                this.updateRanking();
            } else if (tabName === 'chat' && !this.state.chatInitialized) {
                this.loadChatHistory();
                this.state.chatInitialized = true;
            }

            this.log('Switched to tab:', tabName);
        } catch (error) {
            this.log('Error switching tab:', error);
        }
    },

    // Team Selection
    selectTeam(teamId, teamName, element) {
        try {
            this.state.selectedTeam = teamId;
            this.state.teamName = teamName;
            
            // Update UI
            document.querySelectorAll('.team-option').forEach(option => {
                option.classList.remove('selected');
            });
            if (element) {
                element.classList.add('selected');
            }
            
            // Hide team selector
            const selector = document.getElementById('teamSelector');
            if (selector) {
                selector.style.display = 'none';
            }
            
            this.showNotification('Team ausgew√§hlt! üéâ');
            this.saveState();
            this.log('Team selected:', teamId, teamName);
        } catch (error) {
            this.log('Error selecting team:', error);
        }
    },

    // Start Tour
    startTour() {
        try {
            if (!this.state.selectedTeam) {
                alert('Bitte w√§hle zuerst ein Team aus!');
                return;
            }
            
            this.showTab('stations', document.querySelector('[onclick*="stations"]'));
            this.showNotification('Tour gestartet! Viel Erfolg! üöÄ');
            this.log('Tour started');
        } catch (error) {
            this.log('Error starting tour:', error);
        }
    },

    // Generate Stations List
    generateStationsList() {
        try {
            const container = document.getElementById('stationsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            this.stations.forEach(station => {
                const isCompleted = this.state.completedStations.includes(station.id);
                
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${isCompleted ? 'completed' : ''}`;
                stationCard.onclick = () => this.toggleStationDetails(station.id);
                
                const imagesHtml = station.images.map(img => `
                    <div class="gallery-item">
                        <img src="${img.url}" alt="${img.title}" class="gallery-image" onclick="TourApp.showImageModal('${img.url}', '${img.title}', '${img.description}')">
                        <small>${img.title}</small>
                    </div>
                `).join('');
                
                stationCard.innerHTML = `
                    <div class="station-header">
                        <div class="station-number ${isCompleted ? 'completed' : ''}">${station.id}</div>
                        <div style="flex: 1;">
                            <div class="station-title">${station.title}</div>
                            <div class="station-subtitle">${station.subtitle}</div>
                        </div>
                    </div>
                    <div class="station-details" id="station-${station.id}">
                        <div class="detail-section">
                            <h4>üìñ Geschichte</h4>
                            <p>${station.mainText}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üñºÔ∏è Bildergalerie</h4>
                            <div class="image-gallery">
                                ${imagesHtml}
                            </div>
                        </div>

                        <div class="photo-challenge">
                            <h4>üì∏ KI-Foto-Challenge</h4>
                            <p>${station.photoChallenge}</p>
                            
                            <div class="photo-upload-area" onclick="TourApp.selectPhoto(${station.id})" id="upload-area-${station.id}">
                                <div id="upload-content-${station.id}">
                                    üì∑ Hier klicken zum Foto machen/ausw√§hlen<br>
                                    <small>KI bewertet automatisch Qualit√§t, Komposition & Kreativit√§t</small>
                                </div>
                            </div>
                            
                            <input type="file" class="file-input" id="photo-input-${station.id}" accept="image/*" capture="environment" onchange="TourApp.handlePhotoUpload(${station.id}, event)">
                            
                            <div class="ai-rating hidden" id="rating-${station.id}">
                                <div class="rating-score" id="score-${station.id}">0</div>
                                <div class="rating-text" id="rating-text-${station.id}">KI analysiert dein Foto...</div>
                                <div class="rating-details" id="rating-details-${station.id}"></div>
                            </div>
                        </div>

                        <button class="btn" onclick="TourApp.completeStation(${station.id})" id="complete-btn-${station.id}" 
                                ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? '‚úÖ Station abgeschlossen' : 'üèÅ Station abschlie√üen'}
                        </button>
                    </div>
                `;
                
                container.appendChild(stationCard);
            });

            this.log('Stations list generated');
        } catch (error) {
            this.log('Error generating stations list:', error);
        }
    },

    // Toggle Station Details
    toggleStationDetails(stationId) {
        try {
            const details = document.getElementById(`station-${stationId}`);
            if (details) {
                details.classList.toggle('active');
            }
        } catch (error) {
            this.log('Error toggling station details:', error);
        }
    },

    // Photo Selection
    selectPhoto(stationId) {
        try {
            const input = document.getElementById(`photo-input-${stationId}`);
            if (input) {
                input.click();
            }
        } catch (error) {
            this.log('Error selecting photo:', error);
        }
    },

    // Photo Upload Handler
    handlePhotoUpload(stationId, event) {
        try {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                
                // Update upload area
                const uploadArea = document.getElementById(`upload-area-${stationId}`);
                if (uploadArea) {
                    uploadArea.classList.add('has-photo');
                    uploadArea.innerHTML = `
                        <img src="${imageUrl}" class="photo-preview" alt="Uploaded photo">
                        <p>üì∑ Foto erfolgreich hochgeladen!</p>
                        <small>KI analysiert...</small>
                    `;
                }

                // Store photo
                const existingPhotoIndex = this.state.uploadedPhotos.findIndex(p => p.stationId === stationId);
                const photoData = {
                    stationId: stationId,
                    imageUrl: imageUrl,
                    timestamp: Date.now(),
                    teamId: this.state.selectedTeam
                };

                if (existingPhotoIndex >= 0) {
                    this.state.uploadedPhotos[existingPhotoIndex] = photoData;
                } else {
                    this.state.uploadedPhotos.push(photoData);
                }

                // AI Analysis with delay
                setTimeout(() => {
                    this.ratePhoto(stationId, imageUrl);
                }, 1000);

                this.saveState();
            };
            
            reader.readAsDataURL(file);
            this.log('Photo uploaded for station:', stationId);
        } catch (error) {
            this.log('Error handling photo upload:', error);
        }
    },

    // AI Photo Rating (simplified version)
    ratePhoto(stationId, imageUrl) {
        try {
            const ratingDiv = document.getElementById(`rating-${stationId}`);
            if (ratingDiv) {
                ratingDiv.classList.remove('hidden');
            }
            
            // Simulate AI analysis
            const baseScore = 50 + Math.random() * 40; // 50-90 points
            const technicalScore = 70 + Math.random() * 25;
            const compositionScore = 60 + Math.random() * 30;
            const creativityScore = 55 + Math.random() * 35;
            
            const finalScore = Math.round(baseScore);
            
            // Animate score counting
            this.animateScore(stationId, finalScore);
            
            // Generate feedback
            const feedback = this.generatePhotoFeedback(technicalScore, compositionScore, creativityScore);
            
            setTimeout(() => {
                const ratingTextEl = document.getElementById(`rating-text-${stationId}`);
                const ratingDetailsEl = document.getElementById(`rating-details-${stationId}`);
                
                if (ratingTextEl) {
                    ratingTextEl.innerHTML = `
                        <strong>KI-Bewertung abgeschlossen!</strong><br>
                        Qualit√§t: ${Math.round(technicalScore)}% | 
                        Komposition: ${Math.round(compositionScore)}% | 
                        Kreativit√§t: ${Math.round(creativityScore)}%
                    `;
                }
                
                if (ratingDetailsEl) {
                    ratingDetailsEl.innerHTML = feedback.join('<br>');
                }
            }, 2000);
            
            // Add score to total
            this.addScore(finalScore);
            
            // Store rating in photo data
            const photoData = this.state.uploadedPhotos.find(p => p.stationId === stationId);
            if (photoData) {
                photoData.score = finalScore;
                photoData.analysis = {
                    technical: technicalScore,
                    composition: compositionScore,
                    creativity: creativityScore,
                    feedback: feedback
                };
            }
            
            this.showNotification(`KI-Bewertung: ${finalScore} Punkte! ü§ñ`);
            this.log('Photo rated:', stationId, finalScore);
        } catch (error) {
            this.log('Error rating photo:', error);
            // Fallback rating
            this.addScore(60);
            this.showNotification('Foto bewertet! üì∏');
        }
    },

    // Animate Score
    animateScore(stationId, targetScore) {
        try {
            const scoreElement = document.getElementById(`score-${stationId}`);
            if (!scoreElement) return;
            
            let currentScore = 0;
            const increment = Math.ceil(targetScore / 30);
            
            const interval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(interval);
                }
                scoreElement.textContent = currentScore;
            }, 50);
        } catch (error) {
            this.log('Error animating score:', error);
        }
    },

    // Generate Photo Feedback
    generatePhotoFeedback(technical, composition, creativity) {
        const feedback = [];
        
        if (technical > 75) {
            feedback.push("üì∏ Sehr scharfes und gut belichtetes Bild!");
        } else if (technical < 50) {
            feedback.push("‚ö†Ô∏è Bild k√∂nnte sch√§rfer oder besser belichtet sein");
        }
        
        if (composition > 70) {
            feedback.push("üé® Tolle Bildkomposition!");
        } else {
            feedback.push("üí° Tipp: Achte auf die Bildaufteilung");
        }
        
        if (creativity > 75) {
            feedback.push("‚ú® Sehr kreative Aufnahme!");
        } else if (creativity > 60) {
            feedback.push("üé≠ Sch√∂ne kreative Elemente!");
        }
        
        // Always add a positive message
        feedback.push("üë• Toll, dass ihr als Team fotografiert!");
        
        return feedback.length > 0 ? feedback : ["Sch√∂ne Aufnahme! üì∑"];
    },

    // Complete Station
    completeStation(stationId) {
        try {
            if (!this.state.completedStations.includes(stationId)) {
                this.state.completedStations.push(stationId);
                this.updateProgress();
                this.showNotification('Station abgeschlossen! üèÅ');
                
                // Update station card
                const completeBtn = document.getElementById(`complete-btn-${stationId}`);
                if (completeBtn) {
                    const stationCard = completeBtn.closest('.station-card');
                    if (stationCard) {
                        stationCard.classList.add('completed');
                        const stationNumber = stationCard.querySelector('.station-number');
                        if (stationNumber) {
                            stationNumber.classList.add('completed');
                        }
                    }
                    
                    // Disable button
                    completeBtn.disabled = true;
                    completeBtn.textContent = '‚úÖ Station abgeschlossen';
                    completeBtn.style.background = '#6b7280';
                }

                // Check if tour is complete
                if (this.state.completedStations.length === this.stations.length) {
                    this.showNotification('üéâ Herzlichen Gl√ºckwunsch! Tour abgeschlossen!');
                    setTimeout(() => {
                        this.showTab('ranking', document.querySelector('[onclick*="ranking"]'));
                    }, 2000);
                }

                this.saveState();
                this.log('Station completed:', stationId);
            }
        } catch (error) {
            this.log('Error completing station:', error);
        }
    },

    // Add Score
    addScore(points) {
        try {
            this.state.totalScore += Math.round(points);
            this.updateUI();
            this.updateTeamScore();
            this.saveState();
            this.log('Score added:', points, 'Total:', this.state.totalScore);
        } catch (error) {
            this.log('Error adding score:', error);
        }
    },

    // Update UI
    updateUI() {
        try {
            const scoreElement = document.getElementById('totalScore');
            if (scoreElement) {
                scoreElement.textContent = this.state.totalScore;
            }
            this.updateProgress();
        } catch (error) {
            this.log('Error updating UI:', error);
        }
    },

    // Update Progress
    updateProgress() {
        try {
            const progress = (this.state.completedStations.length / this.stations.length) * 100;
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        } catch (error) {
            this.log('Error updating progress:', error);
        }
    },

    // Update Team Score (simplified team sync)
    updateTeamScore() {
        try {
            if (this.state.selectedTeam) {
                const teamData = {
                    teamId: this.state.selectedTeam,
                    score: this.state.totalScore,
                    lastUpdate: Date.now()
                };
                localStorage.setItem(`team_${this.state.selectedTeam}`, JSON.stringify(teamData));
            }
        } catch (error) {
            this.log('Error updating team score:', error);
        }
    },

    // Update Ranking
    updateRanking() {
        try {
            const rankingList = document.getElementById('rankingList');
            if (!rankingList) return;
            
            // Get team scores
            const teams = [
                { id: 'red', name: 'üî¥ Team R√∂mer', score: this.getTeamScore('red') },
                { id: 'blue', name: 'üîµ Team Gaffeln', score: this.getTeamScore('blue') },
                { id: 'green', name: 'üü¢ Team Hanseat', score: this.getTeamScore('green') },
                { id: 'yellow', name: 'üü° Team Modern', score: this.getTeamScore('yellow') }
            ];
            
            // Add some demo scores if no real data
            teams.forEach(team => {
                if (team.score === 0 && team.id !== this.state.selectedTeam) {
                    team.score = Math.floor(Math.random() * 300) + 100;
                }
            });
            
            teams.sort((a, b) => b.score - a.score);
            
            rankingList.innerHTML = '';
            
            teams.forEach((team, index) => {
                const rankItem = document.createElement('div');
                const isUserTeam = team.id === this.state.selectedTeam;
                rankItem.className = `team-rank-item ${isUserTeam ? 'highlight' : ''}`;
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                rankItem.innerHTML = `
                    <div class="rank-position ${rankClass}">${index + 1}</div>
                    <div style="flex: 1;">
                        <strong>${team.name}</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">
                            ${team.score} Punkte
                        </div>
                    </div>
                    ${isUserTeam ? '<div style="color: #f59e0b;">üë§</div>' : ''}
                `;
                
                rankingList.appendChild(rankItem);
            });
            
            this.log('Ranking updated');
        } catch (error) {
            this.log('Error updating ranking:', error);
        }
    },

    // Get Team Score
    getTeamScore(teamId) {
        try {
            const teamData = localStorage.getItem(`team_${teamId}`);
            return teamData ? JSON.parse(teamData).score : 0;
        } catch (error) {
            this.log('Error getting team score:', error);
            return 0;
        }
    },

    // Chat Functions
    initChat() {
        try {
            // Initialize chat system
            this.state.chatInitialized = false;
            this.log('Chat initialized');
        } catch (error) {
            this.log('Error initializing chat:', error);
        }
    },

    sendMessage() {
        try {
            const input = document.getElementById('chatInput');
            if (!input) return;
            
            const message = input.value.trim();
            if (message) {
                this.addChatMessage(this.state.userName, message, true);
                input.value = '';
                
                // Store message
                this.storeChatMessage(this.state.userName, message);
                
                this.log('Message sent:', message);
            }
        } catch (error) {
            this.log('Error sending message:', error);
        }
    },

    addChatMessage(userName, message, isOwn = false) {
        try {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;
            
            const timeStr = new Date().toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <strong>${userName}:</strong> ${message}
                <span class="timestamp">${timeStr}</span>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (error) {
            this.log('Error adding chat message:', error);
        }
    },

    storeChatMessage(userName, message) {
        try {
            const messages = JSON.parse(localStorage.getItem(`chat_${this.state.tourId}`) || '[]');
            messages.push({
                userName: userName,
                message: message,
                timestamp: Date.now()
            });
            
            // Keep only last 50 messages
            if (messages.length > 50) {
                messages.splice(0, messages.length - 50);
            }
            
            localStorage.setItem(`chat_${this.state.tourId}`, JSON.stringify(messages));
        } catch (error) {
            this.log('Error storing chat message:', error);
        }
    },

    loadChatHistory() {
        try {
            const messages = JSON.parse(localStorage.getItem(`chat_${this.state.tourId}`) || '[]');
            messages.forEach(msg => {
                this.addChatMessage(msg.userName, msg.message, msg.userName === this.state.userName);
            });
            this.log('Chat history loaded');
        } catch (error) {
            this.log('Error loading chat history:', error);
        }
    },

    // Map Functions
    initMap() {
        try {
            if (this.state.map || !document.getElementById('map')) return;
            
            // Try to load Leaflet
            if (typeof L === 'undefined') {
                this.loadLeaflet(() => this.createMap());
            } else {
                this.createMap();
            }
        } catch (error) {
            this.log('Error initializing map:', error);
            this.showMapError();
        }
    },

    loadLeaflet(callback) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
        script.onload = callback;
        script.onerror = () => this.showMapError();
        document.head.appendChild(script);
    },

    createMap() {
        try {
            this.state.map = L.map('map').setView([50.9375, 6.9597], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(this.state.map);
            
            // Add station markers
            this.stations.forEach(station => {
                const isCompleted = this.state.completedStations.includes(station.id);
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center; max-width: 200px;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}/${this.stations.length}</strong></p>
                            ${isCompleted ? '<p style="color: green;">‚úÖ Abgeschlossen</p>' : '<p style="color: orange;">‚è≥ Ausstehend</p>'}
                        </div>
                    `)
                    .addTo(this.state.map);
                
                this.state.markers.push(marker);
            });
            
            // Add route
            const routeCoordinates = this.stations.map(station => [station.lat, station.lng]);
            L.polyline(routeCoordinates, {
                color: '#dc2626',
                weight: 3,
                opacity: 0.7
            }).addTo(this.state.map);
            
            // Add user location if available
            if (this.state.userLocation) {
                this.addUserLocationToMap();
            }
            
            this.log('Map created successfully');
        } catch (error) {
            this.log('Error creating map:', error);
            this.showMapError();
        }
    },

    showMapError() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
            mapEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 10px;"><p>üó∫Ô∏è Karte konnte nicht geladen werden</p></div>';
        }
    },

    addUserLocationToMap() {
        try {
            if (!this.state.map || !this.state.userLocation) return;
            
            const userIcon = L.divIcon({
                html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                className: 'user-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            L.marker([this.state.userLocation.lat, this.state.userLocation.lng], {
                icon: userIcon
            })
            .bindPopup('üìç Dein Standort')
            .addTo(this.state.map);
            
            this.log('User location added to map');
        } catch (error) {
            this.log('Error adding user location to map:', error);
        }
    },

    centerOnUser() {
        try {
            if (this.state.userLocation && this.state.map) {
                this.state.map.setView([this.state.userLocation.lat, this.state.userLocation.lng], 17);
            } else {
                alert('Standort nicht verf√ºgbar. Bitte erlaube Standortzugriff in den Browser-Einstellungen.');
            }
        } catch (error) {
            this.log('Error centering on user:', error);
        }
    },

    // Geolocation
    initGeolocation() {
        try {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        this.state.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        this.updateLocationInfo();
                        if (this.state.map) {
                            this.addUserLocationToMap();
                        }
                        this.log('Geolocation obtained');
                    },
                    error => {
                        this.log('Geolocation error:', error);
                        const distanceInfo = document.getElementById('distanceInfo');
                        if (distanceInfo) {
                            distanceInfo.textContent = 'üìç Standort nicht verf√ºgbar';
                        }
                    }
                );
            }
        } catch (error) {
            this.log('Error initializing geolocation:', error);
        }
    },

    updateLocationInfo() {
        try {
            if (!this.state.userLocation) return;
            
            let nearestStation = null;
            let minDistance = Infinity;
            
            this.stations.forEach(station => {
                const distance = this.calculateDistance(
                    this.state.userLocation.lat, this.state.userLocation.lng,
                    station.lat, station.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            });
            
            if (nearestStation) {
                const distanceText = minDistance < 1 
                    ? `${Math.round(minDistance * 1000)}m` 
                    : `${minDistance.toFixed(1)}km`;
                
                const distanceInfo = document.getElementById('distanceInfo');
                if (distanceInfo) {
                    distanceInfo.textContent = `üìç N√§chste Station: ${nearestStation.title} (${distanceText})`;
                }
            }
        } catch (error) {
            this.log('Error updating location info:', error);
        }
    },

    calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },

    // Image Modal
    showImageModal(url, title, description) {
        try {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                flex-direction: column;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <img src="${url}" style="max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px;">
                <div style="color: white; text-align: center; margin-top: 20px; max-width: 600px;">
                    <h3>${title}</h3>
                    <p>${description}</p>
                    <button style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">Schlie√üen</button>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
            this.log('Image modal shown:', title);
        } catch (error) {
            this.log('Error showing image modal:', error);
        }
    },

    // State Management
    saveState() {
        try {
            const stateToSave = {
                ...this.state,
                map: null, // Don't save map object
                markers: [], // Don't save markers
                firebase: null, // Don't save firebase object
                database: null // Don't save database object
            };
            localStorage.setItem('tourState', JSON.stringify(stateToSave));
            this.log('State saved');
        } catch (error) {
            this.log('Error saving state:', error);
        }
    },

    loadState() {
        try {
            const saved = localStorage.getItem('tourState');
            if (saved) {
                const savedState = JSON.parse(saved);
                // Merge saved state but keep current firebase/database objects
                const currentFirebase = this.state.firebase;
                const currentDatabase = this.state.database;
                this.state = { ...this.state, ...savedState };
                this.state.firebase = currentFirebase;
                this.state.database = currentDatabase;
                
                // Restore team selection UI
                if (this.state.selectedTeam) {
                    setTimeout(() => {
                        const teamOptions = document.querySelectorAll('.team-option');
                        teamOptions.forEach(option => {
                            if (option.textContent.includes(this.state.teamName)) {
                                option.classList.add('selected');
                            }
                        });
                        const selector = document.getElementById('teamSelector');
                        if (selector) {
                            selector.style.display = 'none';
                        }
                    }, 100);
                }
                
                // Update UI elements
                if (this.state.tourId) {
                    const currentTourIdEl = document.getElementById('currentTourId');
                    const tourIdInputEl = document.getElementById('tourIdInput');
                    if (currentTourIdEl) currentTourIdEl.textContent = this.state.tourId;
                    if (tourIdInputEl) tourIdInputEl.value = this.state.tourId;
                }
                
                this.log('State loaded');
            }
        } catch (error) {
            this.log('Error loading state:', error);
        }
    }
};

// Initialize app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => TourApp.init());
} else {
    TourApp.init();
}

// Debug mode toggle (uncomment for debugging)
// TourApp.state.debugMode = true;

</script>
```

</body>
</html>: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                    className: 'user-location-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

```
            L.marker([this.state.userLocation.lat, this.state.userLocation.lng], {
                icon: userIcon
            })
            .bindPopup('üìç Dein Standort')
            .addTo(this.state.map);
            
            this.log('User location added to map');
        } catch (error) {
            this.log('Error adding user location to map:', error);
        }
    },

    centerOnUser() {
        try {
            if (this.state.userLocation && this.state.map) {
                this.state.map.setView([this.state.userLocation.lat, this.state.userLocation.lng], 17);
            } else {
                alert('Standort nicht verf√ºgbar. Bitte erlaube Standortzugriff in den Browser-Einstellungen.');
            }
        } catch (error) {
            this.log('Error centering on user:', error);
        }
    },

    // Geolocation
    initGeolocation() {
        try {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        this.state.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        this.updateLocationInfo();
                        if (this.state.map) {
                            this.addUserLocationToMap();
                        }
                        this.log('Geolocation obtained');
                    },
                    error => {
                        this.log('Geolocation error:', error);
                        const distanceInfo = document.getElementById('distanceInfo');
                        if (distanceInfo) {
                            distanceInfo.textContent = 'üìç Standort nicht verf√ºgbar';
                        }
                    }
                );
            }
        } catch (error) {
            this.log('Error initializing geolocation:', error);
        }
    },

    updateLocationInfo() {
        try {
            if (!this.state.userLocation) return;
            
            let nearestStation = null;
            let minDistance = Infinity;
            
            this.stations.forEach(station => {
                const distance = this.calculateDistance(
                    this.state.userLocation.lat, this.state.userLocation.lng,
                    station.lat, station.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            });
            
            if (nearestStation) {
                const distanceText = minDistance < 1 
                    ? `${Math.round(minDistance * 1000)}m` 
                    : `${minDistance.toFixed(1)}km`;
                
                const distanceInfo = document.getElementById('distanceInfo');
                if (distanceInfo) {
                    distanceInfo.textContent = `üìç N√§chste Station: ${nearestStation.title} (${distanceText})`;
                }
            }
        } catch (error) {
            this.log('Error updating location info:', error);
        }
    },

    calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },

    // Image Modal
    showImageModal(url, title, description) {
        try {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                flex-direction: column;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <img src="${url}" style="max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px;">
                <div style="color: white; text-align: center; margin-top: 20px; max-width: 600px;">
                    <h3>${title}</h3>
                    <p>${description}</p>
                    <button style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">Schlie√üen</button>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
            this.log('Image modal shown:', title);
        } catch (error) {
            this.log('Error showing image modal:', error);
        }
    },

    // State Management
    saveState() {
        try {
            const stateToSave = {
                ...this.state,
                map: null, // Don't save map object
                markers: [] // Don't save markers
            };
            localStorage.setItem('tourState', JSON.stringify(stateToSave));
            this.log('State saved');
        } catch (error) {
            this.log('Error saving state:', error);
        }
    },

    loadState() {
        try {
            const saved = localStorage.getItem('tourState');
            if (saved) {
                const savedState = JSON.parse(saved);
                this.state = { ...this.state, ...savedState };
                
                // Restore team selection UI
                if (this.state.selectedTeam) {
                    setTimeout(() => {
                        const teamOptions = document.querySelectorAll('.team-option');
                        teamOptions.forEach(option => {
                            if (option.textContent.includes(this.state.teamName)) {
                                option.classList.add('selected');
                            }
                        });
                        const selector = document.getElementById('teamSelector');
                        if (selector) {
                            selector.style.display = 'none';
                        }
                    }, 100);
                }
                
                this.log('State loaded');
            }
        } catch (error) {
            this.log('Error loading state:', error);
        }
    }
};

// Initialize app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => TourApp.init());
} else {
    TourApp.init();
}

// Debug mode toggle (uncomment for debugging)
// TourApp.state.debugMode = true;

</script>
```

</body>
</html>
