<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√∂lner Abendspaziergang</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiS8O2bG5lciBBYmVuZHNwYXppZXJnYW5nIiwic2hvcnRfbmFtZSI6IkrDtmxuVG91ciIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMjEyMTIxIiwidGhlbWVfY29sb3IiOiIjZGMyNjI2IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBek1qQWlJR1pzYkdwMGRHVnlQU0owYVhSc1pTSWdabWxzYkQwaWJtOXVaU0krUEhKbFkzUWdkMmxrZEdnOUlqRXlPQ0lnYUdWcFoyaDBQU0l6TWpBaUlHWnBiR3c5SWlOa1l6STJNallpTHo0OEwzTjJaejQiLCJzaXplcyI6IjEyOHgxMjgifV19">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .progress-container {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            background: #fbbf24;
            height: 100%;
            width: 0%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .live-message {
            background: #059669;
            color: white;
            padding: 1rem;
            margin: 0.5rem;
            border-radius: 8px;
            animation: slideIn 0.5s ease;
            border-left: 4px solid #047857;
        }

        .live-message.new {
            background: #dc2626;
            animation: pulse 1s infinite;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .main-content {
            padding: 0;
        }

        .tab-container {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 132px;
            z-index: 999;
        }

        .tab {
            flex: 1;
            padding: 1rem 0.5rem;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .tab.active {
            background: white;
            color: #dc2626;
            border-bottom: 3px solid #dc2626;
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            min-height: calc(100vh - 200px);
        }

        .tab-content.active {
            display: block;
        }

        .station-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #dc2626;
            cursor: pointer;
            transition: all 0.3s;
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .station-card.completed {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .station-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .station-number {
            background: #dc2626;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .station-number.completed {
            background: #10b981;
        }

        .station-title {
            flex: 1;
            font-size: 1.3rem;
            font-weight: bold;
            color: #1f2937;
        }

        .station-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .station-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }

        .station-details.active {
            display: block;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h4 {
            color: #dc2626;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .detail-section h4::before {
            content: "‚ñ∂";
            margin-right: 0.5rem;
            color: #dc2626;
        }

        .photo-challenge {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #6366f1;
        }

        .photo-challenge h4 {
            color: #4f46e5;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .photo-upload-area {
            border: 3px dashed #a5b4fc;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.5);
        }

        .photo-upload-area:hover {
            border-color: #6366f1;
            background: rgba(255,255,255,0.8);
        }

        .photo-upload-area.has-photo {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .ai-rating {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
            border: 2px solid #10b981;
        }

        .rating-score {
            font-size: 3rem;
            font-weight: bold;
            color: #059669;
            margin-bottom: 0.5rem;
        }

        .rating-text {
            color: #047857;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .rating-details {
            background: #f0fdf4;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #065f46;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .image-placeholder {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            color: #6b7280;
            border: 2px dashed #d1d5db;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-placeholder:hover {
            background: linear-gradient(135deg, #ddd6fe 0%, #c7d2fe 100%);
            border-color: #8b5cf6;
        }

        .activity-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #f59e0b;
        }

        .activity-title {
            font-weight: bold;
            color: #92400e;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .quiz-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .quiz-option.selected {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .quiz-option.correct {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .quiz-option.wrong {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .btn:hover {
            background: #991b1b;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .score-display {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
            border: 2px solid #8b5cf6;
        }

        .score-number {
            font-size: 2rem;
            font-weight: bold;
            color: #5b21b6;
        }

        .score-label {
            color: #7c3aed;
            margin-top: 0.5rem;
        }

        .team-ranking {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .team-rank-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            background: #f8fafc;
        }

        .team-rank-item.highlight {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .rank-position {
            background: #6b7280;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .rank-position.gold {
            background: #f59e0b;
        }

        .rank-position.silver {
            background: #6b7280;
        }

        .rank-position.bronze {
            background: #d97706;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .location-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .distance-info {
            font-weight: bold;
            color: #0369a1;
            margin-bottom: 0.5rem;
        }

        .team-selector {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .team-option {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .team-option:hover {
            background: #f3f4f6;
        }

        .team-option.selected {
            background: #dbeafe;
            border: 2px solid #3b82f6;
        }

        .team-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .offline-indicator {
            background: #f59e0b;
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
            display: none;
        }

        .offline-indicator.active {
            display: block;
        }

        .master-panel {
            background: #1f2937;
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
        }

        .master-input {
            width: 100%;
            padding: 1rem;
            border-radius: 8px;
            border: none;
            margin: 0.5rem 0;
            font-size: 1rem;
        }

        .voice-controls {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }

        .voice-btn {
            flex: 1;
            padding: 1rem;
            border-radius: 8px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .voice-btn.record {
            background: #dc2626;
        }

        .voice-btn.stop {
            background: #6b7280;
        }

        .voice-btn.broadcasting {
            background: #059669;
            animation: pulse 1s infinite;
        }

        .final-feedback {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .final-feedback h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .feedback-photos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .feedback-photo {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 3px solid rgba(255,255,255,0.5);
        }

        @media (max-width: 768px) {
            .container {
                box-shadow: none;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .tab {
                font-size: 0.8rem;
                padding: 0.8rem 0.3rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .station-card {
                padding: 1rem;
            }
            
            .image-gallery {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .voice-controls {
                flex-direction: column;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc2626;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #10b981;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .role-play-card {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #6366f1;
        }

        .person-role {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.8rem 0;
            border-left: 4px solid #8b5cf6;
        }

        .person-role strong {
            color: #5b21b6;
        }

        .hidden {
            display: none !important;
        }

        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="offline-indicator" id="offlineIndicator">
            üì° Offline-Modus aktiv - Alle Inhalte gespeichert
        </div>

        <!-- Live Messages Area -->
        <div id="liveMessages"></div>

        <header>
            <h1>üèõÔ∏è K√∂lner Abendspaziergang</h1>
            <p class="subtitle">Entdecke 2000 Jahre Stadtgeschichte</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </header>

        <div class="main-content">
            <div class="tab-container">
                <button class="tab active" onclick="showTab('overview')">üó∫Ô∏è √úbersicht</button>
                <button class="tab" onclick="showTab('stations')">üìç Stationen</button>
                <button class="tab" onclick="showTab('ranking')">üèÜ Ranking</button>
                <button class="tab" onclick="showTab('map')">üó∫Ô∏è Karte</button>
                <button class="tab" onclick="showTab('team')">üë• Team</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="score-display">
                    <div class="score-number" id="totalScore">0</div>
                    <div class="score-label">Foto-Punkte gesammelt</div>
                </div>

                <div class="team-selector" id="teamSelector">
                    <h3 style="margin-bottom: 1rem; color: #374151;">üì∏ W√§hle dein Team:</h3>
                    <div class="team-option" onclick="selectTeam('red', 'üî¥ Team R√∂mer')">
                        <div class="team-color" style="background: #dc2626;"></div>
                        <span>üî¥ Team R√∂mer</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('blue', 'üîµ Team Gaffeln')">
                        <div class="team-color" style="background: #2563eb;"></div>
                        <span>üîµ Team Gaffeln</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('green', 'üü¢ Team Hanseat')">
                        <div class="team-color" style="background: #059669;"></div>
                        <span>üü¢ Team Hanseat</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('yellow', 'üü° Team Modern')">
                        <div class="team-color" style="background: #d97706;"></div>
                        <span>üü° Team Modern</span>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">üìã Tour-Informationen</h3>
                    <p><strong>‚è∞ Dauer:</strong> ca. 3,5 Stunden</p>
                    <p><strong>üìç Start:</strong> Heumarkt, 19:30 Uhr</p>
                    <p><strong>üéØ Ziel:</strong> Alte Bastion</p>
                    <p><strong>üë• Teilnehmer:</strong> 15-25 Personen</p>
                    <p><strong>üì∏ Ziel:</strong> Sammle die besten Foto-Punkte!</p>
                </div>

                <!-- Master Panel (hidden by default) -->
                <div class="master-panel hidden" id="masterPanel">
                    <h3>üéõÔ∏è Master-Kontrolle</h3>
                    <input type="password" class="master-input" id="masterPassword" placeholder="Master-Passwort eingeben">
                    <button class="btn" onclick="activateMaster()">üîì Aktivieren</button>
                    
                    <div class="hidden" id="masterControls">
                        <h4>üì¢ Live-Nachricht senden:</h4>
                        <textarea class="master-input" id="liveMessageInput" placeholder="Nachricht an alle Teilnehmer..." rows="3"></textarea>
                        <button class="btn" onclick="sendLiveMessage()">üì§ Nachricht senden</button>
                        
                        <h4>üé§ Sprach-√úbertragung:</h4>
                        <div class="voice-controls">
                            <button class="voice-btn record" onclick="startVoiceBroadcast()">üé§ Sprechen</button>
                            <button class="voice-btn stop" onclick="stopVoiceBroadcast()">‚èπÔ∏è Stopp</button>
                        </div>
                        <div id="voiceStatus"></div>
                    </div>
                </div>

                <button class="btn" onclick="startTour()">üöÄ Tour starten</button>
                <button class="btn btn-secondary" onclick="showMasterPanel()">‚öôÔ∏è Tour-Leitung</button>
            </div>

            <!-- Stations Tab -->
            <div id="stations" class="tab-content">
                <div id="stationsList">
                    <!-- Stations will be generated here -->
                </div>
            </div>

            <!-- Ranking Tab -->
            <div id="ranking" class="tab-content">
                <div class="team-ranking">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">üèÜ Live-Ranking</h3>
                    <div id="rankingList">
                        <!-- Ranking will be generated here -->
                    </div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">üì∏ Punktesystem</h3>
                    <ul style="margin-left: 1.5rem; color: #4b5563;">
                        <li><strong>Perfektes Foto:</strong> 50-100 Punkte</li>
                        <li><strong>Gutes Foto:</strong> 30-49 Punkte</li>
                        <li><strong>Okay Foto:</strong> 10-29 Punkte</li>
                        <li><strong>Kreativit√§ts-Bonus:</strong> +20 Punkte</li>
                        <li><strong>Fr√ºher Upload:</strong> +10 Punkte</li>
                    </ul>
                </div>

                <!-- Final Feedback Area (hidden initially) -->
                <div class="final-feedback hidden" id="finalFeedback">
                    <h2>üéâ Herzlichen Gl√ºckwunsch!</h2>
                    <p>Du hast alle Stationen gemeistert und tolle Fotos gesammelt!</p>
                    <div class="feedback-photos" id="feedbackPhotos"></div>
                    <p><strong>Dein pers√∂nlicher Foto-Score: <span id="finalScore">0</span> Punkte</strong></p>
                    <p>Du hast viele tolle neue Erinnerungen und ein tieferes Verst√§ndnis f√ºr K√∂lns Geschichte gesammelt. Danke f√ºrs Mitmachen! üì∏‚ú®</p>
                </div>
            </div>

            <!-- Map Tab -->
            <div id="map-tab" class="tab-content">
                <div class="location-info">
                    <div class="distance-info" id="distanceInfo">üìç Standort wird ermittelt...</div>
                    <p>üí° Tipp: Erlaube Standortzugriff f√ºr Navigation</p>
                </div>
                <div id="map"></div>
                <button class="btn" onclick="centerOnUser()">üìç Zu meinem Standort</button>
            </div>

            <!-- Team Tab -->
            <div id="team" class="tab-content">
                <div class="score-display">
                    <div class="score-number" id="teamScore">0</div>
                    <div class="score-label">Team: <span id="selectedTeamName">Kein Team gew√§hlt</span></div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">üì± App-Features</h3>
                    <ul style="margin-left: 1.5rem; color: #4b5563;">
                        <li>üåê Offline-f√§hig (alle Inhalte gespeichert)</li>
                        <li>üó∫Ô∏è Interaktive Karte mit Navigation</li>
                        <li>üì∏ KI-bewertete Foto-Challenges</li>
                        <li>üèÜ Live-Team-Ranking</li>
                        <li>üì¢ Live-Nachrichten vom Guide</li>
                        <li>üé§ Sprach-√úbertragung</li>
                        <li>üíæ Automatische Foto-Sammlung</li>
                    </ul>
                </div>

                <button class="btn btn-secondary" onclick="resetProgress()">üîÑ Fortschritt zur√ºcksetzen</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // App State
        let appState = {
            currentStation: 0,
            completedStations: [],
            totalScore: 0,
            selectedTeam: null,
            teamName: '',
            userLocation: null,
            map: null,
            markers: [],
            uploadedPhotos: [],
            masterMode: false,
            voiceBroadcast: null,
            mediaRecorder: null,
            audioStream: null
        };

        // Master password
        const MASTER_PASSWORD = "koeln2025";

        // Fake AI responses for photo rating
        const aiResponses = [
            { score: 95, text: "Perfekt! Fantastische Komposition und historischer Bezug!", details: "Hervorragende Bildqualit√§t, kreative Perspektive, starker Bezug zur Station" },
            { score: 87, text: "Sehr gut! Tolle Aufnahme mit sch√∂ner Beleuchtung!", details: "Gute Bildkomposition, interessanter Winkel, klarer Bezug erkennbar" },
            { score: 78, text: "Gut gelungen! Sch√∂ne Interpretation der Aufgabe!", details: "Solide Aufnahme, passender Inhalt, leichte Verbesserungen m√∂glich" },
            { score: 65, text: "Okay! Das Motiv ist erkennbar, k√∂nnte aber sch√§rfer sein.", details: "Grundlegende Anforderungen erf√ºllt, Bildqualit√§t ausbauf√§hig" },
            { score: 92, text: "Exzellent! Besonders kreative Herangehensweise!", details: "Au√üergew√∂hnliche Kreativit√§t, perfekte technische Umsetzung" },
            { score: 73, text: "Sch√∂n! Gute Umsetzung der Station-Challenge!", details: "Interessante Perspektive, gute Idee, technisch in Ordnung" },
            { score: 88, text: "Sehr sch√∂n! Tolles Verst√§ndnis f√ºr das historische Thema!", details: "Starker thematischer Bezug, gute Bildgestaltung" }
        ];

        // Station Data with Photo Challenges
        const stations = [
            {
                id: 1,
                title: "Heumarkt",
                subtitle: "Wo alles anfing: 2000 Jahre Migration und Handel",
                lat: 50.9356, lng: 6.9611,
                description: "Start der Tour am historischen Heumarkt, einem der geschichtstr√§chtigsten Orte K√∂lns.",
                photoChallenge: "Mache ein Foto von dir oder deinem Team vor dem Reiterstandbild - zeigt dabei mit Handbewegungen, wie H√§ndler fr√ºher ihre Waren angepriesen haben k√∂nnten!",
                mainText: `Die Stadt ist ca. 2.000 Jahre alt. CCAA - Colonia Claudia Ara Agrippinensium - wurde 50 n. Chr. von den R√∂mern gegr√ºndet, mithilfe der germanischen Ubier. Das war √ºbrigens eine der ersten erfolgreichen Integration zweier Kulturen in Europa. 

Hier auf dem Heumarkt stehen wir an einem der ehemaligen Einfallstore zur Stadt. Die Markmannsgasse runter, links von der heutigen Deutzer Br√ºcke, befand sich von 1822 bis 1915 die einzige Schiffsbr√ºcke √ºber den Rhein - 42 schwimmende Boote, die √ºber 30 Mal t√§glich f√ºr Schiffe ge√∂ffnet wurden.

Das "Stapelrecht" von 1259 bis 1804 war ein 545 Jahre g√ºltiges Handelsprivileg. Alle Waren auf Schiffen, die an K√∂ln vorbeifahren wollten, mussten drei Tage hier angeboten werden.`,
                images: [
                    { title: "Heumarkt 1880", description: "Historisches Foto mit Pferdekutschen" },
                    { title: "R√∂mische Stadtentwicklung", description: "Animation der Stadtgr√ºndung" },
                    { title: "Deutzer Schiffsbr√ºcke", description: "Technische Funktionsweise" },
                    { title: "Mittelalterlicher Markt", description: "Rekonstruktion des Handelsplatzes" }
                ]
            },
            {
                id: 2,
                title: "Eisenmarkt",
                subtitle: "Puppentheater, Demokratie und dunkle Zeiten",
                lat: 50.9375, lng: 6.9583,
                description: "Das H√§nneschen Theater und die Geschichte der K√∂lner Gaffeln-Demokratie.",
                photoChallenge: "Macht ein Gruppen-Selfie vor dem H√§nneschen Theater und stellt dabei verschiedene Puppentheater-Figuren mit Gesichtsausdr√ºcken dar!",
                mainText: `Hier steht das H√§nneschen Theater - Deutschlands √§ltestes Puppentheater seit 1802. Das Theater ist mehr als Kinderunterhaltung: Es ist ein politisches Kabarett. Alle St√ºcke spielen im "Knollendorf" - einem satirischen Abbild K√∂lns.

Aber wie so vieles in K√∂ln hat auch dieses Theater eine Nazi-Vergangenheit. W√§hrend der Nazizeit wurde das Puppentheater zur Propaganda-Maschine umfunctioniert.

Hier am Eisenmarkt trafen sich zum ersten Mal H√§ndler und Handwerker, die sich nicht mehr von oben regieren lassen wollten. Sie gr√ºndeten die erste "Gaffel" - benannt nach den gemeinsamen Mahlzeiten mit Gabeln in Brauh√§usern. 1396 √ºbernahmen 22 Gaffeln die komplette Stadtherrschaft - eine der fr√ºhesten b√ºrgerlichen Revolutionen Europas.`,
                images: [
                    { title: "H√§nneschen Theater innen", description: "Aufnahme w√§hrend einer Vorstellung" },
                    { title: "Nazi-Propaganda 1938", description: "Propagandaplakat des Theaters" },
                    { title: "B√ºcherverbrennung K√∂ln", description: "Eine der ersten in Deutschland 1933" },
                    { title: "Erste Gaffel-Versammlung", description: "Rekonstruktion von 1396" }
                ]
            },
            {
                id: 3,
                title: "T√ºnnes und Sch√§l",
                subtitle: "K√∂lner Humor und Selbstironie",
                lat: 50.9361, lng: 6.9578,
                description: "Die ber√ºhmten K√∂lner Figuren als Symbol f√ºr Stadtmensch und Landmensch.",
                photoChallenge: "Stellt T√ºnnes und Sch√§l nach! Eine Person spielt den schlauen Sch√§l (zeigend/belehrend), eine den gutm√ºtigen T√ºnnes (staunend/freundlich).",
                mainText: `Hier seht ihr Sch√§l, den schlechten Stadtbewohner - besserwisserisch, schielend, oft betrunken. Und T√ºnnes, den gutm√ºtigen Bauern vom Land. Sch√§l steht f√ºr die arroganten St√§dter, T√ºnnes f√ºr die ehrlichen Landleute, die die Stadt mit Lebensmitteln versorgen.

Diese Figuren zeigen: Die K√∂lner wissen, dass sie nicht die schlauesten sind - und sind stolz darauf. Selbstironie als √úberlebensstrategie. In einer Stadt, die st√§ndig zwischen verschiedenen M√§chten lavieren musste, war Humor oft der einzige Widerstand.

Direkt hier zeigt uns auch die Schmitz-S√§ule, wie weit der Mond entfernt ist - 384.400 km. Warum? Weil es witzig ist. Typisch K√∂ln.`,
                images: [
                    { title: "Figuren-Entwicklung", description: "T√ºnnes und Sch√§l seit 1803" },
                    { title: "Klassische Geschichten", description: "Audio-Sammlung (3 Min)" },
                    { title: "Moderne Stra√üenkunst", description: "Zeitgen√∂ssische Interpretationen" }
                ]
            },
            {
                id: 4,
                title: "Alter Markt",
                subtitle: "Macht, Rebellion und eine gro√üe Liebesgeschichte",
                lat: 50.9369, lng: 6.9572,
                description: "Das historische Rathaus und die ber√ºhmte Jan-und-Griet-Geschichte.",
                photoChallenge: "Fotografiert euch am Jan-von-Werth-Brunnen und stellt die romantische Szene nach: Eine Person kniet (Jan), eine steht stolz daneben (Griet).",
                mainText: `Der Rathaus-Turm zeigt wichtige Pers√∂nlichkeiten der K√∂lner Geschichte. 1945 zerst√∂rt und wieder aufgebaut. Da auch die Figuren zerst√∂rt waren, w√§hlte eine Kommission neue aus - von √ºber 100 Kandidaten. Alle m√§nnlich. Bei einer Stadt, die quasi von einer Frau gegr√ºndet wurde: Agrippina.

Oben am Turm seht ihr den "Platz-Jabbeck" - er streckt Autorit√§ten die Zunge raus. So viel Respekt hatten die K√∂lner f√ºr die Obrigkeit.

Der Jan-von-Werth-Brunnen erz√§hlt eine der gr√∂√üten deutschen Liebesgeschichten: Jan ist ein armer Knecht, wo auch Griet arbeitet. Er mag sie, sie ihn nicht. Der Krieg beginnt, Jan zieht aus, kommt als ber√ºhmter General zur√ºck. Er fragt: "Jetzt heiratest du mich?" Griets Antwort: "Wer et h√§t jedon, der h√§t es jewuss" - Wahre Liebe braucht keinen Reichtum.`,
                images: [
                    { title: "360¬∞ Panorama", description: "Alter Markt heute vs. 1500" },
                    { title: "Rathausturm-Figuren", description: "Biografien aller Pers√∂nlichkeiten" },
                    { title: "Platz-Jabbeck", description: "Symbol des k√∂lschen Widerstands" },
                    { title: "Jan und Griet", description: "Historiengem√§lde der Liebesgeschichte" }
                ]
            },
            {
                id: 5,
                title: "Rhein-Denkmal",
                subtitle: "Totgeschlagen - Totgeschwiegen",
                lat: 50.9372, lng: 6.9614,
                description: "Denkmal f√ºr verfolgte und ermordete Homosexuelle.",
                photoChallenge: "Macht ein respektvolles Foto am Denkmal mit einem Zeichen f√ºr Vielfalt und Toleranz (z.B. Herz-Handhaltung, Regenbogen-Pose).",
                mainText: `‚ÄûTotgeschlagen ‚Äì Totgeschwiegen" - das steht auf diesem roten Dreieck. Das rote Dreieck war das Erkennungszeichen f√ºr Homosexuelle in Nazi-Konzentrationslagern - √§hnlich dem gelben Judenstern.

"Totgeschlagen" bezieht sich auf die Nazi-Zeit. "Totgeschwiegen" auf die Zeit danach: Homosexualit√§t blieb bis 1994 eine Straftat in Deutschland. Die Verfolgung ging weiter, nur leiser. Das Schweigen f√ºhrte auch zur AIDS-Epidemie der 1980er-90er.

Wenn wir heute von Angriffen auf CSD-Paraden h√∂ren, lohnt es sich, daran zu erinnern, wohin das f√ºhren kann. Demokratie und Menschenrechte sind nicht selbstverst√§ndlich - sie m√ºssen jeden Tag verteidigt werden.`,
                images: [
                    { title: "LGBTQ+-Verfolgung", description: "Dokumentation der Geschichte" },
                    { title: "Zeitleiste", description: "Von Kriminalisierung zur Gleichstellung" },
                    { title: "Zeitzeugen", description: "Pers√∂nliche Berichte 70er-90er Jahre" }
                ]
            },
            {
                id: 6,
                title: "Dom/Hauptbahnhof",
                subtitle: "Das ewige Bauprojekt und die Verkehrsrevolution",
                lat: 50.9413, lng: 6.9583,
                description: "K√∂lns Wahrzeichen und die l√§ngste Baustelle der Welt.",
                photoChallenge: "Bildet mit eurem Team eine 'menschliche Kathedrale' vor dem Dom - streckt die Arme hoch und formt gotische B√∂gen nach!",
                mainText: `Der Dom wird seit fast 800 Jahren gebaut - etwas l√§nger als der BER. Die Grundsteinlegung 1248 war K√∂lns Versuch, Paris und andere Gro√üst√§dte zu beeindrucken. K√∂ln war immer reich, aber auch provinziell.

1248-1330 wurden Grundmauern und der Chor fertiggestellt. Dann ging das Geld aus. Fast 300 Jahre stand nur ein riesiger Kran auf dem unvollendeten Turm - eines der ersten gro√üen "paused projects" der Geschichte.

Erst die Romantik des 19. Jahrhunderts und preu√üisches Geld vollendeten den Dom 1880. Der Hauptbahnhof entstand 1894 als einer der modernsten Europas. Das Problem: Dom, Bahnhof und Hohenzollernbr√ºcke stehen sich gegenseitig im Weg.

Im Zweiten Weltkrieg bekam der Dom 14 Bombenvolltreffer, blieb aber stehen - als Orientierungsmarke f√ºr Bomber.`,
                images: [
                    { title: "Dombau Zeitraffer", description: "1248-1880, l√§ngste Baustelle der Welt" },
                    { title: "Bahnhofsvorplatz 1900", description: "Mit Pferdefuhrwerken" },
                    { title: "K√∂lner Domkran", description: "1560-1842, Symbol des Stillstands" },
                    { title: "Architektur-Konflikt", description: "Warum Dom und Bahnhof nicht passen" },
                    { title: "Bombenangriff", description: "Dom zwischen Tr√ºmmern 1944-45" }
                ]
            },
            {
                id: 7,
                title: "Eigelsteinviertel",
                subtitle: "Klein-Istanbul und 11.000 Jungfrauen",
                lat: 50.9461, lng: 6.9528,
                description: "Das multikulturellste Viertel K√∂lns und eine gro√üe L√ºge der Stadtgeschichte.",
                photoChallenge: "Fotografiert euch vor einem multikulturellen Gesch√§ft und zeigt dabei mit H√§nden/Gesichtern die Vielfalt der Kulturen (z.B. verschiedene Gr√º√üe).",
                mainText: `Willkommen im Eigelsteinviertel - seit 50 Jahren das multikulturellste Viertel K√∂lns. Hier leben Menschen aus √ºber 100 Nationen auf engstem Raum zusammen.

An der Ecke zur Ursulastra√üe begegnet uns eine der gr√∂√üten L√ºgen der Stadtgeschichte: die 11.000 Jungfrauen. Die Wahrheit: Es waren wahrscheinlich 11 Frauen, nicht 11.000. Ein mittelalterlicher √úbersetzungsfehler aus "XI M.V." (11 martyres virgines = 11 jungfr√§uliche M√§rtyrerinnen) wurde zu "11 milia virginum" (11.000 Jungfrauen). Aber mit 11.000 lie√ü sich mehr Geld durch Reliquienhandel verdienen.

Nach dem Anwerbeabkommen mit der T√ºrkei 1961 entstanden hier die ersten "Gastarbeiter"-Siedlungen. Aus den geplanten 2 Jahren wurden Generationen. Das Viertel durchlief alle Phasen der Migration: Ankunft, Ghettobildung, Integration, Gentrifizierung.`,
                images: [
                    { title: "Eigelstein 1974-heute", description: "Von Arbeitervorstadt zu Klein-Istanbul" },
                    { title: "Eigelsteintor", description: "Rekonstruktion mit Stadtmauer" },
                    { title: "Ursula-Legende", description: "Mittelalterliche Handschrift" },
                    { title: "Erste t√ºrkische Familien", description: "Oral History vom Ankommen" }
                ]
            },
            {
                id: 8,
                title: "St√ºtzenhof",
                subtitle: "Arbeit, Moral und gesellschaftliche Doppelmoral",
                lat: 50.9433, lng: 6.9489,
                description: "Das ehemalige Prostituiertenviertel und seine Sozialgeschichte.",
                photoChallenge: "Macht ein nachdenkliches Gruppen-Foto √ºber gesellschaftlichen Wandel - zeigt verschiedene Generationen/Perspektiven in euren Posen.",
                mainText: `Hier, rund um den ehemaligen St√ºtzenhof, befand sich jahrhundertelang K√∂lns gr√∂√ütes Prostitutionsviertel.

Prostitution war im mittelalterlichen K√∂ln legal und st√§dtisch reguliert - fortschrittlicher als in vielen anderen St√§dten. Die Stadt kassierte Steuern, bot medizinische Versorgung und rechtlichen Schutz. Ein pragmatischer Ansatz f√ºr ein unvermeidliches gesellschaftliches Ph√§nomen.

Viele der arbeitenden Frauen waren Migrantinnen aus dem Umland oder anderen St√§dten. Migration und Sexarbeit waren oft verkn√ºpft - ein Muster, das sich durch die Jahrhunderte zieht.

Die Moral √§nderte sich im 19. Jahrhundert. Prostitution wurde kriminalisiert, das Viertel "ges√§ubert". Die Frauen verschwanden nicht - sie wurden nur unsichtbarer und schutzloser.`,
                images: [
                    { title: "Rotlichtviertel", description: "Historische Karten im Wandel" },
                    { title: "Stadtrecht 1437", description: "Regulierung der Prostitution" },
                    { title: "Polizeiprotokoll 1890", description: "S√§uberung des Viertels" },
                    { title: "Moderne Debatte", description: "Sexarbeiter*innen-Rechte heute" }
                ]
            },
            {
                id: 9,
                title: "Ebertplatz",
                subtitle: "Vom Sicherheitshafen zum Angstraum und zur√ºck",
                lat: 50.9472, lng: 6.9456,
                description: "Ein Lehrst√ºck √ºber Stadtplanung und B√ºrgerbeteiligung.",
                photoChallenge: "Zeigt den Wandel des Platzes: Macht zwei Fotos - eins 'grimmig/problematisch' und eins 'hoffnungsvoll/optimistisch' am selben Ort.",
                mainText: `1972 als moderner "Sicherheitshafen" er√∂ffnet: √ºbersichtlich, hell ausgeleuchtet, mit U-Bahn-Anschluss. Ein Vorzeigeprojekt der Stadtplanung. Die Idee: Kriminalit√§t durch Design verhindern.

Dann die Kehrtwende: In den 1990er-2000ern wurde der Platz zum Symbol st√§dtischer Probleme. Drogenhandel, Gewalt, Verm√ºllung. Die Medien nannten ihn "gef√§hrlichsten Platz K√∂lns". Die Realit√§t war komplexer: viel Angst, weniger tats√§chliche Kriminalstatistik.

Der Platz wurde zum Treffpunkt f√ºr Menschen am gesellschaftlichen Rand: Obdachlose, Drogenabh√§ngige, Arbeitslose. Nicht alle waren kriminell, aber alle waren sichtbar. Und Sichtbarkeit von Armut macht vielen Menschen Angst.

Seit 2015 die Wende: B√ºrgerinitiativen, Stadtteilladen, Community-Events. Nicht durch √úberwachung und Verdr√§ngung, sondern durch Beteiligung und positive Nutzung.`,
                images: [
                    { title: "Zeitreise", description: "1970 Vorzeigeplatz vs. 2010 Angstraum vs. heute" },
                    { title: "Medienberichterstattung", description: "Angstraum Ebertplatz 1995-2010" },
                    { title: "Studie", description: "Wahrnehmung vs. Realit√§t von Unsicherheit" },
                    { title: "Ebertplatz lebt", description: "B√ºrgerinitiative dokumentiert Wandel" },
                    { title: "Urban Planning", description: "Erfolgreiche Platz-Revitalisierung weltweit" }
                ]
            },
            {
                id: 10,
                title: "Alte Bastion",
                subtitle: "Grenzen √ºberwinden, Br√ºcken bauen",
                lat: 50.9489, lng: 6.9444,
                description: "Ende der Tour an der ehemaligen Stadtgrenze.",
                photoChallenge: "Abschluss-Foto: Macht ein Siegerfoto mit allen Teammitgliedern - zeigt eure Freude √ºber die abgeschlossene Tour und das Gelernte!",
                mainText: `Wir stehen hier an der ehemaligen Stadtgrenze - der preu√üischen Bastionsbefestigung von 1816. Von hier aus konntet ihr fr√ºher nicht weiter, ohne die Stadt zu verlassen.

Diese Bastion symbolisiert Grenzen. K√∂ln war immer eine Stadt der Grenzen - zwischen r√∂mischem und germanischem Reich, zwischen weltlicher und kirchlicher Macht, zwischen arm und reich, zwischen alteingesessen und zugewandert.

Aber K√∂ln war auch immer eine Stadt, die Grenzen √ºberwunden hat. 1958 schloss K√∂ln als eine der ersten deutschen St√§dte eine Partnerschaft mit dem ehemaligen "Erzfeind" Frankreich (Limoges), 1967 folgte Liverpool - mitten im Kalten Krieg Br√ºcken bauen statt Mauern.

K√∂ln war nie "rein deutsch" oder kulturell homogen. Die Stadt lebte 2000 Jahre von Migration, Handel und kulturellem Austausch. Die Probleme von heute sind nicht neu. Aber die L√∂sungen auch nicht: Respekt, Beteiligung, gemeinsame Gestaltung der Stadt.`,
                images: [
                    { title: "Stadtgrenzen", description: "K√∂lns Grenzen durch 2000 Jahre" },
                    { title: "St√§dtepartnerschaften", description: "K√∂ln baut Br√ºcken nach Europa" },
                    { title: "Gesichter K√∂lns", description: "Montage aller Nationalit√§ten heute" },
                    { title: "Start with a Friend", description: "K√∂ln als Stadt der Begegnungen" }
                ]
            }
        ];

        // Initialize App
        function initApp() {
            generateStationsList();
            initMap();
            updateUI();
            startLiveMessageCheck();
            
            // Check if geolocation is available
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        appState.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateLocationInfo();
                        if (appState.map) {
                            addUserLocationToMap();
                        }
                    },
                    error => {
                        console.log('Geolocation not available:', error);
                        document.getElementById('distanceInfo').textContent = 'üìç Standort nicht verf√ºgbar';
                    }
                );
            }

            // Load saved state
            loadState();

            // Register service worker for offline functionality
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(e => {
                    console.log('Service worker registration failed');
                });
            }

            // Check online status
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }

        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (!navigator.onLine) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName === 'map' ? 'map-tab' : tabName).classList.add('active');

            // Initialize map if switching to map tab
            if (tabName === 'map' && !appState.map) {
                setTimeout(initMap, 100);
            }

            // Update ranking if switching to ranking tab
            if (tabName === 'ranking') {
                updateRanking();
            }
        }

        function generateStationsList() {
            const container = document.getElementById('stationsList');
            
            stations.forEach(station => {
                const isCompleted = appState.completedStations.includes(station.id);
                
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${isCompleted ? 'completed' : ''}`;
                stationCard.onclick = () => toggleStationDetails(station.id);
                
                stationCard.innerHTML = `
                    <div class="station-header">
                        <div class="station-number ${isCompleted ? 'completed' : ''}">${station.id}</div>
                        <div>
                            <div class="station-title">${station.title}</div>
                            <div class="station-subtitle">${station.subtitle}</div>
                        </div>
                    </div>
                    <div class="station-details" id="station-${station.id}">
                        <div class="detail-section">
                            <h4>üìñ Geschichte</h4>
                            <p>${station.mainText}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üñºÔ∏è Bildergalerie</h4>
                            <div class="image-gallery">
                                ${station.images.map(img => `
                                    <div class="image-placeholder" onclick="showImageInfo('${img.title}', '${img.description}')">
                                        üñºÔ∏è<br><small>${img.title}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="photo-challenge">
                            <h4>üì∏ Foto-Challenge</h4>
                            <p>${station.photoChallenge}</p>
                            
                            <div class="photo-upload-area" onclick="selectPhoto(${station.id})" id="upload-area-${station.id}">
                                <div id="upload-content-${station.id}">
                                    üì∑ Hier klicken zum Foto machen/ausw√§hlen
                                </div>
                            </div>
                            
                            <input type="file" class="file-input" id="photo-input-${station.id}" accept="image/*" capture="environment" onchange="handlePhotoUpload(${station.id}, event)">
                            
                            <div class="ai-rating hidden" id="rating-${station.id}">
                                <div class="rating-score" id="score-${station.id}">0</div>
                                <div class="rating-text" id="rating-text-${station.id}">KI bewertet dein Foto...</div>
                                <div class="rating-details" id="rating-details-${station.id}"></div>
                            </div>
                        </div>

                        <button class="btn" onclick="completeStation(${station.id})" id="complete-btn-${station.id}" 
                                ${isCompleted ? 'disabled' : ''} style="background: #10b981;">
                            ${isCompleted ? '‚úÖ Station abgeschlossen' : 'üèÅ Station abschlie√üen'}
                        </button>
                    </div>
                `;
                
                container.appendChild(stationCard);
            });
        }

        function toggleStationDetails(stationId) {
            const details = document.getElementById(`station-${stationId}`);
            details.classList.toggle('active');
        }

        function selectTeam(teamId, teamName) {
            appState.selectedTeam = teamId;
            appState.teamName = teamName;
            
            // Update UI
            document.querySelectorAll('.team-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.team-option').classList.add('selected');
            
            document.getElementById('selectedTeamName').textContent = teamName;
            
            // Hide team selector after selection
            document.getElementById('teamSelector').style.display = 'none';
            
            showSuccessMessage('Team ausgew√§hlt! üéâ');
            saveState();
        }

        function startTour() {
            if (!appState.selectedTeam) {
                alert('Bitte w√§hle zuerst ein Team aus!');
                return;
            }
            
            showTab('stations');
            document.querySelector('[onclick="showTab(\'stations\')"]').click();
            showSuccessMessage('Tour gestartet! Viel Erfolg! üöÄ');
        }

        function selectPhoto(stationId) {
            document.getElementById(`photo-input-${stationId}`).click();
        }

        function handlePhotoUpload(stationId, event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                
                // Update upload area
                const uploadArea = document.getElementById(`upload-area-${stationId}`);
                uploadArea.classList.add('has-photo');
                uploadArea.innerHTML = `
                    <img src="${imageUrl}" class="photo-preview" alt="Uploaded photo">
                    <p>üì∑ Foto erfolgreich hochgeladen!</p>
                    <small>Klicke hier f√ºr ein neues Foto</small>
                `;

                // Store photo
                const existingPhotoIndex = appState.uploadedPhotos.findIndex(p => p.stationId === stationId);
                const photoData = {
                    stationId: stationId,
                    imageUrl: imageUrl,
                    timestamp: Date.now(),
                    teamId: appState.selectedTeam
                };

                if (existingPhotoIndex >= 0) {
                    appState.uploadedPhotos[existingPhotoIndex] = photoData;
                } else {
                    appState.uploadedPhotos.push(photoData);
                }

                // Simulate AI rating
                setTimeout(() => {
                    ratePhoto(stationId);
                }, 1500);

                saveState();
            };
            
            reader.readAsDataURL(file);
        }

        function ratePhoto(stationId) {
            const ratingDiv = document.getElementById(`rating-${stationId}`);
            ratingDiv.classList.remove('hidden');
            
            // Get random AI response
            const response = aiResponses[Math.floor(Math.random() * aiResponses.length)];
            
            // Add bonus points for early uploads and creativity
            const bonusPoints = Math.floor(Math.random() * 30);
            const finalScore = Math.min(100, response.score + bonusPoints);
            
            // Animate score counting up
            let currentScore = 0;
            const scoreElement = document.getElementById(`score-${stationId}`);
            const interval = setInterval(() => {
                currentScore += 3;
                scoreElement.textContent = currentScore;
                if (currentScore >= finalScore) {
                    clearInterval(interval);
                    scoreElement.textContent = finalScore;
                }
            }, 50);
            
            document.getElementById(`rating-text-${stationId}`).textContent = response.text;
            document.getElementById(`rating-details-${stationId}`).textContent = response.details;
            
            // Add score to total
            addScore(finalScore);
            
            // Store rating
            const photoData = appState.uploadedPhotos.find(p => p.stationId === stationId);
            if (photoData) {
                photoData.score = finalScore;
                photoData.rating = response;
            }
            
            showSuccessMessage(`Foto bewertet! +${finalScore} Punkte! üì∏`);
        }

        function completeStation(stationId) {
            if (!appState.completedStations.includes(stationId)) {
                appState.completedStations.push(stationId);
                updateProgress();
                showSuccessMessage('Station abgeschlossen! üèÅ');
                
                // Update station card
                const stationCard = document.querySelector(`#complete-btn-${stationId}`).closest('.station-card');
                stationCard.classList.add('completed');
                stationCard.querySelector('.station-number').classList.add('completed');
                
                // Disable button
                event.target.disabled = true;
                event.target.textContent = '‚úÖ Station abgeschlossen';
                event.target.style.background = '#6b7280';

                // Check if tour is complete
                if (appState.completedStations.length === stations.length) {
                    showFinalFeedback();
                }

                saveState();
            }
        }

        function addScore(points) {
            appState.totalScore += points;
            updateUI();
            saveState();
        }

        function updateUI() {
            document.getElementById('totalScore').textContent = appState.totalScore;
            document.getElementById('teamScore').textContent = appState.totalScore;
            updateProgress();
        }

        function updateProgress() {
            const progress = (appState.completedStations.length / stations.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function updateRanking() {
            const rankingList = document.getElementById('rankingList');
            
            // Generate fake team data for ranking
            const teams = [
                { name: appState.teamName || 'Dein Team', score: appState.totalScore, isUser: true },
                { name: 'üî¥ Team R√∂mer', score: Math.floor(Math.random() * 800) + 200 },
                { name: 'üîµ Team Gaffeln', score: Math.floor(Math.random() * 800) + 200 },
                { name: 'üü¢ Team Hanseat', score: Math.floor(Math.random() * 800) + 200 },
                { name: 'üü° Team Modern', score: Math.floor(Math.random() * 800) + 200 }
            ].filter(team => team.name !== 'Dein Team' || appState.selectedTeam)
             .sort((a, b) => b.score - a.score);

            rankingList.innerHTML = '';
            
            teams.forEach((team, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = `team-rank-item ${team.isUser ? 'highlight' : ''}`;
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                rankItem.innerHTML = `
                    <div class="rank-position ${rankClass}">${index + 1}</div>
                    <div style="flex: 1;">
                        <strong>${team.name}</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">
                            ${team.score} Punkte
                        </div>
                    </div>
                    ${team.isUser ? '<div style="color: #f59e0b;">üë§</div>' : ''}
                `;
                
                rankingList.appendChild(rankItem);
            });
        }

        function showFinalFeedback() {
            const feedbackDiv = document.getElementById('finalFeedback');
            const photosDiv = document.getElementById('feedbackPhotos');
            
            // Show all uploaded photos
            photosDiv.innerHTML = '';
            appState.uploadedPhotos.forEach(photo => {
                const img = document.createElement('img');
                img.src = photo.imageUrl;
                img.className = 'feedback-photo';
                photosDiv.appendChild(img);
            });
            
            document.getElementById('finalScore').textContent = appState.totalScore;
            feedbackDiv.classList.remove('hidden');
            
            // Scroll to feedback
            feedbackDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function showImageInfo(title, description) {
            alert(`üñºÔ∏è ${title}\n\n${description}\n\nüí° Tipp: Scanne den QR-Code vor Ort f√ºr das echte Bild!`);
        }

        function resetProgress() {
            if (confirm('M√∂chtest du wirklich den gesamten Fortschritt zur√ºcksetzen?')) {
                appState.completedStations = [];
                appState.totalScore = 0;
                appState.currentStation = 0;
                appState.uploadedPhotos = [];
                
                // Reset UI
                updateUI();
                saveState();
                location.reload();
            }
        }

        // Master Functions
        function showMasterPanel() {
            document.getElementById('masterPanel').classList.remove('hidden');
        }

        function activateMaster() {
            const password = document.getElementById('masterPassword').value;
            if (password === MASTER_PASSWORD) {
                appState.masterMode = true;
                document.getElementById('masterControls').classList.remove('hidden');
                showSuccessMessage('Master-Modus aktiviert! üéõÔ∏è');
                
                // Request microphone permission
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        appState.audioStream = stream;
                        console.log('Microphone access granted');
                    })
                    .catch(err => {
                        console.log('Microphone access denied:', err);
                    });
            } else {
                alert('Falsches Passwort!');
            }
        }

        function sendLiveMessage() {
            const message = document.getElementById('liveMessageInput').value;
            if (!message.trim()) return;
            
            // Store message in localStorage for other users to pick up
            const messages = JSON.parse(localStorage.getItem('liveMessages') || '[]');
            messages.push({
                id: Date.now(),
                message: message,
                timestamp: new Date().toLocaleTimeString('de-DE')
            });
            localStorage.setItem('liveMessages', JSON.stringify(messages));
            
            // Clear input
            document.getElementById('liveMessageInput').value = '';
            
            showSuccessMessage('Live-Nachricht gesendet! üì¢');
        }

        function startLiveMessageCheck() {
            setInterval(() => {
                const messages = JSON.parse(localStorage.getItem('liveMessages') || '[]');
                const lastCheck = parseInt(localStorage.getItem('lastMessageCheck') || '0');
                
                const newMessages = messages.filter(msg => msg.id > lastCheck);
                
                if (newMessages.length > 0) {
                    newMessages.forEach(msg => displayLiveMessage(msg));
                    localStorage.setItem('lastMessageCheck', Math.max(...newMessages.map(m => m.id)).toString());
                }
            }, 2000);
        }

        function displayLiveMessage(message) {
            const messagesDiv = document.getElementById('liveMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'live-message new';
            messageDiv.innerHTML = `
                <strong>üì¢ Live-Update (${message.timestamp}):</strong><br>
                ${message.message}
            `;
            
            messagesDiv.appendChild(messageDiv);
            
            // Remove 'new' class after animation
            setTimeout(() => {
                messageDiv.classList.remove('new');
            }, 2000);
            
            // Remove old messages
            const allMessages = messagesDiv.querySelectorAll('.live-message');
            if (allMessages.length > 5) {
                allMessages[0].remove();
            }
        }

        function startVoiceBroadcast() {
            if (!appState.audioStream) {
                alert('Mikrofon-Zugriff erforderlich!');
                return;
            }
            
            // Create MediaRecorder
            appState.mediaRecorder = new MediaRecorder(appState.audioStream);
            const audioChunks = [];
            
            appState.mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            appState.mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                // In a real implementation, this would be sent to a server
                console.log('Audio recorded:', audioBlob);
            };
            
            appState.mediaRecorder.start();
            
            // Update UI
            document.querySelector('.voice-btn.record').classList.add('broadcasting');
            document.querySelector('.voice-btn.record').textContent = 'üî¥ √úbertragung l√§uft';
            document.getElementById('voiceStatus').textContent = 'üé§ Sprach-√úbertragung aktiv';
            
            showSuccessMessage('Sprach-√úbertragung gestartet! üé§');
        }

        function stopVoiceBroadcast() {
            if (appState.mediaRecorder && appState.mediaRecorder.state === 'recording') {
                appState.mediaRecorder.stop();
            }
            
            // Update UI
            document.querySelector('.voice-btn.record').classList.remove('broadcasting');
            document.querySelector('.voice-btn.record').textContent = 'üé§ Sprechen';
            document.getElementById('voiceStatus').textContent = '';
            
            showSuccessMessage('Sprach-√úbertragung beendet! ‚èπÔ∏è');
        }

        // State Management
        function saveState() {
            localStorage.setItem('tourState', JSON.stringify(appState));
        }

        function loadState() {
            const saved = localStorage.getItem('tourState');
            if (saved) {
                const savedState = JSON.parse(saved);
                appState = { ...appState, ...savedState };
                updateUI();
                
                // Restore team selection
                if (appState.selectedTeam) {
                    document.getElementById('selectedTeamName').textContent = appState.teamName;
                    document.getElementById('teamSelector').style.display = 'none';
                }
                
                // Restore uploaded photos
                appState.uploadedPhotos.forEach(photo => {
                    const uploadArea = document.getElementById(`upload-area-${photo.stationId}`);
                    if (uploadArea) {
                        uploadArea.classList.add('has-photo');
                        uploadArea.innerHTML = `
                            <img src="${photo.imageUrl}" class="photo-preview" alt="Uploaded photo">
                            <p>üì∑ Foto erfolgreich hochgeladen!</p>
                            <small>Klicke hier f√ºr ein neues Foto</small>
                        `;
                        
                        if (photo.score) {
                            const ratingDiv = document.getElementById(`rating-${photo.stationId}`);
                            if (ratingDiv) {
                                ratingDiv.classList.remove('hidden');
                                document.getElementById(`score-${photo.stationId}`).textContent = photo.score;
                                document.getElementById(`rating-text-${photo.stationId}`).textContent = photo.rating.text;
                                document.getElementById(`rating-details-${photo.stationId}`).textContent = photo.rating.details;
                            }
                        }
                    }
                });
            }
        }

        // Map Functions (same as before)
        function initMap() {
            if (!document.getElementById('map') || appState.map) return;
            
            appState.map = L.map('map').setView([50.9375, 6.9597], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(appState.map);
            
            stations.forEach((station, index) => {
                const isCompleted = appState.completedStations.includes(station.id);
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}/10</strong></p>
                            ${isCompleted ? '<p style="color: green;">‚úÖ Abgeschlossen</p>' : '<p style="color: orange;">‚è≥ Ausstehend</p>'}
                        </div>
                    `)
                    .addTo(appState.map);
                
                appState.markers.push(marker);
            });
            
            if (appState.userLocation) {
                addUserLocationToMap();
            }
            
            const routeCoordinates = stations.map(station => [station.lat, station.lng]);
            L.polyline(routeCoordinates, {
                color: '#dc2626',
                weight: 3,
                opacity: 0.7
            }).addTo(appState.map);
        }

        function addUserLocationToMap() {
            if (!appState.map || !appState.userLocation) return;
            
            L.marker([appState.userLocation.lat, appState.userLocation.lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCA0OCIgZmlsbD0ibm9uZSI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4=',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            })
            .bindPopup('üìç Dein Standort')
            .addTo(appState.map);
        }

        function centerOnUser() {
            if (appState.userLocation && appState.map) {
                appState.map.setView([appState.userLocation.lat, appState.userLocation.lng], 17);
            } else {
                alert('Standort nicht verf√ºgbar. Bitte erlaube Standortzugriff in den Browser-Einstellungen.');
            }
        }

        function updateLocationInfo() {
            if (!appState.userLocation) return;
            
            let nearestStation = null;
            let minDistance = Infinity;
            
            stations.forEach(station => {
                const distance = calculateDistance(
                    appState.userLocation.lat, appState.userLocation.lng,
                    station.lat, station.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            });
            
            if (nearestStation) {
                const distanceText = minDistance < 1 
                    ? `${Math.round(minDistance * 1000)}m` 
                    : `${minDistance.toFixed(1)}km`;
                
                document.getElementById('distanceInfo').textContent = 
                    `üìç N√§chste Station: ${nearestStation.title} (${distanceText})`;
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
