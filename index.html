<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KÃ¶lner Abendspaziergang</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .tour-id-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .connection-status.online {
            background: #10b981;
        }

        .connection-status.offline {
            background: #dc2626;
        }

        .connection-status.connecting {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-container {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            background: #fbbf24;
            height: 100%;
            width: 0%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .main-content {
            padding: 0;
            padding-bottom: 80px; /* Space for fixed navigation */
        }

        /* Fixed Navigation */
        .tab-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 0 -2px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 0.8rem 0.3rem;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            transition: all 0.3s;
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 60px;
            touch-action: manipulation;
            position: relative;
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            color: white;
            border-top: 3px solid #fbbf24;
        }

        .tab.admin {
            background: rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }

        .tab.admin.active {
            background: #f59e0b;
            color: white;
        }

        /* Notification badge for tabs */
        .tab-notification {
            position: absolute;
            top: 5px;
            right: 8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            min-height: calc(100vh - 200px);
        }

        .tab-content.active {
            display: block;
        }

        .error-panel {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            color: #dc2626;
        }

        .score-display {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
            border: 2px solid #8b5cf6;
        }

        .score-number {
            font-size: 2rem;
            font-weight: bold;
            color: #5b21b6;
        }

        .score-label {
            color: #7c3aed;
            margin-top: 0.5rem;
        }

        /* Improved form styles */
        .form-section {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .form-section h3 {
            margin-bottom: 1rem;
            color: #374151;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .input-group input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .team-selector {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .team-option {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            touch-action: manipulation;
        }

        .team-option:hover {
            background: #f3f4f6;
        }

        .team-option.selected {
            background: #dbeafe;
            border: 2px solid #3b82f6;
        }

        .team-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .tour-connection-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .qr-code-area {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .share-url {
            background: #f8fafc;
            padding: 0.8rem;
            border-radius: 8px;
            border: 2px dashed #e2e8f0;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin: 0.5rem 0;
        }

        .admin-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .admin-password-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin: 0.5rem 0;
        }

        .station-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #dc2626;
            cursor: pointer;
            transition: all 0.3s;
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .station-card.completed {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .station-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .station-number {
            background: #dc2626;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .station-number.completed {
            background: #10b981;
        }

        .station-title {
            flex: 1;
            font-size: 1.3rem;
            font-weight: bold;
            color: #1f2937;
        }

        .station-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .station-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }

        .station-details.active {
            display: block;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h4 {
            color: #dc2626;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .detail-section h4::before {
            content: "â¶";
            margin-right: 0.5rem;
            color: #dc2626;
        }

        .photo-challenge {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #6366f1;
            position: relative;
        }

        .photo-challenge h4 {
            color: #4f46e5;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .photo-upload-area {
            border: 3px dashed #a5b4fc;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.5);
            touch-action: manipulation;
        }

        .photo-upload-area:hover {
            border-color: #6366f1;
            background: rgba(255,255,255,0.8);
        }

        .photo-upload-area.has-photo {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .ai-rating {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
            border: 2px solid #10b981;
        }

        .rating-score {
            font-size: 3rem;
            font-weight: bold;
            color: #059669;
            margin-bottom: 0.5rem;
        }

        .rating-text {
            color: #047857;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .rating-details {
            background: #f0fdf4;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #065f46;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .gallery-image {
            width: 100%;
            height: 120px;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 2rem;
        }

        .gallery-image:hover {
            transform: scale(1.05);
        }

        .gallery-item {
            text-align: center;
            position: relative;
        }

        .gallery-item small {
            display: block;
            margin-top: 0.5rem;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 1rem;
            margin-top: 1rem;
            touch-action: manipulation;
        }

        .btn:hover {
            background: #991b1b;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-admin {
            background: #f59e0b;
        }

        .btn-admin:hover {
            background: #d97706;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            width: auto;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        .team-ranking {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .team-rank-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            background: #f8fafc;
        }

        .team-rank-item.highlight {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .rank-position {
            background: #6b7280;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .rank-position.gold {
            background: #f59e0b;
        }

        .rank-position.silver {
            background: #6b7280;
        }

        .rank-position.bronze {
            background: #d97706;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .location-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .distance-info {
            font-weight: bold;
            color: #0369a1;
            margin-bottom: 0.5rem;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-message {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            background: #f8fafc;
            border-left: 3px solid #3b82f6;
        }

        .chat-message.own {
            background: #dbeafe;
            border-left-color: #1d4ed8;
            margin-left: 2rem;
        }

        .chat-message.system {
            background: #fef3c7;
            border-left-color: #f59e0b;
            font-style: italic;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-send {
            padding: 0.8rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            touch-action: manipulation;
        }

        .chat-image-upload {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            touch-action: manipulation;
            white-space: nowrap;
        }

        .chat-image-container {
            margin: 0.5rem 0;
            border-radius: 8px;
            overflow: hidden;
            max-width: 200px;
        }

        .chat-image {
            width: 100%;
            height: auto;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .chat-image:hover {
            transform: scale(1.05);
        }

        /* Chat Sub-Tabs */
        .chat-sub-tab {
            color: #6b7280;
            border-bottom: 3px solid transparent;
        }

        .chat-sub-tab.active {
            background: white !important;
            color: #dc2626;
            border-bottom: 3px solid #dc2626;
        }

        .chat-section {
            display: none;
        }

        .chat-section.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #059669;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.5s ease;
            max-width: 300px;
            cursor: pointer;
        }

        .notification.error {
            background: #dc2626;
        }

        .notification.warning {
            background: #f59e0b;
        }

        .notification.clickable {
            border: 2px solid rgba(255,255,255,0.3);
        }

        .notification.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* Admin-specific styles */
        .admin-content-editor {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .admin-station-editor {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 0;
            margin: 1rem 0;
            overflow: hidden;
        }

        .admin-station-header {
            background: #f9fafb;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.3s;
        }

        .admin-station-header:hover {
            background: #f3f4f6;
        }

        .admin-station-header.expanded {
            background: #fef3c7;
        }

        .admin-station-content {
            padding: 1rem;
            display: none;
        }

        .admin-station-content.expanded {
            display: block;
        }

        .admin-expand-icon {
            transition: transform 0.3s;
            font-size: 1.2rem;
        }

        .admin-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .admin-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin: 0.5rem 0;
        }

        .admin-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin: 0.5rem 0;
            resize: vertical;
        }

        .admin-lat-lng {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Admin Popup Styles */
        .admin-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            animation: fadeIn 0.5s ease;
        }

        .admin-popup {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            animation: popIn 0.5s ease;
        }

        .admin-popup h3 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .admin-popup p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .admin-popup-close {
            background: white;
            color: #f59e0b;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .admin-popup-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,255,255,0.3);
        }

        .hidden {
            display: none !important;
        }

        .file-input {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                box-shadow: none;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .tab {
                font-size: 0.7rem;
                padding: 0.8rem 0.2rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .station-card {
                padding: 1rem;
            }
            
            .image-gallery {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðï¸ KÃ¶lner Abendspaziergang</h1>
            <p class="subtitle">Entdecke 2000 Jahre Stadtgeschichte</p>
            <div class="tour-id-display">
                Tour: <span id="currentTourId">Wird geladen...</span>
                <span class="connection-status connecting" id="connectionStatus" title="Verbindung wird aufgebaut..."></span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </header>

        <div class="main-content">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div id="errorPanel" class="error-panel hidden">
                    <h4>â ï¸ Verbindungsproblem</h4>
                    <p id="errorMessage">Verbindung zu Firebase wird aufgebaut...</p>
                    <button class="btn btn-secondary btn-small" onclick="retryConnection()">ð Erneut versuchen</button>
                </div>

                <div class="score-display">
                    <div class="score-number" id="totalScore">0</div>
                    <div class="score-label">Foto-Punkte gesammelt</div>
                </div>

                <!-- 1. Name -->
                <div class="form-section">
                    <h3>ð¤ Dein Name:</h3>
                    <div class="input-group">
                        <input type="text" id="userNameInput" placeholder="Dein Name..." maxlength="20">
                        <button class="btn btn-secondary btn-small" onclick="changeUserName()">ð¾ Speichern</button>
                    </div>
                    <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">Aktuell: <span id="currentUserName">Tourist_xyz</span></p>
                </div>

                <!-- 2. Team -->
                <div class="team-selector" id="teamSelector">
                    <h3>ð¸ WÃ¤hle dein Team:</h3>
                    <div class="team-option" onclick="selectTeam('red', 'ð´ Team RÃ¶mer', this)">
                        <div class="team-color" style="background: #dc2626;"></div>
                        <span>ð´ Team RÃ¶mer</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('blue', 'ðµ Team Gaffeln', this)">
                        <div class="team-color" style="background: #2563eb;"></div>
                        <span>ðµ Team Gaffeln</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('green', 'ð¢ Team Hanseat', this)">
                        <div class="team-color" style="background: #059669;"></div>
                        <span>ð¢ Team Hanseat</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('yellow', 'ð¡ Team Modern', this)">
                        <div class="team-color" style="background: #d97706;"></div>
                        <span>ð¡ Team Modern</span>
                    </div>
                </div>

                <!-- 3. Start Button -->
                <button class="btn" onclick="startTour()">ð Tour starten</button>

                <!-- 4. Link teilen -->
                <div class="tour-connection-section">
                    <h3 style="margin-bottom: 1rem; color: #0369a1;">ð Mit anderen GerÃ¤ten verbinden</h3>
                    
                    <div class="qr-code-area">
                        <p><strong>Teile diese URL mit anderen Teilnehmern:</strong></p>
                        <div class="share-url" id="shareUrl">App wird gestartet...</div>
                        <button class="btn btn-secondary btn-small" onclick="copyShareUrl()">ð URL kopieren</button>
                        <button class="btn btn-secondary btn-small" onclick="shareViaWhatsApp()">ð± WhatsApp teilen</button>
                    </div>
                    
                    <p style="font-size: 0.9rem; color: #6b7280; text-align: center;">
                        ð¡ Alle die diesen Link Ã¶ffnen, kÃ¶nnen miteinander chatten und sehen Live-Rankings!
                    </p>
                </div>

                <!-- 5. Admin Passwort -->
                <div class="admin-section">
                    <h3 style="margin-bottom: 1rem; color: #92400e;">ð Admin-Zugang</h3>
                    <input type="password" class="admin-password-input" id="adminPassword" placeholder="Admin-Passwort eingeben">
                    <button class="btn btn-admin" onclick="loginAdmin()">Admin-Modus aktivieren</button>
                </div>

                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">ð Tour-Informationen</h3>
                    <p><strong>â° Dauer:</strong> ca. 3,5 Stunden</p>
                    <p><strong>ð Start:</strong> Heumarkt, 19:30 Uhr</p>
                    <p><strong>ð¯ Ziel:</strong> Alte Bastion</p>
                    <p><strong>ð¥ Teilnehmer:</strong> 15-25 Personen</p>
                    <p><strong>ð¸ Ziel:</strong> Sammle die besten Foto-Punkte!</p>
                </div>
            </div>

            <!-- Stations Tab -->
            <div id="stations" class="tab-content">
                <div id="stationsList">
                    <!-- Stations will be generated here -->
                </div>
            </div>

            <!-- Ranking Tab -->
            <div id="ranking" class="tab-content">
                <div class="team-ranking">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">ð Live-Ranking</h3>
                    <div id="rankingList">
                        <!-- Ranking will be generated here -->
                    </div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">ð¸ KI-Punktesystem</h3>
                    <ul style="margin-left: 1.5rem; color: #4b5563;">
                        <li><strong>Technische QualitÃ¤t:</strong> SchÃ¤rfe, Belichtung, Komposition (0-40 Punkte)</li>
                        <li><strong>KreativitÃ¤t:</strong> Perspective, OriginalitÃ¤t (0-30 Punkte)</li>
                        <li><strong>Stadtbezug:</strong> Erkannte SehenswÃ¼rdigkeiten (0-20 Punkte)</li>
                        <li><strong>Personen/Gruppenfoto:</strong> Bonus fÃ¼r Teamarbeit (+10 Punkte)</li>
                    </ul>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chat" class="tab-content">
                <!-- Chat Sub-Navigation -->
                <div style="display: flex; background: #f8fafc; border-radius: 8px; margin-bottom: 1rem; overflow: hidden;">
                    <button class="chat-sub-tab active" onclick="showChatTab('main', this)" style="flex: 1; padding: 0.8rem; border: none; background: transparent; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        ð¬ Haupt-Chat
                    </button>
                    <button class="chat-sub-tab" onclick="showChatTab('team', this)" id="teamChatTab" style="flex: 1; padding: 0.8rem; border: none; background: transparent; cursor: pointer; font-weight: bold; transition: all 0.3s; display: none;">
                        ð¥ Team-Chat
                    </button>
                </div>

                <!-- Main Chat -->
                <div id="mainChatContainer" class="chat-section active">
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message system">
                            <strong>System:</strong> Willkommen im Tour-Chat! ð<br>
                            <small>Chat funktioniert zwischen allen GerÃ¤ten mit derselben Tour-URL.</small>
                            <span class="timestamp">jetzt</span>
                        </div>
                    </div>
                    
                    <!-- Chat Moderation Notice -->
                    <div id="chatModerationNotice" class="hidden" style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: center;">
                        <h4 style="color: #92400e; margin-bottom: 0.5rem;">ð¡ï¸ Chat ist moderiert</h4>
                        <p style="color: #92400e; margin: 0;">Der Chat wurde vom Admin gesperrt. Nachrichten kÃ¶nnen aktuell nicht gesendet werden.</p>
                    </div>
                    
                    <div class="chat-input-container" id="mainChatInput">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht eingeben..." maxlength="200">
                        <button class="chat-image-upload" onclick="selectChatImage()">ð·</button>
                        <button class="chat-send" onclick="sendMessage()">Senden</button>
                    </div>
                </div>

                <!-- Team Chat -->
                <div id="teamChatContainer" class="chat-section" style="display: none;">
                    <div class="chat-container" id="teamChatMessages">
                        <div class="chat-message system">
                            <strong>Team-Chat:</strong> Hier kÃ¶nnt ihr euch als Team koordinieren! ð¥<br>
                            <small>Nur euer Team kann diese Nachrichten sehen.</small>
                            <span class="timestamp">jetzt</span>
                        </div>
                    </div>
                    
                    <div class="chat-input-container" id="teamChatInput">
                        <input type="text" class="chat-input" id="teamChatInputField" placeholder="Team-Nachricht eingeben..." maxlength="200">
                        <button class="chat-image-upload" onclick="selectTeamChatImage()">ð·</button>
                        <button class="chat-send" onclick="sendTeamMessage()">Senden</button>
                    </div>
                </div>

                <input type="file" class="file-input" id="chatImageInput" accept="image/*" onchange="handleChatImageUpload(event)">
                <input type="file" class="file-input" id="teamChatImageInput" accept="image/*" onchange="handleTeamChatImageUpload(event)">
                
                <div style="margin-top: 1rem; text-align: center; color: #6b7280; font-size: 0.9rem;">
                    ð¡ Nachrichten und Bilder werden live synchronisiert
                </div>
            </div>

            <!-- Map Tab -->
            <div id="map-tab" class="tab-content">
                <div class="location-info">
                    <div class="distance-info" id="distanceInfo">ð Standort wird ermittelt...</div>
                    <p>ð¡ Tipp: Erlaube Standortzugriff fÃ¼r Navigation</p>
                </div>
                <div id="map"></div>
                <button class="btn" onclick="centerOnUser()">ð Zu meinem Standort</button>
            </div>

            <!-- Admin Tab -->
            <div id="admin" class="tab-content">
                <div style="background: #fef3c7; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="color: #92400e; margin-bottom: 1rem;">âï¸ Admin-Panel</h3>
                    <p>VollstÃ¤ndiges Content-Management. Alle Ãnderungen werden sofort fÃ¼r alle Teilnehmer sichtbar.</p>
                </div>

                <!-- Content Management -->
                <div class="admin-content-editor">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">ð Stationen-Content bearbeiten</h4>
                    <div id="adminContentEditor">
                        <!-- Content editor will be generated here -->
                    </div>
                </div>

                <!-- Chat Moderation -->
                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">ð¬ Chat-Moderation</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-admin btn-small" onclick="toggleChatModeration()">
                            <span id="chatModerationText">ð¡ï¸ Moderations-Modus aktivieren</span>
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="clearAllChatMessages()">ðï¸ Alle Nachrichten lÃ¶schen</button>
                        <button class="btn btn-secondary btn-small" onclick="sendAdminAnnouncement()">ð¢ AnkÃ¼ndigung senden</button>
                    </div>
                </div>

                <!-- Live Statistics -->
                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">ð Live-Statistiken</h4>
                    <div id="adminStats">
                        <p>Aktive Teilnehmer: <span id="activeUsers">-</span></p>
                        <p>Gesendete Nachrichten: <span id="totalMessages">-</span></p>
                        <p>Abgeschlossene Stationen: <span id="completedStations">-</span></p>
                        <p>Hochgeladene Fotos: <span id="uploadedPhotos">-</span></p>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="refreshAdminStats()">ð Statistiken aktualisieren</button>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">ð Tour zurÃ¼cksetzen</h4>
                    <button class="btn btn-secondary" onclick="resetTour()">Alle Daten zurÃ¼cksetzen</button>
                </div>
            </div>
        </div>

        <!-- Fixed Navigation -->
        <div class="tab-container">
            <button class="tab active" onclick="showTab('overview', this)">ð <br><span style="font-size: 0.6rem;">Start</span></button>
            <button class="tab" onclick="showTab('stations', this)">ð<br><span style="font-size: 0.6rem;">Stationen</span></button>
            <button class="tab" onclick="showTab('ranking', this)">ð<br><span style="font-size: 0.6rem;">Ranking</span></button>
            <button class="tab" onclick="showTab('chat', this)">ð¬<br><span style="font-size: 0.6rem;">Chat</span></button>
            <button class="tab" onclick="showTab('map', this)">ðºï¸<br><span style="font-size: 0.6rem;">Karte</span></button>
            <button class="tab admin hidden" onclick="showTab('admin', this)" id="adminTab">âï¸<br><span style="font-size: 0.6rem;">Admin</span></button>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC1dTE4AiAKbInq-5f2dy92zWBIOmZ8o9Y",
            authDomain: "koeln-tour.firebaseapp.com",
            projectId: "koeln-tour",
            storageBucket: "koeln-tour.firebasestorage.app",
            messagingSenderId: "297105093618",
            appId: "1:297105093618:web:fa44f3fee94e79d304f16b",
            measurementId: "G-TZBGBEPCVW"
        };

        // Global variables
        let tourApp = {
            state: {
                currentStation: 0,
                completedStations: [],
                totalScore: 0,
                selectedTeam: null,
                teamName: '',
                userLocation: null,
                map: null,
                markers: [],
                uploadedPhotos: [],
                userName: 'Tourist_' + Math.random().toString(36).substr(2, 5),
                tourId: null,
                isAdmin: false,
                syncListeners: [],
                isFirebaseConnected: false,
                connectionRetries: 0,
                maxRetries: 3,
                chatModeration: false,
                chatBlocked: false, // NEW: Chat gesperrt durch Moderation
                unreadMessages: 0,
                unreadTeamMessages: 0, // NEW: Team-Chat ungelesen
                currentTab: 'overview',
                currentChatTab: 'main' // NEW: main oder team
            },
            
            stations: [
                {
                    id: 1,
                    title: "Heumarkt",
                    subtitle: "Wo alles anfing: 2000 Jahre Migration und Handel",
                    lat: 50.9356, lng: 6.9611,
                    description: "Start der Tour am historischen Heumarkt, einem der geschichtstrÃ¤chtigsten Orte KÃ¶lns.",
                    photoChallenge: "Mache ein Foto von dir oder deinem Team vor dem Reiterstandbild - zeigt dabei mit Handbewegungen, wie HÃ¤ndler frÃ¼her ihre Waren angepriesen haben kÃ¶nnten!",
                    mainText: `Die Stadt ist ca. 2.000 Jahre alt. CCAA - Colonia Claudia Ara Agrippinensium - wurde 50 n. Chr. von den RÃ¶mern gegrÃ¼ndet, mithilfe der germanischen Ubier. Das war Ã¼brigens eine der ersten erfolgreichen Integration zweier Kulturen in Europa. 

Hier auf dem Heumarkt stehen wir an einem der ehemaligen Einfallstore zur Stadt. Die Markmannsgasse runter, links von der heutigen Deutzer BrÃ¼cke, befand sich von 1822 bis 1915 die einzige SchiffsbrÃ¼cke Ã¼ber den Rhein - 42 schwimmende Boote, die Ã¼ber 30 Mal tÃ¤glich fÃ¼r Schiffe geÃ¶ffnet wurden.

Das "Stapelrecht" von 1259 bis 1804 war ein 545 Jahre gÃ¼ltiges Handelsprivileg. Alle Waren auf Schiffen, die an KÃ¶ln vorbeifahren wollten, mussten drei Tage hier angeboten werden.`,
                    images: [
                        { title: "Heumarkt heute", description: "Moderne Aufnahme des historischen Platzes", url: "" },
                        { title: "KÃ¶lner Architektur", description: "Typische Rheinische Bauweise", url: "" },
                        { title: "Rheinufer", description: "Blick auf den historischen Handelsweg", url: "" }
                    ],
                    audio: [
                        { title: "Heumarkt AtmosphÃ¤re", description: "Originalaufnahme vom historischen Platz", url: "", type: "audio" },
                        { title: "Geschichte Audio-Guide", description: "Gesprochene FÃ¼hrung zur Stadtgeschichte", url: "", type: "podcast" }
                    ]
                },
                {
                    id: 2,
                    title: "KÃ¶lner Dom",
                    subtitle: "Das ewige Bauprojekt und die Verkehrsrevolution",
                    lat: 50.9413, lng: 6.9583,
                    description: "KÃ¶lns Wahrzeichen und die lÃ¤ngste Baustelle der Welt.",
                    photoChallenge: "Bildet mit eurem Team eine 'menschliche Kathedrale' vor dem Dom - streckt die Arme hoch und formt gotische BÃ¶gen nach!",
                    mainText: `Der Dom wird seit fast 800 Jahren gebaut - etwas lÃ¤nger als der BER. Die Grundsteinlegung 1248 war KÃ¶lns Versuch, Paris und andere GroÃstÃ¤dte zu beeindrucken. KÃ¶ln war immer reich, aber auch provinziell.

1248-1330 wurden Grundmauern und der Chor fertiggestellt. Dann ging das Geld aus. Fast 300 Jahre stand nur ein riesiger Kran auf dem unvollendeten Turm - eines der ersten groÃen "paused projects" der Geschichte.

Erst die Romantik des 19. Jahrhunderts und preuÃisches Geld vollendeten den Dom 1880. Der Hauptbahnhof entstand 1894 als einer der modernsten Europas.`,
                    images: [
                        { title: "KÃ¶lner Dom", description: "Die berÃ¼hmten ZwillingstÃ¼rme", url: "" },
                        { title: "Dom Innenraum", description: "Gotische Architektur", url: "" },
                        { title: "Dom bei Nacht", description: "Beleuchtetes Wahrzeichen", url: "" }
                    ],
                    audio: [
                        { title: "Domglocken", description: "Originalaufnahme der berÃ¼hmten Domglocken", url: "", type: "youtube" },
                        { title: "Audio-Guide Dom", description: "Gesprochene FÃ¼hrung durch die Geschichte", url: "", type: "podcast" }
                    ]
                },
                {
                    id: 3,
                    title: "Altstadt",
                    subtitle: "Macht, Rebellion und eine groÃe Liebesgeschichte",
                    lat: 50.9369, lng: 6.9572,
                    description: "Das historische Rathaus und die berÃ¼hmte Jan-und-Griet-Geschichte.",
                    photoChallenge: "Fotografiert euch am historischen Rathaus und stellt eine romantische Szene nach: Eine Person kniet, eine steht stolz daneben.",
                    mainText: `Der Rathaus-Turm zeigt wichtige PersÃ¶nlichkeiten der KÃ¶lner Geschichte. 1945 zerstÃ¶rt und wieder aufgebaut. Da auch die Figuren zerstÃ¶rt waren, wÃ¤hlte eine Kommission neue aus - von Ã¼ber 100 Kandidaten. Alle mÃ¤nnlich.

Oben am Turm seht ihr den "Platz-Jabbeck" - er streckt AutoritÃ¤ten die Zunge raus. So viel Respekt hatten die KÃ¶lner fÃ¼r die Obrigkeit.

Die Altstadt erzÃ¤hlt eine der grÃ¶Ãten deutschen Liebesgeschichten: Jan ist ein armer Knecht, Griet arbeitet auch dort. Er mag sie, sie ihn nicht. Der Krieg beginnt, Jan zieht aus, kommt als berÃ¼hmter General zurÃ¼ck.`,
                    images: [
                        { title: "KÃ¶lner Altstadt", description: "Historische Gassen", url: "" },
                        { title: "Rheinpromenade", description: "Spazierweg mit Domblick", url: "" },
                        { title: "Historisches Rathaus", description: "Gotisches Bauwerk", url: "" }
                    ],
                    audio: [
                        { title: "Altstadt AtmosphÃ¤re", description: "StraÃengerÃ¤usche der historischen Altstadt", url: "", type: "soundcloud" },
                        { title: "Jan und Griet", description: "Die Liebesgeschichte als HÃ¶rspiel", url: "", type: "spotify" }
                    ]
                },
                {
                    id: 4,
                    title: "GroÃ St. Martin",
                    subtitle: "Romanische Kirche und Klostergeschichte",
                    lat: 50.9347, lng: 6.9597,
                    description: "Eine der zwÃ¶lf groÃen romanischen Kirchen KÃ¶lns.",
                    photoChallenge: "Macht ein Foto der imposanten KirchtÃ¼rme und zeigt dabei mittelalterliche Gebetshaltungen!",
                    mainText: `GroÃ St. Martin ist eine der beeindruckendsten romanischen Kirchen KÃ¶lns. Der markante Vierungsturm prÃ¤gt seit dem 12. Jahrhundert die Silhouette der Altstadt.

Die Kirche wurde auf rÃ¶mischen Fundamenten errichtet - archÃ¤ologische Ausgrabungen zeigen die KontinuitÃ¤t der Besiedlung Ã¼ber 2000 Jahre. Im Mittelalter war hier eines der mÃ¤chtigsten BenediktinerklÃ¶ster der Region.

Der Turm diente auch als Orientierungspunkt fÃ¼r Rheinschiffe und HÃ¤ndler - ein frÃ¼her "Leuchtturm" des Handels.`,
                    images: [
                        { title: "GroÃ St. Martin", description: "Romanischer Kirchenbau", url: "" },
                        { title: "Altstadt Panorama", description: "KirchtÃ¼rme der Altstadt", url: "" },
                        { title: "Rheinufer", description: "Blick auf die Kirchen", url: "" }
                    ],
                    audio: [
                        { title: "Kirchenglocken", description: "GlockengelÃ¤ut von GroÃ St. Martin", url: "", type: "audio" },
                        { title: "Gregorianischer Gesang", description: "Historische Klostermusik", url: "", type: "youtube" }
                    ]
                },
                {
                    id: 5,
                    title: "Fischmarkt",
                    subtitle: "Handel, Handwerk und BÃ¼rgerstolz",
                    lat: 50.9378, lng: 6.9589,
                    description: "Mittelpunkt des mittelalterlichen Handels.",
                    photoChallenge: "Zeigt mit euren HÃ¤nden, wie mittelalterliche HÃ¤ndler ihre Waren prÃ¤sentiert haben - seid kreativ mit Gesten!",
                    mainText: `Der Fischmarkt war im Mittelalter das kommerzielle Herz KÃ¶lns. Hier wurde nicht nur Fisch verkauft, sondern alle wichtigen HandelsgÃ¼ter der Region.

Die KÃ¶lner BÃ¼rger entwickelten hier ihre berÃ¼hmte UnabhÃ¤ngigkeit. 1074 erhielt KÃ¶ln bereits wichtige Stadtrechte - 500 Jahre bevor andere deutsche StÃ¤dte folgten.

Die Zunftordnungen vom Fischmarkt dienten als Vorbild fÃ¼r ganz Europa. Handwerksmeister aus KÃ¶ln grÃ¼ndeten in vielen anderen StÃ¤dten Ã¤hnliche Organisationen.`,
                    images: [
                        { title: "Alter Markt KÃ¶ln", description: "Historischer Marktplatz", url: "" },
                        { title: "KÃ¶lner HÃ¤user", description: "Typische Architektur", url: "" },
                        { title: "Rheinischer Markt", description: "Handelstradition", url: "" }
                    ],
                    audio: [
                        { title: "MarktgerÃ¤usche", description: "AtmosphÃ¤re des historischen Marktes", url: "", type: "soundcloud" },
                        { title: "HÃ¤ndlerrufe", description: "Nachstellung mittelalterlicher Marktrufe", url: "", type: "audio" }
                    ]
                }
            ]
        };

        // Firebase Initialization
        let db = null;

        async function initFirebase() {
            try {
                updateConnectionStatus('connecting');
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK not loaded');
                }
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                await db.enableNetwork();
                
                const testDoc = db.collection('tours').doc('test');
                await testDoc.set({ test: Date.now() }, { merge: true });
                
                tourApp.state.isFirebaseConnected = true;
                updateConnectionStatus('online');
                hideErrorPanel();
                
                console.log('â Firebase connected successfully');
                enableRealtimeSync();
                
            } catch (error) {
                console.error('â Firebase connection failed:', error);
                tourApp.state.isFirebaseConnected = false;
                updateConnectionStatus('offline');
                showErrorPanel('Firebase-Verbindung fehlgeschlagen. App funktioniert nur lokal.', error.message);
                
                if (tourApp.state.connectionRetries < tourApp.state.maxRetries) {
                    tourApp.state.connectionRetries++;
                    setTimeout(() => {
                        console.log(`ð Retrying Firebase connection (${tourApp.state.connectionRetries}/${tourApp.state.maxRetries})`);
                        initFirebase();
                    }, 3000);
                }
            }
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.className = `connection-status ${status}`;
                
                const titles = {
                    'connecting': 'Verbindung wird aufgebaut...',
                    'online': 'Online - Daten werden synchronisiert', 
                    'offline': 'Offline - Nur lokale Daten'
                };
                statusEl.title = titles[status] || status;
            }
        }

        function showErrorPanel(message, details = '') {
            const panel = document.getElementById('errorPanel');
            const messageEl = document.getElementById('errorMessage');
            
            if (panel && messageEl) {
                messageEl.innerHTML = `${message}${details ? `<br><small>Details: ${details}</small>` : ''}`;
                panel.classList.remove('hidden');
            }
        }

        function hideErrorPanel() {
            const panel = document.getElementById('errorPanel');
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        function retryConnection() {
            tourApp.state.connectionRetries = 0;
            initFirebase();
        }

        // Firebase Real-time Functions
        function enableRealtimeSync() {
            if (!tourApp.state.isFirebaseConnected || !tourApp.state.tourId) return;

            try {
                // Listen to chat messages
                const chatRef = db.collection('tours').doc(tourApp.state.tourId).collection('chat');
                const chatUnsubscribe = chatRef.orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (messageData.userName !== tourApp.state.userName) {
                            // Handle special challenge photo messages
                            if (messageData.type === 'challenge-photo') {
                                addChallengePhotoMessage(messageData, false);
                            } else {
                                addChatMessage(messageData, false);
                            }
                        }
                        } else if (change.type === 'removed') {
                            // Handle chat clearing - reload chat completely
                            const chatContainer = document.getElementById('chatContainer');
                            if (chatContainer) {
                                chatContainer.innerHTML = `
                                    <div class="chat-message system">
                                        <strong>Admin:</strong> Chat wurde geleert! ðï¸<br>
                                        <small>Alle Nachrichten wurden entfernt</small>
                                        <span class="timestamp">jetzt</span>
                                    </div>
                                `;
                            }
                        }
                    });
                }, (error) => {
                    console.error('Chat sync error:', error);
                });

                // Listen to team chat messages (only if user has selected a team)
                let teamChatUnsubscribe = null;
                if (tourApp.state.selectedTeam) {
                    const teamChatRef = db.collection('tours').doc(tourApp.state.tourId).collection('teamChat').doc(tourApp.state.selectedTeam).collection('messages');
                    teamChatUnsubscribe = teamChatRef.orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                const messageData = change.doc.data();
                                if (messageData.userName !== tourApp.state.userName) {
                                    addTeamChatMessage(messageData, false);
                                }
                            } else if (change.type === 'removed') {
                                // Handle team chat clearing
                                const teamChatContainer = document.getElementById('teamChatMessages');
                                if (teamChatContainer) {
                                    teamChatContainer.innerHTML = `
                                        <div class="chat-message system">
                                            <strong>Admin:</strong> Team-Chat wurde geleert! ðï¸<br>
                                            <small>Alle Team-Nachrichten wurden entfernt</small>
                                            <span class="timestamp">jetzt</span>
                                        </div>
                                    `;
                                }
                            }
                        });
                    }, (error) => {
                        console.error('Team chat sync error:', error);
                    });
                }

                // Listen to moderation status - FIXED REAL-TIME SYNC
                const moderationRef = db.collection('tours').doc(tourApp.state.tourId).collection('settings').doc('moderation');
                const moderationUnsubscribe = moderationRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const moderationData = doc.data();
                        const newBlockedStatus = moderationData.chatBlocked || false;
                        
                        // Only update if status actually changed
                        if (tourApp.state.chatBlocked !== newBlockedStatus) {
                            tourApp.state.chatBlocked = newBlockedStatus;
                            tourApp.state.chatModeration = newBlockedStatus;
                            
                            // Update UI immediately for all users
                            updateChatModeration();
                            
                            // Show notification to non-admin users
                            if (!tourApp.state.isAdmin) {
                                if (newBlockedStatus) {
                                    showNotification('Chat wurde vom Admin gesperrt! ð', 'warning');
                                    addSystemMessage('Chat wurde vom Admin gesperrt ð');
                                } else {
                                    showNotification('Chat wurde vom Admin freigegeben! ð');
                                    addSystemMessage('Chat wurde vom Admin freigegeben ð');
                                }
                            }
                            
                            // Update admin button text if user is admin
                            if (tourApp.state.isAdmin) {
                                const textEl = document.getElementById('chatModerationText');
                                if (textEl) {
                                    textEl.textContent = newBlockedStatus ? 
                                        'ð Chat freigeben' : 
                                        'ð¡ï¸ Chat sperren';
                                }
                            }
                        }
                    }
                }, (error) => {
                    console.error('Moderation sync error:', error);
                });

                // Listen to scores
                const scoresRef = db.collection('tours').doc(tourApp.state.tourId).collection('scores');
                const scoresUnsubscribe = scoresRef.onSnapshot(() => {
                    updateRanking();
                }, (error) => {
                    console.error('Scores sync error:', error);
                });

                // Listen to station updates
                const stationsRef = db.collection('tours').doc(tourApp.state.tourId).collection('stations');
                const stationsUnsubscribe = stationsRef.onSnapshot((snapshot) => {
                    let hasChanges = false;
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const stationData = change.doc.data();
                            const stationIndex = tourApp.stations.findIndex(s => s.id === stationData.id);
                            
                            if (stationIndex >= 0) {
                                tourApp.stations[stationIndex] = stationData;
                                hasChanges = true;
                            } else {
                                tourApp.stations.push(stationData);
                                tourApp.stations.sort((a, b) => a.id - b.id);
                                hasChanges = true;
                            }
                        } else if (change.type === 'removed') {
                            const stationData = change.doc.data();
                            const stationIndex = tourApp.stations.findIndex(s => s.id === stationData.id);
                            if (stationIndex >= 0) {
                                tourApp.stations.splice(stationIndex, 1);
                                hasChanges = true;
                            }
                        }
                    });
                    
                    if (hasChanges && !tourApp.state.isAdmin) {
                        generateStationsList();
                        updateProgress();
                        if (tourApp.state.map) {
                            updateMapMarkers();
                        }
                        showNotification('ð Stationen wurden aktualisiert!');
                    }
                }, (error) => {
                    console.error('Stations sync error:', error);
                });

                // Listen to announcements
                const announcementsRef = db.collection('tours').doc(tourApp.state.tourId).collection('announcements');
                const announcementsUnsubscribe = announcementsRef.onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const announcementData = change.doc.data();
                            if (announcementData.isActive) {
                                showAdminPopup('ð¢ Admin-AnkÃ¼ndigung', announcementData.message);
                            }
                        }
                    });
                }, (error) => {
                    console.error('Announcements sync error:', error);
                });

                // Listen to events (like chat clearing) - NEW!
                const eventsRef = db.collection('tours').doc(tourApp.state.tourId).collection('events');
                const eventsUnsubscribe = eventsRef.onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const eventData = change.doc.data();
                            if (eventData.type === 'chat_cleared' && eventData.by !== tourApp.state.userName) {
                                // Another admin cleared the chat - update local UI immediately
                                const chatContainer = document.getElementById('chatContainer');
                                if (chatContainer) {
                                    const allMessages = chatContainer.querySelectorAll('.chat-message');
                                    allMessages.forEach(msg => {
                                        if (!msg.classList.contains('system') || msg.textContent.includes('geleert')) {
                                            msg.remove();
                                        }
                                    });
                                    
                                    const confirmationMsg = document.createElement('div');
                                    confirmationMsg.className = 'chat-message system';
                                    confirmationMsg.innerHTML = `
                                        <strong>Admin:</strong> Chat wurde von ${eventData.by} geleert! ðï¸<br>
                                        <small>Alle Nachrichten wurden entfernt</small>
                                        <span class="timestamp">jetzt</span>
                                    `;
                                    chatContainer.appendChild(confirmationMsg);
                                }

                                const teamChatContainer = document.getElementById('teamChatMessages');
                                if (teamChatContainer) {
                                    const allTeamMessages = teamChatContainer.querySelectorAll('.chat-message');
                                    allTeamMessages.forEach(msg => {
                                        if (!msg.classList.contains('system') || msg.textContent.includes('geleert')) {
                                            msg.remove();
                                        }
                                    });
                                    
                                    const teamConfirmationMsg = document.createElement('div');
                                    teamConfirmationMsg.className = 'chat-message system';
                                    teamConfirmationMsg.innerHTML = `
                                        <strong>Admin:</strong> Team-Chat wurde geleert! ðï¸<br>
                                        <small>Alle Team-Nachrichten wurden entfernt</small>
                                        <span class="timestamp">jetzt</span>
                                    `;
                                    teamChatContainer.appendChild(teamConfirmationMsg);
                                }

                                showNotification('Chat wurde von Admin geleert! ðï¸', 'warning');
                            }
                        }
                    });
                }, (error) => {
                    console.error('Events sync error:', error);
                });

                const syncListeners = [chatUnsubscribe, scoresUnsubscribe, stationsUnsubscribe, announcementsUnsubscribe, moderationUnsubscribe, eventsUnsubscribe];
                if (teamChatUnsubscribe) {
                    syncListeners.push(teamChatUnsubscribe);
                }
                tourApp.state.syncListeners = syncListeners;
            } catch (error) {
                console.error('Error setting up real-time sync:', error);
            }
        }

        // Firebase Data Functions
        async function saveToFirebase(collection, docId, data) {
            if (!tourApp.state.isFirebaseConnected || !tourApp.state.tourId) return false;

            try {
                await db.collection('tours').doc(tourApp.state.tourId)
                    .collection(collection).doc(docId).set(data, { merge: true });
                return true;
            } catch (error) {
                console.error('Firebase save error:', error);
                showNotification('Speichern fehlgeschlagen - nur lokal gespeichert', 'warning');
                return false;
            }
        }

        async function getFromFirebase(collection) {
            if (!tourApp.state.isFirebaseConnected || !tourApp.state.tourId) return [];

            try {
                const snapshot = await db.collection('tours').doc(tourApp.state.tourId)
                    .collection(collection).get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Firebase get error:', error);
                return [];
            }
        }

        // App Initialization
        function initApp() {
            console.log('ð Starting Tour App...');
            
            try {
                loadTourId();
                initFirebase();
                loadState();
                
                setTimeout(async () => {
                    await loadStationsFromFirebase();
                    generateStationsList();
                    updateUI();
                }, 1500);
                
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            sendMessage();
                        }
                    });
                }
                
                const userNameDisplay = document.getElementById('currentUserName');
                if (userNameDisplay) {
                    userNameDisplay.textContent = tourApp.state.userName;
                }
                
                console.log('â Tour App initialized successfully');
                
                setTimeout(() => {
                    initGeolocation();
                    loadChatHistory();
                }, 1000);
                
            } catch (error) {
                console.error('â Error initializing app:', error);
                showNotification('App-Start mit Fehlern. Basis-Funktionen verfÃ¼gbar.', 'error');
                
                if (!tourApp.state.tourId) {
                    tourApp.state.tourId = 'koeln-emergency-' + Date.now();
                    updateTourDisplay();
                    generateShareUrl();
                }
            }
        }

        async function loadStationsFromFirebase() {
            if (!tourApp.state.isFirebaseConnected || !tourApp.state.tourId) return;
            
            try {
                const firebaseStations = await getFromFirebase('stations');
                if (firebaseStations && firebaseStations.length > 0) {
                    tourApp.stations = firebaseStations.sort((a, b) => a.id - b.id);
                    console.log('â Loaded stations from Firebase:', firebaseStations.length);
                    showNotification('ð Stationen von Server geladen!');
                } else {
                    for (const station of tourApp.stations) {
                        await saveToFirebase('stations', station.id.toString(), station);
                    }
                    console.log('ð¤ Initialized Firebase with default stations');
                }
            } catch (error) {
                console.error('Error loading stations from Firebase:', error);
            }
        }

        function loadTourId() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const urlTourId = urlParams.get('tour');
                
                if (urlTourId && urlTourId.trim().length > 0) {
                    const cleanTourId = urlTourId.trim();
                    const savedTourId = localStorage.getItem('tourId');
                    
                    if (savedTourId !== cleanTourId) {
                        if (savedTourId) {
                            localStorage.removeItem(`chat_${savedTourId}`);
                            localStorage.removeItem(`tourState`);
                        }
                        
                        tourApp.state.tourId = cleanTourId;
                        localStorage.setItem('tourId', cleanTourId);
                        
                        tourApp.state.completedStations = [];
                        tourApp.state.totalScore = 0;
                        tourApp.state.uploadedPhotos = [];
                        tourApp.state.selectedTeam = null;
                        tourApp.state.teamName = '';
                        
                        setTimeout(() => addSystemMessage(`Der Tour "${cleanTourId}" beigetreten! ð`), 2000);
                    } else {
                        tourApp.state.tourId = cleanTourId;
                    }
                } else {
                    const savedTourId = localStorage.getItem('tourId');
                    if (savedTourId) {
                        tourApp.state.tourId = savedTourId;
                    } else {
                        tourApp.state.tourId = generateTourId();
                        localStorage.setItem('tourId', tourApp.state.tourId);
                    }
                }
                
                updateTourDisplay();
                generateShareUrl();
                
            } catch (error) {
                console.error('â Error loading tour ID:', error);
                tourApp.state.tourId = 'koeln-tour-fallback';
                updateTourDisplay();
                generateShareUrl();
            }
        }

        function generateTourId() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const random = Math.random().toString(36).substr(2, 5);
                return `koeln-${today}-${random}`;
            } catch (error) {
                return 'koeln-tour-' + Math.random().toString(36).substr(2, 8);
            }
        }

        function updateTourDisplay() {
            try {
                const el = document.getElementById('currentTourId');
                if (el && tourApp.state.tourId) {
                    el.textContent = tourApp.state.tourId;
                }
            } catch (error) {
                console.error('Error updating tour display:', error);
            }
        }

        function generateShareUrl() {
            try {
                if (!tourApp.state.tourId) return;
                
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?tour=${tourApp.state.tourId}`;
                const el = document.getElementById('shareUrl');
                if (el) {
                    el.textContent = shareUrl;
                }
            } catch (error) {
                console.error('Error generating share URL:', error);
                const el = document.getElementById('shareUrl');
                if (el) {
                    el.textContent = 'Fehler beim Generieren der URL';
                }
            }
        }

        // Chat Functions - ENHANCED with Team Chat and Moderation
        window.sendMessage = async function() {
            try {
                // Check if chat is blocked by moderation
                if (tourApp.state.chatBlocked && !tourApp.state.isAdmin) {
                    showNotification('Chat ist vom Admin gesperrt! ð¡ï¸', 'warning');
                    return;
                }

                const input = document.getElementById('chatInput');
                if (!input) return;
                
                const message = input.value.trim();
                if (message) {
                    const messageData = {
                        userName: tourApp.state.userName,
                        message: message,
                        timestamp: firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : Date.now(),
                        tourId: tourApp.state.tourId,
                        type: 'text'
                    };
                    
                    addChatMessage(messageData, true);
                    
                    if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                        await saveToFirebase('chat', Date.now().toString(), messageData);
                    } else {
                        const chatKey = `chat_${tourApp.state.tourId}`;
                        const chatMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
                        chatMessages.push(messageData);
                        if (chatMessages.length > 50) {
                            chatMessages.splice(0, chatMessages.length - 50);
                        }
                        localStorage.setItem(chatKey, JSON.stringify(chatMessages));
                    }
                    
                    input.value = '';
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Fehler beim Senden der Nachricht', 'error');
            }
        }

        async function sendTeamMessage() {
            try {
                if (!tourApp.state.selectedTeam) {
                    showNotification('Du musst erst einem Team beitreten!', 'error');
                    return;
                }

                const input = document.getElementById('teamChatInputField');
                if (!input) return;
                
                const message = input.value.trim();
                if (message) {
                    const messageData = {
                        userName: tourApp.state.userName,
                        message: message,
                        timestamp: firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : Date.now(),
                        tourId: tourApp.state.tourId,
                        teamId: tourApp.state.selectedTeam,
                        type: 'text'
                    };
                    
                    addTeamChatMessage(messageData, true);
                    
                    if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                        await db.collection('tours').doc(tourApp.state.tourId)
                            .collection('teamChat').doc(tourApp.state.selectedTeam)
                            .collection('messages').doc(Date.now().toString())
                            .set(messageData);
                    } else {
                        const teamChatKey = `teamChat_${tourApp.state.tourId}_${tourApp.state.selectedTeam}`;
                        const teamChatMessages = JSON.parse(localStorage.getItem(teamChatKey) || '[]');
                        teamChatMessages.push(messageData);
                        if (teamChatMessages.length > 50) {
                            teamChatMessages.splice(0, teamChatMessages.length - 50);
                        }
                        localStorage.setItem(teamChatKey, JSON.stringify(teamChatMessages));
                    }
                    
                    input.value = '';
                }
            } catch (error) {
                console.error('Error sending team message:', error);
                showNotification('Fehler beim Senden der Team-Nachricht', 'error');
            }
        }

        function selectChatImage() {
            const input = document.getElementById('chatImageInput');
            if (input) {
                input.click();
            }
        }

        function selectTeamChatImage() {
            const input = document.getElementById('teamChatImageInput');
            if (input) {
                input.click();
            }
        }

        async function handleChatImageUpload(event) {
            try {
                // Check if chat is blocked by moderation
                if (tourApp.state.chatBlocked && !tourApp.state.isAdmin) {
                    showNotification('Chat ist vom Admin gesperrt! ð¡ï¸', 'warning');
                    return;
                }

                const file = event.target.files[0];
                if (!file) return;
                
                const compressedImage = await compressImage(file, 0.6, 600, 400);
                
                const messageData = {
                    userName: tourApp.state.userName,
                    image: compressedImage,
                    timestamp: firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : Date.now(),
                    tourId: tourApp.state.tourId,
                    type: 'image'
                };
                
                addChatMessage(messageData, true);
                
                if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                    await saveToFirebase('chat', Date.now().toString(), messageData);
                } else {
                    const chatKey = `chat_${tourApp.state.tourId}`;
                    const chatMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
                    chatMessages.push(messageData);
                    if (chatMessages.length > 50) {
                        chatMessages.splice(0, chatMessages.length - 50);
                    }
                    localStorage.setItem(chatKey, JSON.stringify(chatMessages));
                }
                
                event.target.value = '';
            } catch (error) {
                console.error('Error uploading chat image:', error);
                showNotification('Fehler beim Hochladen des Bildes', 'error');
            }
        }

        async function handleTeamChatImageUpload(event) {
            try {
                if (!tourApp.state.selectedTeam) {
                    showNotification('Du musst erst einem Team beitreten!', 'error');
                    return;
                }

                const file = event.target.files[0];
                if (!file) return;
                
                const compressedImage = await compressImage(file, 0.6, 600, 400);
                
                const messageData = {
                    userName: tourApp.state.userName,
                    image: compressedImage,
                    timestamp: firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : Date.now(),
                    tourId: tourApp.state.tourId,
                    teamId: tourApp.state.selectedTeam,
                    type: 'image'
                };
                
                addTeamChatMessage(messageData, true);
                
                if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                    await db.collection('tours').doc(tourApp.state.tourId)
                        .collection('teamChat').doc(tourApp.state.selectedTeam)
                        .collection('messages').doc(Date.now().toString())
                        .set(messageData);
                } else {
                    const teamChatKey = `teamChat_${tourApp.state.tourId}_${tourApp.state.selectedTeam}`;
                    const teamChatMessages = JSON.parse(localStorage.getItem(teamChatKey) || '[]');
                    teamChatMessages.push(messageData);
                    if (teamChatMessages.length > 50) {
                        teamChatMessages.splice(0, teamChatMessages.length - 50);
                    }
                    localStorage.setItem(teamChatKey, JSON.stringify(teamChatMessages));
                }
                
                event.target.value = '';
            } catch (error) {
                console.error('Error uploading team chat image:', error);
                showNotification('Fehler beim Hochladen des Team-Bildes', 'error');
            }
        }

        function compressImage(file, quality = 0.7, maxWidth = 800, maxHeight = 600) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(
                        (blob) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        },
                        'image/jpeg',
                        quality
                    );
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        function addChatMessage(messageData, isOwn = false) {
            try {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;
                
                const timeStr = new Date().toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let messageContent = '';
                
                if (messageData.type === 'image') {
                    messageContent = `
                        <strong>${messageData.userName}:</strong> hat ein Bild geteilt<br>
                        <div class="chat-image-container">
                            <img src="${messageData.image}" class="chat-image" onclick="event.stopPropagation(); showImageModal('${messageData.image}', 'Chat Bild', 'Von ${messageData.userName} geteilt')" alt="Chat Bild">
                        </div>
                        <span class="timestamp">${timeStr}</span>
                    `;
                } else {
                    messageContent = `
                        <strong>${messageData.userName}:</strong> ${messageData.message}
                        <span class="timestamp">${timeStr}</span>
                    `;
                }

                messageDiv.innerHTML = messageContent;
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                if (!isOwn && tourApp.state.currentTab !== 'chat') {
                    tourApp.state.unreadMessages++;
                    updateChatNotification();
                    
                    const notificationText = messageData.type === 'image' 
                        ? `ð· ${messageData.userName} hat ein Bild geteilt`
                        : `ð¬ ${messageData.userName}: ${messageData.message.substring(0, 30)}${messageData.message.length > 30 ? '...' : ''}`;
                        
                    showClickableNotification(notificationText, 'chat');
                } else if (!isOwn && tourApp.state.currentTab === 'chat' && tourApp.state.currentChatTab !== 'main') {
                    // User is in chat but not on main tab
                    tourApp.state.unreadMessages++;
                    updateChatNotification();
                }
            } catch (error) {
                console.error('Error adding chat message:', error);
            }
        }

        function addTeamChatMessage(messageData, isOwn = false) {
            try {
                const teamChatContainer = document.getElementById('teamChatMessages');
                if (!teamChatContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;
                
                const timeStr = new Date().toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let messageContent = '';
                
                if (messageData.type === 'image') {
                    messageContent = `
                        <strong>${messageData.userName}:</strong> hat ein Team-Bild geteilt<br>
                        <div class="chat-image-container">
                            <img src="${messageData.image}" class="chat-image" onclick="event.stopPropagation(); showImageModal('${messageData.image}', 'Team Chat Bild', 'Von ${messageData.userName} geteilt')" alt="Team Chat Bild">
                        </div>
                        <span class="timestamp">${timeStr}</span>
                    `;
                } else {
                    messageContent = `
                        <strong>${messageData.userName}:</strong> ${messageData.message}
                        <span class="timestamp">${timeStr}</span>
                    `;
                }

                messageDiv.innerHTML = messageContent;
                
                teamChatContainer.appendChild(messageDiv);
                teamChatContainer.scrollTop = teamChatContainer.scrollHeight;
                
                if (!isOwn && (tourApp.state.currentTab !== 'chat' || tourApp.state.currentChatTab !== 'team')) {
                    tourApp.state.unreadTeamMessages++;
                    updateTeamChatNotification();
                    
                    const notificationText = messageData.type === 'image' 
                        ? `ð· ${messageData.userName} hat ein Team-Bild geteilt`
                        : `ð¥ ${messageData.userName}: ${messageData.message.substring(0, 30)}${messageData.message.length > 30 ? '...' : ''}`;
                        
                    showClickableNotification(notificationText, 'team');
                }
            } catch (error) {
                console.error('Error adding team chat message:', error);
            }
        }

        function showChatTab(tabType, tabElement) {
            try {
                tourApp.state.currentChatTab = tabType;
                
                // Update tab appearance
                document.querySelectorAll('.chat-sub-tab').forEach(tab => tab.classList.remove('active'));
                if (tabElement) {
                    tabElement.classList.add('active');
                }

                // Show/hide chat sections
                document.querySelectorAll('.chat-section').forEach(section => section.classList.remove('active'));
                
                if (tabType === 'main') {
                    document.getElementById('mainChatContainer').classList.add('active');
                    clearChatNotification();
                } else if (tabType === 'team') {
                    document.getElementById('teamChatContainer').classList.add('active');
                    clearTeamChatNotification();
                }
            } catch (error) {
                console.error('Error showing chat tab:', error);
            }
        }

        function updateChatNotification() {
            const chatTab = document.querySelector('.tab[onclick*="chat"]');
            if (chatTab && tourApp.state.unreadMessages > 0) {
                let notification = chatTab.querySelector('.tab-notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.className = 'tab-notification';
                    chatTab.appendChild(notification);
                }
                notification.textContent = tourApp.state.unreadMessages > 9 ? '9+' : tourApp.state.unreadMessages;
            }
        }

        function updateTeamChatNotification() {
            const teamChatTab = document.getElementById('teamChatTab');
            if (teamChatTab && tourApp.state.unreadTeamMessages > 0) {
                let notification = teamChatTab.querySelector('.tab-notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.className = 'tab-notification';
                    notification.style.position = 'absolute';
                    notification.style.top = '5px';
                    notification.style.right = '8px';
                    teamChatTab.style.position = 'relative';
                    teamChatTab.appendChild(notification);
                }
                notification.textContent = tourApp.state.unreadTeamMessages > 9 ? '9+' : tourApp.state.unreadTeamMessages;
            }
        }

        function clearChatNotification() {
            tourApp.state.unreadMessages = 0;
            const chatTab = document.querySelector('.tab[onclick*="chat"]');
            if (chatTab) {
                const notification = chatTab.querySelector('.tab-notification');
                if (notification) {
                    notification.remove();
                }
            }
        }

        function clearTeamChatNotification() {
            tourApp.state.unreadTeamMessages = 0;
            const teamChatTab = document.getElementById('teamChatTab');
            if (teamChatTab) {
                const notification = teamChatTab.querySelector('.tab-notification');
                if (notification) {
                    notification.remove();
                }
            }
        }

        function showClickableNotification(message, targetTab = 'chat') {
            try {
                const notification = document.createElement('div');
                notification.className = 'notification clickable';
                notification.innerHTML = `
                    ${message}<br>
                    <small>ð Klicken um zum Chat zu gelangen</small>
                `;
                
                notification.onclick = () => {
                    showTab('chat', document.querySelector('.tab[onclick*="chat"]'));
                    if (targetTab === 'team') {
                        setTimeout(() => showChatTab('team', document.getElementById('teamChatTab')), 100);
                    }
                    notification.remove();
                };
                
                document.body.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('Error showing clickable notification:', error);
            }
        }

        function updateChatModeration() {
            try {
                const moderationNotice = document.getElementById('chatModerationNotice');
                const mainChatInput = document.getElementById('mainChatInput');
                const teamChatInput = document.getElementById('teamChatInput');
                
                if (tourApp.state.chatBlocked && !tourApp.state.isAdmin) {
                    // Show moderation notice and disable inputs
                    if (moderationNotice) {
                        moderationNotice.classList.remove('hidden');
                    }
                    if (mainChatInput) {
                        mainChatInput.style.opacity = '0.5';
                        mainChatInput.style.pointerEvents = 'none';
                    }
                    if (teamChatInput) {
                        teamChatInput.style.opacity = '0.5';
                        teamChatInput.style.pointerEvents = 'none';
                    }
                } else {
                    // Hide notice and enable inputs
                    if (moderationNotice) {
                        moderationNotice.classList.add('hidden');
                    }
                    if (mainChatInput) {
                        mainChatInput.style.opacity = '1';
                        mainChatInput.style.pointerEvents = 'all';
                    }
                    if (teamChatInput) {
                        teamChatInput.style.opacity = '1';
                        teamChatInput.style.pointerEvents = 'all';
                    }
                }
            } catch (error) {
                console.error('Error updating chat moderation:', error);
            }
        }

        function addSystemMessage(message) {
            try {
                setTimeout(() => {
                    const messageData = {
                        userName: 'System',
                        message: message,
                        type: 'text'
                    };
                    addChatMessage(messageData, false);
                }, 100);
            } catch (error) {
                console.error('Error adding system message:', error);
            }
        }

        async function loadChatHistory() {
            try {
                // Load main chat
                if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                    const messages = await getFromFirebase('chat');
                    messages.forEach(msg => {
                        if (msg.userName !== tourApp.state.userName) {
                            // Handle special challenge photo messages
                            if (msg.type === 'challenge-photo') {
                                addChallengePhotoMessage(msg, false);
                            } else {
                                addChatMessage(msg, false);
                            }
                        }
                    });
                } else {
                    const chatKey = `chat_${tourApp.state.tourId}`;
                    const chatMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
                    chatMessages.forEach(msg => {
                        if (msg.type === 'challenge-photo') {
                            addChallengePhotoMessage(msg, msg.userName === tourApp.state.userName);
                        } else {
                            addChatMessage(msg, msg.userName === tourApp.state.userName);
                        }
                    });
                }

                // Load team chat if user has selected a team
                if (tourApp.state.selectedTeam) {
                    if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                        try {
                            const teamSnapshot = await db.collection('tours').doc(tourApp.state.tourId)
                                .collection('teamChat').doc(tourApp.state.selectedTeam)
                                .collection('messages').orderBy('timestamp', 'asc').get();
                            
                            teamSnapshot.docs.forEach(doc => {
                                const msg = doc.data();
                                if (msg.userName !== tourApp.state.userName) {
                                    addTeamChatMessage(msg, false);
                                }
                            });
                        } catch (error) {
                            console.log('No team chat history found');
                        }
                    } else {
                        const teamChatKey = `teamChat_${tourApp.state.tourId}_${tourApp.state.selectedTeam}`;
                        const teamChatMessages = JSON.parse(localStorage.getItem(teamChatKey) || '[]');
                        teamChatMessages.forEach(msg => {
                            addTeamChatMessage(msg, msg.userName === tourApp.state.userName);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        // Ranking Functions
        async function updateRanking() {
            try {
                const rankingList = document.getElementById('rankingList');
                if (!rankingList) return;
                
                let teams = [];
                
                if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                    teams = await getFromFirebase('scores');
                    
                    if (tourApp.state.selectedTeam && tourApp.state.teamName && 
                        !teams.find(t => t.teamId === tourApp.state.selectedTeam)) {
                        teams.push({
                            teamId: tourApp.state.selectedTeam,
                            teamName: tourApp.state.teamName,
                            score: tourApp.state.totalScore,
                            isUser: true
                        });
                    }
                } else {
                    const teamNames = {
                        'red': 'ð´ Team RÃ¶mer',
                        'blue': 'ðµ Team Gaffeln', 
                        'green': 'ð¢ Team Hanseat',
                        'yellow': 'ð¡ Team Modern'
                    };
                    
                    Object.keys(teamNames).forEach(teamId => {
                        teams.push({
                            teamId: teamId,
                            teamName: teamNames[teamId],
                            score: tourApp.state.selectedTeam === teamId ? 
                                   tourApp.state.totalScore : 
                                   Math.floor(Math.random() * 200) + 50,
                            isUser: tourApp.state.selectedTeam === teamId
                        });
                    });
                }
                
                teams.sort((a, b) => b.score - a.score);
                
                rankingList.innerHTML = '';
                
                teams.forEach((team, index) => {
                    const rankItem = document.createElement('div');
                    const isUserTeam = team.isUser || (team.teamId === tourApp.state.selectedTeam);
                    rankItem.className = `team-rank-item ${isUserTeam ? 'highlight' : ''}`;
                    
                    let rankClass = '';
                    if (index === 0) rankClass = 'gold';
                    else if (index === 1) rankClass = 'silver';
                    else if (index === 2) rankClass = 'bronze';
                    
                    rankItem.innerHTML = `
                        <div class="rank-position ${rankClass}">${index + 1}</div>
                        <div style="flex: 1;">
                            <strong>${team.teamName}</strong>
                            <div style="color: #6b7280; font-size: 0.9rem;">
                                ${team.score} Punkte
                            </div>
                        </div>
                        ${isUserTeam ? '<div style="color: #f59e0b;">ð¤</div>' : ''}
                    `;
                    
                    rankingList.appendChild(rankItem);
                });
            } catch (error) {
                console.error('Error updating ranking:', error);
            }
        }

        // Admin Functions - ENHANCED
        function generateContentEditor() {
            try {
                const container = document.getElementById('adminContentEditor');
                if (!container) return;
                
                container.innerHTML = '';
                
                tourApp.stations.forEach(station => {
                    const stationEditor = document.createElement('div');
                    stationEditor.className = 'admin-station-editor';
                    stationEditor.id = `admin-station-${station.id}`;
                    
                    stationEditor.innerHTML = `
                        <div class="admin-station-header" onclick="toggleStationEditor(${station.id})">
                            <div>
                                <h5 style="color: #1f2937; margin: 0;">Station ${station.id}: ${station.title}</h5>
                                <small style="color: #6b7280;">Klicken zum Bearbeiten</small>
                            </div>
                            <div class="admin-expand-icon" id="expand-icon-${station.id}">â¶</div>
                        </div>
                        
                        <div class="admin-station-content" id="station-content-${station.id}">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Titel:</label>
                                <input type="text" class="admin-input" id="edit-title-${station.id}" value="${station.title}">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Untertitel:</label>
                                <input type="text" class="admin-input" id="edit-subtitle-${station.id}" value="${station.subtitle}">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Haupttext:</label>
                                <textarea class="admin-textarea" id="edit-maintext-${station.id}">${station.mainText}</textarea>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Foto-Challenge:</label>
                                <textarea class="admin-textarea" id="edit-challenge-${station.id}" style="min-height: 80px;">${station.photoChallenge}</textarea>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Koordinaten:</label>
                                <div class="admin-lat-lng">
                                    <input type="number" class="admin-input" id="edit-lat-${station.id}" value="${station.lat}" step="0.000001" placeholder="Breitengrad">
                                    <input type="number" class="admin-input" id="edit-lng-${station.id}" value="${station.lng}" step="0.000001" placeholder="LÃ¤ngengrad">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Bildergalerie bearbeiten:</label>
                                <div id="image-editor-${station.id}" style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: #f9fafb;">
                                    ${generateImageEditor(station)}
                                </div>
                                <button class="btn btn-secondary btn-small" onclick="addNewImage(${station.id})" style="margin-top: 0.5rem;">â Neues Bild hinzufÃ¼gen</button>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Audio-Dateien bearbeiten:</label>
                                <div id="audio-editor-${station.id}" style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: #f0f9ff;">
                                    ${generateAudioEditor(station)}
                                </div>
                                <button class="btn btn-secondary btn-small" onclick="addNewAudio(${station.id})" style="margin-top: 0.5rem;">ðµ Neue Audio-Datei hinzufÃ¼gen</button>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-admin btn-small" onclick="saveStationChanges(${station.id})">ð¾ Ãnderungen speichern</button>
                                <button class="btn btn-secondary btn-small" onclick="resetStationEditor(${station.id})">ð ZurÃ¼cksetzen</button>
                                <button class="btn btn-secondary btn-small" onclick="deleteStation(${station.id})">ðï¸ Station lÃ¶schen</button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(stationEditor);
                });
                
                const addButton = document.createElement('div');
                addButton.style.textAlign = 'center';
                addButton.style.marginTop = '2rem';
                addButton.innerHTML = `
                    <button class="btn btn-admin" onclick="addNewStation()">â Neue Station hinzufÃ¼gen</button>
                `;
                container.appendChild(addButton);
                
            } catch (error) {
                console.error('Error generating content editor:', error);
            }
        }

        function toggleStationEditor(stationId) {
            try {
                const content = document.getElementById(`station-content-${stationId}`);
                const header = document.querySelector(`#admin-station-${stationId} .admin-station-header`);
                const icon = document.getElementById(`expand-icon-${stationId}`);
                
                if (content && header && icon) {
                    const isExpanded = content.classList.contains('expanded');
                    
                    if (isExpanded) {
                        content.classList.remove('expanded');
                        header.classList.remove('expanded');
                        icon.classList.remove('expanded');
                    } else {
                        content.classList.add('expanded');
                        header.classList.add('expanded');
                        icon.classList.add('expanded');
                    }
                }
            } catch (error) {
                console.error('Error toggling station editor:', error);
            }
        }

        async function clearAllChatMessages() {
            try {
                if (confirm('Alle Chat-Nachrichten fÃ¼r ALLE Teilnehmer lÃ¶schen? Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) {
                    // Clear Firebase chat collection for all users
                    if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                        const chatRef = db.collection('tours').doc(tourApp.state.tourId).collection('chat');
                        const snapshot = await chatRef.get();
                        
                        const batch = db.batch();
                        snapshot.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();

                        // Also clear all team chats
                        const teamChatRef = db.collection('tours').doc(tourApp.state.tourId).collection('teamChat');
                        const teamSnapshot = await teamChatRef.get();
                        
                        for (const teamDoc of teamSnapshot.docs) {
                            const messagesRef = teamDoc.ref.collection('messages');
                            const messagesSnapshot = await messagesRef.get();
                            
                            const teamBatch = db.batch();
                            messagesSnapshot.docs.forEach((messageDoc) => {
                                teamBatch.delete(messageDoc.ref);
                            });
                            await teamBatch.commit();
                        }
                    }
                    
                    // IMMEDIATE LOCAL CLEARING FOR ALL USERS - FIXED!
                    // This will be synchronized by Firebase listeners automatically
                    
                    // Clear main chat DOM immediately
                    const chatContainer = document.getElementById('chatContainer');
                    if (chatContainer) {
                        // Remove ALL messages, including challenge photos
                        const allMessages = chatContainer.querySelectorAll('.chat-message');
                        allMessages.forEach(msg => {
                            if (!msg.classList.contains('system') || msg.textContent.includes('geleert')) {
                                msg.remove();
                            }
                        });
                        
                        // Add confirmation message
                        const confirmationMsg = document.createElement('div');
                        confirmationMsg.className = 'chat-message system';
                        confirmationMsg.innerHTML = `
                            <strong>Admin:</strong> Chat wurde komplett geleert! ðï¸<br>
                            <small>Alle Nachrichten wurden fÃ¼r alle Teilnehmer entfernt</small>
                            <span class="timestamp">jetzt</span>
                        `;
                        chatContainer.appendChild(confirmationMsg);
                    }

                    // Clear team chat DOM immediately
                    const teamChatContainer = document.getElementById('teamChatMessages');
                    if (teamChatContainer) {
                        const allTeamMessages = teamChatContainer.querySelectorAll('.chat-message');
                        allTeamMessages.forEach(msg => {
                            if (!msg.classList.contains('system') || msg.textContent.includes('geleert')) {
                                msg.remove();
                            }
                        });
                        
                        const teamConfirmationMsg = document.createElement('div');
                        teamConfirmationMsg.className = 'chat-message system';
                        teamConfirmationMsg.innerHTML = `
                            <strong>Admin:</strong> Team-Chat wurde geleert! ðï¸<br>
                            <small>Alle Team-Nachrichten wurden entfernt</small>
                            <span class="timestamp">jetzt</span>
                        `;
                        teamChatContainer.appendChild(teamConfirmationMsg);
                    }
                    
                    // Clear localStorage for all tour participants
                    localStorage.removeItem(`chat_${tourApp.state.tourId}`);
                    // Clear all team chats from localStorage
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(`teamChat_${tourApp.state.tourId}_`)) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    showNotification('Alle Chats komplett geleert fÃ¼r alle Teilnehmer! ðï¸');
                    
                    // Send system message to Firebase so all users see the notification
                    if (tourApp.state.isFirebaseConnected) {
                        await saveToFirebase('chat', `system_${Date.now()}`, {
                            userName: 'ð System',
                            message: 'Alle Chats wurden vom Admin geleert',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            type: 'system'
                        });
                    }

                    // Broadcast clearing event to all connected clients via Firebase
                    if (tourApp.state.isFirebaseConnected) {
                        await db.collection('tours').doc(tourApp.state.tourId)
                            .collection('events').doc(`clear_${Date.now()}`).set({
                                type: 'chat_cleared',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                by: tourApp.state.userName
                            });
                    }
                }
            } catch (error) {
                console.error('Error clearing all chat messages:', error);
                showNotification('Fehler beim LÃ¶schen der Nachrichten', 'error');
            }
        }

        async function toggleChatModeration() {
            try {
                tourApp.state.chatModeration = !tourApp.state.chatModeration;
                tourApp.state.chatBlocked = tourApp.state.chatModeration; // Set blocked status
                
                const textEl = document.getElementById('chatModerationText');
                
                if (textEl) {
                    textEl.textContent = tourApp.state.chatModeration ? 
                        'ð Chat freigeben' : 
                        'ð¡ï¸ Chat sperren';
                }

                // Save moderation status to Firebase to sync with all users
                if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                    await db.collection('tours').doc(tourApp.state.tourId)
                        .collection('settings').doc('moderation')
                        .set({
                            chatBlocked: tourApp.state.chatBlocked,
                            moderatedBy: tourApp.state.userName,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                }

                // Update local moderation UI
                updateChatModeration();
                
                showNotification(tourApp.state.chatModeration ? 
                    'Chat fÃ¼r alle gesperrt! ð' : 
                    'Chat fÃ¼r alle freigegeben! ð');
                    
                addSystemMessage(tourApp.state.chatModeration ? 
                    'Chat wurde vom Admin gesperrt ð' : 
                    'Chat wurde vom Admin freigegeben ð');
            } catch (error) {
                console.error('Error toggling chat moderation:', error);
            }
        }

        async function sendAdminAnnouncement() {
            try {
                const message = prompt('Admin-AnkÃ¼ndigung eingeben:');
                if (message && message.trim()) {
                    const announcement = message.trim();
                    
                    // Send to chat
                    if (tourApp.state.isFirebaseConnected) {
                        await saveToFirebase('chat', Date.now().toString(), {
                            userName: 'ð Admin',
                            message: announcement,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            type: 'announcement'
                        });
                    }
                    
                    // Send as popup to all users
                    if (tourApp.state.isFirebaseConnected) {
                        await saveToFirebase('announcements', Date.now().toString(), {
                            message: announcement,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            isActive: true
                        });
                    }
                    
                    // Show popup locally for admin too
                    showAdminPopup('ð¢ Admin-AnkÃ¼ndigung', announcement);
                    
                    showNotification('Admin-AnkÃ¼ndigung gesendet! ð¢');
                }
            } catch (error) {
                console.error('Error sending admin announcement:', error);
            }
        }

        function showAdminPopup(title, message) {
            try {
                const overlay = document.createElement('div');
                overlay.className = 'admin-popup-overlay';
                
                overlay.innerHTML = `
                    <div class="admin-popup">
                        <h3>${title}</h3>
                        <p>${message}</p>
                        <button class="admin-popup-close" onclick="closeAdminPopup(this.parentElement.parentElement)">
                            Verstanden
                        </button>
                    </div>
                `;
                
                // Prevent closing by clicking background
                overlay.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                document.body.appendChild(overlay);
            } catch (error) {
                console.error('Error showing admin popup:', error);
            }
        }

        function closeAdminPopup(overlay) {
            try {
                if (overlay && overlay.parentElement) {
                    overlay.remove();
                }
            } catch (error) {
                console.error('Error closing admin popup:', error);
            }
        }

        function saveStationChanges(stationId) {
            try {
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station) return;
                
                station.title = document.getElementById(`edit-title-${stationId}`).value;
                station.subtitle = document.getElementById(`edit-subtitle-${stationId}`).value;
                station.mainText = document.getElementById(`edit-maintext-${stationId}`).value;
                station.photoChallenge = document.getElementById(`edit-challenge-${stationId}`).value;
                station.lat = parseFloat(document.getElementById(`edit-lat-${stationId}`).value);
                station.lng = parseFloat(document.getElementById(`edit-lng-${stationId}`).value);
                
                if (tourApp.state.isFirebaseConnected) {
                    saveToFirebase('stations', stationId.toString(), station);
                }
                
                generateStationsList();
                
                if (tourApp.state.map) {
                    updateMapMarkers();
                }
                
                showNotification(`Station ${stationId} gespeichert! â`);
                addSystemMessage(`Admin hat Station "${station.title}" aktualisiert! ð`);
                
                saveState();
            } catch (error) {
                console.error('Error saving station changes:', error);
                showNotification('Fehler beim Speichern der Ãnderungen', 'error');
            }
        }

        function resetStationEditor(stationId) {
            try {
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station) return;
                
                document.getElementById(`edit-title-${stationId}`).value = station.title;
                document.getElementById(`edit-subtitle-${stationId}`).value = station.subtitle;
                document.getElementById(`edit-maintext-${stationId}`).value = station.mainText;
                document.getElementById(`edit-challenge-${stationId}`).value = station.photoChallenge;
                document.getElementById(`edit-lat-${stationId}`).value = station.lat;
                document.getElementById(`edit-lng-${stationId}`).value = station.lng;
                
                showNotification('Editor zurÃ¼ckgesetzt! ð');
            } catch (error) {
                console.error('Error resetting station editor:', error);
            }
        }

        // Image Management Functions - RESTORED!
        function generateImageEditor(station) {
            try {
                if (!station.images || station.images.length === 0) {
                    return `
                        <p style="color: #6b7280; text-align: center; padding: 2rem;">
                            ð· Noch keine Bilder vorhanden<br>
                            <small>Klicke auf "Neues Bild hinzufÃ¼gen" um Bilder zur Galerie hinzuzufÃ¼gen</small>
                        </p>
                    `;
                }
                
                return station.images.map((image, index) => `
                    <div style="border: 1px solid #d1d5db; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: white;" id="image-item-${station.id}-${index}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #374151;">ð· Bild ${index + 1}</strong>
                            <button onclick="removeImage(${station.id}, ${index})" style="background: #dc2626; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ðï¸ LÃ¶schen</button>
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Titel:</label>
                            <input type="text" value="${image.title || ''}" onchange="updateImageData(${station.id}, ${index}, 'title', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Beschreibung:</label>
                            <input type="text" value="${image.description || ''}" onchange="updateImageData(${station.id}, ${index}, 'description', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Bild-URL (optional):</label>
                            <input type="url" value="${image.url || ''}" onchange="updateImageData(${station.id}, ${index}, 'url', this.value)" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Oder Bild hochladen:</label>
                            <input type="file" accept="image/*" onchange="uploadImageFile(${station.id}, ${index}, this)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        </div>
                        
                        ${image.url ? `
                            <div style="margin-top: 0.5rem;">
                                <img src="${image.url}" alt="${image.title}" style="max-width: 150px; max-height: 100px; border-radius: 4px; object-fit: cover;">
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error generating image editor:', error);
                return '<p style="color: #dc2626;">Fehler beim Laden des Bild-Editors</p>';
            }
        }

        function addNewImage(stationId) {
            try {
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station) return;
                
                if (!station.images) {
                    station.images = [];
                }
                
                station.images.push({
                    title: `Neues Bild ${station.images.length + 1}`,
                    description: "Beschreibung des Bildes",
                    url: ""
                });
                
                // Regenerate image editor
                const editorContainer = document.getElementById(`image-editor-${stationId}`);
                if (editorContainer) {
                    editorContainer.innerHTML = generateImageEditor(station);
                }
                
                showNotification('Neues Bild hinzugefÃ¼gt! ð·');
            } catch (error) {
                console.error('Error adding new image:', error);
            }
        }

        function removeImage(stationId, imageIndex) {
            try {
                if (!confirm('Dieses Bild wirklich lÃ¶schen?')) return;
                
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station || !station.images) return;
                
                station.images.splice(imageIndex, 1);
                
                // Regenerate image editor
                const editorContainer = document.getElementById(`image-editor-${stationId}`);
                if (editorContainer) {
                    editorContainer.innerHTML = generateImageEditor(station);
                }
                
                showNotification('Bild gelÃ¶scht! ðï¸');
            } catch (error) {
                console.error('Error removing image:', error);
            }
        }

        function updateImageData(stationId, imageIndex, field, value) {
            try {
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station || !station.images || !station.images[imageIndex]) return;
                
                station.images[imageIndex][field] = value;
                
                // If URL was updated, refresh the preview
                if (field === 'url') {
                    setTimeout(() => {
                        const editorContainer = document.getElementById(`image-editor-${stationId}`);
                        if (editorContainer) {
                            editorContainer.innerHTML = generateImageEditor(station);
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('Error updating image data:', error);
            }
        }

        function uploadImageFile(stationId, imageIndex, fileInput) {
            try {
                const file = fileInput.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    updateImageData(stationId, imageIndex, 'url', dataUrl);
                    showNotification('Bild hochgeladen! ð·');
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error uploading image file:', error);
                showNotification('Fehler beim Hochladen des Bildes', 'error');
            }
        }

        // Audio Management Functions - RESTORED!
        function generateAudioEditor(station) {
            try {
                if (!station.audio || station.audio.length === 0) {
                    return `
                        <p style="color: #6b7280; text-align: center; padding: 2rem;">
                            ðµ Noch keine Audio-Dateien vorhanden<br>
                            <small>Klicke auf "Neue Audio-Datei hinzufÃ¼gen" um Audio zur Station hinzuzufÃ¼gen</small>
                        </p>
                    `;
                }
                
                return station.audio.map((audio, index) => `
                    <div style="border: 1px solid #d1d5db; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: white;" id="audio-item-${station.id}-${index}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #374151;">ðµ Audio ${index + 1}</strong>
                            <button onclick="removeAudio(${station.id}, ${index})" style="background: #dc2626; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ðï¸ LÃ¶schen</button>
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Titel:</label>
                            <input type="text" value="${audio.title || ''}" onchange="updateAudioData(${station.id}, ${index}, 'title', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Beschreibung:</label>
                            <input type="text" value="${audio.description || ''}" onchange="updateAudioData(${station.id}, ${index}, 'description', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Audio-Typ:</label>
                            <select onchange="updateAudioData(${station.id}, ${index}, 'type', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                <option value="youtube" ${audio.type === 'youtube' ? 'selected' : ''}>ðº YouTube (in-app)</option>
                                <option value="soundcloud" ${audio.type === 'soundcloud' ? 'selected' : ''}>âï¸ SoundCloud (in-app)</option>
                                <option value="spotify" ${audio.type === 'spotify' ? 'selected' : ''}>ð¢ Spotify (in-app)</option>
                                <option value="audio" ${audio.type === 'audio' ? 'selected' : ''}>ðµ Audio-URL (in-app)</option>
                                <option value="podcast" ${audio.type === 'podcast' ? 'selected' : ''}>ðï¸ Podcast-URL (in-app)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">
                                ${audio.type === 'youtube' ? 'YouTube-URL:' :
                                  audio.type === 'soundcloud' ? 'SoundCloud-URL:' :
                                  audio.type === 'spotify' ? 'Spotify-URL:' :
                                  audio.type === 'podcast' ? 'Podcast-URL:' : 'Audio-URL:'}
                            </label>
                            <input type="url" value="${audio.url || ''}" onchange="updateAudioData(${station.id}, ${index}, 'url', this.value)" 
                                   placeholder="${audio.type === 'youtube' ? 'https://www.youtube.com/watch?v=...' :
                                                audio.type === 'soundcloud' ? 'https://soundcloud.com/user/track-name' :
                                                audio.type === 'spotify' ? 'https://open.spotify.com/track/...' :
                                                audio.type === 'podcast' ? 'https://example.com/podcast.mp3' : 'https://example.com/audio.mp3'}" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        </div>
                        
                        ${audio.url ? `
                            <div style="margin-top: 0.5rem;">
                                <button onclick="previewAudio('${audio.url}', '${audio.type}', '${audio.title}')" style="background: #059669; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    â¶ï¸ Vorschau (in-app)
                                </button>
                            </div>
                        ` : ''}
                        
                        ${audio.url ? `
                            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #059669;">
                                â ${audio.type.charAt(0).toUpperCase() + audio.type.slice(1)}-Link gesetzt - wird in-app abgespielt
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error generating audio editor:', error);
                return '<p style="color: #dc2626;">Fehler beim Laden des Audio-Editors</p>';
            }
        }

        function addNewAudio(stationId) {
            try {
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station) return;
                
                if (!station.audio) {
                    station.audio = [];
                }
                
                station.audio.push({
                    title: `Neue Audio-Datei ${station.audio.length + 1}`,
                    description: "Beschreibung der Audio-Datei",
                    url: "",
                    type: "youtube"
                });
                
                // Regenerate audio editor
                const editorContainer = document.getElementById(`audio-editor-${stationId}`);
                if (editorContainer) {
                    editorContainer.innerHTML = generateAudioEditor(station);
                }
                
                showNotification('Neue Audio-Datei hinzugefÃ¼gt! ðµ');
            } catch (error) {
                console.error('Error adding new audio:', error);
            }
        }

        function removeAudio(stationId, audioIndex) {
            try {
                if (!confirm('Diese Audio-Datei wirklich lÃ¶schen?')) return;
                
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station || !station.audio) return;
                
                station.audio.splice(audioIndex, 1);
                
                // Regenerate audio editor
                const editorContainer = document.getElementById(`audio-editor-${stationId}`);
                if (editorContainer) {
                    editorContainer.innerHTML = generateAudioEditor(station);
                }
                
                showNotification('Audio-Datei gelÃ¶scht! ðï¸');
            } catch (error) {
                console.error('Error removing audio:', error);
            }
        }

        function updateAudioData(stationId, audioIndex, field, value) {
            try {
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station || !station.audio || !station.audio[audioIndex]) return;
                
                station.audio[audioIndex][field] = value;
                
                // If type was updated, refresh the editor to show different input fields
                if (field === 'type' || field === 'url') {
                    setTimeout(() => {
                        const editorContainer = document.getElementById(`audio-editor-${stationId}`);
                        if (editorContainer) {
                            editorContainer.innerHTML = generateAudioEditor(station);
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('Error updating audio data:', error);
            }
        }

        // Preview function for admin
        function previewAudio(url, type, title) {
            playAudio(url, type, title);
        }

        function deleteStation(stationId) {
            try {
                if (confirm(`Station ${stationId} wirklich lÃ¶schen? Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.`)) {
                    const stationIndex = tourApp.stations.findIndex(s => s.id === stationId);
                    if (stationIndex > -1) {
                        const station = tourApp.stations[stationIndex];
                        tourApp.stations.splice(stationIndex, 1);
                        
                        tourApp.state.completedStations = tourApp.state.completedStations.filter(id => id !== stationId);
                        
                        if (tourApp.state.isFirebaseConnected) {
                            db.collection('tours').doc(tourApp.state.tourId)
                                .collection('stations').doc(stationId.toString()).delete();
                        }
                        
                        generateContentEditor();
                        generateStationsList();
                        updateProgress();
                        
                        if (tourApp.state.map) {
                            updateMapMarkers();
                        }
                        
                        showNotification(`Station "${station.title}" gelÃ¶scht! ðï¸`);
                        addSystemMessage(`Admin hat Station "${station.title}" entfernt! ðï¸`);
                        saveState();
                    }
                }
            } catch (error) {
                console.error('Error deleting station:', error);
            }
        }

        function addNewStation() {
            try {
                const newId = Math.max(...tourApp.stations.map(s => s.id)) + 1;
                const newStation = {
                    id: newId,
                    title: `Neue Station ${newId}`,
                    subtitle: "Beschreibung der neuen Station",
                    lat: 50.9375, lng: 6.9597,
                    description: `Station ${newId} der Tour`,
                    photoChallenge: "Macht ein kreatives Foto an dieser Station!",
                    mainText: "Hier kommt der Haupttext der neuen Station. ErzÃ¤hle die Geschichte dieses Ortes...",
                    images: [
                        { title: "Bild 1", description: "Beschreibung des ersten Bildes", url: "" }
                    ],
                    audio: [
                        { title: "Audio 1", description: "Beschreibung der ersten Audio-Datei", url: "", type: "youtube" }
                    ]
                };
                
                tourApp.stations.push(newStation);
                tourApp.stations.sort((a, b) => a.id - b.id);
                
                if (tourApp.state.isFirebaseConnected) {
                    saveToFirebase('stations', newId.toString(), newStation);
                }
                
                generateContentEditor();
                generateStationsList();
                
                if (tourApp.state.map) {
                    updateMapMarkers();
                }
                
                showNotification(`Neue Station ${newId} hinzugefÃ¼gt! â`);
                addSystemMessage(`Admin hat neue Station "${newStation.title}" hinzugefÃ¼gt! â`);
                saveState();
            } catch (error) {
                console.error('Error adding new station:', error);
            }
        }

        function updateMapMarkers() {
            try {
                if (!tourApp.state.map) return;
                
                tourApp.state.markers.forEach(marker => {
                    tourApp.state.map.removeLayer(marker);
                });
                tourApp.state.markers = [];
                
                tourApp.stations.forEach(station => {
                    const isCompleted = tourApp.state.completedStations.includes(station.id);
                    const marker = L.marker([station.lat, station.lng])
                        .bindPopup(`
                            <div style="text-align: center; max-width: 200px;">
                                <h4>${station.title}</h4>
                                <p>${station.subtitle}</p>
                                <p><strong>Station ${station.id}/${tourApp.stations.length}</strong></p>
                                ${isCompleted ? '<p style="color: green;">â Abgeschlossen</p>' : '<p style="color: orange;">â³ Ausstehend</p>'}
                            </div>
                        `)
                        .addTo(tourApp.state.map);
                    
                    tourApp.state.markers.push(marker);
                });
                
                const routeCoordinates = tourApp.stations.map(station => [station.lat, station.lng]);
                L.polyline(routeCoordinates, {
                    color: '#dc2626',
                    weight: 3,
                    opacity: 0.7
                }).addTo(tourApp.state.map);
            } catch (error) {
                console.error('Error updating map markers:', error);
            }
        }

        function refreshAdminStats() {
            try {
                const stats = {
                    activeUsers: Object.keys(localStorage).filter(key => key.startsWith('user_')).length + 1,
                    totalMessages: document.querySelectorAll('.chat-message:not(.system)').length,
                    completedStations: tourApp.state.completedStations.length,
                    uploadedPhotos: tourApp.state.uploadedPhotos.length
                };
                
                document.getElementById('activeUsers').textContent = stats.activeUsers;
                document.getElementById('totalMessages').textContent = stats.totalMessages;
                document.getElementById('completedStations').textContent = `${stats.completedStations}/${tourApp.stations.length}`;
                document.getElementById('uploadedPhotos').textContent = stats.uploadedPhotos;
                
                showNotification('Statistiken aktualisiert! ð');
            } catch (error) {
                console.error('Error refreshing admin stats:', error);
            }
        }

        // UI Functions
        window.showTab = function(tabName, tabElement) {
            try {
                tourApp.state.currentTab = tabName;
                
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                if (tabElement) {
                    tabElement.classList.add('active');
                }

                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const targetTab = document.getElementById(tabName === 'map' ? 'map-tab' : tabName);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                if (tabName === 'chat') {
                    // Clear notifications based on current chat tab
                    if (tourApp.state.currentChatTab === 'main') {
                        clearChatNotification();
                    } else {
                        clearTeamChatNotification();
                    }
                    
                    // Add Enter key listener for team chat
                    const teamChatInput = document.getElementById('teamChatInputField');
                    if (teamChatInput) {
                        teamChatInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                sendTeamMessage();
                            }
                        });
                    }
                }

                if (tabName === 'map') {
                    setTimeout(() => initMap(), 100);
                } else if (tabName === 'ranking') {
                    updateRanking();
                } else if (tabName === 'admin' && tourApp.state.isAdmin) {
                    generateContentEditor();
                    refreshAdminStats();
                }
            } catch (error) {
                console.error('Error showing tab:', error);
            }
        }

        window.selectTeam = function(teamId, teamName, element) {
            try {
                tourApp.state.selectedTeam = teamId;
                tourApp.state.teamName = teamName;
                
                document.querySelectorAll('.team-option').forEach(option => {
                    option.classList.remove('selected');
                });
                if (element) {
                    element.classList.add('selected');
                }
                
                const selector = document.getElementById('teamSelector');
                if (selector) {
                    selector.style.display = 'none';
                }

                // Enable team chat tab
                const teamChatTab = document.getElementById('teamChatTab');
                if (teamChatTab) {
                    teamChatTab.style.display = 'block';
                    teamChatTab.innerHTML = `ð¥ ${teamName.split(' ')[1]}-Chat`;
                }
                
                showNotification('Team ausgewÃ¤hlt! ð');
                saveState();
                addSystemMessage(`${tourApp.state.userName} ist ${teamName} beigetreten! ð`);

                // Load team chat history
                setTimeout(() => loadChatHistory(), 500);
            } catch (error) {
                console.error('Error selecting team:', error);
            }
        }

        window.changeUserName = function() {
            try {
                const input = document.getElementById('userNameInput');
                const newName = input.value.trim();
                
                if (newName && newName.length >= 2) {
                    const oldName = tourApp.state.userName;
                    tourApp.state.userName = newName;
                    
                    const displayEl = document.getElementById('currentUserName');
                    if (displayEl) {
                        displayEl.textContent = newName;
                    }
                    
                    input.value = '';
                    saveState();
                    showNotification('Name geÃ¤ndert! ð¤');
                    addSystemMessage(`${oldName} heiÃt jetzt ${newName}! ð¤`);
                } else {
                    showNotification('Name muss mindestens 2 Zeichen haben!', 'error');
                }
            } catch (error) {
                console.error('Error changing user name:', error);
            }
        }

        window.startTour = function() {
            try {
                if (!tourApp.state.selectedTeam) {
                    showNotification('Bitte wÃ¤hle zuerst ein Team aus!', 'error');
                    return;
                }
                
                showTab('stations', document.querySelector('.tab[onclick*="stations"]'));
                showNotification('Tour gestartet! Viel Erfolg! ð');
            } catch (error) {
                console.error('Error starting tour:', error);
            }
        }

        window.loginAdmin = function() {
            try {
                const password = document.getElementById('adminPassword').value;
                if (password === 'koeln2024') {
                    tourApp.state.isAdmin = true;
                    document.getElementById('adminTab').classList.remove('hidden');
                    generateStationsList();
                    showNotification('Admin-Modus aktiviert! âï¸');
                    showTab('admin', document.getElementById('adminTab'));
                } else {
                    showNotification('Falsches Passwort!', 'error');
                }
            } catch (error) {
                console.error('Error logging in admin:', error);
            }
        }

        // Utility Functions
        window.copyShareUrl = function() {
            try {
                const shareUrl = document.getElementById('shareUrl').textContent;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        showNotification('URL kopiert! ð');
                    });
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = shareUrl;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showNotification('URL kopiert! ð');
                }
            } catch (error) {
                console.error('Error copying URL:', error);
            }
        }

        window.shareViaWhatsApp = function() {
            try {
                const shareUrl = document.getElementById('shareUrl').textContent;
                const message = `ðï¸ KÃ¶lner Abendspaziergang - Tour beitreten:\n${shareUrl}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            } catch (error) {
                console.error('Error sharing via WhatsApp:', error);
            }
        }

        window.retryConnection = function() {
            tourApp.state.connectionRetries = 0;
            initFirebase();
        }

        async function addScore(points) {
            try {
                tourApp.state.totalScore += Math.round(points);
                updateUI();
                
                if (tourApp.state.selectedTeam) {
                    await saveToFirebase('scores', tourApp.state.selectedTeam, {
                        teamId: tourApp.state.selectedTeam,
                        teamName: tourApp.state.teamName,
                        score: tourApp.state.totalScore,
                        lastUpdated: Date.now(),
                        userName: tourApp.state.userName
                    });
                }
                
                saveState();
            } catch (error) {
                console.error('Error adding score:', error);
            }
        }

        function generateStationsList() {
            try {
                const container = document.getElementById('stationsList');
                if (!container) return;
                
                container.innerHTML = '';
                
                tourApp.stations.forEach(station => {
                    const isCompleted = tourApp.state.completedStations.includes(station.id);
                    
                    const stationCard = document.createElement('div');
                    stationCard.className = `station-card ${isCompleted ? 'completed' : ''}`;
                    stationCard.onclick = () => toggleStationDetails(station.id);
                    
                    const imagesHtml = station.images.map(img => `
                        <div class="gallery-item">
                            <div class="gallery-image" onclick="openImageModal(event, '${img.url || 'placeholder'}', '${img.title}', '${img.description}')" 
                                 style="${img.url ? `background-image: url('${img.url}'); background-size: cover; background-position: center;` : ''}">
                                ${img.url ? '' : 'ð·'}
                            </div>
                            <small>${img.title}</small>
                        </div>
                    `).join('');
                    
                    const audioHtml = station.audio && station.audio.length > 0 ? station.audio.map(audio => {
                        const typeIcons = {
                            'youtube': 'ðº',
                            'soundcloud': 'âï¸', 
                            'spotify': 'ð¢',
                            'audio': 'ðµ',
                            'podcast': 'ðï¸'
                        };
                        const typeColors = {
                            'youtube': 'linear-gradient(135deg, #ff0000 0%, #cc0000 100%)',
                            'soundcloud': 'linear-gradient(135deg, #ff5500 0%, #ff3300 100%)',
                            'spotify': 'linear-gradient(135deg, #1db954 0%, #1ed760 100%)',
                            'audio': 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
                            'podcast': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
                        };
                        return `
                            <div class="gallery-item">
                                <div class="gallery-image" onclick="openAudioModal(event, '${audio.url}', '${audio.type}', '${audio.title}')"
                                     style="background: ${typeColors[audio.type] || typeColors.audio}; color: white; font-size: 1.8rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;"
                                     onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.2)'"
                                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                    ${typeIcons[audio.type] || 'ðµ'}
                                </div>
                                <small>${audio.title}</small>
                            </div>
                        `;
                    }).join('') : '';
                    
                    stationCard.innerHTML = `
                        <div class="station-header">
                            <div class="station-number ${isCompleted ? 'completed' : ''}">${station.id}</div>
                            <div style="flex: 1;">
                                <div class="station-title">${station.title}</div>
                                <div class="station-subtitle">${station.subtitle}</div>
                            </div>
                        </div>
                        <div class="station-details" id="station-${station.id}">
                            <div class="detail-section">
                                <h4>ðºï¸ Standort</h4>
                                <div class="station-map" id="station-map-${station.id}" style="height: 200px; width: 100%; border-radius: 8px; margin: 0.5rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
                                <p style="font-size: 0.9rem; color: #6b7280;">ð ${station.lat.toFixed(6)}, ${station.lng.toFixed(6)}</p>
                                <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); centerStationMap(${station.id})" style="margin-top: 0.5rem;">
                                    ð¯ Zur Station navigieren
                                </button>
                            </div>

                            <div class="detail-section">
                                <h4>ð Geschichte</h4>
                                <p>${station.mainText}</p>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ð¼ï¸ Bildergalerie</h4>
                                <div class="image-gallery">
                                    ${imagesHtml}
                                </div>
                            </div>
                            
                            ${audioHtml ? `
                            <div class="detail-section">
                                <h4>ðµ Audio-Dateien</h4>
                                <div class="image-gallery">
                                    ${audioHtml}
                                </div>
                            </div>
                            ` : ''}

                            <div class="photo-challenge">
                                <h4>ð¸ KI-Foto-Challenge</h4>
                                <p>${station.photoChallenge}</p>
                                
                                <div class="photo-upload-area" onclick="event.stopPropagation(); selectPhoto(${station.id})" id="upload-area-${station.id}">
                                    <div id="upload-content-${station.id}">
                                        ð· Hier klicken zum Foto machen/auswÃ¤hlen<br>
                                        <small>KI bewertet automatisch QualitÃ¤t, Komposition & KreativitÃ¤t</small>
                                    </div>
                                </div>
                                
                                <input type="file" class="file-input" id="photo-input-${station.id}" accept="image/*" capture="environment" onchange="handlePhotoUpload(${station.id}, event)">
                                
                                <div class="ai-rating hidden" id="rating-${station.id}">
                                    <div class="rating-score" id="score-${station.id}">0</div>
                                    <div class="rating-text" id="rating-text-${station.id}">KI analysiert dein Foto...</div>
                                    <div class="rating-details" id="rating-details-${station.id}"></div>
                                    
                                    <!-- Share Challenge Photo Button -->
                                    <div id="share-photo-section-${station.id}" class="hidden" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e5e7eb;">
                                        <button class="btn btn-secondary" onclick="shareChallengePhoto(${station.id})" style="background: #059669; margin-top: 0.5rem;">
                                            ð¤ Foto im Chat teilen
                                        </button>
                                        <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                                            ð¡ Teile dein Challenge-Foto mit allen Teilnehmern!
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <button class="btn" onclick="event.stopPropagation(); completeStation(${station.id})" id="complete-btn-${station.id}" 
                                    ${isCompleted ? 'disabled' : ''}>
                                ${isCompleted ? 'â Station abgeschlossen' : 'ð Station abschlieÃen'}
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(stationCard);
                });
            } catch (error) {
                console.error('Error generating stations list:', error);
            }
        }

        // Event handling functions for media modals
        function openImageModal(event, url, title, description) {
            event.stopPropagation();
            showImageModal(url, title, description);
        }

        function openAudioModal(event, url, type, title) {
            event.stopPropagation();
            playAudio(url, type, title);
        }

        function toggleStationDetails(stationId) {
            try {
                const details = document.getElementById(`station-${stationId}`);
                if (details) {
                    const wasActive = details.classList.contains('active');
                    details.classList.toggle('active');
                    
                    // Initialize station map when details are opened
                    if (!wasActive && details.classList.contains('active')) {
                        setTimeout(() => initStationMap(stationId), 100);
                    }
                }
            } catch (error) {
                console.error('Error toggling station details:', error);
            }
        }

        function initStationMap(stationId) {
            try {
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station) return;

                const mapContainer = document.getElementById(`station-map-${stationId}`);
                if (!mapContainer || typeof L === 'undefined') return;

                // Create mini map for this station
                const stationMap = L.map(`station-map-${stationId}`, {
                    center: [station.lat, station.lng],
                    zoom: 18,
                    scrollWheelZoom: false
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(stationMap);

                // Add station marker
                const stationMarker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}</strong></p>
                        </div>
                    `)
                    .addTo(stationMap);

                // Add user location if available
                if (tourApp.state.userLocation) {
                    const userIcon = L.divIcon({
                        html: '<div style="background: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>',
                        className: 'user-location-marker-mini',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                    
                    const userMarker = L.marker([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], {
                        icon: userIcon
                    })
                    .bindPopup('ð Dein Standort')
                    .addTo(stationMap);

                    // Draw line from user to station
                    const routeLine = L.polyline([
                        [tourApp.state.userLocation.lat, tourApp.state.userLocation.lng],
                        [station.lat, station.lng]
                    ], {
                        color: '#dc2626',
                        weight: 2,
                        opacity: 0.7,
                        dashArray: '5, 5'
                    }).addTo(stationMap);

                    // Calculate and show distance
                    const distance = calculateDistance(
                        tourApp.state.userLocation.lat, tourApp.state.userLocation.lng,
                        station.lat, station.lng
                    );
                    
                    const distanceText = distance < 1 
                        ? `${Math.round(distance * 1000)}m entfernt` 
                        : `${distance.toFixed(1)}km entfernt`;
                    
                    // Update distance info in the station
                    const distanceInfo = mapContainer.parentElement.querySelector('p');
                    if (distanceInfo) {
                        distanceInfo.innerHTML = `ð ${station.lat.toFixed(6)}, ${station.lng.toFixed(6)} - ${distanceText}`;
                    }
                }

                // Store map reference for later use
                if (!tourApp.state.stationMaps) {
                    tourApp.state.stationMaps = {};
                }
                tourApp.state.stationMaps[stationId] = stationMap;

                // Open popup immediately
                setTimeout(() => stationMarker.openPopup(), 500);

            } catch (error) {
                console.error('Error initializing station map:', error);
            }
        }

        function centerStationMap(stationId) {
            try {
                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station) return;

                // If user has location, open navigation
                if (tourApp.state.userLocation) {
                    const navigationUrl = `https://www.google.com/maps/dir/${tourApp.state.userLocation.lat},${tourApp.state.userLocation.lng}/${station.lat},${station.lng}`;
                    window.open(navigationUrl, '_blank');
                    showNotification('Navigation in Google Maps geÃ¶ffnet! ðºï¸');
                } else {
                    // Just show the location in Google Maps
                    const locationUrl = `https://www.google.com/maps/search/?api=1&query=${station.lat},${station.lng}`;
                    window.open(locationUrl, '_blank');
                    showNotification('Station in Google Maps geÃ¶ffnet! ð');
                }
            } catch (error) {
                console.error('Error centering station map:', error);
                showNotification('Fehler beim Ãffnen der Navigation', 'error');
            }
        }

        function selectPhoto(stationId) {
            try {
                const input = document.getElementById(`photo-input-${stationId}`);
                if (input) {
                    input.click();
                }
            } catch (error) {
                console.error('Error selecting photo:', error);
            }
        }

        function handlePhotoUpload(stationId, event) {
            try {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    
                    const uploadArea = document.getElementById(`upload-area-${stationId}`);
                    if (uploadArea) {
                        uploadArea.classList.add('has-photo');
                        uploadArea.innerHTML = `
                            <img src="${imageUrl}" class="photo-preview" alt="Uploaded photo">
                            <p>ð· Foto erfolgreich hochgeladen!</p>
                            <small>KI analysiert...</small>
                        `;
                    }

                    const photoData = {
                        stationId: stationId,
                        imageUrl: imageUrl,
                        timestamp: Date.now(),
                        teamId: tourApp.state.selectedTeam
                    };

                    const existingIndex = tourApp.state.uploadedPhotos.findIndex(p => p.stationId === stationId);
                    if (existingIndex >= 0) {
                        tourApp.state.uploadedPhotos[existingIndex] = photoData;
                    } else {
                        tourApp.state.uploadedPhotos.push(photoData);
                    }

                    setTimeout(() => ratePhoto(stationId, imageUrl), 1000);
                    saveState();
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error handling photo upload:', error);
            }
        }

        function ratePhoto(stationId, imageUrl) {
            try {
                const ratingDiv = document.getElementById(`rating-${stationId}`);
                if (ratingDiv) {
                    ratingDiv.classList.remove('hidden');
                }
                
                const baseScore = 50 + Math.random() * 40;
                const technicalScore = 70 + Math.random() * 25;
                const compositionScore = 60 + Math.random() * 30;
                const creativityScore = 55 + Math.random() * 35;
                
                const finalScore = Math.round(baseScore);
                
                animateScore(stationId, finalScore);
                
                const feedback = generatePhotoFeedback(technicalScore, compositionScore, creativityScore);
                
                setTimeout(() => {
                    const ratingTextEl = document.getElementById(`rating-text-${stationId}`);
                    const ratingDetailsEl = document.getElementById(`rating-details-${stationId}`);
                    
                    if (ratingTextEl) {
                        ratingTextEl.innerHTML = `
                            <strong>KI-Bewertung abgeschlossen!</strong><br>
                            QualitÃ¤t: ${Math.round(technicalScore)}% | 
                            Komposition: ${Math.round(compositionScore)}% | 
                            KreativitÃ¤t: ${Math.round(creativityScore)}%
                        `;
                    }
                    
                    if (ratingDetailsEl) {
                        ratingDetailsEl.innerHTML = feedback.join('<br>');
                    }

                    // Show share button after rating is complete
                    const shareSection = document.getElementById(`share-photo-section-${stationId}`);
                    if (shareSection) {
                        shareSection.classList.remove('hidden');
                    }
                }, 2000);
                
                addScore(finalScore);
                
                const photoData = tourApp.state.uploadedPhotos.find(p => p.stationId === stationId);
                if (photoData) {
                    photoData.score = finalScore;
                }
                
                showNotification(`KI-Bewertung: ${finalScore} Punkte! ð¤`);
            } catch (error) {
                console.error('Error rating photo:', error);
            }
        }

        // NEW: Challenge Photo Sharing Function
        async function shareChallengePhoto(stationId) {
            try {
                const photoData = tourApp.state.uploadedPhotos.find(p => p.stationId === stationId);
                if (!photoData) {
                    showNotification('Kein Foto zum Teilen gefunden!', 'error');
                    return;
                }

                const station = tourApp.stations.find(s => s.id === stationId);
                if (!station) return;

                // Create high-quality version for sharing (less compression)
                const shareableImage = await compressImage(
                    dataURLtoFile(photoData.imageUrl), 
                    0.8, // Higher quality
                    1200, // Larger dimensions
                    900
                );

                const shareMessageData = {
                    userName: tourApp.state.userName,
                    image: shareableImage,
                    timestamp: firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : Date.now(),
                    tourId: tourApp.state.tourId,
                    type: 'challenge-photo',
                    stationId: stationId,
                    stationTitle: station.title,
                    score: photoData.score || 0,
                    teamName: tourApp.state.teamName || 'Unbekanntes Team',
                    isDownloadable: true
                };

                // Add to main chat
                addChallengePhotoMessage(shareMessageData, true);

                // Save to Firebase
                if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                    await saveToFirebase('chat', `challenge_${Date.now()}`, shareMessageData);
                } else {
                    const chatKey = `chat_${tourApp.state.tourId}`;
                    const chatMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
                    chatMessages.push(shareMessageData);
                    if (chatMessages.length > 50) {
                        chatMessages.splice(0, chatMessages.length - 50);
                    }
                    localStorage.setItem(chatKey, JSON.stringify(chatMessages));
                }

                showNotification('Challenge-Foto im Chat geteilt! ð¤');
                
                // Disable share button to prevent spam
                const shareButton = document.querySelector(`[onclick="shareChallengePhoto(${stationId})"]`);
                if (shareButton) {
                    shareButton.disabled = true;
                    shareButton.textContent = 'â Foto geteilt';
                    shareButton.style.background = '#6b7280';
                }

            } catch (error) {
                console.error('Error sharing challenge photo:', error);
                showNotification('Fehler beim Teilen des Fotos', 'error');
            }
        }

        // Helper function to convert data URL to File
        function dataURLtoFile(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], 'challenge-photo.jpg', {type: mime});
        }

        // Special function for challenge photo messages
        function addChallengePhotoMessage(messageData, isOwn = false) {
            try {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isOwn ? 'own' : ''} challenge-photo-message`;
                messageDiv.style.background = isOwn ? '#e0f2fe' : '#f0f9ff';
                messageDiv.style.borderLeft = '4px solid #0ea5e9';
                
                const timeStr = new Date().toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Ensure all message data is properly defined
                const userName = messageData.userName || 'Unbekannt';
                const teamName = messageData.teamName || '';
                const stationTitle = messageData.stationTitle || 'Unbekannte Station';
                const score = messageData.score || 0;
                const image = messageData.image || '';
                
                const messageContent = `
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <span style="background: #0ea5e9; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; margin-right: 0.5rem;">ð¸ CHALLENGE</span>
                        <strong>${userName}</strong> ${teamName ? `(${teamName})` : ''}
                    </div>
                    <p style="margin-bottom: 0.5rem; color: #0369a1; font-weight: bold;">
                        ðï¸ ${stationTitle} - ${score} Punkte!
                    </p>
                    <div class="chat-image-container" style="position: relative;">
                        <img src="${image}" class="chat-image" 
                            onclick="event.stopPropagation(); showImageModal('${image}', 'Challenge: ${stationTitle}', 'Von ${userName} (${score} Punkte)')" 
                            alt="Challenge Foto" style="max-width: 300px;">
                        <button onclick="event.stopPropagation(); downloadChallengePhoto('${image}', '${stationTitle}', '${userName}')" 
                                style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; padding: 0.5rem; border-radius: 50%; cursor: pointer; font-size: 0.9rem; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(0,0,0,0.9)'"
                                onmouseout="this.style.background='rgba(0,0,0,0.7)'"
                                title="Foto herunterladen">
                            ð¾
                        </button>
                    </div>
                    <span class="timestamp" style="font-size: 0.8rem; color: #6b7280;">${timeStr}</span>
                `;

                messageDiv.innerHTML = messageContent;
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                if (!isOwn && tourApp.state.currentTab !== 'chat') {
                    tourApp.state.unreadMessages++;
                    updateChatNotification();
                    
                    showClickableNotification(`ð¸ ${userName} hat ein Challenge-Foto geteilt!`, 'chat');
                } else if (!isOwn && tourApp.state.currentTab === 'chat' && tourApp.state.currentChatTab !== 'main') {
                    tourApp.state.unreadMessages++;
                    updateChatNotification();
                }
            } catch (error) {
                console.error('Error adding challenge photo message:', error);
            }
        }

        // Download function for challenge photos
        function downloadChallengePhoto(imageUrl, stationTitle, userName) {
            try {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `Challenge_${stationTitle.replace(/\s+/g, '_')}_${userName}_${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Foto wird heruntergeladen! ð¾');
            } catch (error) {
                console.error('Error downloading challenge photo:', error);
                showNotification('Download fehlgeschlagen', 'error');
            }
        }

        function animateScore(stationId, targetScore) {
            try {
                const scoreElement = document.getElementById(`score-${stationId}`);
                if (!scoreElement) return;
                
                let currentScore = 0;
                const increment = Math.ceil(targetScore / 30);
                
                const interval = setInterval(() => {
                    currentScore += increment;
                    if (currentScore >= targetScore) {
                        currentScore = targetScore;
                        clearInterval(interval);
                    }
                    scoreElement.textContent = currentScore;
                }, 50);
            } catch (error) {
                console.error('Error animating score:', error);
            }
        }

        function generatePhotoFeedback(technical, composition, creativity) {
            const feedback = [];
            
            if (technical > 75) {
                feedback.push("ð¸ Sehr scharfes und gut belichtetes Bild!");
            } else if (technical < 50) {
                feedback.push("â ï¸ Bild kÃ¶nnte schÃ¤rfer oder besser belichtet sein");
            }
            
            if (composition > 70) {
                feedback.push("ð¨ Tolle Bildkomposition!");
            } else {
                feedback.push("ð¡ Tipp: Achte auf die Bildaufteilung");
            }
            
            if (creativity > 75) {
                feedback.push("â¨ Sehr kreative Aufnahme!");
            } else if (creativity > 60) {
                feedback.push("ð­ SchÃ¶ne kreative Elemente!");
            }
            
            feedback.push("ð¥ Toll, dass ihr als Team fotografiert!");
            
            return feedback;
        }

        function completeStation(stationId) {
            try {
                if (!tourApp.state.completedStations.includes(stationId)) {
                    tourApp.state.completedStations.push(stationId);
                    updateProgress();
                    showNotification('Station abgeschlossen! ð');
                    
                    const completeBtn = document.getElementById(`complete-btn-${stationId}`);
                    if (completeBtn) {
                        const stationCard = completeBtn.closest('.station-card');
                        if (stationCard) {
                            stationCard.classList.add('completed');
                            const stationNumber = stationCard.querySelector('.station-number');
                            if (stationNumber) {
                                stationNumber.classList.add('completed');
                            }
                        }
                        
                        completeBtn.disabled = true;
                        completeBtn.textContent = 'â Station abgeschlossen';
                        completeBtn.style.background = '#6b7280';
                    }

                    if (tourApp.state.completedStations.length === tourApp.stations.length) {
                        showNotification('ð Herzlichen GlÃ¼ckwunsch! Tour abgeschlossen!');
                        setTimeout(() => {
                            showTab('ranking', document.querySelector('.tab[onclick*="ranking"]'));
                        }, 2000);
                    }

                    saveState();
                    addSystemMessage(`${tourApp.state.userName} hat "${tourApp.stations.find(s => s.id === stationId)?.title}" abgeschlossen! ð`);
                }
            } catch (error) {
                console.error('Error completing station:', error);
            }
        }

        function updateUI() {
            try {
                const scoreElement = document.getElementById('totalScore');
                if (scoreElement) {
                    scoreElement.textContent = tourApp.state.totalScore;
                }
                updateProgress();
            } catch (error) {
                console.error('Error updating UI:', error);
            }
        }

        function updateProgress() {
            try {
                const progress = (tourApp.state.completedStations.length / tourApp.stations.length) * 100;
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        function resetTour() {
            try {
                if (confirm('Wirklich alle Daten zurÃ¼cksetzen?')) {
                    localStorage.removeItem(`chat_${tourApp.state.tourId}`);
                    
                    tourApp.state.completedStations = [];
                    tourApp.state.totalScore = 0;
                    tourApp.state.uploadedPhotos = [];
                    
                    saveState();
                    generateStationsList();
                    updateUI();
                    showNotification('Tour zurÃ¼ckgesetzt! ð');
                    addSystemMessage('Admin hat die Tour zurÃ¼ckgesetzt! ð');
                }
            } catch (error) {
                console.error('Error resetting tour:', error);
            }
        }

        // Map Functions
        function initMap() {
            try {
                if (tourApp.state.map || !document.getElementById('map')) return;
                
                if (typeof L === 'undefined') {
                    loadLeaflet(() => createMap());
                } else {
                    createMap();
                }
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        function loadLeaflet(callback) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
            script.onload = callback;
            script.onerror = () => showMapError();
            document.head.appendChild(script);
        }

        function createMap() {
            try {
                tourApp.state.map = L.map('map').setView([50.9375, 6.9597], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(tourApp.state.map);
                
                tourApp.stations.forEach(station => {
                    const isCompleted = tourApp.state.completedStations.includes(station.id);
                    const marker = L.marker([station.lat, station.lng])
                        .bindPopup(`
                            <div style="text-align: center; max-width: 200px;">
                                <h4>${station.title}</h4>
                                <p>${station.subtitle}</p>
                                <p><strong>Station ${station.id}/${tourApp.stations.length}</strong></p>
                                ${isCompleted ? '<p style="color: green;">â Abgeschlossen</p>' : '<p style="color: orange;">â³ Ausstehend</p>'}
                            </div>
                        `)
                        .addTo(tourApp.state.map);
                    
                    tourApp.state.markers.push(marker);
                });
                
                const routeCoordinates = tourApp.stations.map(station => [station.lat, station.lng]);
                L.polyline(routeCoordinates, {
                    color: '#dc2626',
                    weight: 3,
                    opacity: 0.7
                }).addTo(tourApp.state.map);
                
                if (tourApp.state.userLocation) {
                    addUserLocationToMap();
                }
            } catch (error) {
                console.error('Error creating map:', error);
            }
        }

        function showMapError() {
            const mapEl = document.getElementById('map');
            if (mapEl) {
                mapEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 10px;"><p>ðºï¸ Karte konnte nicht geladen werden</p></div>';
            }
        }

        function addUserLocationToMap() {
            try {
                if (!tourApp.state.map || !tourApp.state.userLocation) return;
                
                const userIcon = L.divIcon({
                    html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                    className: 'user-location-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                L.marker([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], {
                    icon: userIcon
                })
                .bindPopup('ð Dein Standort')
                .addTo(tourApp.state.map);
            } catch (error) {
                console.error('Error adding user location to map:', error);
            }
        }

        function centerOnUser() {
            try {
                if (tourApp.state.userLocation && tourApp.state.map) {
                    tourApp.state.map.setView([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], 17);
                } else {
                    showNotification('Standort nicht verfÃ¼gbar. Bitte erlaube Standortzugriff.', 'error');
                }
            } catch (error) {
                console.error('Error centering on user:', error);
            }
        }

        function initGeolocation() {
            try {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            tourApp.state.userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            updateLocationInfo();
                            if (tourApp.state.map) {
                                addUserLocationToMap();
                            }
                        },
                        error => {
                            const distanceInfo = document.getElementById('distanceInfo');
                            if (distanceInfo) {
                                distanceInfo.textContent = 'ð Standort nicht verfÃ¼gbar';
                            }
                        }
                    );
                }
            } catch (error) {
                console.error('Error initializing geolocation:', error);
            }
        }

        function updateLocationInfo() {
            try {
                if (!tourApp.state.userLocation) return;
                
                let nearestStation = null;
                let minDistance = Infinity;
                
                tourApp.stations.forEach(station => {
                    const distance = calculateDistance(
                        tourApp.state.userLocation.lat, tourApp.state.userLocation.lng,
                        station.lat, station.lng
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStation = station;
                    }
                });
                
                if (nearestStation) {
                    const distanceText = minDistance < 1 
                        ? `${Math.round(minDistance * 1000)}m` 
                        : `${minDistance.toFixed(1)}km`;
                    
                    const distanceInfo = document.getElementById('distanceInfo');
                    if (distanceInfo) {
                        distanceInfo.textContent = `ð NÃ¤chste Station: ${nearestStation.title} (${distanceText})`;
                    }
                }
            } catch (error) {
                console.error('Error updating location info:', error);
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function playAudio(url, type, title) {
            try {
                if (!url || url.trim() === '') {
                    showNotification('Audio-Datei noch nicht verfÃ¼gbar', 'warning');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    flex-direction: column;
                    padding: 20px;
                    box-sizing: border-box;
                `;
                
                let audioContent = '';
                
                switch(type) {
                    case 'youtube':
                        const youtubeId = extractYouTubeId(url);
                        if (youtubeId) {
                            audioContent = `
                                <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 90vw; width: 100%; max-width: 800px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                                    <h3 style="color: #1f2937; margin-bottom: 1rem; font-size: 1.3rem;">ðº ${title}</h3>
                                    <div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; margin-bottom: 1rem;">
                                        <iframe 
                                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 12px;" 
                                            src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&rel=0" 
                                            frameborder="0" 
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                            allowfullscreen>
                                        </iframe>
                                    </div>
                                    <p style="color: #6b7280; font-size: 0.9rem;">ð¬ In-App YouTube Player</p>
                                </div>
                            `;
                        } else {
                            audioContent = `
                                <div style="background: white; border-radius: 16px; padding: 2rem; text-align: center;">
                                    <h3 style="color: #dc2626;">â UngÃ¼ltige YouTube-URL</h3>
                                    <p style="color: #6b7280; margin-top: 1rem;">Bitte Ã¼berprÃ¼fen Sie die URL</p>
                                </div>
                            `;
                        }
                        break;
                        
                    case 'soundcloud':
                        const soundcloudEmbedUrl = generateSoundCloudEmbed(url);
                        audioContent = `
                            <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 90vw; width: 100%; max-width: 600px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                                <h3 style="color: #1f2937; margin-bottom: 1rem; font-size: 1.3rem;">âï¸ ${title}</h3>
                                <iframe 
                                    width="100%" 
                                    height="166" 
                                    scrolling="no" 
                                    frameborder="no" 
                                    src="${soundcloudEmbedUrl}"
                                    style="border-radius: 12px; margin-bottom: 1rem;">
                                </iframe>
                                <p style="color: #6b7280; font-size: 0.9rem;">ðµ In-App SoundCloud Player</p>
                            </div>
                        `;
                        break;
                        
                    case 'spotify':
                        const spotifyEmbedUrl = generateSpotifyEmbed(url);
                        if (spotifyEmbedUrl) {
                            audioContent = `
                                <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 90vw; width: 100%; max-width: 500px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                                    <h3 style="color: #1f2937; margin-bottom: 1rem; font-size: 1.3rem;">ð¢ ${title}</h3>
                                    <iframe 
                                        style="border-radius: 12px; margin-bottom: 1rem;" 
                                        src="${spotifyEmbedUrl}" 
                                        width="100%" 
                                        height="352" 
                                        frameborder="0" 
                                        allowtransparency="true" 
                                        allow="encrypted-media">
                                    </iframe>
                                    <p style="color: #6b7280; font-size: 0.9rem;">ð¶ In-App Spotify Player</p>
                                </div>
                            `;
                        } else {
                            audioContent = `
                                <div style="background: white; border-radius: 16px; padding: 2rem; text-align: center;">
                                    <h3 style="color: #dc2626;">â UngÃ¼ltige Spotify-URL</h3>
                                    <p style="color: #6b7280; margin-top: 1rem;">Bitte Ã¼berprÃ¼fen Sie die URL</p>
                                </div>
                            `;
                        }
                        break;
                        
                    case 'audio':
                    case 'podcast':
                        audioContent = `
                            <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 90vw; width: 100%; max-width: 500px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                                <h3 style="color: #1f2937; margin-bottom: 1.5rem; font-size: 1.3rem;">ðµ ${title}</h3>
                                <audio controls style="width: 100%; margin-bottom: 1.5rem; border-radius: 8px;" autoplay>
                                    <source src="${url}" type="audio/mpeg">
                                    <source src="${url}" type="audio/ogg">
                                    <source src="${url}" type="audio/wav">
                                    Ihr Browser unterstÃ¼tzt das Audio-Element nicht.
                                </audio>
                                <p style="color: #6b7280; font-size: 0.9rem;">ð§ In-App Audio Player</p>
                            </div>
                        `;
                        break;
                        
                    default:
                        audioContent = `
                            <div style="background: white; border-radius: 16px; padding: 2rem; text-align: center;">
                                <h3 style="color: #dc2626;">â Unbekannter Audio-Typ</h3>
                                <p style="color: #6b7280; margin-top: 1rem;">Typ "${type}" wird nicht unterstÃ¼tzt</p>
                            </div>
                        `;
                }
                
                modal.innerHTML = `
                    ${audioContent}
                    <button 
                        style="margin-top: 30px; padding: 12px 24px; background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: bold; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3); transition: all 0.3s;" 
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(220, 38, 38, 0.4)'" 
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(220, 38, 38, 0.3)'"
                        onclick="event.stopPropagation(); closeAudioModal(this.parentElement)">
                        â SchlieÃen
                    </button>
                `;
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        e.stopPropagation();
                        closeAudioModal(modal);
                    }
                });
                
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        e.stopPropagation();
                        closeAudioModal(modal);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
                
                modal.setAttribute('data-escape-handler', 'true');
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error playing audio:', error);
                showNotification('Fehler beim Abspielen der Audio-Datei', 'error');
            }
        }

        function closeAudioModal(modal) {
            try {
                if (modal && modal.parentElement) {
                    const escapeHandler = modal.getAttribute('data-escape-handler');
                    if (escapeHandler) {
                        document.removeEventListener('keydown', (e) => {
                            if (e.key === 'Escape') modal.remove();
                        });
                    }
                    modal.remove();
                }
            } catch (error) {
                console.error('Error closing audio modal:', error);
            }
        }

        function extractYouTubeId(url) {
            try {
                const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            } catch (error) {
                return null;
            }
        }

        function generateSoundCloudEmbed(url) {
            try {
                const encodedUrl = encodeURIComponent(url);
                return `https://w.soundcloud.com/player/?url=${encodedUrl}&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`;
            } catch (error) {
                return url;
            }
        }

        function generateSpotifyEmbed(url) {
            try {
                const spotifyRegex = /https:\/\/open\.spotify\.com\/(track|album|playlist|episode|show)\/([a-zA-Z0-9]+)/;
                const match = url.match(spotifyRegex);
                
                if (match) {
                    const [, type, id] = match;
                    return `https://open.spotify.com/embed/${type}/${id}?utm_source=generator&theme=0`;
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        function showImageModal(url, title, description) {
            try {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    flex-direction: column;
                    padding: 20px;
                    box-sizing: border-box;
                `;
                
                const imageContent = !url || url === 'placeholder' ? `
                    <div style="width: 300px; height: 200px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 3rem;">ð·</div>
                ` : `
                    <img src="${url}" style="max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px;" alt="${title}">
                `;
                
                modal.innerHTML = `
                    ${imageContent}
                    <div style="color: white; text-align: center; margin-top: 20px; max-width: 600px;">
                        <h3>${title}</h3>
                        <p>${description}</p>
                        <button 
                            style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;" 
                            onclick="event.stopPropagation(); closeImageModal(this.parentElement.parentElement)">
                            SchlieÃen
                        </button>
                    </div>
                `;
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        e.stopPropagation();
                        closeImageModal(modal);
                    }
                });

                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        e.stopPropagation();
                        closeImageModal(modal);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
                
                modal.setAttribute('data-escape-handler', 'true');
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error showing image modal:', error);
            }
        }

        function closeImageModal(modal) {
            try {
                if (modal && modal.parentElement) {
                    const escapeHandler = modal.getAttribute('data-escape-handler');
                    if (escapeHandler) {
                        document.removeEventListener('keydown', (e) => {
                            if (e.key === 'Escape') modal.remove();
                        });
                    }
                    modal.remove();
                }
            } catch (error) {
                console.error('Error closing image modal:', error);
            }
        }

        function showNotification(message, type = 'success') {
            try {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 4000);
            } catch (error) {
                console.error('Error showing notification:', error);
            }
        }

        function saveState() {
            try {
                const stateToSave = {
                    ...tourApp.state,
                    map: null,
                    markers: [],
                    syncListeners: []
                };
                localStorage.setItem('tourState', JSON.stringify(stateToSave));
            } catch (error) {
                console.error('Error saving state:', error);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('tourState');
                if (saved) {
                    const savedState = JSON.parse(saved);
                    tourApp.state = { ...tourApp.state, ...savedState };
                    
                    if (tourApp.state.selectedTeam) {
                        setTimeout(() => {
                            const teamOptions = document.querySelectorAll('.team-option');
                            teamOptions.forEach(option => {
                                if (option.textContent.includes(tourApp.state.teamName)) {
                                    option.classList.add('selected');
                                }
                            });
                            const selector = document.getElementById('teamSelector');
                            if (selector) {
                                selector.style.display = 'none';
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error loading state:', error);
            }
        }

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initApp, 100);
            });
        } else {
            setTimeout(initApp, 100);
        }

    </script>
</body>
</html>
