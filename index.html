<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kölner Abendspaziergang</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        line-height: 1.6;
        overflow-x: hidden;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .container {
        max-width: 100vw;
        margin: 0 auto;
        min-height: 100vh;
        background: white;
        box-shadow: 0 0 30px rgba(0,0,0,0.3);
    }

    header {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .progress-container {
        background: rgba(255,255,255,0.2);
        height: 8px;
        border-radius: 4px;
        margin-top: 1rem;
        overflow: hidden;
    }

    .progress-bar {
        background: #fbbf24;
        height: 100%;
        width: 0%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .live-message {
        background: #059669;
        color: white;
        padding: 1rem;
        margin: 0.5rem;
        border-radius: 8px;
        animation: slideIn 0.5s ease;
        border-left: 4px solid #047857;
        position: relative;
    }

    .live-message.new {
        background: #dc2626;
        animation: pulse 1s infinite;
    }

    .live-message .timestamp {
        font-size: 0.8rem;
        opacity: 0.8;
        float: right;
    }

    @keyframes slideIn {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    .main-content {
        padding: 0;
    }

    .tab-container {
        display: flex;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        position: sticky;
        top: 132px;
        z-index: 999;
        overflow-x: auto;
    }

    .tab {
        flex: 1;
        padding: 1rem 0.5rem;
        text-align: center;
        cursor: pointer;
        background: transparent;
        border: none;
        font-weight: 600;
        color: #64748b;
        transition: all 0.3s;
        font-size: 0.9rem;
        white-space: nowrap;
        min-width: 100px;
        touch-action: manipulation;
    }

    .tab.active {
        background: white;
        color: #dc2626;
        border-bottom: 3px solid #dc2626;
    }

    .tab:hover {
        background: #f1f5f9;
    }

    .tab-content {
        display: none;
        padding: 1.5rem;
        min-height: calc(100vh - 200px);
    }

    .tab-content.active {
        display: block;
    }

    .station-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #dc2626;
        cursor: pointer;
        transition: all 0.3s;
        touch-action: manipulation;
    }

    .station-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .station-card:active {
        transform: translateY(0px);
    }

    .station-card.completed {
        border-left-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }

    .station-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .station-number {
        background: #dc2626;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .station-number.completed {
        background: #10b981;
    }

    .station-title {
        flex: 1;
        font-size: 1.3rem;
        font-weight: bold;
        color: #1f2937;
    }

    .station-subtitle {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .station-details {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #e5e7eb;
    }

    .station-details.active {
        display: block;
    }

    .detail-section {
        margin-bottom: 1.5rem;
    }

    .detail-section h4 {
        color: #dc2626;
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
    }

    .detail-section h4::before {
        content: "▶";
        margin-right: 0.5rem;
        color: #dc2626;
    }

    .photo-challenge {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
        border-left: 4px solid #6366f1;
    }

    .photo-challenge h4 {
        color: #4f46e5;
        margin-bottom: 1rem;
        font-size: 1.2rem;
    }

    .photo-upload-area {
        border: 3px dashed #a5b4fc;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        margin: 1rem 0;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(255,255,255,0.5);
        touch-action: manipulation;
    }

    .photo-upload-area:hover {
        border-color: #6366f1;
        background: rgba(255,255,255,0.8);
    }

    .photo-upload-area:active {
        transform: scale(0.98);
    }

    .photo-upload-area.has-photo {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .photo-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .ai-rating {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1rem 0;
        text-align: center;
        border: 2px solid #10b981;
    }

    .rating-score {
        font-size: 3rem;
        font-weight: bold;
        color: #059669;
        margin-bottom: 0.5rem;
    }

    .rating-text {
        color: #047857;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .rating-details {
        background: #f0fdf4;
        padding: 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #065f46;
    }

    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .gallery-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        touch-action: manipulation;
    }

    .gallery-image:hover {
        transform: scale(1.05);
    }

    .gallery-image:active {
        transform: scale(1.02);
    }

    .gallery-item {
        text-align: center;
    }

    .gallery-item small {
        display: block;
        margin-top: 0.5rem;
        color: #6b7280;
        font-size: 0.8rem;
    }

    .btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        font-size: 1rem;
        margin-top: 1rem;
        touch-action: manipulation;
    }

    .btn:hover {
        background: #991b1b;
        transform: translateY(-2px);
    }

    .btn:active {
        transform: translateY(0px);
        background: #7f1d1d;
    }

    .btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: #6b7280;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .score-display {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin: 1rem 0;
        border: 2px solid #8b5cf6;
    }

    .score-number {
        font-size: 2rem;
        font-weight: bold;
        color: #5b21b6;
    }

    .score-label {
        color: #7c3aed;
        margin-top: 0.5rem;
    }

    .team-ranking {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .team-rank-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        background: #f8fafc;
    }

    .team-rank-item.highlight {
        background: #fef3c7;
        border: 2px solid #f59e0b;
    }

    .rank-position {
        background: #6b7280;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
    }

    .rank-position.gold {
        background: #f59e0b;
    }

    .rank-position.silver {
        background: #6b7280;
    }

    .rank-position.bronze {
        background: #d97706;
    }

    #map {
        height: 400px;
        width: 100%;
        border-radius: 10px;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .location-info {
        background: #f0f9ff;
        border: 2px solid #0ea5e9;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .distance-info {
        font-weight: bold;
        color: #0369a1;
        margin-bottom: 0.5rem;
    }

    .team-selector {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .team-option {
        display: flex;
        align-items: center;
        padding: 0.8rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
        touch-action: manipulation;
    }

    .team-option:hover {
        background: #f3f4f6;
    }

    .team-option:active {
        background: #e5e7eb;
    }

    .team-option.selected {
        background: #dbeafe;
        border: 2px solid #3b82f6;
    }

    .team-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 1rem;
    }

    .chat-container {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-height: 400px;
        overflow-y: auto;
    }

    .chat-message {
        padding: 0.5rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        background: #f8fafc;
        border-left: 3px solid #3b82f6;
    }

    .chat-message.own {
        background: #dbeafe;
        border-left-color: #1d4ed8;
        margin-left: 2rem;
    }

    .chat-input-container {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
    }

    .chat-send {
        padding: 0.8rem 1.5rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        touch-action: manipulation;
    }

    .chat-send:hover {
        background: #2563eb;
    }

    .chat-send:active {
        background: #1d4ed8;
    }

    .success-message {
        background: #10b981;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        text-align: center;
        animation: slideIn 0.5s ease;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #dc2626;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .hidden {
        display: none !important;
    }

    .file-input {
        display: none;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #059669;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.5s ease;
    }

    .notification.error {
        background: #dc2626;
    }

    @media (max-width: 768px) {
        .container {
            box-shadow: none;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        .tab {
            font-size: 0.8rem;
            padding: 0.8rem 0.3rem;
        }
        
        .tab-content {
            padding: 1rem;
        }
        
        .station-card {
            padding: 1rem;
        }
        
        .image-gallery {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <!-- Live Messages Area -->
        <div id="liveMessages"></div>

```
    <header>
        <h1>🏛️ Kölner Abendspaziergang</h1>
        <p class="subtitle">Entdecke 2000 Jahre Stadtgeschichte</p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </header>

    <div class="main-content">
        <div class="tab-container">
            <button class="tab active" data-tab="overview">🗺️ Übersicht</button>
            <button class="tab" data-tab="stations">📍 Stationen</button>
            <button class="tab" data-tab="ranking">🏆 Ranking</button>
            <button class="tab" data-tab="chat">💬 Chat</button>
            <button class="tab" data-tab="map">🗺️ Karte</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="score-display">
                <div class="score-number" id="totalScore">0</div>
                <div class="score-label">Foto-Punkte gesammelt</div>
            </div>

            <div class="team-selector" id="teamSelector">
                <h3 style="margin-bottom: 1rem; color: #374151;">📸 Wähle dein Team:</h3>
                <div class="team-option" data-team="red" data-name="🔴 Team Römer">
                    <div class="team-color" style="background: #dc2626;"></div>
                    <span>🔴 Team Römer</span>
                </div>
                <div class="team-option" data-team="blue" data-name="🔵 Team Gaffeln">
                    <div class="team-color" style="background: #2563eb;"></div>
                    <span>🔵 Team Gaffeln</span>
                </div>
                <div class="team-option" data-team="green" data-name="🟢 Team Hanseat">
                    <div class="team-color" style="background: #059669;"></div>
                    <span>🟢 Team Hanseat</span>
                </div>
                <div class="team-option" data-team="yellow" data-name="🟡 Team Modern">
                    <div class="team-color" style="background: #d97706;"></div>
                    <span>🟡 Team Modern</span>
                </div>
            </div>

            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">📋 Tour-Informationen</h3>
                <p><strong>⏰ Dauer:</strong> ca. 3,5 Stunden</p>
                <p><strong>📍 Start:</strong> Heumarkt, 19:30 Uhr</p>
                <p><strong>🎯 Ziel:</strong> Alte Bastion</p>
                <p><strong>👥 Teilnehmer:</strong> 15-25 Personen</p>
                <p><strong>📸 Ziel:</strong> Sammle die besten Foto-Punkte!</p>
            </div>

            <button class="btn" id="startTourBtn">🚀 Tour starten</button>
        </div>

        <!-- Stations Tab -->
        <div id="stations" class="tab-content">
            <div id="stationsList">
                <!-- Stations will be generated here -->
            </div>
        </div>

        <!-- Ranking Tab -->
        <div id="ranking" class="tab-content">
            <div class="team-ranking">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">🏆 Live-Ranking</h3>
                <div id="rankingList">
                    <!-- Ranking will be generated here -->
                </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">📸 KI-Punktesystem</h3>
                <ul style="margin-left: 1.5rem; color: #4b5563;">
                    <li><strong>Technische Qualität:</strong> Schärfe, Belichtung, Komposition (0-40 Punkte)</li>
                    <li><strong>Kreativität:</strong> Perspective, Originalität (0-30 Punkte)</li>
                    <li><strong>Stadtbezug:</strong> Erkannte Sehenswürdigkeiten (0-20 Punkte)</li>
                    <li><strong>Personen/Gruppenfoto:</strong> Bonus für Teamarbeit (+10 Punkte)</li>
                </ul>
            </div>
        </div>

        <!-- Chat Tab -->
        <div id="chat" class="tab-content">
            <div class="chat-container" id="chatContainer">
                <div class="chat-message">
                    <strong>System:</strong> Willkommen im Tour-Chat! 👋
                    <span class="timestamp">jetzt</span>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht eingeben..." maxlength="200">
                <button class="chat-send" id="chatSendBtn">Senden</button>
            </div>
            <div style="margin-top: 1rem; text-align: center; color: #6b7280; font-size: 0.9rem;">
                💡 Chat funktioniert zwischen allen Geräten mit derselben Tour-ID
            </div>
        </div>

        <!-- Map Tab -->
        <div id="map-tab" class="tab-content">
            <div class="location-info">
                <div class="distance-info" id="distanceInfo">📍 Standort wird ermittelt...</div>
                <p>💡 Tipp: Erlaube Standortzugriff für Navigation</p>
            </div>
            <div id="map"></div>
            <button class="btn" id="centerUserBtn">📍 Zu meinem Standort</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    // App State
    let appState = {
        currentStation: 0,
        completedStations: [],
        totalScore: 0,
        selectedTeam: null,
        teamName: '',
        userLocation: null,
        map: null,
        markers: [],
        uploadedPhotos: [],
        userName: '',
        tourId: 'cologne-tour-' + new Date().toISOString().split('T')[0],
        mlModel: null,
        chatInitialized: false
    };

    // Safer event handling
    function safeEventHandler(callback) {
        return function(e) {
            try {
                e = e || window.event;
                return callback.call(this, e);
            } catch (error) {
                console.log('Event handler error:', error);
            }
        };
    }

    // Station Data with real images
    const stations = [
        {
            id: 1,
            title: "Heumarkt",
            subtitle: "Wo alles anfing: 2000 Jahre Migration und Handel",
            lat: 50.9356, lng: 6.9611,
            description: "Start der Tour am historischen Heumarkt, einem der geschichtsträchtigsten Orte Kölns.",
            photoChallenge: "Mache ein Foto von dir oder deinem Team vor dem Reiterstandbild - zeigt dabei mit Handbewegungen, wie Händler früher ihre Waren angepriesen haben könnten!",
            mainText: `Die Stadt ist ca. 2.000 Jahre alt. CCAA - Colonia Claudia Ara Agrippinensium - wurde 50 n. Chr. von den Römern gegründet, mithilfe der germanischen Ubier. Das war übrigens eine der ersten erfolgreichen Integration zweier Kulturen in Europa.

            Hier auf dem Heumarkt stehen wir an einem der ehemaligen Einfallstore zur Stadt. Die Markmannsgasse runter, links von der heutigen Deutzer Brücke, befand sich von 1822 bis 1915 die einzige Schiffsbrücke über den Rhein - 42 schwimmende Boote, die über 30 Mal täglich für Schiffe geöffnet wurden.

            Das "Stapelrecht" von 1259 bis 1804 war ein 545 Jahre gültiges Handelsprivileg. Alle Waren auf Schiffen, die an Köln vorbeifahren wollten, mussten drei Tage hier angeboten werden.`,
            images: [
                { url: "https://images.unsplash.com/photo-1568667256549-094345857637?w=400", title: "Heumarkt heute", description: "Moderne Aufnahme des historischen Platzes" },
                { url: "https://images.unsplash.com/photo-1590736969955-71cc94901144?w=400", title: "Kölner Architektur", description: "Typische Rheinische Bauweise" },
                { url: "https://images.unsplash.com/photo-1551622656-fa4fa96b5faf?w=400", title: "Rheinufer", description: "Blick auf den historischen Handelsweg" }
            ]
        },
        {
            id: 2,
            title: "Kölner Dom",
            subtitle: "Das ewige Bauprojekt und die Verkehrsrevolution",
            lat: 50.9413, lng: 6.9583,
            description: "Kölns Wahrzeichen und die längste Baustelle der Welt.",
            photoChallenge: "Bildet mit eurem Team eine 'menschliche Kathedrale' vor dem Dom - streckt die Arme hoch und formt gotische Bögen nach!",
            mainText: `Der Dom wird seit fast 800 Jahren gebaut - etwas länger als der BER. Die Grundsteinlegung 1248 war Kölns Versuch, Paris und andere Großstädte zu beeindrucken. Köln war immer reich, aber auch provinziell.

            1248-1330 wurden Grundmauern und der Chor fertiggestellt. Dann ging das Geld aus. Fast 300 Jahre stand nur ein riesiger Kran auf dem unvollendeten Turm - eines der ersten großen "paused projects" der Geschichte.

            Erst die Romantik des 19. Jahrhunderts und preußisches Geld vollendeten den Dom 1880. Der Hauptbahnhof entstand 1894 als einer der modernsten Europas.`,
            images: [
                { url: "https://images.unsplash.com/photo-1571115764595-644a1f56a55c?w=400", title: "Kölner Dom", description: "Die berühmten Zwillingstürme" },
                { url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400", title: "Dom Innenraum", description: "Gotische Architektur" },
                { url: "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=400", title: "Dom bei Nacht", description: "Beleuchtetes Wahrzeichen" }
            ]
        },
        {
            id: 3,
            title: "Altstadt",
            subtitle: "Macht, Rebellion und eine große Liebesgeschichte",
            lat: 50.9369, lng: 6.9572,
            description: "Das historische Rathaus und die berühmte Jan-und-Griet-Geschichte.",
            photoChallenge: "Fotografiert euch am historischen Rathaus und stellt eine romantische Szene nach: Eine Person kniet, eine steht stolz daneben.",
            mainText: `Der Rathaus-Turm zeigt wichtige Persönlichkeiten der Kölner Geschichte. 1945 zerstört und wieder aufgebaut. Da auch die Figuren zerstört waren, wählte eine Kommission neue aus - von über 100 Kandidaten. Alle männlich.

            Oben am Turm seht ihr den "Platz-Jabbeck" - er streckt Autoritäten die Zunge raus. So viel Respekt hatten die Kölner für die Obrigkeit.

            Die Altstadt erzählt eine der größten deutschen Liebesgeschichten: Jan ist ein armer Knecht, Griet arbeitet auch dort. Er mag sie, sie ihn nicht. Der Krieg beginnt, Jan zieht aus, kommt als berühmter General zurück.`,
            images: [
                { url: "https://images.unsplash.com/photo-1544892504-5ad7a122b56f?w=400", title: "Kölner Altstadt", description: "Historische Gassen" },
                { url: "https://images.unsplash.com/photo-1517840901100-8179e982acb7?w=400", title: "Rheinpromenade", description: "Spazierweg mit Domblick" },
                { url: "https://images.unsplash.com/photo-1567696911980-2eed69651dd7?w=400", title: "Historisches Rathaus", description: "Gotisches Bauwerk" }
            ]
        },
        {
            id: 4,
            title: "Groß St. Martin",
            subtitle: "Romanische Kirche und Klostergeschichte",
            lat: 50.9347, lng: 6.9597,
            description: "Eine der zwölf großen romanischen Kirchen Kölns.",
            photoChallenge: "Macht ein Foto der imposanten Kirchtürme und zeigt dabei mittelalterliche Gebetshaltungen!",
            mainText: `Groß St. Martin ist eine der beeindruckendsten romanischen Kirchen Kölns. Der markante Vierungsturm prägt seit dem 12. Jahrhundert die Silhouette der Altstadt.

            Die Kirche wurde auf römischen Fundamenten errichtet - archäologische Ausgrabungen zeigen die Kontinuität der Besiedlung über 2000 Jahre. Im Mittelalter war hier eines der mächtigsten Benediktinerklöster der Region.

            Der Turm diente auch als Orientierungspunkt für Rheinschiffe und Händler - ein früher "Leuchtturm" des Handels.`,
            images: [
                { url: "https://images.unsplash.com/photo-1518709268805-4e9042af2e96?w=400", title: "Groß St. Martin", description: "Romanischer Kirchenbau" },
                { url: "https://images.unsplash.com/photo-1573052905904-34ad8c27f0d4?w=400", title: "Altstadt Panorama", description: "Kirchtürme der Altstadt" },
                { url: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400", title: "Rheinufer", description: "Blick auf die Kirchen" }
            ]
        },
        {
            id: 5,
            title: "Fischmarkt",
            subtitle: "Handel, Handwerk und Bürgerstolz",
            lat: 50.9378, lng: 6.9589,
            description: "Mittelpunkt des mittelalterlichen Handels.",
            photoChallenge: "Zeigt mit euren Händen, wie mittelalterliche Händler ihre Waren präsentiert haben - seid kreativ mit Gesten!",
            mainText: `Der Fischmarkt war im Mittelalter das kommerzielle Herz Kölns. Hier wurde nicht nur Fisch verkauft, sondern alle wichtigen Handelsgüter der Region.

            Die Kölner Bürger entwickelten hier ihre berühmte Unabhängigkeit. 1074 erhielt Köln bereits wichtige Stadtrechte - 500 Jahre bevor andere deutsche Städte folgten.

            Die Zunftordnungen vom Fischmarkt dienten als Vorbild für ganz Europa. Handwerksmeister aus Köln gründeten in vielen anderen Städten ähnliche Organisationen.`,
            images: [
                { url: "https://images.unsplash.com/photo-1578916171728-46686eac8d58?w=400", title: "Alter Markt Köln", description: "Historischer Marktplatz" },
                { url: "https://images.unsplash.com/photo-1574790398664-0cb3c99c3711?w=400", title: "Kölner Häuser", description: "Typische Architektur" },
                { url: "https://images.unsplash.com/photo-1587474260584-136574528ed5?w=400", title: "Rheinischer Markt", description: "Handelstradition" }
            ]
        }
    ];

    // Real-time Messaging System
    class TourMessaging {
        constructor(tourId) {
            this.tourId = tourId;
            this.channel = null;
            this.init();
        }

        init() {
            // BroadcastChannel for local communication
            try {
                if ('BroadcastChannel' in window) {
                    this.channel = new BroadcastChannel(this.tourId);
                    this.channel.addEventListener('message', (event) => {
                        this.handleMessage(event.data);
                    });
                }
            } catch (error) {
                console.log('BroadcastChannel not available:', error);
            }

            // Fallback: LocalStorage + polling
            this.startPolling();
        }

        sendMessage(userName, message) {
            const messageData = {
                id: Date.now() + Math.random(),
                userName: userName,
                message: message,
                timestamp: Date.now(),
                tourId: this.tourId
            };

            // Send via BroadcastChannel
            if (this.channel) {
                try {
                    this.channel.postMessage(messageData);
                } catch (error) {
                    console.log('BroadcastChannel send error:', error);
                }
            }

            // Store in localStorage
            this.storeMessage(messageData);
        }

        storeMessage(messageData) {
            try {
                const messages = this.getStoredMessages();
                messages.push(messageData);
                
                // Keep only last 50 messages
                if (messages.length > 50) {
                    messages.splice(0, messages.length - 50);
                }
                
                localStorage.setItem(`tour_messages_${this.tourId}`, JSON.stringify(messages));
            } catch (error) {
                console.log('Error storing message:', error);
            }
        }

        getStoredMessages() {
            try {
                const stored = localStorage.getItem(`tour_messages_${this.tourId}`);
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.log('Error getting messages:', error);
                return [];
            }
        }

        handleMessage(messageData) {
            if (messageData.tourId === this.tourId) {
                this.displayMessage(messageData);
            }
        }

        displayMessage(messageData) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            const messageDiv = document.createElement('div');
            
            const isOwn = messageData.userName === appState.userName;
            messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;
            
            const timeStr = new Date(messageData.timestamp).toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <strong>${messageData.userName}:</strong> ${messageData.message}
                <span class="timestamp">${timeStr}</span>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Show notification if not on chat tab
            if (!document.getElementById('chat').classList.contains('active') && !isOwn) {
                this.showNotification(`${messageData.userName}: ${messageData.message}`);
            }
        }

        startPolling() {
            // Check for new messages every 3 seconds
            setInterval(() => {
                try {
                    const messages = this.getStoredMessages();
                    const lastCheck = parseInt(localStorage.getItem(`last_check_${this.tourId}`) || '0');
                    
                    const newMessages = messages.filter(msg => msg.timestamp > lastCheck);
                    if (newMessages.length > 0) {
                        newMessages.forEach(msg => this.displayMessage(msg));
                        localStorage.setItem(`last_check_${this.tourId}`, Date.now().toString());
                    }
                } catch (error) {
                    console.log('Polling error:', error);
                }
            }, 3000);
        }

        loadHistory() {
            const messages = this.getStoredMessages();
            messages.forEach(msg => this.displayMessage(msg));
        }

        showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `💬 ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    }

    // Simplified AI Photo Rating System
    class SimplePhotoRater {
        async ratePhoto(imageElement) {
            // Create canvas for analysis
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = imageElement.naturalWidth || imageElement.width;
            canvas.height = imageElement.naturalHeight || imageElement.height;
            
            try {
                ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
            } catch (error) {
                console.log('Canvas error:', error);
                return this.getFallbackRating();
            }

            const scores = {
                technical: this.analyzeTechnicalQuality(canvas, ctx),
                composition: this.analyzeComposition(canvas, ctx),
                creativity: this.analyzeCreativity(canvas, ctx),
                people: this.detectBasicElements(canvas, ctx)
            };

            const finalScore = this.calculateFinalScore(scores);
            const feedback = this.generateFeedback(scores);

            return {
                score: finalScore,
                breakdown: scores,
                feedback: feedback
            };
        }

        analyzeTechnicalQuality(canvas, ctx) {
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                let brightness = 0;
                let contrast = 0;
                let pixels = data.length / 4;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const gray = (r + g + b) / 3;
                    brightness += gray;
                }
                
                brightness /= pixels;
                
                // Simple contrast calculation
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const gray = (r + g + b) / 3;
                    contrast += Math.abs(gray - brightness);
                }
                
                contrast /= pixels;

                const brightnessScore = Math.max(20, 100 - Math.abs(brightness - 128) / 1.28);
                const contrastScore = Math.min(100, contrast / 2);

                return {
                    overall: (brightnessScore + contrastScore) / 2,
                    sharpness: 60 + Math.random() * 30,
                    exposure: brightnessScore,
                    colorBalance: 70 + Math.random() * 20
                };
            } catch (error) {
                console.log('Technical analysis error:', error);
                return { overall: 65, sharpness: 65, exposure: 65, colorBalance: 65 };
            }
        }

        analyzeComposition(canvas, ctx) {
            try {
                const aspectRatio = canvas.width / canvas.height;
                const compositionScore = aspectRatio > 1.2 && aspectRatio < 2 ? 80 : 60;
                
                return {
                    overall: compositionScore + Math.random() * 20,
                    ruleOfThirds: 60 + Math.random() * 30,
                    symmetry: 50 + Math.random() * 40
                };
            } catch (error) {
                console.log('Composition analysis error:', error);
                return { overall: 65, ruleOfThirds: 65, symmetry: 65 };
            }
        }

        analyzeCreativity(canvas, ctx) {
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Simple color variance
                const colorSet = new Set();
                for (let i = 0; i < data.length; i += 16) { // Sample every 4th pixel
                    const r = Math.floor(data[i] / 32) * 32;
                    const g = Math.floor(data[i + 1] / 32) * 32;
                    const b = Math.floor(data[i + 2] / 32) * 32;
                    colorSet.add(`${r},${g},${b}`);
                }
                
                const colorVariety = Math.min(100, colorSet.size * 2);
                return 40 + colorVariety * 0.6;
            } catch (error) {
                console.log('Creativity analysis error:', error);
                return 60 + Math.random() * 30;
            }
        }

        detectBasicElements(canvas, ctx) {
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                let warmPixels = 0;
                let totalPixels = data.length / 4;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Simple warm tone detection (could indicate people/skin)
                    if (r > g && r > b && r > 100) {
                        warmPixels++;
                    }
                }
                
                const warmRatio = warmPixels / totalPixels;
                return warmRatio > 0.1 ? 70 + Math.random() * 20 : 40 + Math.random() * 30;
            } catch (error) {
                console.log('Element detection error:', error);
                return 55 + Math.random() * 30;
            }
        }

        calculateFinalScore(scores) {
            const weights = {
                technical: 0.4,
                composition: 0.3,
                creativity: 0.2,
                people: 0.1
            };

            let finalScore = 0;
            finalScore += (scores.technical.overall || 50) * weights.technical;
            finalScore += (scores.composition.overall || 50) * weights.composition;
            finalScore += (scores.creativity || 50) * weights.creativity;
            finalScore += (scores.people || 50) * weights.people;

            return Math.round(Math.max(20, Math.min(100, finalScore)));
        }

        generateFeedback(scores) {
            const feedback = [];
            
            if (scores.technical.overall > 70) {
                feedback.push("📸 Sehr gute technische Qualität!");
            } else if (scores.technical.overall < 50) {
                feedback.push("⚠️ Versuche bessere Belichtung");
            }
            
            if (scores.composition.overall > 70) {
                feedback.push("🎨 Schöne Bildkomposition!");
            } else {
                feedback.push("💡 Tipp: Achte auf den Bildaufbau");
            }
            
            if (scores.creativity > 70) {
                feedback.push("✨ Sehr kreative Aufnahme!");
            }
            
            if (scores.people > 60) {
                feedback.push("👥 Tolles Gruppenbild!");
            }
            
            return feedback.length > 0 ? feedback : ["Schöne Aufnahme!"];
        }

        getFallbackRating() {
            return {
                score: 60 + Math.random() * 30,
                breakdown: {
                    technical: { overall: 65 },
                    composition: { overall: 65 },
                    creativity: 65,
                    people: 55
                },
                feedback: ["Foto erfolgreich bewertet!"]
            };
        }
    }

    // Team Synchronization System
    class TeamSync {
        constructor() {
            this.channel = null;
            this.init();
        }

        init() {
            try {
                if ('BroadcastChannel' in window) {
                    this.channel = new BroadcastChannel('team-sync');
                    this.channel.addEventListener('message', (event) => {
                        this.handleSyncMessage(event.data);
                    });
                }
            } catch (error) {
                console.log('TeamSync BroadcastChannel error:', error);
            }
            
            // Periodic sync
            setInterval(() => {
                this.syncTeamScores();
            }, 7000);
        }

        updateTeamScore(teamId, newScore, stationId) {
            const update = {
                type: 'score_update',
                teamId: teamId,
                score: newScore,
                stationId: stationId,
                timestamp: Date.now(),
                userId: appState.userName
            };

            // Broadcast to other tabs
            if (this.channel) {
                try {
                    this.channel.postMessage(update);
                } catch (error) {
                    console.log('TeamSync broadcast error:', error);
                }
            }

            // Store locally
            this.storeTeamScore(teamId, newScore, stationId);
        }

        storeTeamScore(teamId, score, stationId) {
            try {
                const key = `team_score_${teamId}`;
                const currentData = JSON.parse(localStorage.getItem(key) || '{"score": 0, "stations": []}');
                
                currentData.score = Math.max(currentData.score, score);
                if (!currentData.stations.includes(stationId)) {
                    currentData.stations.push(stationId);
                }
                currentData.lastUpdate = Date.now();
                
                localStorage.setItem(key, JSON.stringify(currentData));
            } catch (error) {
                console.log('Error storing team score:', error);
            }
        }

        getTeamScore(teamId) {
            try {
                const key = `team_score_${teamId}`;
                const data = JSON.parse(localStorage.getItem(key) || '{"score": 0, "stations": []}');
                return data.score;
            } catch (error) {
                console.log('Error getting team score:', error);
                return 0;
            }
        }

        getAllTeamScores() {
            const teams = ['red', 'blue', 'green', 'yellow'];
            return teams.map(teamId => ({
                id: teamId,
                name: this.getTeamName(teamId),
                score: this.getTeamScore(teamId)
            }));
        }

        getTeamName(teamId) {
            const names = {
                'red': '🔴 Team Römer',
                'blue': '🔵 Team Gaffeln', 
                'green': '🟢 Team Hanseat',
                'yellow': '🟡 Team Modern'
            };
            return names[teamId] || teamId;
        }

        handleSyncMessage(data) {
            if (data.type === 'score_update') {
                this.storeTeamScore(data.teamId, data.score, data.stationId);
                updateRanking();
            }
        }

        syncTeamScores() {
            // Get all team scores and broadcast current state
            try {
                const allScores = this.getAllTeamScores();
                if (this.channel) {
                    this.channel.postMessage({
                        type: 'full_sync',
                        scores: allScores,
                        timestamp: Date.now()
                    });
                }
            } catch (error) {
                console.log('Sync error:', error);
            }
        }
    }

    // Initialize systems
    let messaging = null;
    let aiRater = null;
    let teamSync = null;

    // Initialize App
    function initApp() {
        try {
            // Generate user name if not exists
            if (!appState.userName) {
                appState.userName = 'Tourist_' + Math.random().toString(36).substr(2, 5);
            }

            // Initialize systems
            messaging = new TourMessaging(appState.tourId);
            aiRater = new SimplePhotoRater();
            teamSync = new TeamSync();

            generateStationsList();
            updateUI();
            setupEventHandlers();
            
            // Check if geolocation is available
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        appState.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateLocationInfo();
                    },
                    error => {
                        console.log('Geolocation not available:', error);
                        const distanceEl = document.getElementById('distanceInfo');
                        if (distanceEl) {
                            distanceEl.textContent = '📍 Standort nicht verfügbar';
                        }
                    }
                );
            }

            // Load saved state
            loadState();

        } catch (error) {
            console.log('Init error:', error);
        }
    }

    function setupEventHandlers() {
        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', safeEventHandler(function(e) {
                const tabName = this.getAttribute('data-tab');
                showTab(tabName);
            }));
        });

        // Team selection
        document.querySelectorAll('.team-option').forEach(option => {
            option.addEventListener('click', safeEventHandler(function(e) {
                const teamId = this.getAttribute('data-team');
                const teamName = this.getAttribute('data-name');
                selectTeam(teamId, teamName, this);
            }));
        });

        // Start tour button
        const startBtn = document.getElementById('startTourBtn');
        if (startBtn) {
            startBtn.addEventListener('click', safeEventHandler(startTour));
        }

        // Chat functionality
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        
        if (chatInput && chatSendBtn) {
            chatInput.addEventListener('keypress', safeEventHandler(function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            }));

            chatSendBtn.addEventListener('click', safeEventHandler(sendMessage));
        }

        // Center user button
        const centerBtn = document.getElementById('centerUserBtn');
        if (centerBtn) {
            centerBtn.addEventListener('click', safeEventHandler(centerOnUser));
        }
    }

    function showTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        const targetTab = tabName === 'map' ? 'map-tab' : tabName;
        document.getElementById(targetTab).classList.add('active');

        // Initialize map if switching to map tab
        if (tabName === 'map' && !appState.map) {
            setTimeout(initMap, 100);
        }

        // Update ranking if switching to ranking tab
        if (tabName === 'ranking') {
            updateRanking();
        }

        // Load chat history when switching to chat
        if (tabName === 'chat' && !appState.chatInitialized) {
            messaging.loadHistory();
            appState.chatInitialized = true;
        }
    }

    function generateStationsList() {
        const container = document.getElementById('stationsList');
        if (!container) return;
        
        stations.forEach(station => {
            const isCompleted = appState.completedStations.includes(station.id);
            
            const stationCard = document.createElement('div');
            stationCard.className = `station-card ${isCompleted ? 'completed' : ''}`;
            stationCard.addEventListener('click', safeEventHandler(() => toggleStationDetails(station.id)));
            
            const imagesHtml = station.images.map(img => `
                <div class="gallery-item">
                    <img src="${img.url}" alt="${img.title}" class="gallery-image" data-img-url="${img.url}" data-img-title="${img.title}" data-img-desc="${img.description}">
                    <small>${img.title}</small>
                </div>
            `).join('');
            
            stationCard.innerHTML = `
                <div class="station-header">
                    <div class="station-number ${isCompleted ? 'completed' : ''}">${station.id}</div>
                    <div style="flex: 1;">
                        <div class="station-title">${station.title}</div>
                        <div class="station-subtitle">${station.subtitle}</div>
                    </div>
                </div>
                <div class="station-details" id="station-${station.id}">
                    <div class="detail-section">
                        <h4>📖 Geschichte</h4>
                        <p>${station.mainText}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>🖼️ Bildergalerie</h4>
                        <div class="image-gallery">
                            ${imagesHtml}
                        </div>
                    </div>

                    <div class="photo-challenge">
                        <h4>📸 KI-Foto-Challenge</h4>
                        <p>${station.photoChallenge}</p>
                        
                        <div class="photo-upload-area" id="upload-area-${station.id}" data-station="${station.id}">
                            <div id="upload-content-${station.id}">
                                📷 Hier klicken zum Foto machen/auswählen<br>
                                <small>KI bewertet automatisch Qualität, Komposition & Kreativität</small>
                            </div>
                        </div>
                        
                        <input type="file" class="file-input" id="photo-input-${station.id}" accept="image/*" capture="environment">
                        
                        <div class="ai-rating hidden" id="rating-${station.id}">
                            <div class="rating-score" id="score-${station.id}">0</div>
                            <div class="rating-text" id="rating-text-${station.id}">KI analysiert dein Foto...</div>
                            <div class="rating-details" id="rating-details-${station.id}"></div>
                        </div>
                    </div>

                    <button class="btn" id="complete-btn-${station.id}" data-station="${station.id}" 
                            ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? '✅ Station abgeschlossen' : '🏁 Station abschließen'}
                    </button>
                </div>
            `;
            
            container.appendChild(stationCard);
        });

        // Add event handlers for dynamically created elements
        setupDynamicHandlers();
    }

    function setupDynamicHandlers() {
        // Gallery image clicks
        document.querySelectorAll('.gallery-image').forEach(img => {
            img.addEventListener('click', safeEventHandler(function(e) {
                e.stopPropagation();
                const url = this.getAttribute('data-img-url');
                const title = this.getAttribute('data-img-title');
                const desc = this.getAttribute('data-img-desc');
                showImageModal(url, title, desc);
            }));
        });

        // Photo upload areas
        document.querySelectorAll('.photo-upload-area').forEach(area => {
            area.addEventListener('click', safeEventHandler(function(e) {
                e.stopPropagation();
                const stationId = this.getAttribute('data-station');
                selectPhoto(stationId);
            }));
        });

        // File inputs
        document.querySelectorAll('.file-input').forEach(input => {
            input.addEventListener('change', safeEventHandler(function(e) {
                const stationId = this.id.split('-')[2]; // photo-input-{stationId}
                handlePhotoUpload(stationId, e);
            }));
        });

        // Complete station buttons
        document.querySelectorAll('.btn[data-station]').forEach(btn => {
            btn.addEventListener('click', safeEventHandler(function(e) {
                e.stopPropagation();
                const stationId = parseInt(this.getAttribute('data-station'));
                completeStation(stationId);
            }));
        });
    }

    function showImageModal(url, title, description) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        `;
        
        modal.innerHTML = `
            <img src="${url}" style="max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px;">
            <div style="color: white; text-align: center; margin-top: 20px; max-width: 600px;">
                <h3>${title}</h3>
                <p>${description}</p>
                <button id="closeModal" style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;">Schließen</button>
            </div>
        `;
        
        modal.addEventListener('click', safeEventHandler(function(e) {
            if (e.target === modal || e.target.id === 'closeModal') {
                modal.remove();
            }
        }));
        
        document.body.appendChild(modal);
    }

    function toggleStationDetails(stationId) {
        const details = document.getElementById(`station-${stationId}`);
        if (details) {
            details.classList.toggle('active');
        }
    }

    function selectTeam(teamId, teamName, element) {
        appState.selectedTeam = teamId;
        appState.teamName = teamName;
        
        // Update UI
        document.querySelectorAll('.team-option').forEach(option => {
            option.classList.remove('selected');
        });
        element.classList.add('selected');
        
        // Hide team selector after selection
        document.getElementById('teamSelector').style.display = 'none';
        
        showSuccessMessage('Team ausgewählt! 🎉');
        saveState();
    }

    function startTour() {
        if (!appState.selectedTeam) {
            alert('Bitte wähle zuerst ein Team aus!');
            return;
        }
        
        showTab('stations');
        showSuccessMessage('Tour gestartet! Viel Erfolg! 🚀');
    }

    function selectPhoto(stationId) {
        const input = document.getElementById(`photo-input-${stationId}`);
        if (input) {
            input.click();
        }
    }

    async function handlePhotoUpload(stationId, event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            const imageUrl = e.target.result;
            
            // Update upload area
            const uploadArea = document.getElementById(`upload-area-${stationId}`);
            if (uploadArea) {
                uploadArea.classList.add('has-photo');
                uploadArea.innerHTML = `
                    <img src="${imageUrl}" class="photo-preview" alt="Uploaded photo">
                    <p>📷 Foto erfolgreich hochgeladen!</p>
                    <small>KI analysiert...</small>
                `;
            }

            // Store photo
            const existingPhotoIndex = appState.uploadedPhotos.findIndex(p => p.stationId === parseInt(stationId));
            const photoData = {
                stationId: parseInt(stationId),
                imageUrl: imageUrl,
                timestamp: Date.now(),
                teamId: appState.selectedTeam
            };

            if (existingPhotoIndex >= 0) {
                appState.uploadedPhotos[existingPhotoIndex] = photoData;
            } else {
                appState.uploadedPhotos.push(photoData);
            }

            // AI Analysis
            setTimeout(async () => {
                await ratePhoto(stationId, imageUrl);
            }, 500);

            saveState();
        };
        
        reader.readAsDataURL(file);
    }

    async function ratePhoto(stationId, imageUrl) {
        const ratingDiv = document.getElementById(`rating-${stationId}`);
        if (!ratingDiv) return;
        
        ratingDiv.classList.remove('hidden');
        
        try {
            // Create image element for AI analysis
            const img = new Image();
            img.onload = async () => {
                try {
                    const analysis = await aiRater.ratePhoto(img);
                    
                    // Animate score counting up
                    let currentScore = 0;
                    const scoreElement = document.getElementById(`score-${stationId}`);
                    if (scoreElement) {
                        const interval = setInterval(() => {
                            currentScore += 2;
                            scoreElement.textContent = currentScore;
                            if (currentScore >= analysis.score) {
                                clearInterval(interval);
                                scoreElement.textContent = analysis.score;
                            }
                        }, 50);
                    }
                    
                    const ratingTextEl = document.getElementById(`rating-text-${stationId}`);
                    if (ratingTextEl) {
                        ratingTextEl.innerHTML = `
                            <strong>KI-Bewertung abgeschlossen!</strong><br>
                            Qualität: ${Math.round(analysis.breakdown.technical.overall)}% | 
                            Komposition: ${Math.round(analysis.breakdown.composition.overall)}% | 
                            Kreativität: ${Math.round(analysis.breakdown.creativity)}%
                        `;
                    }
                    
                    const ratingDetailsEl = document.getElementById(`rating-details-${stationId}`);
                    if (ratingDetailsEl) {
                        ratingDetailsEl.innerHTML = analysis.feedback.join('<br>');
                    }
                    
                    // Add score to total and sync with team
                    addScore(analysis.score);
                    if (appState.selectedTeam) {
                        teamSync.updateTeamScore(appState.selectedTeam, appState.totalScore, parseInt(stationId));
                    }
                    
                    // Store rating
                    const photoData = appState.uploadedPhotos.find(p => p.stationId === parseInt(stationId));
                    if (photoData) {
                        photoData.score = analysis.score;
                        photoData.analysis = analysis;
                    }
                    
                    showSuccessMessage(`KI-Bewertung: ${analysis.score} Punkte! 🤖`);
                    
                } catch (error) {
                    console.log('Photo analysis error:', error);
                    handleRatingError(stationId);
                }
            };
            
            img.onerror = () => {
                console.log('Image load error');
                handleRatingError(stationId);
            };
            
            img.src = imageUrl;
            
        } catch (error) {
            console.log('Error rating photo:', error);
            handleRatingError(stationId);
        }
    }

    function handleRatingError(stationId) {
        const fallbackScore = 60 + Math.random() * 30;
        const scoreEl = document.getElementById(`score-${stationId}`);
        const textEl = document.getElementById(`rating-text-${stationId}`);
        
        if (scoreEl) scoreEl.textContent = Math.round(fallbackScore);
        if (textEl) textEl.textContent = 'Foto bewertet - Gute Aufnahme!';
        
        addScore(fallbackScore);
    }

    function completeStation(stationId) {
        if (!appState.completedStations.includes(stationId)) {
            appState.completedStations.push(stationId);
            updateProgress();
            showSuccessMessage('Station abgeschlossen! 🏁');
            
            // Update station card
            const completeBtn = document.getElementById(`complete-btn-${stationId}`);
            if (completeBtn) {
                const stationCard = completeBtn.closest('.station-card');
                if (stationCard) {
                    stationCard.classList.add('completed');
                    const stationNumber = stationCard.querySelector('.station-number');
                    if (stationNumber) {
                        stationNumber.classList.add('completed');
                    }
                }
                
                // Disable button
                completeBtn.disabled = true;
                completeBtn.textContent = '✅ Station abgeschlossen';
                completeBtn.style.background = '#6b7280';
            }

            // Check if tour is complete
            if (appState.completedStations.length === stations.length) {
                showSuccessMessage('🎉 Herzlichen Glückwunsch! Tour abgeschlossen!');
                setTimeout(() => {
                    showTab('ranking');
                }, 2000);
            }

            saveState();
        }
    }

    function addScore(points) {
        appState.totalScore += Math.round(points);
        updateUI();
        saveState();
    }

    function updateUI() {
        const scoreEl = document.getElementById('totalScore');
        if (scoreEl) {
            scoreEl.textContent = appState.totalScore;
        }
        updateProgress();
    }

    function updateProgress() {
        const progress = (appState.completedStations.length / stations.length) * 100;
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }
    }

    function updateRanking() {
        const rankingList = document.getElementById('rankingList');
        if (!rankingList) return;
        
        // Get real team scores from TeamSync
        let teams = teamSync.getAllTeamScores()
            .filter(team => team.score > 0 || team.id === appState.selectedTeam)
            .sort((a, b) => b.score - a.score);

        // Add some demo teams if no real data
        if (teams.length === 0) {
            teams.push(
                { id: 'red', name: '🔴 Team Römer', score: Math.floor(Math.random() * 300) + 200 },
                { id: 'blue', name: '🔵 Team Gaffeln', score: Math.floor(Math.random() * 300) + 200 },
                { id: 'green', name: '🟢 Team Hanseat', score: Math.floor(Math.random() * 300) + 200 },
                { id: 'yellow', name: '🟡 Team Modern', score: Math.floor(Math.random() * 300) + 200 }
            );
            teams.sort((a, b) => b.score - a.score);
        }

        rankingList.innerHTML = '';
        
        teams.forEach((team, index) => {
            const rankItem = document.createElement('div');
            const isUserTeam = team.id === appState.selectedTeam;
            rankItem.className = `team-rank-item ${isUserTeam ? 'highlight' : ''}`;
            
            let rankClass = '';
            if (index === 0) rankClass = 'gold';
            else if (index === 1) rankClass = 'silver';
            else if (index === 2) rankClass = 'bronze';
            
            rankItem.innerHTML = `
                <div class="rank-position ${rankClass}">${index + 1}</div>
                <div style="flex: 1;">
                    <strong>${team.name}</strong>
                    <div style="color: #6b7280; font-size: 0.9rem;">
                        ${team.score} Punkte
                    </div>
                </div>
                ${isUserTeam ? '<div style="color: #f59e0b;">👤</div>' : ''}
            `;
            
            rankingList.appendChild(rankItem);
        });
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        if (!input) return;
        
        const message = input.value.trim();
        
        if (message) {
            messaging.sendMessage(appState.userName, message);
            input.value = '';
        }
    }

    function showSuccessMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'success-message';
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }

    // Map Functions (simplified for mobile)
    function initMap() {
        if (!document.getElementById('map') || appState.map) return;
        
        try {
            // Simple fallback map display
            const mapEl = document.getElementById('map');
            if (mapEl) {
                mapEl.innerHTML = `
                    <div style="height: 100%; display: flex; align-items: center; justify-content: center; background: #f0f9ff; border-radius: 10px;">
                        <div style="text-align: center; color: #0369a1;">
                            <h3>🗺️ Kölner Tour Route</h3>
                            <p>Interaktive Karte wird geladen...</p>
                            <p><small>Falls die Karte nicht lädt, nutze eine Karten-App</small></p>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.log('Map init error:', error);
        }
    }

    function centerOnUser() {
        if (appState.userLocation) {
            // Open in system map app
            const url = `https://www.google.com/maps/@${appState.userLocation.lat},${appState.userLocation.lng},17z`;
            window.open(url, '_blank');
        } else {
            alert('Standort nicht verfügbar. Bitte erlaube Standortzugriff in den Browser-Einstellungen.');
        }
    }

    function updateLocationInfo() {
        if (!appState.userLocation) return;
        
        let nearestStation = null;
        let minDistance = Infinity;
        
        stations.forEach(station => {
            const distance = calculateDistance(
                appState.userLocation.lat, appState.userLocation.lng,
                station.lat, station.lng
            );
            
            if (distance < minDistance) {
                minDistance = distance;
                nearestStation = station;
            }
        });
        
        if (nearestStation) {
            const distanceText = minDistance < 1 
                ? `${Math.round(minDistance * 1000)}m` 
                : `${minDistance.toFixed(1)}km`;
            
            const distanceEl = document.getElementById('distanceInfo');
            if (distanceEl) {
                distanceEl.textContent = `📍 Nächste Station: ${nearestStation.title} (${distanceText})`;
            }
        }
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // State Management
    function saveState() {
        try {
            const stateToSave = {
                ...appState,
                map: null, // Don't save map object
                markers: [] // Don't save markers
            };
            localStorage.setItem('tourState', JSON.stringify(stateToSave));
        } catch (error) {
            console.log('Save state error:', error);
        }
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('tourState');
            if (saved) {
                const savedState = JSON.parse(saved);
                appState = { ...appState, ...savedState };
                updateUI();
                
                // Restore team selection
                if (appState.selectedTeam) {
                    const teamOptions = document.querySelectorAll('.team-option');
                    teamOptions.forEach(option => {
                        if (option.textContent.includes(appState.teamName)) {
                            option.classList.add('selected');
                        }
                    });
                    const teamSelector = document.getElementById('teamSelector');
                    if (teamSelector) {
                        teamSelector.style.display = 'none';
                    }
                }
                
                // Restore uploaded photos after stations are generated
                setTimeout(restorePhotos, 100);
            }
        } catch (error) {
            console.log('Load state error:', error);
        }
    }

    function restorePhotos() {
        appState.uploadedPhotos.forEach(photo => {
            const uploadArea = document.getElementById(`upload-area-${photo.stationId}`);
            if (uploadArea) {
                uploadArea.classList.add('has-photo');
                uploadArea.innerHTML = `
                    <img src="${photo.imageUrl}" class="photo-preview" alt="Uploaded photo">
                    <p>📷 Foto erfolgreich hochgeladen!</p>
                    <small>Klicke hier für ein neues Foto</small>
                `;
                
                if (photo.score) {
                    const ratingDiv = document.getElementById(`rating-${photo.stationId}`);
                    if (ratingDiv) {
                        ratingDiv.classList.remove('hidden');
                        const scoreEl = document.getElementById(`score-${photo.stationId}`);
                        if (scoreEl) {
                            scoreEl.textContent = Math.round(photo.score);
                        }
                        
                        if (photo.analysis) {
                            const textEl = document.getElementById(`rating-text-${photo.stationId}`);
                            if (textEl) {
                                textEl.innerHTML = `
                                    <strong>KI-Bewertung:</strong><br>
                                    Qualität: ${Math.round(photo.analysis.breakdown.technical.overall)}% | 
                                    Komposition: ${Math.round(photo.analysis.breakdown.composition.overall)}% | 
                                    Kreativität: ${Math.round(photo.analysis.breakdown.creativity)}%
                                `;
                            }
                            
                            const detailsEl = document.getElementById(`rating-details-${photo.stationId}`);
                            if (detailsEl) {
                                detailsEl.innerHTML = photo.analysis.feedback.join('<br>');
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize app when page loads
    document.addEventListener('DOMContentLoaded', function() {
        try {
            initApp();
        } catch (error) {
            console.log('DOMContentLoaded error:', error);
        }
    });

</script>
```

</body>
</html>
