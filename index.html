<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kölner Abendspaziergang</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .tour-id-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .connection-status.online {
            background: #10b981;
        }

        .connection-status.offline {
            background: #dc2626;
        }

        .connection-status.connecting {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-container {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            background: #fbbf24;
            height: 100%;
            width: 0%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .main-content {
            padding: 0;
        }

        .tab-container {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 132px;
            z-index: 999;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 1rem 0.5rem;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            font-size: 0.9rem;
            white-space: nowrap;
            min-width: 100px;
            touch-action: manipulation;
        }

        .tab.active {
            background: white;
            color: #dc2626;
            border-bottom: 3px solid #dc2626;
        }

        .tab.admin {
            background: #fef3c7;
            color: #92400e;
        }

        .tab.admin.active {
            background: #f59e0b;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            min-height: calc(100vh - 200px);
        }

        .tab-content.active {
            display: block;
        }

        .tour-connection-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .qr-code-area {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .share-url {
            background: #f8fafc;
            padding: 0.8rem;
            border-radius: 8px;
            border: 2px dashed #e2e8f0;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin: 0.5rem 0;
        }

        .admin-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .admin-password-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin: 0.5rem 0;
        }

        .station-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #dc2626;
            cursor: pointer;
            transition: all 0.3s;
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .station-card.completed {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .station-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .station-number {
            background: #dc2626;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .station-number.completed {
            background: #10b981;
        }

        .station-title {
            flex: 1;
            font-size: 1.3rem;
            font-weight: bold;
            color: #1f2937;
        }

        .station-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .station-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }

        .station-details.active {
            display: block;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h4 {
            color: #dc2626;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .detail-section h4::before {
            content: "▶";
            margin-right: 0.5rem;
            color: #dc2626;
        }

        .photo-challenge {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #6366f1;
            position: relative;
        }

        .photo-challenge h4 {
            color: #4f46e5;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .photo-upload-area {
            border: 3px dashed #a5b4fc;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.5);
            touch-action: manipulation;
        }

        .photo-upload-area:hover {
            border-color: #6366f1;
            background: rgba(255,255,255,0.8);
        }

        .photo-upload-area.has-photo {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .ai-rating {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
            border: 2px solid #10b981;
        }

        .rating-score {
            font-size: 3rem;
            font-weight: bold;
            color: #059669;
            margin-bottom: 0.5rem;
        }

        .rating-text {
            color: #047857;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .rating-details {
            background: #f0fdf4;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #065f46;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .gallery-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .gallery-image:hover {
            transform: scale(1.05);
        }

        .gallery-item {
            text-align: center;
            position: relative;
        }

        .gallery-item small {
            display: block;
            margin-top: 0.5rem;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 1rem;
            margin-top: 1rem;
            touch-action: manipulation;
        }

        .btn:hover {
            background: #991b1b;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-admin {
            background: #f59e0b;
        }

        .btn-admin:hover {
            background: #d97706;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            width: auto;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        .score-display {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
            border: 2px solid #8b5cf6;
        }

        .score-number {
            font-size: 2rem;
            font-weight: bold;
            color: #5b21b6;
        }

        .score-label {
            color: #7c3aed;
            margin-top: 0.5rem;
        }

        .team-ranking {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .team-rank-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            background: #f8fafc;
        }

        .team-rank-item.highlight {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .rank-position {
            background: #6b7280;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .rank-position.gold {
            background: #f59e0b;
        }

        .rank-position.silver {
            background: #6b7280;
        }

        .rank-position.bronze {
            background: #d97706;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .location-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .distance-info {
            font-weight: bold;
            color: #0369a1;
            margin-bottom: 0.5rem;
        }

        .team-selector {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .team-option {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            touch-action: manipulation;
        }

        .team-option:hover {
            background: #f3f4f6;
        }

        .team-option.selected {
            background: #dbeafe;
            border: 2px solid #3b82f6;
        }

        .team-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-message {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            background: #f8fafc;
            border-left: 3px solid #3b82f6;
        }

        .chat-message.own {
            background: #dbeafe;
            border-left-color: #1d4ed8;
            margin-left: 2rem;
        }

        .chat-message.system {
            background: #fef3c7;
            border-left-color: #f59e0b;
            font-style: italic;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-send {
            padding: 0.8rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            touch-action: manipulation;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #059669;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.5s ease;
            max-width: 300px;
        }

        .notification.error {
            background: #dc2626;
        }

        .notification.warning {
            background: #f59e0b;
        }

        .error-panel {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            color: #dc2626;
        }

        .hidden {
            display: none !important;
        }

        .file-input {
            display: none;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                box-shadow: none;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .tab {
                font-size: 0.8rem;
                padding: 0.8rem 0.3rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .station-card {
                padding: 1rem;
            }
            
            .image-gallery {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🏛️ Kölner Abendspaziergang</h1>
            <p class="subtitle">Entdecke 2000 Jahre Stadtgeschichte</p>
            <div class="tour-id-display">
                Tour: <span id="currentTourId">Wird geladen...</span>
                <span class="connection-status connecting" id="connectionStatus" title="Verbindung wird aufgebaut..."></span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </header>

        <div class="main-content">
            <div class="tab-container">
                <button class="tab active" onclick="showTab('overview', this)">🗺️ Übersicht</button>
                <button class="tab" onclick="showTab('stations', this)">📍 Stationen</button>
                <button class="tab" onclick="showTab('ranking', this)">🏆 Ranking</button>
                <button class="tab" onclick="showTab('chat', this)">💬 Chat</button>
                <button class="tab" onclick="showTab('map', this)">🗺️ Karte</button>
                <button class="tab admin hidden" onclick="showTab('admin', this)" id="adminTab">⚙️ Admin</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div id="errorPanel" class="error-panel hidden">
                    <h4>⚠️ Verbindungsproblem</h4>
                    <p id="errorMessage">Verbindung zu Firebase wird aufgebaut...</p>
                    <button class="btn btn-secondary btn-small" onclick="retryConnection()">🔄 Erneut versuchen</button>
                </div>

                <div class="tour-connection-section">
                    <h3 style="margin-bottom: 1rem; color: #0369a1;">🔗 Mit anderen Geräten verbinden</h3>
                    
                    <div class="qr-code-area">
                        <p><strong>Teile diese URL mit anderen Teilnehmern:</strong></p>
                        <div class="share-url" id="shareUrl">App wird gestartet...</div>
                        <button class="btn btn-secondary btn-small" onclick="copyShareUrl()">📋 URL kopieren</button>
                        <button class="btn btn-secondary btn-small" onclick="shareViaWhatsApp()">📱 WhatsApp teilen</button>
                    </div>
                    
                    <p style="font-size: 0.9rem; color: #6b7280; text-align: center;">
                        💡 Alle die diesen Link öffnen, können miteinander chatten und sehen Live-Rankings!
                    </p>
                </div>

                <div class="admin-section">
                    <h3 style="margin-bottom: 1rem; color: #92400e;">🔐 Admin-Zugang</h3>
                    <input type="password" class="admin-password-input" id="adminPassword" placeholder="Admin-Passwort eingeben">
                    <button class="btn btn-admin" onclick="loginAdmin()">Admin-Modus aktivieren</button>
                </div>

                <div class="score-display">
                    <div class="score-number" id="totalScore">0</div>
                    <div class="score-label">Foto-Punkte gesammelt</div>
                </div>

                <div class="team-selector" id="teamSelector">
                    <h3 style="margin-bottom: 1rem; color: #374151;">📸 Wähle dein Team:</h3>
                    <div class="team-option" onclick="selectTeam('red', '🔴 Team Römer', this)">
                        <div class="team-color" style="background: #dc2626;"></div>
                        <span>🔴 Team Römer</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('blue', '🔵 Team Gaffeln', this)">
                        <div class="team-color" style="background: #2563eb;"></div>
                        <span>🔵 Team Gaffeln</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('green', '🟢 Team Hanseat', this)">
                        <div class="team-color" style="background: #059669;"></div>
                        <span>🟢 Team Hanseat</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('yellow', '🟡 Team Modern', this)">
                        <div class="team-color" style="background: #d97706;"></div>
                        <span>🟡 Team Modern</span>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">📋 Tour-Informationen</h3>
                    <p><strong>⏰ Dauer:</strong> ca. 3,5 Stunden</p>
                    <p><strong>📍 Start:</strong> Heumarkt, 19:30 Uhr</p>
                    <p><strong>🎯 Ziel:</strong> Alte Bastion</p>
                    <p><strong>👥 Teilnehmer:</strong> 15-25 Personen</p>
                    <p><strong>📸 Ziel:</strong> Sammle die besten Foto-Punkte!</p>
                </div>

                <button class="btn" onclick="startTour()">🚀 Tour starten</button>
            </div>

            <!-- Stations Tab -->
            <div id="stations" class="tab-content">
                <div id="stationsList">
                    <!-- Stations will be generated here -->
                </div>
            </div>

            <!-- Ranking Tab -->
            <div id="ranking" class="tab-content">
                <div class="team-ranking">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">🏆 Live-Ranking</h3>
                    <div id="rankingList">
                        <!-- Ranking will be generated here -->
                    </div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">📸 KI-Punktesystem</h3>
                    <ul style="margin-left: 1.5rem; color: #4b5563;">
                        <li><strong>Technische Qualität:</strong> Schärfe, Belichtung, Komposition (0-40 Punkte)</li>
                        <li><strong>Kreativität:</strong> Perspective, Originalität (0-30 Punkte)</li>
                        <li><strong>Stadtbezug:</strong> Erkannte Sehenswürdigkeiten (0-20 Punkte)</li>
                        <li><strong>Personen/Gruppenfoto:</strong> Bonus für Teamarbeit (+10 Punkte)</li>
                    </ul>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chat" class="tab-content">
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message system">
                        <strong>System:</strong> Willkommen im Tour-Chat! 👋<br>
                        <small>Chat funktioniert automatisch zwischen allen Geräten mit derselben Tour-URL.</small>
                        <span class="timestamp">jetzt</span>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht eingeben..." maxlength="200">
                    <button class="chat-send" onclick="sendMessage()">Senden</button>
                </div>
                <div style="margin-top: 1rem; text-align: center; color: #6b7280; font-size: 0.9rem;">
                    💡 Nachrichten werden live synchronisiert
                </div>
            </div>

            <!-- Map Tab -->
            <div id="map-tab" class="tab-content">
                <div class="location-info">
                    <div class="distance-info" id="distanceInfo">📍 Standort wird ermittelt...</div>
                    <p>💡 Tipp: Erlaube Standortzugriff für Navigation</p>
                </div>
                <div id="map"></div>
                <button class="btn" onclick="centerOnUser()">📍 Zu meinem Standort</button>
            </div>

            <!-- Admin Tab -->
            <div id="admin" class="tab-content">
                <div style="background: #fef3c7; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="color: #92400e; margin-bottom: 1rem;">⚙️ Admin-Panel</h3>
                    <p>Hier können Sie Inhalte bearbeiten, die sofort für alle Teilnehmer sichtbar werden.</p>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">🔄 Tour zurücksetzen</h4>
                    <button class="btn btn-secondary" onclick="resetTour()">Alle Daten zurücksetzen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

    <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC1dTE4AiAKbInq-5f2dy92zWBIOmZ8o9Y",
        authDomain: "koeln-tour.firebaseapp.com",
        projectId: "koeln-tour",
        storageBucket: "koeln-tour.firebasestorage.app",
        messagingSenderId: "297105093618",
        appId: "1:297105093618:web:fa44f3fee94e79d304f16b",
        measurementId: "G-TZBGBEPCVW"
    };

    // Global variables
    let tourApp = {
        state: {
            currentStation: 0,
            completedStations: [],
            totalScore: 0,
            selectedTeam: null,
            teamName: '',
            userLocation: null,
            map: null,
            markers: [],
            uploadedPhotos: [],
            userName: 'Tourist_' + Math.random().toString(36).substr(2, 5),
            tourId: null,
            isAdmin: false,
            syncListeners: [],
            isFirebaseConnected: false,
            connectionRetries: 0,
            maxRetries: 3
        },
        
        stations: [
            {
                id: 1,
                title: "Heumarkt",
                subtitle: "Wo alles anfing: 2000 Jahre Migration und Handel",
                lat: 50.9356, lng: 6.9611,
                description: "Start der Tour am historischen Heumarkt, einem der geschichtsträchtigsten Orte Kölns.",
                photoChallenge: "Mache ein Foto von dir oder deinem Team vor dem Reiterstandbild - zeigt dabei mit Handbewegungen, wie Händler früher ihre Waren angepriesen haben könnten!",
                mainText: `Die Stadt ist ca. 2.000 Jahre alt. CCAA - Colonia Claudia Ara Agrippinensium - wurde 50 n. Chr. von den Römern gegründet, mithilfe der germanischen Ubier. Das war übrigens eine der ersten erfolgreichen Integration zweier Kulturen in Europa. 

Hier auf dem Heumarkt stehen wir an einem der ehemaligen Einfallstore zur Stadt. Die Markmannsgasse runter, links von der heutigen Deutzer Brücke, befand sich von 1822 bis 1915 die einzige Schiffsbrücke über den Rhein - 42 schwimmende Boote, die über 30 Mal täglich für Schiffe geöffnet wurden.

Das "Stapelrecht" von 1259 bis 1804 war ein 545 Jahre gültiges Handelsprivileg. Alle Waren auf Schiffen, die an Köln vorbeifahren wollten, mussten drei Tage hier angeboten werden.`,
                images: [
                    { url: "https://images.unsplash.com/photo-1568667256549-094345857637?w=400", title: "Heumarkt heute", description: "Moderne Aufnahme des historischen Platzes" },
                    { url: "https://images.unsplash.com/photo-1590736969955-71cc94901144?w=400", title: "Kölner Architektur", description: "Typische Rheinische Bauweise" },
                    { url: "https://images.unsplash.com/photo-1551622656-fa4fa96b5faf?w=400", title: "Rheinufer", description: "Blick auf den historischen Handelsweg" }
                ]
            },
            {
                id: 2,
                title: "Kölner Dom",
                subtitle: "Das ewige Bauprojekt und die Verkehrsrevolution",
                lat: 50.9413, lng: 6.9583,
                description: "Kölns Wahrzeichen und die längste Baustelle der Welt.",
                photoChallenge: "Bildet mit eurem Team eine 'menschliche Kathedrale' vor dem Dom - streckt die Arme hoch und formt gotische Bögen nach!",
                mainText: `Der Dom wird seit fast 800 Jahren gebaut - etwas länger als der BER. Die Grundsteinlegung 1248 war Kölns Versuch, Paris und andere Großstädte zu beeindrucken. Köln war immer reich, aber auch provinziell.

1248-1330 wurden Grundmauern und der Chor fertiggestellt. Dann ging das Geld aus. Fast 300 Jahre stand nur ein riesiger Kran auf dem unvollendeten Turm - eines der ersten großen "paused projects" der Geschichte.

Erst die Romantik des 19. Jahrhunderts und preußisches Geld vollendeten den Dom 1880. Der Hauptbahnhof entstand 1894 als einer der modernsten Europas.`,
                images: [
                    { url: "https://images.unsplash.com/photo-1571115764595-644a1f56a55c?w=400", title: "Kölner Dom", description: "Die berühmten Zwillingstürme" },
                    { url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400", title: "Dom Innenraum", description: "Gotische Architektur" },
                    { url: "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=400", title: "Dom bei Nacht", description: "Beleuchtetes Wahrzeichen" }
                ]
            },
            {
                id: 3,
                title: "Altstadt",
                subtitle: "Macht, Rebellion und eine große Liebesgeschichte",
                lat: 50.9369, lng: 6.9572,
                description: "Das historische Rathaus und die berühmte Jan-und-Griet-Geschichte.",
                photoChallenge: "Fotografiert euch am historischen Rathaus und stellt eine romantische Szene nach: Eine Person kniet, eine steht stolz daneben.",
                mainText: `Der Rathaus-Turm zeigt wichtige Persönlichkeiten der Kölner Geschichte. 1945 zerstört und wieder aufgebaut. Da auch die Figuren zerstört waren, wählte eine Kommission neue aus - von über 100 Kandidaten. Alle männlich.

Oben am Turm seht ihr den "Platz-Jabbeck" - er streckt Autoritäten die Zunge raus. So viel Respekt hatten die Kölner für die Obrigkeit.

Die Altstadt erzählt eine der größten deutschen Liebesgeschichten: Jan ist ein armer Knecht, Griet arbeitet auch dort. Er mag sie, sie ihn nicht. Der Krieg beginnt, Jan zieht aus, kommt als berühmter General zurück.`,
                images: [
                    { url: "https://images.unsplash.com/photo-1544892504-5ad7a122b56f?w=400", title: "Kölner Altstadt", description: "Historische Gassen" },
                    { url: "https://images.unsplash.com/photo-1517840901100-8179e982acb7?w=400", title: "Rheinpromenade", description: "Spazierweg mit Domblick" },
                    { url: "https://images.unsplash.com/photo-1567696911980-2eed69651dd7?w=400", title: "Historisches Rathaus", description: "Gotisches Bauwerk" }
                ]
            },
            {
                id: 4,
                title: "Groß St. Martin",
                subtitle: "Romanische Kirche und Klostergeschichte",
                lat: 50.9347, lng: 6.9597,
                description: "Eine der zwölf großen romanischen Kirchen Kölns.",
                photoChallenge: "Macht ein Foto der imposanten Kirchtürme und zeigt dabei mittelalterliche Gebetshaltungen!",
                mainText: `Groß St. Martin ist eine der beeindruckendsten romanischen Kirchen Kölns. Der markante Vierungsturm prägt seit dem 12. Jahrhundert die Silhouette der Altstadt.

Die Kirche wurde auf römischen Fundamenten errichtet - archäologische Ausgrabungen zeigen die Kontinuität der Besiedlung über 2000 Jahre. Im Mittelalter war hier eines der mächtigsten Benediktinerklöster der Region.

Der Turm diente auch als Orientierungspunkt für Rheinschiffe und Händler - ein früher "Leuchtturm" des Handels.`,
                images: [
                    { url: "https://images.unsplash.com/photo-1518709268805-4e9042af2e96?w=400", title: "Groß St. Martin", description: "Romanischer Kirchenbau" },
                    { url: "https://images.unsplash.com/photo-1573052905904-34ad8c27f0d4?w=400", title: "Altstadt Panorama", description: "Kirchtürme der Altstadt" },
                    { url: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400", title: "Rheinufer", description: "Blick auf die Kirchen" }
                ]
            },
            {
                id: 5,
                title: "Fischmarkt",
                subtitle: "Handel, Handwerk und Bürgerstolz",
                lat: 50.9378, lng: 6.9589,
                description: "Mittelpunkt des mittelalterlichen Handels.",
                photoChallenge: "Zeigt mit euren Händen, wie mittelalterliche Händler ihre Waren präsentiert haben - seid kreativ mit Gesten!",
                mainText: `Der Fischmarkt war im Mittelalter das kommerzielle Herz Kölns. Hier wurde nicht nur Fisch verkauft, sondern alle wichtigen Handelsgüter der Region.

Die Kölner Bürger entwickelten hier ihre berühmte Unabhängigkeit. 1074 erhielt Köln bereits wichtige Stadtrechte - 500 Jahre bevor andere deutsche Städte folgten.

Die Zunftordnungen vom Fischmarkt dienten als Vorbild für ganz Europa. Handwerksmeister aus Köln gründeten in vielen anderen Städten ähnliche Organisationen.`,
                images: [
                    { url: "https://images.unsplash.com/photo-1578916171728-46686eac8d58?w=400", title: "Alter Markt Köln", description: "Historischer Marktplatz" },
                    { url: "https://images.unsplash.com/photo-1574790398664-0cb3c99c3711?w=400", title: "Kölner Häuser", description: "Typische Architektur" },
                    { url: "https://images.unsplash.com/photo-1587474260584-136574528ed5?w=400", title: "Rheinischer Markt", description: "Handelstradition" }
                ]
            }
        ]
    };

    // Firebase Initialization with Better Error Handling
    let db = null;

    async function initFirebase() {
        try {
            updateConnectionStatus('connecting');
            
            // Initialize Firebase
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Test connection
            await db.enableNetwork();
            
            // Test read/write access
            const testDoc = db.collection('tours').doc('test');
            await testDoc.set({ test: Date.now() }, { merge: true });
            
            tourApp.state.isFirebaseConnected = true;
            updateConnectionStatus('online');
            hideErrorPanel();
            
            console.log('✅ Firebase connected successfully');
            
            // Enable real-time sync
            enableRealtimeSync();
            
        } catch (error) {
            console.error('❌ Firebase connection failed:', error);
            tourApp.state.isFirebaseConnected = false;
            updateConnectionStatus('offline');
            showErrorPanel('Firebase-Verbindung fehlgeschlagen. App funktioniert nur lokal.', error.message);
            
            // Retry connection
            if (tourApp.state.connectionRetries < tourApp.state.maxRetries) {
                tourApp.state.connectionRetries++;
                setTimeout(() => {
                    console.log(`🔄 Retrying Firebase connection (${tourApp.state.connectionRetries}/${tourApp.state.maxRetries})`);
                    initFirebase();
                }, 3000);
            }
        }
    }

    function updateConnectionStatus(status) {
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) {
            statusEl.className = `connection-status ${status}`;
            
            const titles = {
                'connecting': 'Verbindung wird aufgebaut...',
                'online': 'Online - Daten werden synchronisiert', 
                'offline': 'Offline - Nur lokale Daten'
            };
            statusEl.title = titles[status] || status;
        }
    }

    function showErrorPanel(message, details = '') {
        const panel = document.getElementById('errorPanel');
        const messageEl = document.getElementById('errorMessage');
        
        if (panel && messageEl) {
            messageEl.innerHTML = `${message}${details ? `<br><small>Details: ${details}</small>` : ''}`;
            panel.classList.remove('hidden');
        }
    }

    function hideErrorPanel() {
        const panel = document.getElementById('errorPanel');
        if (panel) {
            panel.classList.add('hidden');
        }
    }

    function retryConnection() {
        tourApp.state.connectionRetries = 0;
        initFirebase();
    }

    // Firebase Real-time Functions
    function enableRealtimeSync() {
        if (!tourApp.state.isFirebaseConnected) return;

        try {
            // Listen to chat messages
            const chatRef = db.collection('tours').doc(tourApp.state.tourId).collection('chat');
            const chatUnsubscribe = chatRef.orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' && change.doc.data().userName !== tourApp.state.userName) {
                        const messageData = change.doc.data();
                        addChatMessage(messageData.userName, messageData.message, false);
                    }
                });
            });

            // Listen to team scores
            const scoresRef = db.collection('tours').doc(tourApp.state.tourId).collection('scores');
            const scoresUnsubscribe = scoresRef.onSnapshot(() => {
                updateRanking();
            });

            tourApp.state.syncListeners.push(chatUnsubscribe, scoresUnsubscribe);
            
            console.log('✅ Real-time sync enabled');
        } catch (error) {
            console.error('Error setting up real-time sync:', error);
        }
    }

    // Firebase Data Functions
    async function saveToFirebase(collection, docId, data) {
        if (!tourApp.state.isFirebaseConnected) return false;

        try {
            await db.collection('tours').doc(tourApp.state.tourId)
                .collection(collection).doc(docId).set(data, { merge: true });
            return true;
        } catch (error) {
            console.error('Firebase save error:', error);
            showNotification('Speichern fehlgeschlagen - nur lokal gespeichert', 'warning');
            return false;
        }
    }

    async function getFromFirebase(collection) {
        if (!tourApp.state.isFirebaseConnected) return [];

        try {
            const snapshot = await db.collection('tours').doc(tourApp.state.tourId)
                .collection(collection).get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error('Firebase get error:', error);
            return [];
        }
    }

    // App Initialization
    function initApp() {
        console.log('🚀 Starting Tour App...');
        
        try {
            // Generate tour ID first
            loadTourId();
            
            // Initialize Firebase
            initFirebase();
            
            // Load saved state
            loadState();
            
            // Generate UI
            generateStationsList();
            updateUI();
            
            // Setup event listeners
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            console.log('✅ Tour App initialized successfully');
            
            // Initialize optional features
            setTimeout(() => {
                initGeolocation();
                loadChatHistory();
            }, 1000);
            
        } catch (error) {
            console.error('❌ Error initializing app:', error);
            showNotification('App-Start mit Fehlern. Basis-Funktionen verfügbar.', 'error');
            
            // Emergency fallback
            if (!tourApp.state.tourId) {
                tourApp.state.tourId = 'koeln-emergency-' + Date.now();
                updateTourDisplay();
                generateShareUrl();
            }
        }
    }

    function loadTourId() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const urlTourId = urlParams.get('tour');
            
            if (urlTourId) {
                tourApp.state.tourId = urlTourId;
                setTimeout(() => addSystemMessage(`Automatisch der Tour "${urlTourId}" beigetreten! 🎉`), 2000);
            } else {
                tourApp.state.tourId = localStorage.getItem('tourId') || generateTourId();
            }
            
            localStorage.setItem('tourId', tourApp.state.tourId);
            updateTourDisplay();
            generateShareUrl();
        } catch (error) {
            console.error('Error loading tour ID:', error);
            tourApp.state.tourId = 'koeln-tour-' + Math.random().toString(36).substr(2, 8);
            updateTourDisplay();
            generateShareUrl();
        }
    }

    function generateTourId() {
        try {
            const today = new Date().toISOString().split('T')[0];
            const random = Math.random().toString(36).substr(2, 5);
            return `koeln-${today}-${random}`;
        } catch (error) {
            return 'koeln-tour-' + Math.random().toString(36).substr(2, 8);
        }
    }

    function updateTourDisplay() {
        try {
            const el = document.getElementById('currentTourId');
            if (el && tourApp.state.tourId) {
                el.textContent = tourApp.state.tourId;
            }
        } catch (error) {
            console.error('Error updating tour display:', error);
        }
    }

    function generateShareUrl() {
        try {
            if (!tourApp.state.tourId) return;
            
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?tour=${tourApp.state.tourId}`;
            const el = document.getElementById('shareUrl');
            if (el) {
                el.textContent = shareUrl;
            }
        } catch (error) {
            console.error('Error generating share URL:', error);
            const el = document.getElementById('shareUrl');
            if (el) {
                el.textContent = 'Fehler beim Generieren der URL';
            }
        }
    }

    // Chat Functions
    async function sendMessage() {
        try {
            const input = document.getElementById('chatInput');
            if (!input) return;
            
            const message = input.value.trim();
            if (message) {
                // Add to local chat immediately
                addChatMessage(tourApp.state.userName, message, true);
                
                // Try to save to Firebase
                const saved = await saveToFirebase('chat', Date.now().toString(), {
                    userName: tourApp.state.userName,
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Fallback to localStorage if Firebase fails
                if (!saved) {
                    const chatMessages = JSON.parse(localStorage.getItem(`chat_${tourApp.state.tourId}`) || '[]');
                    chatMessages.push({
                        userName: tourApp.state.userName,
                        message: message,
                        timestamp: Date.now()
                    });
                    if (chatMessages.length > 50) {
                        chatMessages.splice(0, chatMessages.length - 50);
                    }
                    localStorage.setItem(`chat_${tourApp.state.tourId}`, JSON.stringify(chatMessages));
                }
                
                input.value = '';
            }
        } catch (error) {
            console.error('Error sending message:', error);
            showNotification('Fehler beim Senden der Nachricht', 'error');
        }
    }

    async function addScore(points) {
        try {
            tourApp.state.totalScore += Math.round(points);
            updateUI();
            
            // Try to save to Firebase
            if (tourApp.state.selectedTeam) {
                await saveToFirebase('scores', tourApp.state.selectedTeam, {
                    teamId: tourApp.state.selectedTeam,
                    teamName: tourApp.state.teamName,
                    score: tourApp.state.totalScore,
                    lastUpdated: Date.now()
                });
            }
            
            saveState();
        } catch (error) {
            console.error('Error adding score:', error);
        }
    }

    async function updateRanking() {
        try {
            const rankingList = document.getElementById('rankingList');
            if (!rankingList) return;
            
            let teams;
            
            if (tourApp.state.isFirebaseConnected) {
                teams = await getFromFirebase('scores');
                
                if (tourApp.state.selectedTeam && !teams.find(t => t.teamId === tourApp.state.selectedTeam)) {
                    teams.push({
                        teamId: tourApp.state.selectedTeam,
                        teamName: tourApp.state.teamName,
                        score: tourApp.state.totalScore
                    });
                }
                
                const allTeamIds = ['red', 'blue', 'green', 'yellow'];
                const teamNames = {
                    'red': '🔴 Team Römer',
                    'blue': '🔵 Team Gaffeln', 
                    'green': '🟢 Team Hanseat',
                    'yellow': '🟡 Team Modern'
                };
                
                allTeamIds.forEach(teamId => {
                    if (!teams.find(t => t.teamId === teamId)) {
                        teams.push({
                            teamId: teamId,
                            teamName: teamNames[teamId],
                            score: Math.floor(Math.random() * 200) + 50
                        });
                    }
                });
            } else {
                teams = [
                    { teamId: 'red', teamName: '🔴 Team Römer', score: tourApp.state.selectedTeam === 'red' ? tourApp.state.totalScore : Math.floor(Math.random() * 300) + 100 },
                    { teamId: 'blue', teamName: '🔵 Team Gaffeln', score: tourApp.state.selectedTeam === 'blue' ? tourApp.state.totalScore : Math.floor(Math.random() * 300) + 100 },
                    { teamId: 'green', teamName: '🟢 Team Hanseat', score: tourApp.state.selectedTeam === 'green' ? tourApp.state.totalScore : Math.floor(Math.random() * 300) + 100 },
                    { teamId: 'yellow', teamName: '🟡 Team Modern', score: tourApp.state.selectedTeam === 'yellow' ? tourApp.state.totalScore : Math.floor(Math.random() * 300) + 100 }
                ];
            }
            
            teams.sort((a, b) => b.score - a.score);
            
            rankingList.innerHTML = '';
            
            teams.forEach((team, index) => {
                const rankItem = document.createElement('div');
                const isUserTeam = team.teamId === tourApp.state.selectedTeam;
                rankItem.className = `team-rank-item ${isUserTeam ? 'highlight' : ''}`;
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                rankItem.innerHTML = `
                    <div class="rank-position ${rankClass}">${index + 1}</div>
                    <div style="flex: 1;">
                        <strong>${team.teamName}</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">
                            ${team.score} Punkte
                        </div>
                    </div>
                    ${isUserTeam ? '<div style="color: #f59e0b;">👤</div>' : ''}
                `;
                
                rankingList.appendChild(rankItem);
            });
        } catch (error) {
            console.error('Error updating ranking:', error);
        }
    }

    // UI Functions (Basic implementations)
    function copyShareUrl() {
        try {
            const shareUrl = document.getElementById('shareUrl').textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('URL kopiert! 📋');
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = shareUrl;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('URL kopiert! 📋');
            }
        } catch (error) {
            console.error('Error copying URL:', error);
        }
    }

    function shareViaWhatsApp() {
        try {
            const shareUrl = document.getElementById('shareUrl').textContent;
            const message = `🏛️ Kölner Abendspaziergang - Tour beitreten:\n${shareUrl}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        } catch (error) {
            console.error('Error sharing via WhatsApp:', error);
        }
    }

    function loginAdmin() {
        try {
            const password = document.getElementById('adminPassword').value;
            if (password === 'koeln2024') {
                tourApp.state.isAdmin = true;
                document.getElementById('adminTab').classList.remove('hidden');
                generateStationsList();
                showNotification('Admin-Modus aktiviert! ⚙️');
                showTab('admin', document.getElementById('adminTab'));
            } else {
                showNotification('Falsches Passwort!', 'error');
            }
        } catch (error) {
            console.error('Error logging in admin:', error);
        }
    }

    function showTab(tabName, tabElement) {
        try {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (tabElement) {
                tabElement.classList.add('active');
            }

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const targetTab = document.getElementById(tabName === 'map' ? 'map-tab' : tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            if (tabName === 'map') {
                setTimeout(() => initMap(), 100);
            } else if (tabName === 'ranking') {
                updateRanking();
            }
        } catch (error) {
            console.error('Error showing tab:', error);
        }
    }

    function selectTeam(teamId, teamName, element) {
        try {
            tourApp.state.selectedTeam = teamId;
            tourApp.state.teamName = teamName;
            
            document.querySelectorAll('.team-option').forEach(option => {
                option.classList.remove('selected');
            });
            if (element) {
                element.classList.add('selected');
            }
            
            const selector = document.getElementById('teamSelector');
            if (selector) {
                selector.style.display = 'none';
            }
            
            showNotification('Team ausgewählt! 🎉');
            saveState();
            addSystemMessage(`${tourApp.state.userName} ist ${teamName} beigetreten! 🎊`);
        } catch (error) {
            console.error('Error selecting team:', error);
        }
    }

    function startTour() {
        try {
            if (!tourApp.state.selectedTeam) {
                showNotification('Bitte wähle zuerst ein Team aus!', 'error');
                return;
            }
            
            showTab('stations', document.querySelector('[onclick*="stations"]'));
            showNotification('Tour gestartet! Viel Erfolg! 🚀');
        } catch (error) {
            console.error('Error starting tour:', error);
        }
    }

    function generateStationsList() {
        try {
            const container = document.getElementById('stationsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            tourApp.stations.forEach(station => {
                const isCompleted = tourApp.state.completedStations.includes(station.id);
                
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${isCompleted ? 'completed' : ''}`;
                stationCard.onclick = () => toggleStationDetails(station.id);
                
                const imagesHtml = station.images.map(img => `
                    <div class="gallery-item">
                        <img src="${img.url}" alt="${img.title}" class="gallery-image" onclick="showImageModal('${img.url}', '${img.title}', '${img.description}')">
                        <small>${img.title}</small>
                    </div>
                `).join('');
                
                stationCard.innerHTML = `
                    <div class="station-header">
                        <div class="station-number ${isCompleted ? 'completed' : ''}">${station.id}</div>
                        <div style="flex: 1;">
                            <div class="station-title">${station.title}</div>
                            <div class="station-subtitle">${station.subtitle}</div>
                        </div>
                    </div>
                    <div class="station-details" id="station-${station.id}">
                        <div class="detail-section">
                            <h4>📖 Geschichte</h4>
                            <p>${station.mainText}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>🖼️ Bildergalerie</h4>
                            <div class="image-gallery">
                                ${imagesHtml}
                            </div>
                        </div>

                        <div class="photo-challenge">
                            <h4>📸 KI-Foto-Challenge</h4>
                            <p>${station.photoChallenge}</p>
                            
                            <div class="photo-upload-area" onclick="selectPhoto(${station.id})" id="upload-area-${station.id}">
                                <div id="upload-content-${station.id}">
                                    📷 Hier klicken zum Foto machen/auswählen<br>
                                    <small>KI bewertet automatisch Qualität, Komposition & Kreativität</small>
                                </div>
                            </div>
                            
                            <input type="file" class="file-input" id="photo-input-${station.id}" accept="image/*" capture="environment" onchange="handlePhotoUpload(${station.id}, event)">
                            
                            <div class="ai-rating hidden" id="rating-${station.id}">
                                <div class="rating-score" id="score-${station.id}">0</div>
                                <div class="rating-text" id="rating-text-${station.id}">KI analysiert dein Foto...</div>
                                <div class="rating-details" id="rating-details-${station.id}"></div>
                            </div>
                        </div>

                        <button class="btn" onclick="completeStation(${station.id})" id="complete-btn-${station.id}" 
                                ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? '✅ Station abgeschlossen' : '🏁 Station abschließen'}
                        </button>
                    </div>
                `;
                
                container.appendChild(stationCard);
            });
        } catch (error) {
            console.error('Error generating stations list:', error);
        }
    }

    function toggleStationDetails(stationId) {
        try {
            const details = document.getElementById(`station-${stationId}`);
            if (details) {
                details.classList.toggle('active');
            }
        } catch (error) {
            console.error('Error toggling station details:', error);
        }
    }

    function selectPhoto(stationId) {
        try {
            const input = document.getElementById(`photo-input-${stationId}`);
            if (input) {
                input.click();
            }
        } catch (error) {
            console.error('Error selecting photo:', error);
        }
    }

    function handlePhotoUpload(stationId, event) {
        try {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                
                const uploadArea = document.getElementById(`upload-area-${stationId}`);
                if (uploadArea) {
                    uploadArea.classList.add('has-photo');
                    uploadArea.innerHTML = `
                        <img src="${imageUrl}" class="photo-preview" alt="Uploaded photo">
                        <p>📷 Foto erfolgreich hochgeladen!</p>
                        <small>KI analysiert...</small>
                    `;
                }

                const photoData = {
                    stationId: stationId,
                    imageUrl: imageUrl,
                    timestamp: Date.now(),
                    teamId: tourApp.state.selectedTeam
                };

                const existingIndex = tourApp.state.uploadedPhotos.findIndex(p => p.stationId === stationId);
                if (existingIndex >= 0) {
                    tourApp.state.uploadedPhotos[existingIndex] = photoData;
                } else {
                    tourApp.state.uploadedPhotos.push(photoData);
                }

                setTimeout(() => ratePhoto(stationId, imageUrl), 1000);
                saveState();
            };
            
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('Error handling photo upload:', error);
        }
    }

    function ratePhoto(stationId, imageUrl) {
        try {
            const ratingDiv = document.getElementById(`rating-${stationId}`);
            if (ratingDiv) {
                ratingDiv.classList.remove('hidden');
            }
            
            const baseScore = 50 + Math.random() * 40;
            const technicalScore = 70 + Math.random() * 25;
            const compositionScore = 60 + Math.random() * 30;
            const creativityScore = 55 + Math.random() * 35;
            
            const finalScore = Math.round(baseScore);
            
            animateScore(stationId, finalScore);
            
            const feedback = generatePhotoFeedback(technicalScore, compositionScore, creativityScore);
            
            setTimeout(() => {
                const ratingTextEl = document.getElementById(`rating-text-${stationId}`);
                const ratingDetailsEl = document.getElementById(`rating-details-${stationId}`);
                
                if (ratingTextEl) {
                    ratingTextEl.innerHTML = `
                        <strong>KI-Bewertung abgeschlossen!</strong><br>
                        Qualität: ${Math.round(technicalScore)}% | 
                        Komposition: ${Math.round(compositionScore)}% | 
                        Kreativität: ${Math.round(creativityScore)}%
                    `;
                }
                
                if (ratingDetailsEl) {
                    ratingDetailsEl.innerHTML = feedback.join('<br>');
                }
            }, 2000);
            
            addScore(finalScore);
            
            const photoData = tourApp.state.uploadedPhotos.find(p => p.stationId === stationId);
            if (photoData) {
                photoData.score = finalScore;
            }
            
            showNotification(`KI-Bewertung: ${finalScore} Punkte! 🤖`);
        } catch (error) {
            console.error('Error rating photo:', error);
        }
    }

    function animateScore(stationId, targetScore) {
        try {
            const scoreElement = document.getElementById(`score-${stationId}`);
            if (!scoreElement) return;
            
            let currentScore = 0;
            const increment = Math.ceil(targetScore / 30);
            
            const interval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(interval);
                }
                scoreElement.textContent = currentScore;
            }, 50);
        } catch (error) {
            console.error('Error animating score:', error);
        }
    }

    function generatePhotoFeedback(technical, composition, creativity) {
        const feedback = [];
        
        if (technical > 75) {
            feedback.push("📸 Sehr scharfes und gut belichtetes Bild!");
        } else if (technical < 50) {
            feedback.push("⚠️ Bild könnte schärfer oder besser belichtet sein");
        }
        
        if (composition > 70) {
            feedback.push("🎨 Tolle Bildkomposition!");
        } else {
            feedback.push("💡 Tipp: Achte auf die Bildaufteilung");
        }
        
        if (creativity > 75) {
            feedback.push("✨ Sehr kreative Aufnahme!");
        } else if (creativity > 60) {
            feedback.push("🎭 Schöne kreative Elemente!");
        }
        
        feedback.push("👥 Toll, dass ihr als Team fotografiert!");
        
        return feedback;
    }

    function completeStation(stationId) {
        try {
            if (!tourApp.state.completedStations.includes(stationId)) {
                tourApp.state.completedStations.push(stationId);
                updateProgress();
                showNotification('Station abgeschlossen! 🏁');
                
                const completeBtn = document.getElementById(`complete-btn-${stationId}`);
                if (completeBtn) {
                    const stationCard = completeBtn.closest('.station-card');
                    if (stationCard) {
                        stationCard.classList.add('completed');
                        const stationNumber = stationCard.querySelector('.station-number');
                        if (stationNumber) {
                            stationNumber.classList.add('completed');
                        }
                    }
                    
                    completeBtn.disabled = true;
                    completeBtn.textContent = '✅ Station abgeschlossen';
                    completeBtn.style.background = '#6b7280';
                }

                if (tourApp.state.completedStations.length === tourApp.stations.length) {
                    showNotification('🎉 Herzlichen Glückwunsch! Tour abgeschlossen!');
                    setTimeout(() => {
                        showTab('ranking', document.querySelector('[onclick*="ranking"]'));
                    }, 2000);
                }

                saveState();
                addSystemMessage(`${tourApp.state.userName} hat "${tourApp.stations.find(s => s.id === stationId)?.title}" abgeschlossen! 🏁`);
            }
        } catch (error) {
            console.error('Error completing station:', error);
        }
    }

    function updateUI() {
        try {
            const scoreElement = document.getElementById('totalScore');
            if (scoreElement) {
                scoreElement.textContent = tourApp.state.totalScore;
            }
            updateProgress();
        } catch (error) {
            console.error('Error updating UI:', error);
        }
    }

    function updateProgress() {
        try {
            const progress = (tourApp.state.completedStations.length / tourApp.stations.length) * 100;
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        } catch (error) {
            console.error('Error updating progress:', error);
        }
    }

    function addChatMessage(userName, message, isOwn = false) {
        try {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;
            
            const timeStr = new Date().toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <strong>${userName}:</strong> ${message}
                <span class="timestamp">${timeStr}</span>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            if (!isOwn && !document.getElementById('chat').classList.contains('active')) {
                showNotification(`💬 ${userName}: ${message.substring(0, 30)}${message.length > 30 ? '...' : ''}`);
            }
        } catch (error) {
            console.error('Error adding chat message:', error);
        }
    }

    function addSystemMessage(message) {
        try {
            setTimeout(() => {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message system';
                
                const timeStr = new Date().toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageDiv.innerHTML = `
                    <strong>System:</strong> ${message}
                    <span class="timestamp">${timeStr}</span>
                `;
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        } catch (error) {
            console.error('Error adding system message:', error);
        }
    }

    // Admin Functions
    function generateAdminContentEditor() {
        try {
            const container = document.getElementById('adminContentEditor');
            if (!container) return;
            
            container.innerHTML = '';
            
            tourApp.stations.forEach(station => {
                const editorSection = document.createElement('div');
                editorSection.className = 'content-edit-section';
                editorSection.innerHTML = `
                    <h5 style="color: #1f2937; margin-bottom: 1rem;">Station ${station.id}: ${station.title}</h5>
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Titel:</label>
                    <input type="text" class="edit-field" id="admin-title-${station.id}" value="${station.title}">
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Untertitel:</label>
                    <input type="text" class="edit-field" id="admin-subtitle-${station.id}" value="${station.subtitle}">
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Beschreibung:</label>
                    <textarea class="edit-field" id="admin-description-${station.id}" rows="3">${station.description}</textarea>
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Haupttext:</label>
                    <textarea class="edit-field" id="admin-maintext-${station.id}" rows="6">${station.mainText}</textarea>
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Foto-Challenge:</label>
                    <textarea class="edit-field" id="admin-challenge-${station.id}" rows="3">${station.photoChallenge}</textarea>
                    
                    <div class="edit-controls">
                        <button class="btn btn-admin btn-small" onclick="saveStationContent(${station.id})">💾 Speichern</button>
                        <button class="btn btn-secondary btn-small" onclick="resetStationContent(${station.id})">🔄 Zurücksetzen</button>
                    </div>
                `;
                container.appendChild(editorSection);
            });
        } catch (error) {
            console.error('Error generating admin content editor:', error);
        }
    }

    function saveStationContent(stationId) {
        try {
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station) return;
            
            station.title = document.getElementById(`admin-title-${stationId}`).value;
            station.subtitle = document.getElementById(`admin-subtitle-${stationId}`).value;
            station.description = document.getElementById(`admin-description-${stationId}`).value;
            station.mainText = document.getElementById(`admin-maintext-${stationId}`).value;
            station.photoChallenge = document.getElementById(`admin-challenge-${stationId}`).value;
            
            // Update Firebase
            saveToFirebase('stations', stationId.toString(), station);
            
            // Refresh UI
            generateStationsList();
            
            showNotification(`Station ${stationId} aktualisiert! 📝`);
            addSystemMessage(`Admin hat Station "${station.title}" aktualisiert! 📝`);
        } catch (error) {
            console.error('Error saving station content:', error);
            showNotification('Fehler beim Speichern', 'error');
        }
    }

    function resetStationContent(stationId) {
        try {
            if (confirm('Station-Inhalte auf Standardwerte zurücksetzen?')) {
                generateAdminContentEditor();
                showNotification('Inhalte zurückgesetzt!');
            }
        } catch (error) {
            console.error('Error resetting station content:', error);
        }
    }

    function editChallenge(stationId) {
        try {
            const challengeDiv = document.getElementById(`challenge-${stationId}`);
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!challengeDiv || !station) return;
            
            challengeDiv.innerHTML = `
                <div class="inline-edit">
                    <textarea id="edit-challenge-${stationId}" style="width: 100%; height: 80px; padding: 0.5rem; border: 2px solid #f59e0b; border-radius: 8px; font-family: inherit;">${station.photoChallenge}</textarea>
                    <div style="margin-top: 0.5rem;">
                        <button class="btn btn-admin btn-small" onclick="saveInlineChallenge(${stationId})">💾 Speichern</button>
                        <button class="btn btn-secondary btn-small" onclick="cancelEditChallenge(${stationId})">❌ Abbrechen</button>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error editing challenge:', error);
        }
    }

    function saveInlineChallenge(stationId) {
        try {
            const textarea = document.getElementById(`edit-challenge-${stationId}`);
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!textarea || !station) return;
            
            station.photoChallenge = textarea.value;
            saveToFirebase('stations', stationId.toString(), station);
            generateStationsList();
            showNotification('Challenge aktualisiert! 📸');
            addSystemMessage(`Admin hat die Challenge für "${station.title}" aktualisiert! 📝`);
        } catch (error) {
            console.error('Error saving inline challenge:', error);
        }
    }

    function cancelEditChallenge(stationId) {
        try {
            generateStationsList();
        } catch (error) {
            console.error('Error canceling edit challenge:', error);
        }
    }

    // Chat Moderation Functions
    function enableChatModeration() {
        try {
            if (!tourApp.state.isAdmin) return;
            
            tourApp.state.isChatModerationActive = true;
            
            // Add moderation controls to existing messages
            document.querySelectorAll('.chat-message:not(.system)').forEach(message => {
                message.classList.add('admin-mode');
            });
            
            updateChatModerationButton();
        } catch (error) {
            console.error('Error enabling chat moderation:', error);
        }
    }

    function toggleChatModeration() {
        try {
            tourApp.state.isChatModerationActive = !tourApp.state.isChatModerationActive;
            
            if (tourApp.state.isChatModerationActive) {
                enableChatModeration();
                showNotification('Chat-Moderation aktiviert! 🛡️');
            } else {
                document.querySelectorAll('.chat-message').forEach(message => {
                    message.classList.remove('admin-mode');
                });
                showNotification('Chat-Moderation deaktiviert!');
            }
            
            updateChatModerationButton();
        } catch (error) {
            console.error('Error toggling chat moderation:', error);
        }
    }

    function updateChatModerationButton() {
        try {
            const button = document.getElementById('chatModerationText');
            if (button) {
                button.textContent = tourApp.state.isChatModerationActive 
                    ? '🛡️ Moderations-Modus deaktivieren' 
                    : '🛡️ Moderations-Modus aktivieren';
            }
        } catch (error) {
            console.error('Error updating chat moderation button:', error);
        }
    }

    function deleteMessage(button) {
        try {
            if (!tourApp.state.isAdmin) return;
            
            const messageDiv = button.closest('.chat-message');
            if (messageDiv && confirm('Nachricht löschen?')) {
                messageDiv.remove();
                showNotification('Nachricht gelöscht! 🗑️');
            }
        } catch (error) {
            console.error('Error deleting message:', error);
        }
    }

    function clearAllChatMessages() {
        try {
            if (!tourApp.state.isAdmin) return;
            
            if (confirm('Wirklich alle Chat-Nachrichten löschen?')) {
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.innerHTML = `
                        <div class="chat-message system">
                            <strong>System:</strong> Chat wurde von einem Admin geleert! 🗑️<br>
                            <small>Neue Nachrichten werden wieder angezeigt</small>
                            <span class="timestamp">jetzt</span>
                        </div>
                    `;
                }
                
                // Clear Firebase chat
                if (tourApp.state.isFirebaseConnected) {
                    const chatRef = db.collection('tours').doc(tourApp.state.tourId).collection('chat');
                    chatRef.get().then(snapshot => {
                        snapshot.forEach(doc => doc.ref.delete());
                    });
                }
                
                // Clear localStorage chat
                localStorage.removeItem(`chat_${tourApp.state.tourId}`);
                
                showNotification('Alle Nachrichten gelöscht! 🗑️');
                addSystemMessage('Admin hat alle Chat-Nachrichten gelöscht! 🗑️');
            }
        } catch (error) {
            console.error('Error clearing all chat messages:', error);
        }
    }

    function sendAdminAnnouncement() {
        try {
            if (!tourApp.state.isAdmin) return;
            
            const announcement = prompt('Admin-Ankündigung eingeben:');
            if (announcement && announcement.trim()) {
                addChatMessage('📢 ADMIN', announcement.trim(), false, 'system');
                
                if (tourApp.state.isFirebaseConnected) {
                    saveToFirebase('chat', Date.now().toString(), {
                        userName: '📢 ADMIN',
                        message: announcement.trim(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showNotification('Ankündigung gesendet! 📢');
            }
        } catch (error) {
            console.error('Error sending admin announcement:', error);
        }
    }

    // Media Upload Functions
    function selectChatImage() {
        try {
            const input = document.getElementById('chatImageInput');
            if (input) {
                input.click();
            }
        } catch (error) {
            console.error('Error selecting chat image:', error);
        }
    }

    async function uploadChatImage(event) {
        try {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageUrl = e.target.result;
                
                // For demo, use data URL. In production, upload to Firebase Storage
                addChatMessage(tourApp.state.userName, '📷 Bild gesendet', true, 'image', imageUrl);
                
                if (tourApp.state.isFirebaseConnected) {
                    await saveToFirebase('chat', Date.now().toString(), {
                        userName: tourApp.state.userName,
                        message: '📷 Bild gesendet',
                        messageType: 'image',
                        mediaUrl: imageUrl, // In production: upload to Storage first
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showNotification('Bild gesendet! 📷');
            };
            
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('Error uploading chat image:', error);
            showNotification('Fehler beim Bild-Upload', 'error');
        }
    }

    function toggleAudioRecording() {
        try {
            if (tourApp.state.isRecording) {
                stopAudioRecording();
            } else {
                startAudioRecording();
            }
        } catch (error) {
            console.error('Error toggling audio recording:', error);
            showNotification('Audio-Aufnahme nicht verfügbar', 'error');
        }
    }

    async function startAudioRecording() {
        try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Audio recording not supported');
            }
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            tourApp.state.audioRecorder = new MediaRecorder(stream);
            
            const audioChunks = [];
            tourApp.state.audioRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            tourApp.state.audioRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                addChatMessage(tourApp.state.userName, '🎤 Audio-Nachricht', true, 'audio', audioUrl);
                
                // Clean up
                stream.getTracks().forEach(track => track.stop());
            };
            
            tourApp.state.audioRecorder.start();
            tourApp.state.isRecording = true;
            
            const button = document.getElementById('audioRecordBtn');
            if (button) {
                button.textContent = '⏹️ Stop';
                button.classList.add('recording');
            }
            
            showNotification('🎤 Aufnahme gestartet...');
        } catch (error) {
            console.error('Error starting audio recording:', error);
            showNotification('Mikrofon-Zugriff verweigert', 'error');
        }
    }

    function stopAudioRecording() {
        try {
            if (tourApp.state.audioRecorder && tourApp.state.isRecording) {
                tourApp.state.audioRecorder.stop();
                tourApp.state.isRecording = false;
                
                const button = document.getElementById('audioRecordBtn');
                if (button) {
                    button.textContent = '🎤 Audio';
                    button.classList.remove('recording');
                }
                
                showNotification('🎤 Aufnahme beendet!');
            }
        } catch (error) {
            console.error('Error stopping audio recording:', error);
        }
    }

    // Tour Management Functions
    function exportTourData() {
        try {
            const tourData = {
                tourId: tourApp.state.tourId,
                stations: tourApp.stations,
                completedStations: tourApp.state.completedStations,
                uploadedPhotos: tourApp.state.uploadedPhotos,
                totalScore: tourApp.state.totalScore,
                selectedTeam: tourApp.state.selectedTeam,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(tourData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `koeln-tour-${tourApp.state.tourId}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Tour-Daten exportiert! 💾');
        } catch (error) {
            console.error('Error exporting tour data:', error);
            showNotification('Fehler beim Export', 'error');
        }
    }

    function resetTour() {
        try {
            if (confirm('Wirklich alle Tour-Daten zurücksetzen? Dies kann nicht rückgängig gemacht werden!')) {
                // Clear Firebase data
                if (tourApp.state.isFirebaseConnected) {
                    const tourRef = db.collection('tours').doc(tourApp.state.tourId);
                    tourRef.collection('chat').get().then(snapshot => {
                        snapshot.forEach(doc => doc.ref.delete());
                    });
                    tourRef.collection('scores').get().then(snapshot => {
                        snapshot.forEach(doc => doc.ref.delete());
                    });
                }
                
                // Clear localStorage
                localStorage.removeItem(`chat_${tourApp.state.tourId}`);
                localStorage.removeItem(`scores_${tourApp.state.tourId}`);
                localStorage.removeItem('tourState');
                
                // Reset app state
                tourApp.state.completedStations = [];
                tourApp.state.totalScore = 0;
                tourApp.state.uploadedPhotos = [];
                tourApp.state.selectedTeam = null;
                tourApp.state.teamName = '';
                
                // Refresh UI
                document.getElementById('teamSelector').style.display = 'block';
                generateStationsList();
                updateUI();
                
                // Clear chat
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.innerHTML = `
                        <div class="chat-message system">
                            <strong>System:</strong> Tour wurde zurückgesetzt! 🔄<br>
                            <small>Alle Daten wurden gelöscht</small>
                            <span class="timestamp">jetzt</span>
                        </div>
                    `;
                }
                
                showNotification('Tour zurückgesetzt! 🔄');
                addSystemMessage('Admin hat die Tour komplett zurückgesetzt! 🔄');
            }
        } catch (error) {
            console.error('Error resetting tour:', error);
            showNotification('Fehler beim Zurücksetzen', 'error');
        }
    }

    function refreshAdminStats() {
        try {
            if (!tourApp.state.isAdmin) return;
            
            // Count active users (simplified)
            const activeUsers = Math.floor(Math.random() * 15) + 5;
            
            // Count messages in chat container
            const totalMessages = document.querySelectorAll('.chat-message:not(.system)').length;
            
            // Count completed stations
            const completedStations = tourApp.state.completedStations.length;
            
            // Count uploaded photos
            const uploadedPhotos = tourApp.state.uploadedPhotos.length;
            
            // Update stats display
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('completedStations').textContent = `${completedStations}/${tourApp.stations.length}`;
            document.getElementById('uploadedPhotos').textContent = uploadedPhotos;
            
        } catch (error) {
            console.error('Error refreshing admin stats:', error);
        }
    }

    // Map Functions
    function initMap() {
        try {
            if (tourApp.state.map || !document.getElementById('map')) return;
            
            if (typeof L === 'undefined') {
                loadLeaflet(() => createMap());
            } else {
                createMap();
            }
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    function loadLeaflet(callback) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
        script.onload = callback;
        script.onerror = () => showMapError();
        document.head.appendChild(script);
    }

    function createMap() {
        try {
            tourApp.state.map = L.map('map').setView([50.9375, 6.9597], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(tourApp.state.map);
            
            tourApp.stations.forEach(station => {
                const isCompleted = tourApp.state.completedStations.includes(station.id);
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center; max-width: 200px;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}/${tourApp.stations.length}</strong></p>
                            ${isCompleted ? '<p style="color: green;">✅ Abgeschlossen</p>' : '<p style="color: orange;">⏳ Ausstehend</p>'}
                        </div>
                    `)
                    .addTo(tourApp.state.map);
                
                tourApp.state.markers.push(marker);
            });
            
            const routeCoordinates = tourApp.stations.map(station => [station.lat, station.lng]);
            L.polyline(routeCoordinates, {
                color: '#dc2626',
                weight: 3,
                opacity: 0.7
            }).addTo(tourApp.state.map);
            
            if (tourApp.state.userLocation) {
                addUserLocationToMap();
            }
        } catch (error) {
            console.error('Error creating map:', error);
        }
    }

    function showMapError() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
            mapEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 10px;"><p>🗺️ Karte konnte nicht geladen werden</p></div>';
        }
    }

    function addUserLocationToMap() {
        try {
            if (!tourApp.state.map || !tourApp.state.userLocation) return;
            
            const userIcon = L.divIcon({
                html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                className: 'user-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            L.marker([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], {
                icon: userIcon
            })
            .bindPopup('📍 Dein Standort')
            .addTo(tourApp.state.map);
        } catch (error) {
            console.error('Error adding user location to map:', error);
        }
    }

    function centerOnUser() {
        try {
            if (tourApp.state.userLocation && tourApp.state.map) {
                tourApp.state.map.setView([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], 17);
            } else {
                showNotification('Standort nicht verfügbar. Bitte erlaube Standortzugriff.', 'error');
            }
        } catch (error) {
            console.error('Error centering on user:', error);
        }
    }

    function initGeolocation() {
        try {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        tourApp.state.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateLocationInfo();
                        if (tourApp.state.map) {
                            addUserLocationToMap();
                        }
                    },
                    error => {
                        const distanceInfo = document.getElementById('distanceInfo');
                        if (distanceInfo) {
                            distanceInfo.textContent = '📍 Standort nicht verfügbar';
                        }
                    }
                );
            }
        } catch (error) {
            console.error('Error initializing geolocation:', error);
        }
    }

    function updateLocationInfo() {
        try {
            if (!tourApp.state.userLocation) return;
            
            let nearestStation = null;
            let minDistance = Infinity;
            
            tourApp.stations.forEach(station => {
                const distance = calculateDistance(
                    tourApp.state.userLocation.lat, tourApp.state.userLocation.lng,
                    station.lat, station.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            });
            
            if (nearestStation) {
                const distanceText = minDistance < 1 
                    ? `${Math.round(minDistance * 1000)}m` 
                    : `${minDistance.toFixed(1)}km`;
                
                const distanceInfo = document.getElementById('distanceInfo');
                if (distanceInfo) {
                    distanceInfo.textContent = `📍 Nächste Station: ${nearestStation.title} (${distanceText})`;
                }
            }
        } catch (error) {
            console.error('Error updating location info:', error);
        }
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Utility Functions
    function showImageModal(url, title, description) {
        try {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                flex-direction: column;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            const imageContent = url === 'placeholder' ? `
                <div style="width: 300px; height: 200px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 3rem;">📷</div>
            ` : `
                <img src="${url}" style="max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px;">
            `;
            
            modal.innerHTML = `
                ${imageContent}
                <div style="color: white; text-align: center; margin-top: 20px; max-width: 600px;">
                    <h3>${title}</h3>
                    <p>${description}</p>
                    <button style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">Schließen</button>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        } catch (error) {
            console.error('Error showing image modal:', error);
        }
    }

    function showNotification(message, type = 'success') {
        try {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        } catch (error) {
            console.error('Error showing notification:', error);
        }
    }

    function saveState() {
        try {
            const stateToSave = {
                ...tourApp.state,
                map: null,
                markers: [],
                syncListeners: [],
                audioRecorder: null
            };
            localStorage.setItem('tourState', JSON.stringify(stateToSave));
        } catch (error) {
            console.error('Error saving state:', error);
        }
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('tourState');
            if (saved) {
                const savedState = JSON.parse(saved);
                tourApp.state = { ...tourApp.state, ...savedState };
                
                if (tourApp.state.selectedTeam) {
                    setTimeout(() => {
                        const teamOptions = document.querySelectorAll('.team-option');
                        teamOptions.forEach(option => {
                            if (option.textContent.includes(tourApp.state.teamName)) {
                                option.classList.add('selected');
                            }
                        });
                        const selector = document.getElementById('teamSelector');
                        if (selector) {
                            selector.style.display = 'none';
                        }
                    }, 100);
                }
            }
        } catch (error) {
            console.error('Error loading state:', error);
        }
    }

    // Initialize app when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initApp, 100);
        });
    } else {
        setTimeout(initApp, 100);
    }

    </script>
</body>
</html>
                    <strong>System:</strong> ${message}
                    <span class="timestamp">${timeStr}</span>
                `;
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        } catch (error) {
            console.error('Error adding system message:', error);
        }
    }

    async function loadChatHistory() {
        try {
            if (tourApp.state.isFirebaseConnected) {
                const messages = await getFromFirebase('chat');
                messages.forEach(msg => {
                    if (msg.userName !== tourApp.state.userName) {
                        addChatMessage(msg.userName, msg.message, false);
                    }
                });
            } else {
                const chatMessages = JSON.parse(localStorage.getItem(`chat_${tourApp.state.tourId}`) || '[]');
                chatMessages.forEach(msg => {
                    addChatMessage(msg.userName, msg.message, msg.userName === tourApp.state.userName);
                });
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
    }

    // Map initialization (simplified)
    function initMap() {
        try {
            if (tourApp.state.map || !document.getElementById('map')) return;
            
            if (typeof L === 'undefined') {
                loadLeaflet(() => createMap());
            } else {
                createMap();
            }
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    function loadLeaflet(callback) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
        script.onload = callback;
        script.onerror = () => showMapError();
        document.head.appendChild(script);
    }

    function createMap() {
        try {
            tourApp.state.map = L.map('map').setView([50.9375, 6.9597], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(tourApp.state.map);
            
            tourApp.stations.forEach(station => {
                const isCompleted = tourApp.state.completedStations.includes(station.id);
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center; max-width: 200px;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}/${tourApp.stations.length}</strong></p>
                            ${isCompleted ? '<p style="color: green;">✅ Abgeschlossen</p>' : '<p style="color: orange;">⏳ Ausstehend</p>'}
                        </div>
                    `)
                    .addTo(tourApp.state.map);
                
                tourApp.state.markers.push(marker);
            });
            
            const routeCoordinates = tourApp.stations.map(station => [station.lat, station.lng]);
            L.polyline(routeCoordinates, {
                color: '#dc2626',
                weight: 3,
                opacity: 0.7
            }).addTo(tourApp.state.map);
            
            if (tourApp.state.userLocation) {
                addUserLocationToMap();
            }
        } catch (error) {
            console.error('Error creating map:', error);
        }
    }

    function showMapError() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
            mapEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 10px;"><p>🗺️ Karte konnte nicht geladen werden</p></div>';
        }
    }

    function addUserLocationToMap() {
        try {
            if (!tourApp.state.map || !tourApp.state.userLocation) return;
            
            const userIcon = L.divIcon({
                html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                className: 'user-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            L.marker([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], {
                icon: userIcon
            })
            .bindPopup('📍 Dein Standort')
            .addTo(tourApp.state.map);
        } catch (error) {
            console.error('Error adding user location to map:', error);
        }
    }

    function centerOnUser() {
        try {
            if (tourApp.state.userLocation && tourApp.state.map) {
                tourApp.state.map.setView([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], 17);
            } else {
                showNotification('Standort nicht verfügbar. Bitte erlaube Standortzugriff.', 'error');
            }
        } catch (error) {
            console.error('Error centering on user:', error);
        }
    }

    function initGeolocation() {
        try {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        tourApp.state.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateLocationInfo();
                        if (tourApp.state.map) {
                            addUserLocationToMap();
                        }
                    },
                    error => {
                        const distanceInfo = document.getElementById('distanceInfo');
                        if (distanceInfo) {
                            distanceInfo.textContent = '📍 Standort nicht verfügbar';
                        }
                    }
                );
            }
        } catch (error) {
            console.error('Error initializing geolocation:', error);
        }
    }

    function updateLocationInfo() {
        try {
            if (!tourApp.state.userLocation) return;
            
            let nearestStation = null;
            let minDistance = Infinity;
            
            tourApp.stations.forEach(station => {
                const distance = calculateDistance(
                    tourApp.state.userLocation.lat, tourApp.state.userLocation.lng,
                    station.lat, station.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            });
            
            if (nearestStation) {
                const distanceText = minDistance < 1 
                    ? `${Math.round(minDistance * 1000)}m` 
                    : `${minDistance.toFixed(1)}km`;
                
                const distanceInfo = document.getElementById('distanceInfo');
                if (distanceInfo) {
                    distanceInfo.textContent = `📍 Nächste Station: ${nearestStation.title} (${distanceText})`;
                }
            }
        } catch (error) {
            console.error('Error updating location info:', error);
        }
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function showImageModal(url, title, description) {
        try {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                flex-direction: column;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <img src="${url}" style="max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px;">
                <div style="color: white; text-align: center; margin-top: 20px; max-width: 600px;">
                    <h3>${title}</h3>
                    <p>${description}</p>
                    <button style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">Schließen</button>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        } catch (error) {
            console.error('Error showing image modal:', error);
        }
    }

    function resetTour() {
        try {
            if (confirm('Wirklich alle Daten zurücksetzen?')) {
                localStorage.removeItem(`chat_${tourApp.state.tourId}`);
                
                tourApp.state.completedStations = [];
                tourApp.state.totalScore = 0;
                tourApp.state.uploadedPhotos = [];
                
                saveState();
                generateStationsList();
                updateUI();
                showNotification('Tour zurückgesetzt! 🔄');
                addSystemMessage('Admin hat die Tour zurückgesetzt! 🔄');
            }
        } catch (error) {
            console.error('Error resetting tour:', error);
        }
    }

    function showNotification(message, type = 'success') {
        try {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        } catch (error) {
            console.error('Error showing notification:', error);
        }
    }

    function saveState() {
        try {
            const stateToSave = {
                ...tourApp.state,
                map: null,
                markers: [],
                syncListeners: []
            };
            localStorage.setItem('tourState', JSON.stringify(stateToSave));
        } catch (error) {
            console.error('Error saving state:', error);
        }
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('tourState');
            if (saved) {
                const savedState = JSON.parse(saved);
                tourApp.state = { ...tourApp.state, ...savedState };
                
                if (tourApp.state.selectedTeam) {
                    setTimeout(() => {
                        const teamOptions = document.querySelectorAll('.team-option');
                        teamOptions.forEach(option => {
                            if (option.textContent.includes(tourApp.state.teamName)) {
                                option.classList.add('selected');
                            }
                        });
                        const selector = document.getElementById('teamSelector');
                        if (selector) {
                            selector.style.display = 'none';
                        }
                    }, 100);
                }
            }
        } catch (error) {
            console.error('Error loading state:', error);
        }
    }

    // Initialize app when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initApp, 100);
        });
    } else {
        setTimeout(initApp, 100);
    }

    </script>
</body>
</html>
