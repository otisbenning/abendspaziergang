<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kölner Abendspaziergang</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiS8O2bG5lciBBYmVuZHNwYXppZXJnYW5nIiwic2hvcnRfbmFtZSI6IkrDtmxuVG91ciIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMjEyMTIxIiwidGhlbWVfY29sb3IiOiIjZGMyNjI2IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBek1qQWlJR1pzYkdwMGRHVnlQU0owYVhSc1pTSWdabWxzYkQwaWJtOXVaU0krUEhKbFkzUWdkMmxrZEdnOUlqRXlPQ0lnYUdWcFoyaDBQU0l6TWpBaUlHWnBiR3c5SWlOa1l6STJNallpTHo0OEwzTjJaejQiLCJzaXplcyI6IjEyOHgxMjgifV19">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .progress-container {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            background: #fbbf24;
            height: 100%;
            width: 0%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .main-content {
            padding: 0;
        }

        .tab-container {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 132px;
            z-index: 999;
        }

        .tab {
            flex: 1;
            padding: 1rem 0.5rem;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .tab.active {
            background: white;
            color: #dc2626;
            border-bottom: 3px solid #dc2626;
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            min-height: calc(100vh - 200px);
        }

        .tab-content.active {
            display: block;
        }

        .station-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #dc2626;
            cursor: pointer;
            transition: all 0.3s;
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .station-card.completed {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .station-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .station-number {
            background: #dc2626;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .station-number.completed {
            background: #10b981;
        }

        .station-title {
            flex: 1;
            font-size: 1.3rem;
            font-weight: bold;
            color: #1f2937;
        }

        .station-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .station-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }

        .station-details.active {
            display: block;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h4 {
            color: #dc2626;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .detail-section h4::before {
            content: "▶";
            margin-right: 0.5rem;
            color: #dc2626;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .image-placeholder {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            color: #6b7280;
            border: 2px dashed #d1d5db;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-placeholder:hover {
            background: linear-gradient(135deg, #ddd6fe 0%, #c7d2fe 100%);
            border-color: #8b5cf6;
        }

        .activity-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #f59e0b;
        }

        .activity-title {
            font-weight: bold;
            color: #92400e;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .quiz-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .quiz-option.selected {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .quiz-option.correct {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .quiz-option.wrong {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .btn:hover {
            background: #991b1b;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .score-display {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
            border: 2px solid #8b5cf6;
        }

        .score-number {
            font-size: 2rem;
            font-weight: bold;
            color: #5b21b6;
        }

        .score-label {
            color: #7c3aed;
            margin-top: 0.5rem;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .location-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .distance-info {
            font-weight: bold;
            color: #0369a1;
            margin-bottom: 0.5rem;
        }

        .team-selector {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .team-option {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .team-option:hover {
            background: #f3f4f6;
        }

        .team-option.selected {
            background: #dbeafe;
            border: 2px solid #3b82f6;
        }

        .team-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .offline-indicator {
            background: #f59e0b;
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
            display: none;
        }

        .offline-indicator.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                box-shadow: none;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .tab {
                font-size: 0.8rem;
                padding: 0.8rem 0.3rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .station-card {
                padding: 1rem;
            }
            
            .image-gallery {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc2626;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #10b981;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .role-play-card {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #6366f1;
        }

        .person-role {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.8rem 0;
            border-left: 4px solid #8b5cf6;
        }

        .person-role strong {
            color: #5b21b6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="offline-indicator" id="offlineIndicator">
            📡 Offline-Modus aktiv - Alle Inhalte gespeichert
        </div>

        <header>
            <h1>🏛️ Kölner Abendspaziergang</h1>
            <p class="subtitle">Entdecke 2000 Jahre Stadtgeschichte</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </header>

        <div class="main-content">
            <div class="tab-container">
                <button class="tab active" onclick="showTab('overview')">🗺️ Übersicht</button>
                <button class="tab" onclick="showTab('stations')">📍 Stationen</button>
                <button class="tab" onclick="showTab('map')">🗺️ Karte</button>
                <button class="tab" onclick="showTab('team')">👥 Team</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="score-display">
                    <div class="score-number" id="totalScore">0</div>
                    <div class="score-label">Kölner Kronen gesammelt</div>
                </div>

                <div class="team-selector" id="teamSelector">
                    <h3 style="margin-bottom: 1rem; color: #374151;">🎯 Wähle dein Team:</h3>
                    <div class="team-option" onclick="selectTeam('red', '🔴 Team Römer')">
                        <div class="team-color" style="background: #dc2626;"></div>
                        <span>🔴 Team Römer</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('blue', '🔵 Team Gaffeln')">
                        <div class="team-color" style="background: #2563eb;"></div>
                        <span>🔵 Team Gaffeln</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('green', '🟢 Team Hanseat')">
                        <div class="team-color" style="background: #059669;"></div>
                        <span>🟢 Team Hanseat</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('yellow', '🟡 Team Modern')">
                        <div class="team-color" style="background: #d97706;"></div>
                        <span>🟡 Team Modern</span>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">📋 Tour-Informationen</h3>
                    <p><strong>⏰ Dauer:</strong> ca. 3,5 Stunden</p>
                    <p><strong>📍 Start:</strong> Heumarkt, 19:30 Uhr</p>
                    <p><strong>🎯 Ziel:</strong> Alte Bastion</p>
                    <p><strong>👥 Teilnehmer:</strong> 15-25 Personen</p>
                    <p><strong>🏆 Ziel:</strong> 300 Kronen für Meisterdetektiv</p>
                </div>

                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
                    <h4 style="color: #92400e; margin-bottom: 1rem;">⚠️ Wichtige Hinweise</h4>
                    <ul style="margin-left: 1.5rem; color: #92400e;">
                        <li>Smartphone-Akku vollständig laden</li>
                        <li>Warme Kleidung (Abendtour)</li>
                        <li>Wasserfeste Hülle empfohlen</li>
                        <li>Bei Problemen: Team-Leiter kontaktieren</li>
                    </ul>
                </div>

                <button class="btn" onclick="startTour()">🚀 Tour starten</button>
            </div>

            <!-- Stations Tab -->
            <div id="stations" class="tab-content">
                <div id="stationsList">
                    <!-- Stations will be generated here -->
                </div>
            </div>

            <!-- Map Tab -->
            <div id="map-tab" class="tab-content">
                <div class="location-info">
                    <div class="distance-info" id="distanceInfo">📍 Standort wird ermittelt...</div>
                    <p>💡 Tipp: Erlaube Standortzugriff für Navigation</p>
                </div>
                <div id="map"></div>
                <button class="btn" onclick="centerOnUser()">📍 Zu meinem Standort</button>
            </div>

            <!-- Team Tab -->
            <div id="team" class="tab-content">
                <div class="score-display">
                    <div class="score-number" id="teamScore">0</div>
                    <div class="score-label">Team: <span id="selectedTeamName">Kein Team gewählt</span></div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">🏆 Punktesystem</h3>
                    <ul style="margin-left: 1.5rem; color: #4b5563;">
                        <li><strong>Multiple Choice richtig:</strong> 10 Kronen</li>
                        <li><strong>Beobachtung gelöst:</strong> 15 Kronen</li>
                        <li><strong>Rollenspiel gespielt:</strong> 20 Kronen</li>
                        <li><strong>Station komplett:</strong> 5 Bonus-Kronen</li>
                    </ul>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">📱 App-Features</h3>
                    <ul style="margin-left: 1.5rem; color: #4b5563;">
                        <li>🌐 Offline-fähig (alle Inhalte gespeichert)</li>
                        <li>🗺️ Interaktive Karte mit Navigation</li>
                        <li>📸 Bildergalerien für jede Station</li>
                        <li>🎯 Gamifizierte Aktivitäten</li>
                        <li>👥 Team-basiertes Lernen</li>
                        <li>📊 Fortschritts-Tracking</li>
                    </ul>
                </div>

                <button class="btn btn-secondary" onclick="resetProgress()">🔄 Fortschritt zurücksetzen</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // App State
        let appState = {
            currentStation: 0,
            completedStations: [],
            totalScore: 0,
            selectedTeam: null,
            teamName: '',
            userLocation: null,
            map: null,
            markers: []
        };

        // Station Data
        const stations = [
            {
                id: 1,
                title: "Heumarkt",
                subtitle: "Wo alles anfing: 2000 Jahre Migration und Handel",
                lat: 50.9356, lng: 6.9611,
                description: "Start der Tour am historischen Heumarkt, einem der geschichtsträchtigsten Orte Kölns.",
                mainText: `Die Stadt ist ca. 2.000 Jahre alt. CCAA - Colonia Claudia Ara Agrippinensium - wurde 50 n. Chr. von den Römern gegründet, mithilfe der germanischen Ubier. Das war übrigens eine der ersten erfolgreichen Integration zweier Kulturen in Europa. 

Hier auf dem Heumarkt stehen wir an einem der ehemaligen Einfallstore zur Stadt. Die Markmannsgasse runter, links von der heutigen Deutzer Brücke, befand sich von 1822 bis 1915 die einzige Schiffsbrücke über den Rhein - 42 schwimmende Boote, die über 30 Mal täglich für Schiffe geöffnet wurden.

Das "Stapelrecht" von 1259 bis 1804 war ein 545 Jahre gültiges Handelsprivileg. Alle Waren auf Schiffen, die an Köln vorbeifahren wollten, mussten drei Tage hier angeboten werden.`,
                images: [
                    { title: "Heumarkt 1880", description: "Historisches Foto mit Pferdekutschen" },
                    { title: "Römische Stadtentwicklung", description: "Animation der Stadtgründung" },
                    { title: "Deutzer Schiffsbrücke", description: "Technische Funktionsweise" },
                    { title: "Mittelalterlicher Markt", description: "Rekonstruktion des Handelsplatzes" }
                ],
                quiz: {
                    question: "Was bedeutete das Stapelrecht für vorbeifahrende Händler?",
                    options: [
                        "Sie durften kostenlos übernachten",
                        "Sie mussten ihre Waren 3 Tage zum Verkauf anbieten",
                        "Sie bekamen Steuererleichterungen", 
                        "Sie durften nur bestimmte Waren transportieren"
                    ],
                    correct: 1
                },
                observation: "Schaut euch 2 Minuten um: Welche Spuren der historischen Handelszeit könnt ihr heute noch erkennen?",
                roleplay: {
                    title: "Römischer Soldat trifft germanischen Ubier - erste Begegnung 50 n. Chr.",
                    roles: [
                        { name: "Römischer Soldat", description: "spricht nur Latein/Italienisch" },
                        { name: "Germanischer Ubier", description: "spricht nur Germanisch" },
                        { name: "Dolmetscher", description: "versucht zu vermitteln" }
                    ],
                    instruction: "Improvisiert 2 Minuten - wie könnte diese erste Begegnung abgelaufen sein?"
                }
            },
            {
                id: 2,
                title: "Eisenmarkt",
                subtitle: "Puppentheater, Demokratie und dunkle Zeiten",
                lat: 50.9375, lng: 6.9583,
                description: "Das Hänneschen Theater und die Geschichte der Kölner Gaffeln-Demokratie.",
                mainText: `Hier steht das Hänneschen Theater - Deutschlands ältestes Puppentheater seit 1802. Das Theater ist mehr als Kinderunterhaltung: Es ist ein politisches Kabarett. Alle Stücke spielen im "Knollendorf" - einem satirischen Abbild Kölns.

Aber wie so vieles in Köln hat auch dieses Theater eine Nazi-Vergangenheit. Während der Nazizeit wurde das Puppentheater zur Propaganda-Maschine umfunctioniert.

Hier am Eisenmarkt trafen sich zum ersten Mal Händler und Handwerker, die sich nicht mehr von oben regieren lassen wollten. Sie gründeten die erste "Gaffel" - benannt nach den gemeinsamen Mahlzeiten mit Gabeln in Brauhäusern. 1396 übernahmen 22 Gaffeln die komplette Stadtherrschaft - eine der frühesten bürgerlichen Revolutionen Europas.`,
                images: [
                    { title: "Hänneschen Theater innen", description: "Aufnahme während einer Vorstellung" },
                    { title: "Nazi-Propaganda 1938", description: "Propagandaplakat des Theaters" },
                    { title: "Bücherverbrennung Köln", description: "Eine der ersten in Deutschland 1933" },
                    { title: "Erste Gaffel-Versammlung", description: "Rekonstruktion von 1396" }
                ],
                quiz: {
                    question: "Was waren die Kölner Gaffeln?",
                    options: [
                        "Mittelalterliche Waffen",
                        "Zunft-ähnliche Organisationen der Bürger",
                        "Kirchliche Vereinigungen",
                        "Adlige Familien"
                    ],
                    correct: 1
                },
                observation: "Das Hänneschen Theater ist sehr klein. Warum glaubt ihr, war es trotzdem politisch so einflussreich?",
                roleplay: {
                    title: "Erste Gaffel-Versammlung 1396 - Händler planen die Revolution",
                    roles: [
                        { name: "Konservativer Händler", description: "hat Angst vor Veränderung" },
                        { name: "Revolutionärer Handwerker", description: "will alles ändern" },
                        { name: "Pragmatische Kauffrau", description: "sucht Kompromisse" }
                    ],
                    instruction: "Thema: Sollen wir wirklich gegen den Stadtrat rebellieren?"
                }
            },
            {
                id: 3,
                title: "Tünnes und Schäl",
                subtitle: "Kölner Humor und Selbstironie",
                lat: 50.9361, lng: 6.9578,
                description: "Die berühmten Kölner Figuren als Symbol für Stadtmensch und Landmensch.",
                mainText: `Hier seht ihr Schäl, den schlechten Stadtbewohner - besserwisserisch, schielend, oft betrunken. Und Tünnes, den gutmütigen Bauern vom Land. Schäl steht für die arroganten Städter, Tünnes für die ehrlichen Landleute, die die Stadt mit Lebensmitteln versorgen.

Diese Figuren zeigen: Die Kölner wissen, dass sie nicht die schlauesten sind - und sind stolz darauf. Selbstironie als Überlebensstrategie. In einer Stadt, die ständig zwischen verschiedenen Mächten lavieren musste, war Humor oft der einzige Widerstand.

Direkt hier zeigt uns auch die Schmitz-Säule, wie weit der Mond entfernt ist - 384.400 km. Warum? Weil es witzig ist. Typisch Köln.`,
                images: [
                    { title: "Figuren-Entwicklung", description: "Tünnes und Schäl seit 1803" },
                    { title: "Klassische Geschichten", description: "Audio-Sammlung (3 Min)" },
                    { title: "Moderne Straßenkunst", description: "Zeitgenössische Interpretationen" }
                ],
                quiz: {
                    question: "Was symbolisieren Tünnes und Schäl?",
                    options: [
                        "Reiche und Arme",
                        "Stadt- und Landmenschen", 
                        "Junge und Alte",
                        "Deutsche und Ausländer"
                    ],
                    correct: 1
                },
                observation: "Welche Details an den Statuen zeigen den Charakter der beiden Figuren? Sammelt 5 Minuten lang Beobachtungen.",
                roleplay: {
                    title: "Tünnes und Schäl diskutieren über ein aktuelles Problem",
                    roles: [
                        { name: "Tünnes", description: "ehrlich, direkt, etwas naiv" },
                        { name: "Schäl", description: "klugscheißerisch, kompliziert, städtisch" }
                    ],
                    instruction: "Thema nach Wahl: ÖPNV, Wohnungspreise, Klimawandel, etc."
                }
            },
            {
                id: 4,
                title: "Alter Markt",
                subtitle: "Macht, Rebellion und eine große Liebesgeschichte",
                lat: 50.9369, lng: 6.9572,
                description: "Das historische Rathaus und die berühmte Jan-und-Griet-Geschichte.",
                mainText: `Der Rathaus-Turm zeigt wichtige Persönlichkeiten der Kölner Geschichte. 1945 zerstört und wieder aufgebaut. Da auch die Figuren zerstört waren, wählte eine Kommission neue aus - von über 100 Kandidaten. Alle männlich. Bei einer Stadt, die quasi von einer Frau gegründet wurde: Agrippina.

Oben am Turm seht ihr den "Platz-Jabbeck" - er streckt Autoritäten die Zunge raus. So viel Respekt hatten die Kölner für die Obrigkeit.

Der Jan-von-Werth-Brunnen erzählt eine der größten deutschen Liebesgeschichten: Jan ist ein armer Knecht, wo auch Griet arbeitet. Er mag sie, sie ihn nicht. Der Krieg beginnt, Jan zieht aus, kommt als berühmter General zurück. Er fragt: "Jetzt heiratest du mich?" Griets Antwort: "Wer et hät jedon, der hät es jewuss" - Wahre Liebe braucht keinen Reichtum.`,
                images: [
                    { title: "360° Panorama", description: "Alter Markt heute vs. 1500" },
                    { title: "Rathausturm-Figuren", description: "Biografien aller Persönlichkeiten" },
                    { title: "Platz-Jabbeck", description: "Symbol des kölschen Widerstands" },
                    { title: "Jan und Griet", description: "Historiengemälde der Liebesgeschichte" }
                ],
                quiz: {
                    question: "Was wollte Griet Jan mit ihrer Antwort sagen?",
                    options: [
                        "Sie ist immer noch nicht interessiert",
                        "Er soll noch reicher werden",
                        "Wahre Liebe braucht keinen Reichtum",
                        "Sie hat inzwischen einen anderen"
                    ],
                    correct: 2
                },
                observation: "Sucht den Platz-Jabbeck am Rathausturm. Was drückt seine Geste aus? Modern gesprochen: Welches Emoji wäre das?",
                roleplay: {
                    title: "Die Szene am Brunnen - Jan kehrt zurück",
                    roles: [
                        { name: "Jan von Werth", description: "selbstbewusst, aber unsicher" },
                        { name: "Griet", description: "selbstbestimmt, unbeeindruckt" },
                        { name: "Marktbesucher", description: "kommentiert das Geschehen" }
                    ],
                    instruction: "Spielt die Brunnen-Szene nach - mit eigenem Ende"
                }
            },
            {
                id: 5,
                title: "Rhein-Denkmal",
                subtitle: "Totgeschlagen - Totgeschwiegen",
                lat: 50.9372, lng: 6.9614,
                description: "Denkmal für verfolgte und ermordete Homosexuelle.",
                mainText: `„Totgeschlagen – Totgeschwiegen" - das steht auf diesem roten Dreieck. Das rote Dreieck war das Erkennungszeichen für Homosexuelle in Nazi-Konzentrationslagern - ähnlich dem gelben Judenstern.

"Totgeschlagen" bezieht sich auf die Nazi-Zeit. "Totgeschwiegen" auf die Zeit danach: Homosexualität blieb bis 1994 eine Straftat in Deutschland. Die Verfolgung ging weiter, nur leiser. Das Schweigen führte auch zur AIDS-Epidemie der 1980er-90er.

Wenn wir heute von Angriffen auf CSD-Paraden hören, lohnt es sich, daran zu erinnern, wohin das führen kann. Demokratie und Menschenrechte sind nicht selbstverständlich - sie müssen jeden Tag verteidigt werden.`,
                images: [
                    { title: "LGBTQ+-Verfolgung", description: "Dokumentation der Geschichte" },
                    { title: "Zeitleiste", description: "Von Kriminalisierung zur Gleichstellung" },
                    { title: "Zeitzeugen", description: "Persönliche Berichte 70er-90er Jahre" }
                ],
                quiz: {
                    question: "Bis wann war Homosexualität in Deutschland strafbar?",
                    options: [
                        "1969",
                        "1985",
                        "1994",
                        "2001"
                    ],
                    correct: 2
                },
                observation: "Schaut euch die Brücke an. Was symbolisieren eurer Meinung nach die Liebesschlösser im Kontrast zum Denkmal hier unten?",
                roleplay: {
                    title: "Dialog zwischen Großeltern und Enkeln über gesellschaftlichen Wandel",
                    roles: [
                        { name: "Person aus den 1970ern", description: "erklärt, wie es damals war" },
                        { name: "Person von heute", description: "fragt nach, versteht nicht alles" }
                    ],
                    instruction: "Thema: Wie hat sich die Akzeptanz verschiedener Lebensentwürfe verändert?"
                }
            },
            {
                id: 6,
                title: "Dom/Hauptbahnhof",
                subtitle: "Das ewige Bauprojekt und die Verkehrsrevolution",
                lat: 50.9413, lng: 6.9583,
                description: "Kölns Wahrzeichen und die längste Baustelle der Welt.",
                mainText: `Der Dom wird seit fast 800 Jahren gebaut - etwas länger als der BER. Die Grundsteinlegung 1248 war Kölns Versuch, Paris und andere Großstädte zu beeindrucken. Köln war immer reich, aber auch provinziell.

1248-1330 wurden Grundmauern und der Chor fertiggestellt. Dann ging das Geld aus. Fast 300 Jahre stand nur ein riesiger Kran auf dem unvollendeten Turm - eines der ersten großen "paused projects" der Geschichte.

Erst die Romantik des 19. Jahrhunderts und preußisches Geld vollendeten den Dom 1880. Der Hauptbahnhof entstand 1894 als einer der modernsten Europas. Das Problem: Dom, Bahnhof und Hohenzollernbrücke stehen sich gegenseitig im Weg.

Im Zweiten Weltkrieg bekam der Dom 14 Bombenvolltreffer, blieb aber stehen - als Orientierungsmarke für Bomber.`,
                images: [
                    { title: "Dombau Zeitraffer", description: "1248-1880, längste Baustelle der Welt" },
                    { title: "Bahnhofsvorplatz 1900", description: "Mit Pferdefuhrwerken" },
                    { title: "Kölner Domkran", description: "1560-1842, Symbol des Stillstands" },
                    { title: "Architektur-Konflikt", description: "Warum Dom und Bahnhof nicht passen" },
                    { title: "Bombenangriff", description: "Dom zwischen Trümmern 1944-45" }
                ],
                quiz: {
                    question: "Wie lange dauerte die Dom-Pause zwischen Mittelalter und Vollendung?",
                    options: [
                        "150 Jahre",
                        "300 Jahre", 
                        "550 Jahre",
                        "700 Jahre"
                    ],
                    correct: 2
                },
                observation: "Schaut euch das 'Dreigestirn' an: Dom, Bahnhof, Brücke. Welches Gebäude dominiert? Warum könnte das problematisch sein?",
                roleplay: {
                    title: "Streitgespräch: Mittelalterlicher vs. moderner Stadtplaner",
                    roles: [
                        { name: "Mittelalterlicher Dombaumeister", description: "will nur den Dom" },
                        { name: "Moderner Verkehrsplaner", description: "braucht Platz für Züge und Autos" }
                    ],
                    instruction: "Problem: Wer bekommt den wertvollsten Platz der Stadt?"
                }
            },
            {
                id: 7,
                title: "Eigelsteinviertel",
                subtitle: "Klein-Istanbul und 11.000 Jungfrauen",
                lat: 50.9461, lng: 6.9528,
                description: "Das multikulturellste Viertel Kölns und eine große Lüge der Stadtgeschichte.",
                mainText: `Willkommen im Eigelsteinviertel - seit 50 Jahren das multikulturellste Viertel Kölns. Hier leben Menschen aus über 100 Nationen auf engstem Raum zusammen.

An der Ecke zur Ursulastraße begegnet uns eine der größten Lügen der Stadtgeschichte: die 11.000 Jungfrauen. Die Wahrheit: Es waren wahrscheinlich 11 Frauen, nicht 11.000. Ein mittelalterlicher Übersetzungsfehler aus "XI M.V." (11 martyres virgines = 11 jungfräuliche Märtyrerinnen) wurde zu "11 milia virginum" (11.000 Jungfrauen). Aber mit 11.000 ließ sich mehr Geld durch Reliquienhandel verdienen.

Nach dem Anwerbeabkommen mit der Türkei 1961 entstanden hier die ersten "Gastarbeiter"-Siedlungen. Aus den geplanten 2 Jahren wurden Generationen. Das Viertel durchlief alle Phasen der Migration: Ankunft, Ghettobildung, Integration, Gentrifizierung.`,
                images: [
                    { title: "Eigelstein 1974-heute", description: "Von Arbeitervorstadt zu Klein-Istanbul" },
                    { title: "Eigelsteintor", description: "Rekonstruktion mit Stadtmauer" },
                    { title: "Ursula-Legende", description: "Mittelalterliche Handschrift" },
                    { title: "Erste türkische Familien", description: "Oral History vom Ankommen" }
                ],
                quiz: {
                    question: "Wie viele Jungfrauen waren wahrscheinlich wirklich mit der heiligen Ursula unterwegs?",
                    options: [
                        "11",
                        "110",
                        "1.100",
                        "11.000"
                    ],
                    correct: 0
                },
                observation: "Zählt 5 Minuten lang verschiedene Kulturen/Sprachen/Geschäfte. Wie viele verschiedene Länder könnt ihr identifizieren?",
                roleplay: {
                    title: "Familie diskutiert übers Wegziehen aus dem Viertel",
                    roles: [
                        { name: "Großeltern", description: "leben seit 40 Jahren hier, wollen bleiben" },
                        { name: "Eltern", description: "unentschlossen, Sorgen um die Kinder" },
                        { name: "Jugendliche", description: "wollen weg oder bleiben" }
                    ],
                    instruction: "Thema: Gentrifizierung - Chance oder Problem?"
                }
            },
            {
                id: 8,
                title: "Stützenhof",
                subtitle: "Arbeit, Moral und gesellschaftliche Doppelmoral",
                lat: 50.9433, lng: 6.9489,
                description: "Das ehemalige Prostituiertenviertel und seine Sozialgeschichte.",
                mainText: `Hier, rund um den ehemaligen Stützenhof, befand sich jahrhundertelang Kölns größtes Prostitutionsviertel.

Prostitution war im mittelalterlichen Köln legal und städtisch reguliert - fortschrittlicher als in vielen anderen Städten. Die Stadt kassierte Steuern, bot medizinische Versorgung und rechtlichen Schutz. Ein pragmatischer Ansatz für ein unvermeidliches gesellschaftliches Phänomen.

Viele der arbeitenden Frauen waren Migrantinnen aus dem Umland oder anderen Städten. Migration und Sexarbeit waren oft verknüpft - ein Muster, das sich durch die Jahrhunderte zieht.

Die Moral änderte sich im 19. Jahrhundert. Prostitution wurde kriminalisiert, das Viertel "gesäubert". Die Frauen verschwanden nicht - sie wurden nur unsichtbarer und schutzloser.`,
                images: [
                    { title: "Rotlichtviertel", description: "Historische Karten im Wandel" },
                    { title: "Stadtrecht 1437", description: "Regulierung der Prostitution" },
                    { title: "Polizeiprotokoll 1890", description: "Säuberung des Viertels" },
                    { title: "Moderne Debatte", description: "Sexarbeiter*innen-Rechte heute" }
                ],
                quiz: {
                    question: "Wie ging das mittelalterliche Köln mit Prostitution um?",
                    options: [
                        "Sie war komplett verboten",
                        "Sie war legal und städtisch reguliert",
                        "Sie war nur in Klöstern erlaubt",
                        "Sie existierte nicht"
                    ],
                    correct: 1
                },
                observation: "Schaut euch die heutige Bebauung an. Was sagt sie über Stadtentwicklung aus? Wie verändert sich die Nutzung von Vierteln?",
                roleplay: {
                    title: "Debatte: Sollten Städte Sexarbeit regulieren oder verbieten?",
                    roles: [
                        { name: "Befürworter*in der Regulierung", description: "Arbeitsrechte, Schutz" },
                        { name: "Befürworter*in des Verbots", description: "moralische Gründe" }
                    ],
                    instruction: "Führt eine respektvolle, sachliche Debatte - wie in einem Stadtrat"
                }
            },
            {
                id: 9,
                title: "Ebertplatz",
                subtitle: "Vom Sicherheitshafen zum Angstraum und zurück",
                lat: 50.9472, lng: 6.9456,
                description: "Ein Lehrstück über Stadtplanung und Bürgerbeteiligung.",
                mainText: `1972 als moderner "Sicherheitshafen" eröffnet: übersichtlich, hell ausgeleuchtet, mit U-Bahn-Anschluss. Ein Vorzeigeprojekt der Stadtplanung. Die Idee: Kriminalität durch Design verhindern.

Dann die Kehrtwende: In den 1990er-2000ern wurde der Platz zum Symbol städtischer Probleme. Drogenhandel, Gewalt, Vermüllung. Die Medien nannten ihn "gefährlichsten Platz Kölns". Die Realität war komplexer: viel Angst, weniger tatsächliche Kriminalstatistik.

Der Platz wurde zum Treffpunkt für Menschen am gesellschaftlichen Rand: Obdachlose, Drogenabhängige, Arbeitslose. Nicht alle waren kriminell, aber alle waren sichtbar. Und Sichtbarkeit von Armut macht vielen Menschen Angst.

Seit 2015 die Wende: Bürgerinitiativen, Stadtteilladen, Community-Events. Nicht durch Überwachung und Verdrängung, sondern durch Beteiligung und positive Nutzung.`,
                images: [
                    { title: "Zeitreise", description: "1970 Vorzeigeplatz vs. 2010 Angstraum vs. heute" },
                    { title: "Medienberichterstattung", description: "Angstraum Ebertplatz 1995-2010" },
                    { title: "Studie", description: "Wahrnehmung vs. Realität von Unsicherheit" },
                    { title: "Ebertplatz lebt", description: "Bürgerinitiative dokumentiert Wandel" },
                    { title: "Urban Planning", description: "Erfolgreiche Platz-Revitalisierung weltweit" }
                ],
                quiz: {
                    question: "Was war der Hauptgrund für die 'Wiederbelebung' des Ebertplatzes?",
                    options: [
                        "Mehr Polizei und Überwachung",
                        "Bürgerinitiative und Community-Events",
                        "Gentrifizierung und teure Geschäfte",
                        "Komplette Neubebauung"
                    ],
                    correct: 1
                },
                observation: "Wie wirkt der Platz jetzt auf euch? Was würdet ihr ändern, um ihn noch lebendiger zu machen?",
                roleplay: {
                    title: "Stadtratssitzung: Wie lösen wir städtische Probleme?",
                    roles: [
                        { name: "Sicherheits-Politiker*in", description: "will mehr Überwachung" },
                        { name: "Sozialarbeiter*in", description: "will mehr Unterstützung" },
                        { name: "Anwohner*in", description: "will Ruhe, aber auch Gerechtigkeit" }
                    ],
                    instruction: "Findet einen Kompromiss für den 'neuen' Ebertplatz"
                }
            },
            {
                id: 10,
                title: "Alte Bastion",
                subtitle: "Grenzen überwinden, Brücken bauen",
                lat: 50.9489, lng: 6.9444,
                description: "Ende der Tour an der ehemaligen Stadtgrenze.",
                mainText: `Wir stehen hier an der ehemaligen Stadtgrenze - der preußischen Bastionsbefestigung von 1816. Von hier aus konntet ihr früher nicht weiter, ohne die Stadt zu verlassen.

Diese Bastion symbolisiert Grenzen. Köln war immer eine Stadt der Grenzen - zwischen römischem und germanischem Reich, zwischen weltlicher und kirchlicher Macht, zwischen arm und reich, zwischen alteingesessen und zugewandert.

Aber Köln war auch immer eine Stadt, die Grenzen überwunden hat. 1958 schloss Köln als eine der ersten deutschen Städte eine Partnerschaft mit dem ehemaligen "Erzfeind" Frankreich (Limoges), 1967 folgte Liverpool - mitten im Kalten Krieg Brücken bauen statt Mauern.

Köln war nie "rein deutsch" oder kulturell homogen. Die Stadt lebte 2000 Jahre von Migration, Handel und kulturellem Austausch. Die Probleme von heute sind nicht neu. Aber die Lösungen auch nicht: Respekt, Beteiligung, gemeinsame Gestaltung der Stadt.`,
                images: [
                    { title: "Stadtgrenzen", description: "Kölns Grenzen durch 2000 Jahre" },
                    { title: "Städtepartnerschaften", description: "Köln baut Brücken nach Europa" },
                    { title: "Gesichter Kölns", description: "Montage aller Nationalitäten heute" },
                    { title: "Start with a Friend", description: "Köln als Stadt der Begegnungen" }
                ],
                quiz: {
                    question: "Was war das wichtigste Erfolgsrezept Kölns über 2000 Jahre?",
                    options: [
                        "Militärische Stärke",
                        "Kulturelle Vielfalt und Handel",
                        "Religiöse Einheit",
                        "Politische Stabilität"
                    ],
                    correct: 1
                },
                observation: "Was war euer persönliches Highlight? Was seht ihr jetzt anders als vor 3 Stunden?",
                roleplay: {
                    title: "Abschluss-Statement als Kölner Oberbürgermeister*in",
                    roles: [
                        { name: "Oberbürgermeister*in", description: "hält eine 2-Minuten-Rede" }
                    ],
                    instruction: "Was macht Köln aus? Was können andere Städte von Köln lernen?"
                }
            }
        ];

        // Initialize App
        function initApp() {
            generateStationsList();
            initMap();
            updateUI();
            
            // Check if geolocation is available
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        appState.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateLocationInfo();
                        if (appState.map) {
                            addUserLocationToMap();
                        }
                    },
                    error => {
                        console.log('Geolocation not available:', error);
                        document.getElementById('distanceInfo').textContent = '📍 Standort nicht verfügbar';
                    }
                );
            }

            // Register service worker for offline functionality
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(e => {
                    console.log('Service worker registration failed');
                });
            }

            // Check online status
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }

        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (!navigator.onLine) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName === 'map' ? 'map-tab' : tabName).classList.add('active');

            // Initialize map if switching to map tab
            if (tabName === 'map' && !appState.map) {
                setTimeout(initMap, 100);
            }
        }

        function generateStationsList() {
            const container = document.getElementById('stationsList');
            
            stations.forEach(station => {
                const isCompleted = appState.completedStations.includes(station.id);
                
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${isCompleted ? 'completed' : ''}`;
                stationCard.onclick = () => toggleStationDetails(station.id);
                
                stationCard.innerHTML = `
                    <div class="station-header">
                        <div class="station-number ${isCompleted ? 'completed' : ''}">${station.id}</div>
                        <div>
                            <div class="station-title">${station.title}</div>
                            <div class="station-subtitle">${station.subtitle}</div>
                        </div>
                    </div>
                    <div class="station-details" id="station-${station.id}">
                        <div class="detail-section">
                            <h4>📖 Geschichte</h4>
                            <p>${station.mainText}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>🖼️ Bildergalerie</h4>
                            <div class="image-gallery">
                                ${station.images.map(img => `
                                    <div class="image-placeholder" onclick="showImageInfo('${img.title}', '${img.description}')">
                                        🖼️<br><small>${img.title}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="activity-card">
                            <div class="activity-title">🧠 Multiple Choice (10 Kronen)</div>
                            <p><strong>${station.quiz.question}</strong></p>
                            ${station.quiz.options.map((option, index) => `
                                <div class="quiz-option" onclick="selectQuizOption(${station.id}, ${index})" id="quiz-${station.id}-${index}">
                                    ${String.fromCharCode(65 + index)}) ${option}
                                </div>
                            `).join('')}
                            <button class="btn" onclick="checkQuizAnswer(${station.id})" id="quiz-btn-${station.id}">Antwort prüfen</button>
                        </div>

                        <div class="activity-card">
                            <div class="activity-title">👀 Beobachtungsaufgabe (15 Kronen)</div>
                            <p>${station.observation}</p>
                            <button class="btn" onclick="completeObservation(${station.id})">Aufgabe erledigt</button>
                        </div>

                        <div class="role-play-card">
                            <div class="activity-title">🎭 Rollenspiel (20 Kronen)</div>
                            <h4>${station.roleplay.title}</h4>
                            ${station.roleplay.roles.map(role => `
                                <div class="person-role">
                                    <strong>${role.name}:</strong> ${role.description}
                                </div>
                            `).join('')}
                            <p><em>${station.roleplay.instruction}</em></p>
                            <button class="btn" onclick="completeRoleplay(${station.id})">Rollenspiel gespielt</button>
                        </div>

                        <button class="btn" onclick="completeStation(${station.id})" id="complete-btn-${station.id}" 
                                ${isCompleted ? 'disabled' : ''} style="background: #10b981;">
                            ${isCompleted ? '✅ Station abgeschlossen' : '🏁 Station abschließen (+5 Bonus-Kronen)'}
                        </button>
                    </div>
                `;
                
                container.appendChild(stationCard);
            });
        }

        function toggleStationDetails(stationId) {
            const details = document.getElementById(`station-${stationId}`);
            details.classList.toggle('active');
        }

        function selectTeam(teamId, teamName) {
            appState.selectedTeam = teamId;
            appState.teamName = teamName;
            
            // Update UI
            document.querySelectorAll('.team-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.team-option').classList.add('selected');
            
            document.getElementById('selectedTeamName').textContent = teamName;
            
            // Hide team selector after selection
            document.getElementById('teamSelector').style.display = 'none';
            
            showSuccessMessage('Team ausgewählt! 🎉');
        }

        function startTour() {
            if (!appState.selectedTeam) {
                alert('Bitte wähle zuerst ein Team aus!');
                return;
            }
            
            showTab('stations');
            document.querySelector('[onclick="showTab(\'stations\')"]').click();
            showSuccessMessage('Tour gestartet! Viel Erfolg! 🚀');
        }

        function selectQuizOption(stationId, optionIndex) {
            // Clear previous selections
            document.querySelectorAll(`#station-${stationId} .quiz-option`).forEach(option => {
                option.classList.remove('selected');
            });
            
            // Select current option
            document.getElementById(`quiz-${stationId}-${optionIndex}`).classList.add('selected');
            
            // Store selection
            appState[`quiz-${stationId}-selected`] = optionIndex;
        }

        function checkQuizAnswer(stationId) {
            const selectedOption = appState[`quiz-${stationId}-selected`];
            if (selectedOption === undefined) {
                alert('Bitte wähle zuerst eine Antwort aus!');
                return;
            }

            const station = stations.find(s => s.id === stationId);
            const isCorrect = selectedOption === station.quiz.correct;
            
            // Update UI
            document.querySelectorAll(`#station-${stationId} .quiz-option`).forEach((option, index) => {
                if (index === station.quiz.correct) {
                    option.classList.add('correct');
                } else if (index === selectedOption && !isCorrect) {
                    option.classList.add('wrong');
                }
            });
            
            // Award points
            if (isCorrect) {
                addScore(10);
                showSuccessMessage('Richtig! +10 Kronen 🎉');
            } else {
                showSuccessMessage('Nicht ganz richtig, aber Versuch zählt! 🤔');
            }
            
            // Disable button
            document.getElementById(`quiz-btn-${stationId}`).disabled = true;
            document.getElementById(`quiz-btn-${stationId}`).textContent = isCorrect ? '✅ Richtig!' : '❌ Falsch';
        }

        function completeObservation(stationId) {
            addScore(15);
            showSuccessMessage('Beobachtungsaufgabe abgeschlossen! +15 Kronen 👀');
            event.target.disabled = true;
            event.target.textContent = '✅ Erledigt';
        }

        function completeRoleplay(stationId) {
            addScore(20);
            showSuccessMessage('Rollenspiel gespielt! +20 Kronen 🎭');
            event.target.disabled = true;
            event.target.textContent = '✅ Gespielt';
        }

        function completeStation(stationId) {
            if (!appState.completedStations.includes(stationId)) {
                appState.completedStations.push(stationId);
                addScore(5);
                updateProgress();
                showSuccessMessage('Station abgeschlossen! +5 Bonus-Kronen 🏁');
                
                // Update station card
                const stationCard = document.querySelector(`#complete-btn-${stationId}`).closest('.station-card');
                stationCard.classList.add('completed');
                stationCard.querySelector('.station-number').classList.add('completed');
                
                // Disable button
                event.target.disabled = true;
                event.target.textContent = '✅ Station abgeschlossen';
                event.target.style.background = '#6b7280';
            }
        }

        function addScore(points) {
            appState.totalScore += points;
            updateUI();
        }

        function updateUI() {
            document.getElementById('totalScore').textContent = appState.totalScore;
            document.getElementById('teamScore').textContent = appState.totalScore;
            updateProgress();
        }

        function updateProgress() {
            const progress = (appState.completedStations.length / stations.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function showImageInfo(title, description) {
            alert(`🖼️ ${title}\n\n${description}\n\n💡 Tipp: Scanne den QR-Code vor Ort für das echte Bild!`);
        }

        function resetProgress() {
            if (confirm('Möchtest du wirklich den gesamten Fortschritt zurücksetzen?')) {
                appState.completedStations = [];
                appState.totalScore = 0;
                appState.currentStation = 0;
                
                // Reset UI
                updateUI();
                location.reload();
            }
        }

        function initMap() {
            if (!document.getElementById('map') || appState.map) return;
            
            // Initialize map centered on Cologne
            appState.map = L.map('map').setView([50.9375, 6.9597], 15);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(appState.map);
            
            // Add station markers
            stations.forEach((station, index) => {
                const isCompleted = appState.completedStations.includes(station.id);
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}/10</strong></p>
                            ${isCompleted ? '<p style="color: green;">✅ Abgeschlossen</p>' : '<p style="color: orange;">⏳ Ausstehend</p>'}
                        </div>
                    `)
                    .addTo(appState.map);
                
                appState.markers.push(marker);
            });
            
            // Add user location if available
            if (appState.userLocation) {
                addUserLocationToMap();
            }
            
            // Draw route line between stations
            const routeCoordinates = stations.map(station => [station.lat, station.lng]);
            L.polyline(routeCoordinates, {
                color: '#dc2626',
                weight: 3,
                opacity: 0.7
            }).addTo(appState.map);
        }

        function addUserLocationToMap() {
            if (!appState.map || !appState.userLocation) return;
            
            L.marker([appState.userLocation.lat, appState.userLocation.lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCA0OCIgZmlsbD0ibm9uZSI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4=',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            })
            .bindPopup('📍 Dein Standort')
            .addTo(appState.map);
        }

        function centerOnUser() {
            if (appState.userLocation && appState.map) {
                appState.map.setView([appState.userLocation.lat, appState.userLocation.lng], 17);
            } else {
                alert('Standort nicht verfügbar. Bitte erlaube Standortzugriff in den Browser-Einstellungen.');
            }
        }

        function updateLocationInfo() {
            if (!appState.userLocation) return;
            
            // Find nearest station
            let nearestStation = null;
            let minDistance = Infinity;
            
            stations.forEach(station => {
                const distance = calculateDistance(
                    appState.userLocation.lat, appState.userLocation.lng,
                    station.lat, station.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            });
            
            if (nearestStation) {
                const distanceText = minDistance < 1 
                    ? `${Math.round(minDistance * 1000)}m` 
                    : `${minDistance.toFixed(1)}km`;
                
                document.getElementById('distanceInfo').textContent = 
                    `📍 Nächste Station: ${nearestStation.title} (${distanceText})`;
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
