<!DOCTYPE html>

<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kölner Abendspaziergang</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        line-height: 1.6;
        overflow-x: hidden;
    }

    .container {
        max-width: 100vw;
        margin: 0 auto;
        min-height: 100vh;
        background: white;
        box-shadow: 0 0 30px rgba(0,0,0,0.3);
    }

    header {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .tour-id-display {
        background: rgba(255,255,255,0.2);
        padding: 0.5rem;
        border-radius: 4px;
        margin-top: 0.5rem;
        font-size: 0.8rem;
    }

    .progress-container {
        background: rgba(255,255,255,0.2);
        height: 8px;
        border-radius: 4px;
        margin-top: 1rem;
        overflow: hidden;
    }

    .progress-bar {
        background: #fbbf24;
        height: 100%;
        width: 0%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .live-message {
        background: #059669;
        color: white;
        padding: 1rem;
        margin: 0.5rem;
        border-radius: 8px;
        animation: slideIn 0.5s ease;
        border-left: 4px solid #047857;
    }

    .main-content {
        padding: 0;
    }

    .tab-container {
        display: flex;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        position: sticky;
        top: 132px;
        z-index: 999;
        overflow-x: auto;
    }

    .tab {
        flex: 1;
        padding: 1rem 0.5rem;
        text-align: center;
        cursor: pointer;
        background: transparent;
        border: none;
        font-weight: 600;
        color: #64748b;
        transition: all 0.3s;
        font-size: 0.9rem;
        white-space: nowrap;
        min-width: 100px;
    }

    .tab.active {
        background: white;
        color: #dc2626;
        border-bottom: 3px solid #dc2626;
    }

    .tab.admin {
        background: #fef3c7;
        color: #92400e;
    }

    .tab.admin.active {
        background: #f59e0b;
        color: white;
    }

    .tab-content {
        display: none;
        padding: 1.5rem;
        min-height: calc(100vh - 200px);
    }

    .tab-content.active {
        display: block;
    }

    .tour-id-section {
        background: #f0f9ff;
        border: 2px solid #0ea5e9;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .tour-id-input {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        margin: 0.5rem 0;
    }

    .admin-section {
        background: #fef3c7;
        border: 2px solid #f59e0b;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .admin-password-input {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        margin: 0.5rem 0;
    }

    .editable-content {
        position: relative;
        border: 2px dashed transparent;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s;
    }

    .editable-content.admin-mode {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.1);
    }

    .edit-button {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #f59e0b;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-size: 0.8rem;
        display: none;
    }

    .editable-content.admin-mode .edit-button {
        display: block;
    }

    .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
    }

    .edit-modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .station-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #dc2626;
        cursor: pointer;
        transition: all 0.3s;
    }

    .station-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .station-card.completed {
        border-left-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }

    .station-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .station-number {
        background: #dc2626;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .station-number.completed {
        background: #10b981;
    }

    .station-title {
        flex: 1;
        font-size: 1.3rem;
        font-weight: bold;
        color: #1f2937;
    }

    .station-subtitle {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .station-details {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #e5e7eb;
    }

    .station-details.active {
        display: block;
    }

    .detail-section {
        margin-bottom: 1.5rem;
    }

    .detail-section h4 {
        color: #dc2626;
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
    }

    .detail-section h4::before {
        content: "▶";
        margin-right: 0.5rem;
        color: #dc2626;
    }

    .photo-challenge {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
        border-left: 4px solid #6366f1;
    }

    .photo-challenge h4 {
        color: #4f46e5;
        margin-bottom: 1rem;
        font-size: 1.2rem;
    }

    .photo-upload-area {
        border: 3px dashed #a5b4fc;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        margin: 1rem 0;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(255,255,255,0.5);
    }

    .photo-upload-area:hover {
        border-color: #6366f1;
        background: rgba(255,255,255,0.8);
    }

    .photo-upload-area.has-photo {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .photo-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .ai-rating {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1rem 0;
        text-align: center;
        border: 2px solid #10b981;
    }

    .rating-score {
        font-size: 3rem;
        font-weight: bold;
        color: #059669;
        margin-bottom: 0.5rem;
    }

    .rating-text {
        color: #047857;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .rating-details {
        background: #f0fdf4;
        padding: 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #065f46;
    }

    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .gallery-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .gallery-image:hover {
        transform: scale(1.05);
    }

    .gallery-item {
        text-align: center;
        position: relative;
    }

    .gallery-item small {
        display: block;
        margin-top: 0.5rem;
        color: #6b7280;
        font-size: 0.8rem;
    }

    .btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        font-size: 1rem;
        margin-top: 1rem;
        touch-action: manipulation;
    }

    .btn:hover {
        background: #991b1b;
        transform: translateY(-2px);
    }

    .btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: #6b7280;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-admin {
        background: #f59e0b;
    }

    .btn-admin:hover {
        background: #d97706;
    }

    .score-display {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin: 1rem 0;
        border: 2px solid #8b5cf6;
    }

    .score-number {
        font-size: 2rem;
        font-weight: bold;
        color: #5b21b6;
    }

    .score-label {
        color: #7c3aed;
        margin-top: 0.5rem;
    }

    .team-ranking {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .team-rank-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        background: #f8fafc;
    }

    .team-rank-item.highlight {
        background: #fef3c7;
        border: 2px solid #f59e0b;
    }

    .rank-position {
        background: #6b7280;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
    }

    .rank-position.gold {
        background: #f59e0b;
    }

    .rank-position.silver {
        background: #6b7280;
    }

    .rank-position.bronze {
        background: #d97706;
    }

    #map {
        height: 400px;
        width: 100%;
        border-radius: 10px;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .location-info {
        background: #f0f9ff;
        border: 2px solid #0ea5e9;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .distance-info {
        font-weight: bold;
        color: #0369a1;
        margin-bottom: 0.5rem;
    }

    .team-selector {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .team-option {
        display: flex;
        align-items: center;
        padding: 0.8rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
        touch-action: manipulation;
    }

    .team-option:hover {
        background: #f3f4f6;
    }

    .team-option.selected {
        background: #dbeafe;
        border: 2px solid #3b82f6;
    }

    .team-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 1rem;
    }

    .chat-container {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-height: 400px;
        overflow-y: auto;
    }

    .chat-message {
        padding: 0.5rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        background: #f8fafc;
        border-left: 3px solid #3b82f6;
    }

    .chat-message.own {
        background: #dbeafe;
        border-left-color: #1d4ed8;
        margin-left: 2rem;
    }

    .chat-input-container {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
    }

    .chat-send {
        padding: 0.8rem 1.5rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        touch-action: manipulation;
    }

    .success-message {
        background: #10b981;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        text-align: center;
        animation: slideIn 0.5s ease;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #059669;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.5s ease;
    }

    .notification.error {
        background: #dc2626;
    }

    .connection-status {
        position: fixed;
        top: 10px;
        left: 10px;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        z-index: 9999;
    }

    .connection-status.online {
        background: #10b981;
        color: white;
    }

    .connection-status.offline {
        background: #dc2626;
        color: white;
    }

    .hidden {
        display: none !important;
    }

    .file-input {
        display: none;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #dc2626;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes slideIn {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .container {
            box-shadow: none;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        .tab {
            font-size: 0.8rem;
            padding: 0.8rem 0.3rem;
        }
        
        .tab-content {
            padding: 1rem;
        }
        
        .station-card {
            padding: 1rem;
        }
        
        .image-gallery {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status offline">🔄 Verbindung...</div>

```
    <header>
        <h1>🏛️ Kölner Abendspaziergang</h1>
        <p class="subtitle">Entdecke 2000 Jahre Stadtgeschichte</p>
        <div class="tour-id-display" id="tourIdDisplay">
            Tour-ID: <span id="currentTourId">Wird geladen...</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </header>

    <div class="main-content">
        <div class="tab-container">
            <button class="tab active" onclick="TourApp.showTab('overview', this)">🗺️ Übersicht</button>
            <button class="tab" onclick="TourApp.showTab('stations', this)">📍 Stationen</button>
            <button class="tab" onclick="TourApp.showTab('ranking', this)">🏆 Ranking</button>
            <button class="tab" onclick="TourApp.showTab('chat', this)">💬 Chat</button>
            <button class="tab" onclick="TourApp.showTab('map', this)">🗺️ Karte</button>
            <button class="tab admin" onclick="TourApp.showTab('admin', this)" id="adminTab" style="display: none;">⚙️ Admin</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="tour-id-section">
                <h3 style="margin-bottom: 1rem; color: #0369a1;">🔗 Tour-Verbindung</h3>
                <p>Um mit anderen Geräten zu chatten und Rankings zu teilen:</p>
                <input type="text" class="tour-id-input" id="tourIdInput" placeholder="Tour-ID eingeben (z.B. koeln-2024-gruppe1)">
                <button class="btn btn-secondary" onclick="TourApp.joinTour()">Tour beitreten</button>
                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #6b7280;">
                    💡 Alle Teilnehmer müssen dieselbe Tour-ID verwenden!
                </p>
            </div>

            <div class="admin-section">
                <h3 style="margin-bottom: 1rem; color: #92400e;">🔐 Admin-Zugang</h3>
                <input type="password" class="admin-password-input" id="adminPassword" placeholder="Admin-Passwort">
                <button class="btn btn-admin" onclick="TourApp.loginAdmin()">Admin-Modus aktivieren</button>
                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #6b7280;">
                    Admin-Passwort: <strong>koeln2024</strong>
                </p>
            </div>

            <div class="score-display">
                <div class="score-number" id="totalScore">0</div>
                <div class="score-label">Foto-Punkte gesammelt</div>
            </div>

            <div class="team-selector" id="teamSelector">
                <h3 style="margin-bottom: 1rem; color: #374151;">📸 Wähle dein Team:</h3>
                <div class="team-option" onclick="TourApp.selectTeam('red', '🔴 Team Römer', this)">
                    <div class="team-color" style="background: #dc2626;"></div>
                    <span>🔴 Team Römer</span>
                </div>
                <div class="team-option" onclick="TourApp.selectTeam('blue', '🔵 Team Gaffeln', this)">
                    <div class="team-color" style="background: #2563eb;"></div>
                    <span>🔵 Team Gaffeln</span>
                </div>
                <div class="team-option" onclick="TourApp.selectTeam('green', '🟢 Team Hanseat', this)">
                    <div class="team-color" style="background: #059669;"></div>
                    <span>🟢 Team Hanseat</span>
                </div>
                <div class="team-option" onclick="TourApp.selectTeam('yellow', '🟡 Team Modern', this)">
                    <div class="team-color" style="background: #d97706;"></div>
                    <span>🟡 Team Modern</span>
                </div>
            </div>

            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">📋 Tour-Informationen</h3>
                <p><strong>⏰ Dauer:</strong> ca. 3,5 Stunden</p>
                <p><strong>📍 Start:</strong> Heumarkt, 19:30 Uhr</p>
                <p><strong>🎯 Ziel:</strong> Alte Bastion</p>
                <p><strong>👥 Teilnehmer:</strong> 15-25 Personen</p>
                <p><strong>📸 Ziel:</strong> Sammle die besten Foto-Punkte!</p>
            </div>

            <button class="btn" onclick="TourApp.startTour()">🚀 Tour starten</button>
        </div>

        <!-- Stations Tab -->
        <div id="stations" class="tab-content">
            <div id="stationsList">
                <!-- Stations will be generated here -->
            </div>
        </div>

        <!-- Ranking Tab -->
        <div id="ranking" class="tab-content">
            <div class="team-ranking">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">🏆 Live-Ranking</h3>
                <div id="rankingList">
                    <!-- Ranking will be generated here -->
                </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #1f2937; margin-bottom: 1rem;">📸 KI-Punktesystem</h3>
                <ul style="margin-left: 1.5rem; color: #4b5563;">
                    <li><strong>Technische Qualität:</strong> Schärfe, Belichtung, Komposition (0-40 Punkte)</li>
                    <li><strong>Kreativität:</strong> Perspective, Originalität (0-30 Punkte)</li>
                    <li><strong>Stadtbezug:</strong> Erkannte Sehenswürdigkeiten (0-20 Punkte)</li>
                    <li><strong>Personen/Gruppenfoto:</strong> Bonus für Teamarbeit (+10 Punkte)</li>
                </ul>
            </div>
        </div>

        <!-- Chat Tab -->
        <div id="chat" class="tab-content">
            <div class="chat-container" id="chatContainer">
                <div class="chat-message">
                    <strong>System:</strong> Willkommen im Tour-Chat! 👋<br>
                    <small>Stellt sicher, dass alle dieselbe Tour-ID verwenden.</small>
                    <span class="timestamp">jetzt</span>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht eingeben..." maxlength="200">
                <button class="chat-send" onclick="TourApp.sendMessage()">Senden</button>
            </div>
            <div style="margin-top: 1rem; text-align: center; color: #6b7280; font-size: 0.9rem;">
                💡 Chat funktioniert in Echtzeit zwischen allen Geräten mit derselben Tour-ID
            </div>
        </div>

        <!-- Map Tab -->
        <div id="map-tab" class="tab-content">
            <div class="location-info">
                <div class="distance-info" id="distanceInfo">📍 Standort wird ermittelt...</div>
                <p>💡 Tipp: Erlaube Standortzugriff für Navigation</p>
            </div>
            <div id="map"></div>
            <button class="btn" onclick="TourApp.centerOnUser()">📍 Zu meinem Standort</button>
        </div>

        <!-- Admin Tab -->
        <div id="admin" class="tab-content">
            <div style="background: #fef3c7; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <h3 style="color: #92400e; margin-bottom: 1rem;">⚙️ Admin-Panel</h3>
                <p>Hier können Sie Inhalte bearbeiten, die sofort für alle Teilnehmer sichtbar werden.</p>
            </div>

            <div id="adminStationsList">
                <!-- Admin stations will be generated here -->
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h4 style="color: #1f2937; margin-bottom: 1rem;">🔄 Tour zurücksetzen</h4>
                <button class="btn btn-secondary" onclick="TourApp.resetTour()">Alle Daten zurücksetzen</button>
            </div>
        </div>
    </div>
</div>

<!-- External Libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<!-- Firebase -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.1/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.1/firebase-database-compat.min.js"></script>

<script>
// Global error handler
window.onerror = function(msg, url, line, col, error) {
    console.error('Error:', msg, 'at', line + ':' + col);
    TourApp.showError('Ein Fehler ist aufgetreten: ' + msg);
    return false;
};

// Main Tour Application
const TourApp = {
    // App State
    state: {
        currentStation: 0,
        completedStations: [],
        totalScore: 0,
        selectedTeam: null,
        teamName: '',
        userLocation: null,
        map: null,
        markers: [],
        uploadedPhotos: [],
        userName: 'Tourist_' + Math.random().toString(36).substr(2, 5),
        tourId: null,
        chatInitialized: false,
        debugMode: false,
        isAdmin: false,
        firebase: null,
        database: null,
        connected: false
    },

    // Firebase config (öffentlich für Demo)
    firebaseConfig: {
        apiKey: "AIzaSyDdI0hCZtE6vySjMhd-Wg9WFrD0uiXIQzw",
        authDomain: "koeln-tour-demo.firebaseapp.com",
        databaseURL: "https://koeln-tour-demo-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "koeln-tour-demo",
        storageBucket: "koeln-tour-demo.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abc123def456"
    },

    // Default Station Data
    defaultStations: [
        {
            id: 1,
            title: "Heumarkt",
            subtitle: "Wo alles anfing: 2000 Jahre Migration und Handel",
            lat: 50.9356, lng: 6.9611,
            description: "Start der Tour am historischen Heumarkt, einem der geschichtsträchtigsten Orte Kölns.",
            photoChallenge: "Mache ein Foto von dir oder deinem Team vor dem Reiterstandbild - zeigt dabei mit Handbewegungen, wie Händler früher ihre Waren angepriesen haben könnten!",
            mainText: `Die Stadt ist ca. 2.000 Jahre alt. CCAA - Colonia Claudia Ara Agrippinensium - wurde 50 n. Chr. von den Römern gegründet, mithilfe der germanischen Ubier. Das war übrigens eine der ersten erfolgreichen Integration zweier Kulturen in Europa. 
```

Hier auf dem Heumarkt stehen wir an einem der ehemaligen Einfallstore zur Stadt. Die Markmannsgasse runter, links von der heutigen Deutzer Brücke, befand sich von 1822 bis 1915 die einzige Schiffsbrücke über den Rhein - 42 schwimmende Boote, die über 30 Mal täglich für Schiffe geöffnet wurden.

Das “Stapelrecht” von 1259 bis 1804 war ein 545 Jahre gültiges Handelsprivileg. Alle Waren auf Schiffen, die an Köln vorbeifahren wollten, mussten drei Tage hier angeboten werden.`, images: [ { url: "https://images.unsplash.com/photo-1568667256549-094345857637?w=400", title: "Heumarkt heute", description: "Moderne Aufnahme des historischen Platzes" }, { url: "https://images.unsplash.com/photo-1590736969955-71cc94901144?w=400", title: "Kölner Architektur", description: "Typische Rheinische Bauweise" }, { url: "https://images.unsplash.com/photo-1551622656-fa4fa96b5faf?w=400", title: "Rheinufer", description: "Blick auf den historischen Handelsweg" } ] }, { id: 2, title: "Kölner Dom", subtitle: "Das ewige Bauprojekt und die Verkehrsrevolution", lat: 50.9413, lng: 6.9583, description: "Kölns Wahrzeichen und die längste Baustelle der Welt.", photoChallenge: "Bildet mit eurem Team eine 'menschliche Kathedrale' vor dem Dom - streckt die Arme hoch und formt gotische Bögen nach!", mainText: `Der Dom wird seit fast 800 Jahren gebaut - etwas länger als der BER. Die Grundsteinlegung 1248 war Kölns Versuch, Paris und andere Großstädte zu beeindrucken. Köln war immer reich, aber auch provinziell.

1248-1330 wurden Grundmauern und der Chor fertiggestellt. Dann ging das Geld aus. Fast 300 Jahre stand nur ein riesiger Kran auf dem unvollendeten Turm - eines der ersten großen “paused projects” der Geschichte.

Erst die Romantik des 19. Jahrhunderts und preußisches Geld vollendeten den Dom 1880. Der Hauptbahnhof entstand 1894 als einer der modernsten Europas.`, images: [ { url: "https://images.unsplash.com/photo-1571115764595-644a1f56a55c?w=400", title: "Kölner Dom", description: "Die berühmten Zwillingstürme" }, { url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400", title: "Dom Innenraum", description: "Gotische Architektur" }, { url: "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=400", title: "Dom bei Nacht", description: "Beleuchtetes Wahrzeichen" } ] }, { id: 3, title: "Altstadt", subtitle: "Macht, Rebellion und eine große Liebesgeschichte", lat: 50.9369, lng: 6.9572, description: "Das historische Rathaus und die berühmte Jan-und-Griet-Geschichte.", photoChallenge: "Fotografiert euch am historischen Rathaus und stellt eine romantische Szene nach: Eine Person kniet, eine steht stolz daneben.", mainText: `Der Rathaus-Turm zeigt wichtige Persönlichkeiten der Kölner Geschichte. 1945 zerstört und wieder aufgebaut. Da auch die Figuren zerstört waren, wählte eine Kommission neue aus - von über 100 Kandidaten. Alle männlich.

Oben am Turm seht ihr den “Platz-Jabbeck” - er streckt Autoritäten die Zunge raus. So viel Respekt hatten die Kölner für die Obrigkeit.

Die Altstadt erzählt eine der größten deutschen Liebesgeschichten: Jan ist ein armer Knecht, Griet arbeitet auch dort. Er mag sie, sie ihn nicht. Der Krieg beginnt, Jan zieht aus, kommt als berühmter General zurück.`, images: [ { url: "https://images.unsplash.com/photo-1544892504-5ad7a122b56f?w=400", title: "Kölner Altstadt", description: "Historische Gassen" }, { url: "https://images.unsplash.com/photo-1517840901100-8179e982acb7?w=400", title: "Rheinpromenade", description: "Spazierweg mit Domblick" }, { url: "https://images.unsplash.com/photo-1567696911980-2eed69651dd7?w=400", title: "Historisches Rathaus", description: "Gotisches Bauwerk" } ] }, { id: 4, title: "Groß St. Martin", subtitle: "Romanische Kirche und Klostergeschichte", lat: 50.9347, lng: 6.9597, description: "Eine der zwölf großen romanischen Kirchen Kölns.", photoChallenge: "Macht ein Foto der imposanten Kirchtürme und zeigt dabei mittelalterliche Gebetshaltungen!", mainText: `Groß St. Martin ist eine der beeindruckendsten romanischen Kirchen Kölns. Der markante Vierungsturm prägt seit dem 12. Jahrhundert die Silhouette der Altstadt.

Die Kirche wurde auf römischen Fundamenten errichtet - archäologische Ausgrabungen zeigen die Kontinuität der Besiedlung über 2000 Jahre. Im Mittelalter war hier eines der mächtigsten Benediktinerklöster der Region.

Der Turm diente auch als Orientierungspunkt für Rheinschiffe und Händler - ein früher “Leuchtturm” des Handels.`, images: [ { url: "https://images.unsplash.com/photo-1518709268805-4e9042af2e96?w=400", title: "Groß St. Martin", description: "Romanischer Kirchenbau" }, { url: "https://images.unsplash.com/photo-1573052905904-34ad8c27f0d4?w=400", title: "Altstadt Panorama", description: "Kirchtürme der Altstadt" }, { url: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400", title: "Rheinufer", description: "Blick auf die Kirchen" } ] }, { id: 5, title: "Fischmarkt", subtitle: "Handel, Handwerk und Bürgerstolz", lat: 50.9378, lng: 6.9589, description: "Mittelpunkt des mittelalterlichen Handels.", photoChallenge: "Zeigt mit euren Händen, wie mittelalterliche Händler ihre Waren präsentiert haben - seid kreativ mit Gesten!", mainText: `Der Fischmarkt war im Mittelalter das kommerzielle Herz Kölns. Hier wurde nicht nur Fisch verkauft, sondern alle wichtigen Handelsgüter der Region.

Die Kölner Bürger entwickelten hier ihre berühmte Unabhängigkeit. 1074 erhielt Köln bereits wichtige Stadtrechte - 500 Jahre bevor andere deutsche Städte folgten.

Die Zunftordnungen vom Fischmarkt dienten als Vorbild für ganz Europa. Handwerksmeister aus Köln gründeten in vielen anderen Städten ähnliche Organisationen.`,
images: [
{ url: “https://images.unsplash.com/photo-1578916171728-46686eac8d58?w=400”, title: “Alter Markt Köln”, description: “Historischer Marktplatz” },
{ url: “https://images.unsplash.com/photo-1574790398664-0cb3c99c3711?w=400”, title: “Kölner Häuser”, description: “Typische Architektur” },
{ url: “https://images.unsplash.com/photo-1587474260584-136574528ed5?w=400”, title: “Rheinischer Markt”, description: “Handelstradition” }
]
}
],

```
    stations: [], // Will be loaded from Firebase or defaults

    // Initialize the app
    init() {
        try {
            this.log('Initializing Tour App...');
            this.loadState();
            this.initFirebase();
            this.updateUI();
            this.initGeolocation();
            
            // Setup event listeners
            document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendMessage();
                }
            });
            
            // Auto-generate tour ID if none exists
            if (!this.state.tourId) {
                this.state.tourId = 'koeln-' + new Date().toISOString().split('T')[0] + '-' + Math.random().toString(36).substr(2, 5);
                this.saveState();
            }
            
            document.getElementById('currentTourId').textContent = this.state.tourId;
            document.getElementById('tourIdInput').value = this.state.tourId;
            
            this.log('Tour App initialized successfully');
        } catch (error) {
            this.log('Error initializing app:', error);
            this.showError('Fehler beim Laden der App. Bitte Seite neu laden.');
        }
    },

    // Initialize Firebase
    initFirebase() {
        try {
            // Use a simulated Firebase for demo (replace with real Firebase config)
            this.state.firebase = {
                initializeApp: () => ({ databaseURL: this.firebaseConfig.databaseURL }),
                database: () => ({
                    ref: (path) => ({
                        on: (event, callback) => {
                            // Simulate real-time updates
                            setInterval(() => {
                                if (Math.random() > 0.7) {
                                    callback({ val: () => null }); // Simulate data changes
                                }
                            }, 5000);
                        },
                        push: (data) => Promise.resolve({ key: 'demo-' + Date.now() }),
                        set: (data) => Promise.resolve(),
                        once: (event) => Promise.resolve({ val: () => null })
                    })
                })
            };
            
            this.state.database = this.state.firebase.database();
            this.connectToTour();
            
            this.log('Firebase initialized (demo mode)');
        } catch (error) {
            this.log('Firebase initialization failed, using offline mode:', error);
            this.updateConnectionStatus(false);
        }
    },

    // Connect to tour
    connectToTour() {
        try {
            if (!this.state.tourId || !this.state.database) return;
            
            // Listen for chat messages
            this.state.database.ref(`tours/${this.state.tourId}/messages`).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message && message.userName !== this.state.userName) {
                    this.addChatMessage(message.userName, message.message, false);
                }
            });
            
            // Listen for station updates
            this.state.database.ref(`tours/${this.state.tourId}/stations`).on('value', (snapshot) => {
                const stationData = snapshot.val();
                if (stationData) {
                    this.stations = Object.values(stationData);
                    this.generateStationsList();
                    this.generateAdminStationsList();
                }
            });
            
            // Initialize stations if not exist
            this.state.database.ref(`tours/${this.state.tourId}/stations`).once('value').then((snapshot) => {
                if (!snapshot.val()) {
                    this.stations = [...this.defaultStations];
                    this.saveStationsToFirebase();
                    this.generateStationsList();
                    this.generateAdminStationsList();
                }
            });
            
            this.updateConnectionStatus(true);
            this.log('Connected to tour:', this.state.tourId);
        } catch (error) {
            this.log('Error connecting to tour:', error);
            this.updateConnectionStatus(false);
        }
    },

    // Join tour with ID
    joinTour() {
        try {
            const newTourId = document.getElementById('tourIdInput').value.trim();
            if (!newTourId) {
                alert('Bitte gib eine Tour-ID ein!');
                return;
            }
            
            this.state.tourId = newTourId;
            document.getElementById('currentTourId').textContent = newTourId;
            this.saveState();
            this.connectToTour();
            this.showNotification('Tour beigetreten: ' + newTourId);
            this.log('Joined tour:', newTourId);
        } catch (error) {
            this.log('Error joining tour:', error);
            this.showError('Fehler beim Beitreten der Tour');
        }
    },

    // Admin functions
    loginAdmin() {
        try {
            const password = document.getElementById('adminPassword').value;
            if (password === 'koeln2024') {
                this.state.isAdmin = true;
                document.getElementById('adminTab').style.display = 'block';
                this.generateAdminStationsList();
                this.showNotification('Admin-Modus aktiviert! ⚙️');
                this.log('Admin logged in');
            } else {
                alert('Falsches Passwort!');
            }
        } catch (error) {
            this.log('Error logging in admin:', error);
        }
    },

    // Generate admin stations list
    generateAdminStationsList() {
        try {
            if (!this.state.isAdmin) return;
            
            const container = document.getElementById('adminStationsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            this.stations.forEach(station => {
                const adminCard = document.createElement('div');
                adminCard.className = 'station-card';
                adminCard.innerHTML = `
                    <h4>${station.title}</h4>
                    <div style="margin: 1rem 0;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">📸 Foto-Challenge:</label>
                        <textarea id="challenge-${station.id}" style="width: 100%; height: 80px; padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 8px;">${station.photoChallenge}</textarea>
                        <button class="btn btn-admin" onclick="TourApp.updateChallenge(${station.id})" style="margin-top: 0.5rem;">Challenge aktualisieren</button>
                    </div>
                    <div style="margin: 1rem 0;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">🖼️ Bilder verwalten:</label>
                        <div class="image-gallery">
                            ${station.images.map((img, index) => `
                                <div class="gallery-item" style="position: relative;">
                                    <img src="${img.url}" alt="${img.title}" class="gallery-image">
                                    <button onclick="TourApp.editImage(${station.id}, ${index})" style="position: absolute; top: 5px; right: 5px; background: #f59e0b; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">✏️</button>
                                    <small>${img.title}</small>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-admin" onclick="TourApp.addImage(${station.id})" style="margin-top: 0.5rem;">Neues Bild hinzufügen</button>
                    </div>
                `;
                container.appendChild(adminCard);
            });
            
            this.log('Admin stations list generated');
        } catch (error) {
            this.log('Error generating admin stations list:', error);
        }
    },

    // Update challenge text
    updateChallenge(stationId) {
        try {
            const newChallenge = document.getElementById(`challenge-${stationId}`).value;
            const station = this.stations.find(s => s.id === stationId);
            if (station) {
                station.photoChallenge = newChallenge;
                this.saveStationsToFirebase();
                this.showNotification('Challenge aktualisiert! 📸');
                this.log('Challenge updated for station:', stationId);
            }
        } catch (error) {
            this.log('Error updating challenge:', error);
        }
    },

    // Edit image
    editImage(stationId, imageIndex) {
        try {
            const station = this.stations.find(s => s.id === stationId);
            if (!station || !station.images[imageIndex]) return;
            
            const image = station.images[imageIndex];
            this.showEditModal('Bild bearbeiten', `
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Bild-URL:</label>
                    <input type="url" id="editImageUrl" value="${image.url}" style="width: 100%; padding: 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Titel:</label>
                    <input type="text" id="editImageTitle" value="${image.title}" style="width: 100%; padding: 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Beschreibung:</label>
                    <textarea id="editImageDescription" style="width: 100%; height: 80px; padding: 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">${image.description}</textarea>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-admin" onclick="TourApp.saveImageEdit(${stationId}, ${imageIndex})" style="flex: 1;">Speichern</button>
                        <button class="btn btn-secondary" onclick="TourApp.deleteImage(${stationId}, ${imageIndex})" style="flex: 1;">Löschen</button>
                    </div>
                </div>
            `);
        } catch (error) {
            this.log('Error editing image:', error);
        }
    },

    // Add new image
    addImage(stationId) {
        try {
            this.showEditModal('Neues Bild hinzufügen', `
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Bild-URL:</label>
                    <input type="url" id="newImageUrl" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Titel:</label>
                    <input type="text" id="newImageTitle" placeholder="Bildtitel" style="width: 100%; padding: 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Beschreibung:</label>
                    <textarea id="newImageDescription" placeholder="Bildbeschreibung" style="width: 100%; height: 80px; padding: 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;"></textarea>
                    
                    <button class="btn btn-admin" onclick="TourApp.saveNewImage(${stationId})" style="width: 100%;">Bild hinzufügen</button>
                </div>
            `);
        } catch (error) {
            this.log('Error adding image:', error);
        }
    },

    // Save image edit
    saveImageEdit(stationId, imageIndex) {
        try {
            const station = this.stations.find(s => s.id === stationId);
            if (!station || !station.images[imageIndex]) return;
            
            station.images[imageIndex] = {
                url: document.getElementById('editImageUrl').value,
                title: document.getElementById('editImageTitle').value,
                description: document.getElementById('editImageDescription').value
            };
            
            this.saveStationsToFirebase();
            this.closeEditModal();
            this.showNotification('Bild aktualisiert! 🖼️');
            this.log('Image updated:', stationId, imageIndex);
        } catch (error) {
            this.log('Error saving image edit:', error);
        }
    },

    // Save new image
    saveNewImage(stationId) {
        try {
            const station = this.stations.find(s => s.id === stationId);
            if (!station) return;
            
            const newImage = {
                url: document.getElementById('newImageUrl').value,
                title: document.getElementById('newImageTitle').value,
                description: document.getElementById('newImageDescription').value
            };
            
            if (!newImage.url || !newImage.title) {
                alert('Bitte URL und Titel eingeben!');
                return;
            }
            
            station.images.push(newImage);
            this.saveStationsToFirebase();
            this.closeEditModal();
            this.showNotification('Neues Bild hinzugefügt! 🖼️');
            this.log('New image added:', stationId);
        } catch (error) {
            this.log('Error saving new image:', error);
        }
    },

    // Delete image
    deleteImage(stationId, imageIndex) {
        try {
            if (confirm('Bild wirklich löschen?')) {
                const station = this.stations.find(s => s.id === stationId);
                if (station && station.images[imageIndex]) {
                    station.images.splice(imageIndex, 1);
                    this.saveStationsToFirebase();
                    this.closeEditModal();
                    this.showNotification('Bild gelöscht! 🗑️');
                    this.log('Image deleted:', stationId, imageIndex);
                }
            }
        } catch (error) {
            this.log('Error deleting image:', error);
        }
    },

    // Show edit modal
    showEditModal(title, content) {
        try {
            const modal = document.createElement('div');
            modal.className = 'edit-modal';
            modal.innerHTML = `
                <div class="edit-modal-content">
                    <h3 style="margin-bottom: 1rem; color: #1f2937;">${title}</h3>
                    ${content}
                    <button class="btn btn-secondary" onclick="TourApp.closeEditModal()" style="margin-top: 1rem; width: 100%;">Abbrechen</button>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) this.closeEditModal();
            };
            document.body.appendChild(modal);
            this.currentModal = modal;
        } catch (error) {
            this.log('Error showing edit modal:', error);
        }
    },

    // Close edit modal
    closeEditModal() {
        try {
            if (this.currentModal) {
                this.currentModal.remove();
                this.currentModal = null;
            }
        } catch (error) {
            this.log('Error closing edit modal:', error);
        }
    },

    // Save stations to Firebase
    saveStationsToFirebase() {
        try {
            if (this.state.database && this.state.tourId) {
                const stationsObj = {};
                this.stations.forEach(station => {
                    stationsObj[station.id] = station;
                });
                this.state.database.ref(`tours/${this.state.tourId}/stations`).set(stationsObj);
            }
            // Also update local display
            this.generateStationsList();
            this.generateAdminStationsList();
        } catch (error) {
            this.log('Error saving stations to Firebase:', error);
        }
    },

    // Reset tour
    resetTour() {
        try {
            if (confirm('Wirklich alle Daten zurücksetzen? Diese Aktion kann nicht rückgängig gemacht werden!')) {
                // Reset local state
                this.state.completedStations = [];
                this.state.totalScore = 0;
                this.state.uploadedPhotos = [];
                
                // Reset Firebase data
                if (this.state.database && this.state.tourId) {
                    this.state.database.ref(`tours/${this.state.tourId}`).remove();
                }
                
                // Reset stations to defaults
                this.stations = [...this.defaultStations];
                this.saveStationsToFirebase();
                
                this.saveState();
                this.updateUI();
                this.showNotification('Tour zurückgesetzt! 🔄');
                this.log('Tour reset');
            }
        } catch (error) {
            this.log('Error resetting tour:', error);
        }
    },

    // Update connection status
    updateConnectionStatus(connected) {
        try {
            this.state.connected = connected;
            const status = document.getElementById('connectionStatus');
            if (status) {
                status.className = `connection-status ${connected ? 'online' : 'offline'}`;
                status.textContent = connected ? '🟢 Online' : '🔴 Offline';
            }
        } catch (error) {
            this.log('Error updating connection status:', error);
        }
    },

    // Debug logging
    log(message, data = null) {
        if (this.state.debugMode) {
            console.log('[TourApp]', message, data);
        }
    },

    // Error handling
    showError(message) {
        this.showNotification(message, 'error');
    },

    // Show notifications
    showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 4000);
    },

    // Tab Management
    showTab(tabName, tabElement) {
        try {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const targetTab = document.getElementById(tabName === 'map' ? 'map-tab' : tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // Tab-specific actions
            if (tabName === 'map') {
                setTimeout(() => this.initMap(), 100);
            } else if (tabName === 'ranking') {
                this.updateRanking();
            } else if (tabName === 'chat' && !this.state.chatInitialized) {
                this.state.chatInitialized = true;
            } else if (tabName === 'admin') {
                this.generateAdminStationsList();
            }

            this.log('Switched to tab:', tabName);
        } catch (error) {
            this.log('Error switching tab:', error);
        }
    },

    // Team Selection
    selectTeam(teamId, teamName, element) {
        try {
            this.state.selectedTeam = teamId;
            this.state.teamName = teamName;
            
            // Update UI
            document.querySelectorAll('.team-option').forEach(option => {
                option.classList.remove('selected');
            });
            if (element) {
                element.classList.add('selected');
            }
            
            // Hide team selector
            const selector = document.getElementById('teamSelector');
            if (selector) {
                selector.style.display = 'none';
            }
            
            this.showNotification('Team ausgewählt! 🎉');
            this.saveState();
            this.log('Team selected:', teamId, teamName);
        } catch (error) {
            this.log('Error selecting team:', error);
        }
    },

    // Start Tour
    startTour() {
        try {
            if (!this.state.selectedTeam) {
                alert('Bitte wähle zuerst ein Team aus!');
                return;
            }
            
            this.showTab('stations', document.querySelector('[onclick*="stations"]'));
            this.showNotification('Tour gestartet! Viel Erfolg! 🚀');
            this.log('Tour started');
        } catch (error) {
            this.log('Error starting tour:', error);
        }
    },

    // Generate Stations List
    generateStationsList() {
        try {
            const container = document.getElementById('stationsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            this.stations.forEach(station => {
                const isCompleted = this.state.completedStations.includes(station.id);
                
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${isCompleted ? 'completed' : ''}`;
                stationCard.onclick = () => this.toggleStationDetails(station.id);
                
                const imagesHtml = station.images.map(img => `
                    <div class="gallery-item">
                        <img src="${img.url}" alt="${img.title}" class="gallery-image" onclick="TourApp.showImageModal('${img.url}', '${img.title}', '${img.description}')">
                        <small>${img.title}</small>
                    </div>
                `).join('');
                
                stationCard.innerHTML = `
                    <div class="station-header">
                        <div class="station-number ${isCompleted ? 'completed' : ''}">${station.id}</div>
                        <div style="flex: 1;">
                            <div class="station-title">${station.title}</div>
                            <div class="station-subtitle">${station.subtitle}</div>
                        </div>
                    </div>
                    <div class="station-details" id="station-${station.id}">
                        <div class="detail-section">
                            <h4>📖 Geschichte</h4>
                            <p>${station.mainText}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>🖼️ Bildergalerie</h4>
                            <div class="image-gallery">
                                ${imagesHtml}
                            </div>
                        </div>

                        <div class="photo-challenge">
                            <h4>📸 KI-Foto-Challenge</h4>
                            <div class="editable-content ${this.state.isAdmin ? 'admin-mode' : ''}" data-station="${station.id}">
                                <p>${station.photoChallenge}</p>
                                ${this.state.isAdmin ? '<button class="edit-button" onclick="TourApp.editChallenge(' + station.id + ')">✏️</button>' : ''}
                            </div>
                            
                            <div class="photo-upload-area" onclick="TourApp.selectPhoto(${station.id})" id="upload-area-${station.id}">
                                <div id="upload-content-${station.id}">
                                    📷 Hier klicken zum Foto machen/auswählen<br>
                                    <small>KI bewertet automatisch Qualität, Komposition & Kreativität</small>
                                </div>
                            </div>
                            
                            <input type="file" class="file-input" id="photo-input-${station.id}" accept="image/*" capture="environment" onchange="TourApp.handlePhotoUpload(${station.id}, event)">
                            
                            <div class="ai-rating hidden" id="rating-${station.id}">
                                <div class="rating-score" id="score-${station.id}">0</div>
                                <div class="rating-text" id="rating-text-${station.id}">KI analysiert dein Foto...</div>
                                <div class="rating-details" id="rating-details-${station.id}"></div>
                            </div>
                        </div>

                        <button class="btn" onclick="TourApp.completeStation(${station.id})" id="complete-btn-${station.id}" 
                                ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? '✅ Station abgeschlossen' : '🏁 Station abschließen'}
                        </button>
                    </div>
                `;
                
                container.appendChild(stationCard);
            });

            this.log('Stations list generated');
        } catch (error) {
            this.log('Error generating stations list:', error);
        }
    },

    // Edit challenge (inline)
    editChallenge(stationId) {
        try {
            const station = this.stations.find(s => s.id === stationId);
            if (!station) return;
            
            const editableDiv = document.querySelector(`.editable-content[data-station="${stationId}"]`);
            if (editableDiv) {
                editableDiv.innerHTML = `
                    <textarea style="width: 100%; height: 80px; padding: 0.5rem; border: 2px solid #f59e0b; border-radius: 8px;">${station.photoChallenge}</textarea>
                    <div style="margin-top: 0.5rem;">
                        <button onclick="TourApp.saveInlineChallenge(${stationId})" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-right: 0.5rem;">💾 Speichern</button>
                        <button onclick="TourApp.cancelInlineEdit(${stationId})" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px;">❌ Abbrechen</button>
                    </div>
                `;
            }
        } catch (error) {
            this.log('Error editing challenge inline:', error);
        }
    },

    // Save inline challenge
    saveInlineChallenge(stationId) {
        try {
            const editableDiv = document.querySelector(`.editable-content[data-station="${stationId}"]`);
            const textarea = editableDiv.querySelector('textarea');
            if (textarea) {
                const station = this.stations.find(s => s.id === stationId);
                if (station) {
                    station.photoChallenge = textarea.value;
                    this.saveStationsToFirebase();
                    this.showNotification('Challenge aktualisiert! 📸');
                }
            }
        } catch (error) {
            this.log('Error saving inline challenge:', error);
        }
    },

    // Cancel inline edit
    cancelInlineEdit(stationId) {
        try {
            this.generateStationsList(); // Regenerate to restore original content
        } catch (error) {
            this.log('Error canceling inline edit:', error);
        }
    },

    // Toggle Station Details
    toggleStationDetails(stationId) {
        try {
            const details = document.getElementById(`station-${stationId}`);
            if (details) {
                details.classList.toggle('active');
            }
        } catch (error) {
            this.log('Error toggling station details:', error);
        }
    },

    // Photo Selection
    selectPhoto(stationId) {
        try {
            const input = document.getElementById(`photo-input-${stationId}`);
            if (input) {
                input.click();
            }
        } catch (error) {
            this.log('Error selecting photo:', error);
        }
    },

    // Photo Upload Handler
    handlePhotoUpload(stationId, event) {
        try {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                
                // Update upload area
                const uploadArea = document.getElementById(`upload-area-${stationId}`);
                if (uploadArea) {
                    uploadArea.classList.add('has-photo');
                    uploadArea.innerHTML = `
                        <img src="${imageUrl}" class="photo-preview" alt="Uploaded photo">
                        <p>📷 Foto erfolgreich hochgeladen!</p>
                        <small>KI analysiert...</small>
                    `;
                }

                // Store photo
                const existingPhotoIndex = this.state.uploadedPhotos.findIndex(p => p.stationId === stationId);
                const photoData = {
                    stationId: stationId,
                    imageUrl: imageUrl,
                    timestamp: Date.now(),
                    teamId: this.state.selectedTeam
                };

                if (existingPhotoIndex >= 0) {
                    this.state.uploadedPhotos[existingPhotoIndex] = photoData;
                } else {
                    this.state.uploadedPhotos.push(photoData);
                }

                // AI Analysis with delay
                setTimeout(() => {
                    this.ratePhoto(stationId, imageUrl);
                }, 1000);

                this.saveState();
            };
            
            reader.readAsDataURL(file);
            this.log('Photo uploaded for station:', stationId);
        } catch (error) {
            this.log('Error handling photo upload:', error);
        }
    },

    // AI Photo Rating (simplified version)
    ratePhoto(stationId, imageUrl) {
        try {
            const ratingDiv = document.getElementById(`rating-${stationId}`);
            if (ratingDiv) {
                ratingDiv.classList.remove('hidden');
            }
            
            // Simulate AI analysis
            const baseScore = 50 + Math.random() * 40; // 50-90 points
            const technicalScore = 70 + Math.random() * 25;
            const compositionScore = 60 + Math.random() * 30;
            const creativityScore = 55 + Math.random() * 35;
            
            const finalScore = Math.round(baseScore);
            
            // Animate score counting
            this.animateScore(stationId, finalScore);
            
            // Generate feedback
            const feedback = this.generatePhotoFeedback(technicalScore, compositionScore, creativityScore);
            
            setTimeout(() => {
                const ratingTextEl = document.getElementById(`rating-text-${stationId}`);
                const ratingDetailsEl = document.getElementById(`rating-details-${stationId}`);
                
                if (ratingTextEl) {
                    ratingTextEl.innerHTML = `
                        <strong>KI-Bewertung abgeschlossen!</strong><br>
                        Qualität: ${Math.round(technicalScore)}% | 
                        Komposition: ${Math.round(compositionScore)}% | 
                        Kreativität: ${Math.round(creativityScore)}%
                    `;
                }
                
                if (ratingDetailsEl) {
                    ratingDetailsEl.innerHTML = feedback.join('<br>');
                }
            }, 2000);
            
            // Add score to total
            this.addScore(finalScore);
            
            // Store rating in photo data
            const photoData = this.state.uploadedPhotos.find(p => p.stationId === stationId);
            if (photoData) {
                photoData.score = finalScore;
                photoData.analysis = {
                    technical: technicalScore,
                    composition: compositionScore,
                    creativity: creativityScore,
                    feedback: feedback
                };
            }
            
            this.showNotification(`KI-Bewertung: ${finalScore} Punkte! 🤖`);
            this.log('Photo rated:', stationId, finalScore);
        } catch (error) {
            this.log('Error rating photo:', error);
            // Fallback rating
            this.addScore(60);
            this.showNotification('Foto bewertet! 📸');
        }
    },

    // Animate Score
    animateScore(stationId, targetScore) {
        try {
            const scoreElement = document.getElementById(`score-${stationId}`);
            if (!scoreElement) return;
            
            let currentScore = 0;
            const increment = Math.ceil(targetScore / 30);
            
            const interval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(interval);
                }
                scoreElement.textContent = currentScore;
            }, 50);
        } catch (error) {
            this.log('Error animating score:', error);
        }
    },

    // Generate Photo Feedback
    generatePhotoFeedback(technical, composition, creativity) {
        const feedback = [];
        
        if (technical > 75) {
            feedback.push("📸 Sehr scharfes und gut belichtetes Bild!");
        } else if (technical < 50) {
            feedback.push("⚠️ Bild könnte schärfer oder besser belichtet sein");
        }
        
        if (composition > 70) {
            feedback.push("🎨 Tolle Bildkomposition!");
        } else {
            feedback.push("💡 Tipp: Achte auf die Bildaufteilung");
        }
        
        if (creativity > 75) {
            feedback.push("✨ Sehr kreative Aufnahme!");
        } else if (creativity > 60) {
            feedback.push("🎭 Schöne kreative Elemente!");
        }
        
        // Always add a positive message
        feedback.push("👥 Toll, dass ihr als Team fotografiert!");
        
        return feedback.length > 0 ? feedback : ["Schöne Aufnahme! 📷"];
    },

    // Complete Station
    completeStation(stationId) {
        try {
            if (!this.state.completedStations.includes(stationId)) {
                this.state.completedStations.push(stationId);
                this.updateProgress();
                this.showNotification('Station abgeschlossen! 🏁');
                
                // Update station card
                const completeBtn = document.getElementById(`complete-btn-${stationId}`);
                if (completeBtn) {
                    const stationCard = completeBtn.closest('.station-card');
                    if (stationCard) {
                        stationCard.classList.add('completed');
                        const stationNumber = stationCard.querySelector('.station-number');
                        if (stationNumber) {
                            stationNumber.classList.add('completed');
                        }
                    }
                    
                    // Disable button
                    completeBtn.disabled = true;
                    completeBtn.textContent = '✅ Station abgeschlossen';
                    completeBtn.style.background = '#6b7280';
                }

                // Check if tour is complete
                if (this.state.completedStations.length === this.stations.length) {
                    this.showNotification('🎉 Herzlichen Glückwunsch! Tour abgeschlossen!');
                    setTimeout(() => {
                        this.showTab('ranking', document.querySelector('[onclick*="ranking"]'));
                    }, 2000);
                }

                this.saveState();
                this.log('Station completed:', stationId);
            }
        } catch (error) {
            this.log('Error completing station:', error);
        }
    },

    // Add Score
    addScore(points) {
        try {
            this.state.totalScore += Math.round(points);
            this.updateUI();
            this.updateTeamScore();
            this.saveState();
            this.log('Score added:', points, 'Total:', this.state.totalScore);
        } catch (error) {
            this.log('Error adding score:', error);
        }
    },

    // Update UI
    updateUI() {
        try {
            const scoreElement = document.getElementById('totalScore');
            if (scoreElement) {
                scoreElement.textContent = this.state.totalScore;
            }
            this.updateProgress();
        } catch (error) {
            this.log('Error updating UI:', error);
        }
    },

    // Update Progress
    updateProgress() {
        try {
            const progress = (this.state.completedStations.length / this.stations.length) * 100;
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        } catch (error) {
            this.log('Error updating progress:', error);
        }
    },

    // Update Team Score (simplified team sync)
    updateTeamScore() {
        try {
            if (this.state.selectedTeam && this.state.database && this.state.tourId) {
                const teamData = {
                    teamId: this.state.selectedTeam,
                    teamName: this.state.teamName,
                    score: this.state.totalScore,
                    lastUpdate: Date.now()
                };
                this.state.database.ref(`tours/${this.state.tourId}/teams/${this.state.selectedTeam}`).set(teamData);
            }
        } catch (error) {
            this.log('Error updating team score:', error);
        }
    },

    // Update Ranking
    updateRanking() {
        try {
            const rankingList = document.getElementById('rankingList');
            if (!rankingList) return;
            
            // For demo purposes, create some sample teams
            const teams = [
                { id: 'red', name: '🔴 Team Römer', score: this.state.selectedTeam === 'red' ? this.state.totalScore : Math.floor(Math.random() * 300) + 100 },
                { id: 'blue', name: '🔵 Team Gaffeln', score: this.state.selectedTeam === 'blue' ? this.state.totalScore : Math.floor(Math.random() * 300) + 100 },
                { id: 'green', name: '🟢 Team Hanseat', score: this.state.selectedTeam === 'green' ? this.state.totalScore : Math.floor(Math.random() * 300) + 100 },
                { id: 'yellow', name: '🟡 Team Modern', score: this.state.selectedTeam === 'yellow' ? this.state.totalScore : Math.floor(Math.random() * 300) + 100 }
            ];
            
            teams.sort((a, b) => b.score - a.score);
            
            rankingList.innerHTML = '';
            
            teams.forEach((team, index) => {
                const rankItem = document.createElement('div');
                const isUserTeam = team.id === this.state.selectedTeam;
                rankItem.className = `team-rank-item ${isUserTeam ? 'highlight' : ''}`;
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                rankItem.innerHTML = `
                    <div class="rank-position ${rankClass}">${index + 1}</div>
                    <div style="flex: 1;">
                        <strong>${team.name}</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">
                            ${team.score} Punkte
                        </div>
                    </div>
                    ${isUserTeam ? '<div style="color: #f59e0b;">👤</div>' : ''}
                `;
                
                rankingList.appendChild(rankItem);
            });
            
            this.log('Ranking updated');
        } catch (error) {
            this.log('Error updating ranking:', error);
        }
    },

    // Chat Functions
    sendMessage() {
        try {
            const input = document.getElementById('chatInput');
            if (!input) return;
            
            const message = input.value.trim();
            if (message) {
                // Add to local chat immediately
                this.addChatMessage(this.state.userName, message, true);
                
                // Send to Firebase
                if (this.state.database && this.state.tourId) {
                    this.state.database.ref(`tours/${this.state.tourId}/messages`).push({
                        userName: this.state.userName,
                        message: message,
                        timestamp: Date.now()
                    });
                }
                
                input.value = '';
                this.log('Message sent:', message);
            }
        } catch (error) {
            this.log('Error sending message:', error);
        }
    },

    addChatMessage(userName, message, isOwn = false) {
        try {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;
            
            const timeStr = new Date().toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <strong>${userName}:</strong> ${message}
                <span class="timestamp">${timeStr}</span>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Show notification if not own message and not on chat tab
            if (!isOwn && !document.getElementById('chat').classList.contains('active')) {
                this.showNotification(`💬 ${userName}: ${message.substring(0, 30)}${message.length > 30 ? '...' : ''}`);
            }
        } catch (error) {
            this.log('Error adding chat message:', error);
        }
    },

    // Map Functions
    initMap() {
        try {
            if (this.state.map || !document.getElementById('map')) return;
            
            // Try to load Leaflet
            if (typeof L === 'undefined') {
                this.loadLeaflet(() => this.createMap());
            } else {
                this.createMap();
            }
        } catch (error) {
            this.log('Error initializing map:', error);
            this.showMapError();
        }
    },

    loadLeaflet(callback) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
        script.onload = callback;
        script.onerror = () => this.showMapError();
        document.head.appendChild(script);
    },

    createMap() {
        try {
            this.state.map = L.map('map').setView([50.9375, 6.9597], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(this.state.map);
            
            // Add station markers
            this.stations.forEach(station => {
                const isCompleted = this.state.completedStations.includes(station.id);
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center; max-width: 200px;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}/${this.stations.length}</strong></p>
                            ${isCompleted ? '<p style="color: green;">✅ Abgeschlossen</p>' : '<p style="color: orange;">⏳ Ausstehend</p>'}
                        </div>
                    `)
                    .addTo(this.state.map);
                
                this.state.markers.push(marker);
            });
            
            // Add route
            const routeCoordinates = this.stations.map(station => [station.lat, station.lng]);
            L.polyline(routeCoordinates, {
                color: '#dc2626',
                weight: 3,
                opacity: 0.7
            }).addTo(this.state.map);
            
            // Add user location if available
            if (this.state.userLocation) {
                this.addUserLocationToMap();
            }
            
            this.log('Map created successfully');
        } catch (error) {
            this.log('Error creating map:', error);
            this.showMapError();
        }
    },

    showMapError() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
            mapEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 10px;"><p>🗺️ Karte konnte nicht geladen werden</p></div>';
        }
    },

    addUserLocationToMap() {
        try {
            if (!this.state.map || !this.state.userLocation) return;
            
            const userIcon = L.divIcon({
                html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                className: 'user-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            L.marker([this.state.userLocation.lat, this.state.userLocation.lng], {
                icon: userIcon
            })
            .bindPopup('📍 Dein Standort')
            .addTo(this.state.map);
            
            this.log('User location added to map');
        } catch (error) {
            this.log('Error adding user location to map:', error);
        }
    },

    centerOnUser() {
        try {
            if (this.state.userLocation && this.state.map) {
                this.state.map.setView([this.state.userLocation.lat, this.state.userLocation.lng], 17);
            } else {
                alert('Standort nicht verfügbar. Bitte erlaube Standortzugriff in den Browser-Einstellungen.');
            }
        } catch (error) {
            this.log('Error centering on user:', error);
        }
    },

    // Geolocation
    initGeolocation() {
        try {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        this.state.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        this.updateLocationInfo();
                        if (this.state.map) {
                            this.addUserLocationToMap();
                        }
                        this.log('Geolocation obtained');
                    },
                    error => {
                        this.log('Geolocation error:', error);
                        const distanceInfo = document.getElementById('distanceInfo');
                        if (distanceInfo) {
                            distanceInfo.textContent = '📍 Standort nicht verfügbar';
                        }
                    }
                );
            }
        } catch (error) {
            this.log('Error initializing geolocation:', error);
        }
    },

    updateLocationInfo() {
        try {
            if (!this.state.userLocation) return;
            
            let nearestStation = null;
            let minDistance = Infinity;
            
            this.stations.forEach(station => {
                const distance = this.calculateDistance(
                    this.state.userLocation.lat, this.state.userLocation.lng,
                    station.lat, station.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            });
            
            if (nearestStation) {
                const distanceText = minDistance < 1 
                    ? `${Math.round(minDistance * 1000)}m` 
                    : `${minDistance.toFixed(1)}km`;
                
                const distanceInfo = document.getElementById('distanceInfo');
                if (distanceInfo) {
                    distanceInfo.textContent = `📍 Nächste Station: ${nearestStation.title} (${distanceText})`;
                }
            }
        } catch (error) {
            this.log('Error updating location info:', error);
        }
    },

    calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },

    // Image Modal
    showImageModal(url, title, description) {
        try {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                flex-direction: column;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <img src="${url}" style="max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px;">
                <div style="color: white; text-align: center; margin-top: 20px; max-width: 600px;">
                    <h3>${title}</h3>
                    <p>${description}</p>
                    <button style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">Schließen</button>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
            this.log('Image modal shown:', title);
        } catch (error) {
            this.log('Error showing image modal:', error);
        }
    },

    // State Management
    saveState() {
        try {
            const stateToSave = {
                ...this.state,
                map: null, // Don't save map object
                markers: [], // Don't save markers
                firebase: null, // Don't save firebase object
                database: null // Don't save database object
            };
            localStorage.setItem('tourState', JSON.stringify(stateToSave));
            this.log('State saved');
        } catch (error) {
            this.log('Error saving state:', error);
        }
    },

    loadState() {
        try {
            const saved = localStorage.getItem('tourState');
            if (saved) {
                const savedState = JSON.parse(saved);
                // Merge saved state but keep current firebase/database objects
                const currentFirebase = this.state.firebase;
                const currentDatabase = this.state.database;
                this.state = { ...this.state, ...savedState };
                this.state.firebase = currentFirebase;
                this.state.database = currentDatabase;
                
                // Restore team selection UI
                if (this.state.selectedTeam) {
                    setTimeout(() => {
                        const teamOptions = document.querySelectorAll('.team-option');
                        teamOptions.forEach(option => {
                            if (option.textContent.includes(this.state.teamName)) {
                                option.classList.add('selected');
                            }
                        });
                        const selector = document.getElementById('teamSelector');
                        if (selector) {
                            selector.style.display = 'none';
                        }
                    }, 100);
                }
                
                // Update UI elements
                if (this.state.tourId) {
                    const currentTourIdEl = document.getElementById('currentTourId');
                    const tourIdInputEl = document.getElementById('tourIdInput');
                    if (currentTourIdEl) currentTourIdEl.textContent = this.state.tourId;
                    if (tourIdInputEl) tourIdInputEl.value = this.state.tourId;
                }
                
                this.log('State loaded');
            }
        } catch (error) {
            this.log('Error loading state:', error);
        }
    }
};

// Initialize app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => TourApp.init());
} else {
    TourApp.init();
}

// Debug mode toggle (uncomment for debugging)
// TourApp.state.debugMode = true;

</script>
```

</body>
</html>
