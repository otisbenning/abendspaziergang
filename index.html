<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√∂lner Abendspaziergang</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .tour-id-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .connection-status.online {
            background: #10b981;
        }

        .connection-status.offline {
            background: #dc2626;
        }

        .connection-status.connecting {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-container {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            background: #fbbf24;
            height: 100%;
            width: 0%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .main-content {
            padding: 0;
        }

        .tab-container {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 132px;
            z-index: 999;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 1rem 0.5rem;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            font-size: 0.9rem;
            white-space: nowrap;
            min-width: 100px;
            touch-action: manipulation;
        }

        .tab.active {
            background: white;
            color: #dc2626;
            border-bottom: 3px solid #dc2626;
        }

        .tab.admin {
            background: #fef3c7;
            color: #92400e;
        }

        .tab.admin.active {
            background: #f59e0b;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            min-height: calc(100vh - 200px);
        }

        .tab-content.active {
            display: block;
        }

        .tour-connection-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .qr-code-area {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .share-url {
            background: #f8fafc;
            padding: 0.8rem;
            border-radius: 8px;
            border: 2px dashed #e2e8f0;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin: 0.5rem 0;
        }

        .admin-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .admin-password-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin: 0.5rem 0;
        }

        .station-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #dc2626;
            cursor: pointer;
            transition: all 0.3s;
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .station-card.completed {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .station-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .station-number {
            background: #dc2626;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .station-number.completed {
            background: #10b981;
        }

        .station-title {
            flex: 1;
            font-size: 1.3rem;
            font-weight: bold;
            color: #1f2937;
        }

        .station-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .station-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }

        .station-details.active {
            display: block;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h4 {
            color: #dc2626;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .detail-section h4::before {
            content: "‚ñ∂";
            margin-right: 0.5rem;
            color: #dc2626;
        }

        .photo-challenge {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #6366f1;
            position: relative;
        }

        .photo-challenge h4 {
            color: #4f46e5;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .photo-upload-area {
            border: 3px dashed #a5b4fc;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.5);
            touch-action: manipulation;
        }

        .photo-upload-area:hover {
            border-color: #6366f1;
            background: rgba(255,255,255,0.8);
        }

        .photo-upload-area.has-photo {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .ai-rating {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
            border: 2px solid #10b981;
        }

        .rating-score {
            font-size: 3rem;
            font-weight: bold;
            color: #059669;
            margin-bottom: 0.5rem;
        }

        .rating-text {
            color: #047857;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .rating-details {
            background: #f0fdf4;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #065f46;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .gallery-image {
            width: 100%;
            height: 120px;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 2rem;
        }

        .gallery-image:hover {
            transform: scale(1.05);
        }

        .gallery-item {
            text-align: center;
            position: relative;
        }

        .gallery-item small {
            display: block;
            margin-top: 0.5rem;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 1rem;
            margin-top: 1rem;
            touch-action: manipulation;
        }

        .btn:hover {
            background: #991b1b;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-admin {
            background: #f59e0b;
        }

        .btn-admin:hover {
            background: #d97706;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            width: auto;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        .score-display {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
            border: 2px solid #8b5cf6;
        }

        .score-number {
            font-size: 2rem;
            font-weight: bold;
            color: #5b21b6;
        }

        .score-label {
            color: #7c3aed;
            margin-top: 0.5rem;
        }

        .team-ranking {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .team-rank-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            background: #f8fafc;
        }

        .team-rank-item.highlight {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .rank-position {
            background: #6b7280;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .rank-position.gold {
            background: #f59e0b;
        }

        .rank-position.silver {
            background: #6b7280;
        }

        .rank-position.bronze {
            background: #d97706;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .location-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .distance-info {
            font-weight: bold;
            color: #0369a1;
            margin-bottom: 0.5rem;
        }

        .team-selector {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .team-option {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            touch-action: manipulation;
        }

        .team-option:hover {
            background: #f3f4f6;
        }

        .team-option.selected {
            background: #dbeafe;
            border: 2px solid #3b82f6;
        }

        .team-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-message {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            background: #f8fafc;
            border-left: 3px solid #3b82f6;
        }

        .chat-message.own {
            background: #dbeafe;
            border-left-color: #1d4ed8;
            margin-left: 2rem;
        }

        .chat-message.system {
            background: #fef3c7;
            border-left-color: #f59e0b;
            font-style: italic;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-send {
            padding: 0.8rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            touch-action: manipulation;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #059669;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.5s ease;
            max-width: 300px;
        }

        .notification.error {
            background: #dc2626;
        }

        .notification.warning {
            background: #f59e0b;
        }

        .error-panel {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            color: #dc2626;
        }

        .debug-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .debug-section h4 {
            color: #856404;
            margin-bottom: 1rem;
        }

        .debug-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #ffc107;
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        /* Admin-specific styles */
        .admin-content-editor {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .admin-station-editor {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .admin-station-editor.editing {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .admin-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin: 0.5rem 0;
        }

        .admin-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin: 0.5rem 0;
            resize: vertical;
        }

        .admin-lat-lng {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .file-input {
            display: none;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                box-shadow: none;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .tab {
                font-size: 0.8rem;
                padding: 0.8rem 0.3rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .station-card {
                padding: 1rem;
            }
            
            .image-gallery {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèõÔ∏è K√∂lner Abendspaziergang</h1>
            <p class="subtitle">Entdecke 2000 Jahre Stadtgeschichte</p>
            <div class="tour-id-display">
                Tour: <span id="currentTourId">Wird geladen...</span>
                <span class="connection-status connecting" id="connectionStatus" title="Verbindung wird aufgebaut..."></span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </header>

        <div class="main-content">
            <div class="tab-container">
                <button class="tab active" onclick="showTab('overview', this)">üó∫Ô∏è √úbersicht</button>
                <button class="tab" onclick="showTab('stations', this)">üìç Stationen</button>
                <button class="tab" onclick="showTab('ranking', this)">üèÜ Ranking</button>
                <button class="tab" onclick="showTab('chat', this)">üí¨ Chat</button>
                <button class="tab" onclick="showTab('map', this)">üó∫Ô∏è Karte</button>
                <button class="tab admin hidden" onclick="showTab('admin', this)" id="adminTab">‚öôÔ∏è Admin</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div id="errorPanel" class="error-panel hidden">
                    <h4>‚ö†Ô∏è Verbindungsproblem</h4>
                    <p id="errorMessage">Verbindung zu Firebase wird aufgebaut...</p>
                    <button class="btn btn-secondary btn-small" onclick="retryConnection()">üîÑ Erneut versuchen</button>
                </div>

                <div class="tour-connection-section">
                    <h3 style="margin-bottom: 1rem; color: #0369a1;">üîó Mit anderen Ger√§ten verbinden</h3>
                    
                    <div class="qr-code-area">
                        <p><strong>Teile diese URL mit anderen Teilnehmern:</strong></p>
                        <div class="share-url" id="shareUrl">App wird gestartet...</div>
                        <button class="btn btn-secondary btn-small" onclick="copyShareUrl()">üìã URL kopieren</button>
                        <button class="btn btn-secondary btn-small" onclick="shareViaWhatsApp()">üì± WhatsApp teilen</button>
                    </div>
                    
                    <p style="font-size: 0.9rem; color: #6b7280; text-align: center;">
                        üí° Alle die diesen Link √∂ffnen, k√∂nnen miteinander chatten und sehen Live-Rankings!
                    </p>
                </div>

                <div class="debug-section">
                    <h4>üîß Problem mit Tour-Synchronisation?</h4>
                    <p style="color: #856404; font-size: 0.9rem; margin-bottom: 0.5rem;">Falls Chat/Ranking nicht synchronisiert wird, alle Ger√§te auf dieselbe Tour-ID setzen:</p>
                    <input type="text" id="manualTourId" placeholder="z.B. koeln-tour-2025-06-23" class="debug-input">
                    <button class="btn btn-secondary btn-small" onclick="setManualTourId()">üéØ Tour-ID manuell setzen</button>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ffc107;">
                        <h5 style="color: #856404; margin-bottom: 0.5rem;">üêõ Debug Chat-Sync:</h5>
                        <button class="btn btn-secondary btn-small" onclick="testChatSync()">üîÑ Chat neu laden</button>
                        <button class="btn btn-secondary btn-small" onclick="clearChatHistory()">üóëÔ∏è Chat leeren</button>
                        <button class="btn btn-secondary btn-small" onclick="showDebugInfo()">üìä Debug-Info anzeigen</button>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 style="margin-bottom: 1rem; color: #92400e;">üîê Admin-Zugang</h3>
                    <input type="password" class="admin-password-input" id="adminPassword" placeholder="Admin-Passwort eingeben">
                    <button class="btn btn-admin" onclick="loginAdmin()">Admin-Modus aktivieren</button>
                </div>

                <div class="score-display">
                    <div class="score-number" id="totalScore">0</div>
                    <div class="score-label">Foto-Punkte gesammelt</div>
                </div>

                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                    <h3 style="margin-bottom: 1rem; color: #374151;">üë§ Dein Name:</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" id="userNameInput" placeholder="Dein Name..." style="flex: 1; padding: 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" maxlength="20">
                        <button class="btn btn-secondary btn-small" onclick="changeUserName()">üíæ Speichern</button>
                    </div>
                    <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">Aktuell: <span id="currentUserName">Tourist_xyz</span></p>
                </div>

                <div class="team-selector" id="teamSelector">
                    <h3 style="margin-bottom: 1rem; color: #374151;">üì∏ W√§hle dein Team:</h3>
                    <div class="team-option" onclick="selectTeam('red', 'üî¥ Team R√∂mer', this)">
                        <div class="team-color" style="background: #dc2626;"></div>
                        <span>üî¥ Team R√∂mer</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('blue', 'üîµ Team Gaffeln', this)">
                        <div class="team-color" style="background: #2563eb;"></div>
                        <span>üîµ Team Gaffeln</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('green', 'üü¢ Team Hanseat', this)">
                        <div class="team-color" style="background: #059669;"></div>
                        <span>üü¢ Team Hanseat</span>
                    </div>
                    <div class="team-option" onclick="selectTeam('yellow', 'üü° Team Modern', this)">
                        <div class="team-color" style="background: #d97706;"></div>
                        <span>üü° Team Modern</span>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">üìã Tour-Informationen</h3>
                    <p><strong>‚è∞ Dauer:</strong> ca. 3,5 Stunden</p>
                    <p><strong>üìç Start:</strong> Heumarkt, 19:30 Uhr</p>
                    <p><strong>üéØ Ziel:</strong> Alte Bastion</p>
                    <p><strong>üë• Teilnehmer:</strong> 15-25 Personen</p>
                    <p><strong>üì∏ Ziel:</strong> Sammle die besten Foto-Punkte!</p>
                </div>

                <button class="btn" onclick="startTour()">üöÄ Tour starten</button>
            </div>

            <!-- Stations Tab -->
            <div id="stations" class="tab-content">
                <div id="stationsList">
                    <!-- Stations will be generated here -->
                </div>
            </div>

            <!-- Ranking Tab -->
            <div id="ranking" class="tab-content">
                <div class="team-ranking">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">üèÜ Live-Ranking</h3>
                    <div id="rankingList">
                        <!-- Ranking will be generated here -->
                    </div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1f2937; margin-bottom: 1rem;">üì∏ KI-Punktesystem</h3>
                    <ul style="margin-left: 1.5rem; color: #4b5563;">
                        <li><strong>Technische Qualit√§t:</strong> Sch√§rfe, Belichtung, Komposition (0-40 Punkte)</li>
                        <li><strong>Kreativit√§t:</strong> Perspective, Originalit√§t (0-30 Punkte)</li>
                        <li><strong>Stadtbezug:</strong> Erkannte Sehensw√ºrdigkeiten (0-20 Punkte)</li>
                        <li><strong>Personen/Gruppenfoto:</strong> Bonus f√ºr Teamarbeit (+10 Punkte)</li>
                    </ul>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chat" class="tab-content">
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message system">
                        <strong>System:</strong> Willkommen im Tour-Chat! üëã<br>
                        <small>Chat funktioniert zwischen allen Ger√§ten mit derselben Tour-URL.</small>
                        <span class="timestamp">jetzt</span>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht eingeben..." maxlength="200">
                    <button class="chat-send" onclick="sendMessage()">Senden</button>
                </div>
                <div style="margin-top: 1rem; text-align: center; color: #6b7280; font-size: 0.9rem;">
                    üí° Nachrichten werden live synchronisiert
                </div>
            </div>

            <!-- Map Tab -->
            <div id="map-tab" class="tab-content">
                <div class="location-info">
                    <div class="distance-info" id="distanceInfo">üìç Standort wird ermittelt...</div>
                    <p>üí° Tipp: Erlaube Standortzugriff f√ºr Navigation</p>
                </div>
                <div id="map"></div>
                <button class="btn" onclick="centerOnUser()">üìç Zu meinem Standort</button>
            </div>

            <!-- Admin Tab -->
            <div id="admin" class="tab-content">
                <div style="background: #fef3c7; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="color: #92400e; margin-bottom: 1rem;">‚öôÔ∏è Admin-Panel</h3>
                    <p>Vollst√§ndiges Content-Management. Alle √Ñnderungen werden sofort f√ºr alle Teilnehmer sichtbar.</p>
                </div>

                <!-- Content Management -->
                <div class="admin-content-editor">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">üìù Stationen-Content bearbeiten</h4>
                    <div id="adminContentEditor">
                        <!-- Content editor will be generated here -->
                    </div>
                </div>

                <!-- Chat Moderation -->
                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">üí¨ Chat-Moderation</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-admin btn-small" onclick="toggleChatModeration()">
                            <span id="chatModerationText">üõ°Ô∏è Moderations-Modus aktivieren</span>
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="clearAllChatMessages()">üóëÔ∏è Alle Nachrichten l√∂schen</button>
                        <button class="btn btn-secondary btn-small" onclick="sendAdminAnnouncement()">üì¢ Ank√ºndigung senden</button>
                    </div>
                </div>

                <!-- Live Statistics -->
                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">üìä Live-Statistiken</h4>
                    <div id="adminStats">
                        <p>Aktive Teilnehmer: <span id="activeUsers">-</span></p>
                        <p>Gesendete Nachrichten: <span id="totalMessages">-</span></p>
                        <p>Abgeschlossene Stationen: <span id="completedStations">-</span></p>
                        <p>Hochgeladene Fotos: <span id="uploadedPhotos">-</span></p>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="refreshAdminStats()">üîÑ Statistiken aktualisieren</button>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">üîÑ Tour zur√ºcksetzen</h4>
                    <button class="btn btn-secondary" onclick="resetTour()">Alle Daten zur√ºcksetzen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

    <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC1dTE4AiAKbInq-5f2dy92zWBIOmZ8o9Y",
        authDomain: "koeln-tour.firebaseapp.com",
        projectId: "koeln-tour",
        storageBucket: "koeln-tour.firebasestorage.app",
        messagingSenderId: "297105093618",
        appId: "1:297105093618:web:fa44f3fee94e79d304f16b",
        measurementId: "G-TZBGBEPCVW"
    };

    // Global variables
    let tourApp = {
        state: {
            currentStation: 0,
            completedStations: [],
            totalScore: 0,
            selectedTeam: null,
            teamName: '',
            userLocation: null,
            map: null,
            markers: [],
            uploadedPhotos: [],
            userName: 'Tourist_' + Math.random().toString(36).substr(2, 5),
            tourId: null,
            isAdmin: false,
            syncListeners: [],
            isFirebaseConnected: false,
            connectionRetries: 0,
            maxRetries: 3,
            chatModeration: false
        },
        
        stations: [
            {
                id: 1,
                title: "Heumarkt",
                subtitle: "Wo alles anfing: 2000 Jahre Migration und Handel",
                lat: 50.9356, lng: 6.9611,
                description: "Start der Tour am historischen Heumarkt, einem der geschichtstr√§chtigsten Orte K√∂lns.",
                photoChallenge: "Mache ein Foto von dir oder deinem Team vor dem Reiterstandbild - zeigt dabei mit Handbewegungen, wie H√§ndler fr√ºher ihre Waren angepriesen haben k√∂nnten!",
                mainText: `Die Stadt ist ca. 2.000 Jahre alt. CCAA - Colonia Claudia Ara Agrippinensium - wurde 50 n. Chr. von den R√∂mern gegr√ºndet, mithilfe der germanischen Ubier. Das war √ºbrigens eine der ersten erfolgreichen Integration zweier Kulturen in Europa. 

Hier auf dem Heumarkt stehen wir an einem der ehemaligen Einfallstore zur Stadt. Die Markmannsgasse runter, links von der heutigen Deutzer Br√ºcke, befand sich von 1822 bis 1915 die einzige Schiffsbr√ºcke √ºber den Rhein - 42 schwimmende Boote, die √ºber 30 Mal t√§glich f√ºr Schiffe ge√∂ffnet wurden.

Das "Stapelrecht" von 1259 bis 1804 war ein 545 Jahre g√ºltiges Handelsprivileg. Alle Waren auf Schiffen, die an K√∂ln vorbeifahren wollten, mussten drei Tage hier angeboten werden.`,
                images: [
                    { title: "Heumarkt heute", description: "Moderne Aufnahme des historischen Platzes", url: "" },
                    { title: "K√∂lner Architektur", description: "Typische Rheinische Bauweise", url: "" },
                    { title: "Rheinufer", description: "Blick auf den historischen Handelsweg", url: "" }
                ],
                audio: [
                    { title: "Heumarkt Atmosph√§re", description: "Originalaufnahme vom historischen Platz", url: "", type: "file" },
                    { title: "Geschichte Audio-Guide", description: "Gesprochene F√ºhrung zur Stadtgeschichte", url: "", type: "file" }
                ]
            },
            {
                id: 2,
                title: "K√∂lner Dom",
                subtitle: "Das ewige Bauprojekt und die Verkehrsrevolution",
                lat: 50.9413, lng: 6.9583,
                description: "K√∂lns Wahrzeichen und die l√§ngste Baustelle der Welt.",
                photoChallenge: "Bildet mit eurem Team eine 'menschliche Kathedrale' vor dem Dom - streckt die Arme hoch und formt gotische B√∂gen nach!",
                mainText: `Der Dom wird seit fast 800 Jahren gebaut - etwas l√§nger als der BER. Die Grundsteinlegung 1248 war K√∂lns Versuch, Paris und andere Gro√üst√§dte zu beeindrucken. K√∂ln war immer reich, aber auch provinziell.

1248-1330 wurden Grundmauern und der Chor fertiggestellt. Dann ging das Geld aus. Fast 300 Jahre stand nur ein riesiger Kran auf dem unvollendeten Turm - eines der ersten gro√üen "paused projects" der Geschichte.

Erst die Romantik des 19. Jahrhunderts und preu√üisches Geld vollendeten den Dom 1880. Der Hauptbahnhof entstand 1894 als einer der modernsten Europas.`,
                images: [
                    { title: "K√∂lner Dom", description: "Die ber√ºhmten Zwillingst√ºrme", url: "" },
                    { title: "Dom Innenraum", description: "Gotische Architektur", url: "" },
                    { title: "Dom bei Nacht", description: "Beleuchtetes Wahrzeichen", url: "" }
                ],
                audio: [
                    { title: "Domglocken", description: "Originalaufnahme der ber√ºhmten Domglocken", url: "", type: "file" },
                    { title: "Audio-Guide Dom", description: "Gesprochene F√ºhrung durch die Geschichte", url: "", type: "file" }
                ]
            },
            {
                id: 3,
                title: "Altstadt",
                subtitle: "Macht, Rebellion und eine gro√üe Liebesgeschichte",
                lat: 50.9369, lng: 6.9572,
                description: "Das historische Rathaus und die ber√ºhmte Jan-und-Griet-Geschichte.",
                photoChallenge: "Fotografiert euch am historischen Rathaus und stellt eine romantische Szene nach: Eine Person kniet, eine steht stolz daneben.",
                mainText: `Der Rathaus-Turm zeigt wichtige Pers√∂nlichkeiten der K√∂lner Geschichte. 1945 zerst√∂rt und wieder aufgebaut. Da auch die Figuren zerst√∂rt waren, w√§hlte eine Kommission neue aus - von √ºber 100 Kandidaten. Alle m√§nnlich.

Oben am Turm seht ihr den "Platz-Jabbeck" - er streckt Autorit√§ten die Zunge raus. So viel Respekt hatten die K√∂lner f√ºr die Obrigkeit.

Die Altstadt erz√§hlt eine der gr√∂√üten deutschen Liebesgeschichten: Jan ist ein armer Knecht, Griet arbeitet auch dort. Er mag sie, sie ihn nicht. Der Krieg beginnt, Jan zieht aus, kommt als ber√ºhmter General zur√ºck.`,
                images: [
                    { title: "K√∂lner Altstadt", description: "Historische Gassen", url: "" },
                    { title: "Rheinpromenade", description: "Spazierweg mit Domblick", url: "" },
                    { title: "Historisches Rathaus", description: "Gotisches Bauwerk", url: "" }
                ],
                audio: [
                    { title: "Altstadt Atmosph√§re", description: "Stra√üenger√§usche der historischen Altstadt", url: "", type: "file" },
                    { title: "Jan und Griet", description: "Die Liebesgeschichte als H√∂rspiel", url: "", type: "file" }
                ]
            },
            {
                id: 4,
                title: "Gro√ü St. Martin",
                subtitle: "Romanische Kirche und Klostergeschichte",
                lat: 50.9347, lng: 6.9597,
                description: "Eine der zw√∂lf gro√üen romanischen Kirchen K√∂lns.",
                photoChallenge: "Macht ein Foto der imposanten Kircht√ºrme und zeigt dabei mittelalterliche Gebetshaltungen!",
                mainText: `Gro√ü St. Martin ist eine der beeindruckendsten romanischen Kirchen K√∂lns. Der markante Vierungsturm pr√§gt seit dem 12. Jahrhundert die Silhouette der Altstadt.

Die Kirche wurde auf r√∂mischen Fundamenten errichtet - arch√§ologische Ausgrabungen zeigen die Kontinuit√§t der Besiedlung √ºber 2000 Jahre. Im Mittelalter war hier eines der m√§chtigsten Benediktinerkl√∂ster der Region.

Der Turm diente auch als Orientierungspunkt f√ºr Rheinschiffe und H√§ndler - ein fr√ºher "Leuchtturm" des Handels.`,
                images: [
                    { title: "Gro√ü St. Martin", description: "Romanischer Kirchenbau", url: "" },
                    { title: "Altstadt Panorama", description: "Kircht√ºrme der Altstadt", url: "" },
                    { title: "Rheinufer", description: "Blick auf die Kirchen", url: "" }
                ],
                audio: [
                    { title: "Kirchenglocken", description: "Glockengel√§ut von Gro√ü St. Martin", url: "", type: "file" },
                    { title: "Gregorianischer Gesang", description: "Historische Klostermusik", url: "", type: "file" }
                ]
            },
            {
                id: 5,
                title: "Fischmarkt",
                subtitle: "Handel, Handwerk und B√ºrgerstolz",
                lat: 50.9378, lng: 6.9589,
                description: "Mittelpunkt des mittelalterlichen Handels.",
                photoChallenge: "Zeigt mit euren H√§nden, wie mittelalterliche H√§ndler ihre Waren pr√§sentiert haben - seid kreativ mit Gesten!",
                mainText: `Der Fischmarkt war im Mittelalter das kommerzielle Herz K√∂lns. Hier wurde nicht nur Fisch verkauft, sondern alle wichtigen Handelsg√ºter der Region.

Die K√∂lner B√ºrger entwickelten hier ihre ber√ºhmte Unabh√§ngigkeit. 1074 erhielt K√∂ln bereits wichtige Stadtrechte - 500 Jahre bevor andere deutsche St√§dte folgten.

Die Zunftordnungen vom Fischmarkt dienten als Vorbild f√ºr ganz Europa. Handwerksmeister aus K√∂ln gr√ºndeten in vielen anderen St√§dten √§hnliche Organisationen.`,
                images: [
                    { title: "Alter Markt K√∂ln", description: "Historischer Marktplatz", url: "" },
                    { title: "K√∂lner H√§user", description: "Typische Architektur", url: "" },
                    { title: "Rheinischer Markt", description: "Handelstradition", url: "" }
                ],
                audio: [
                    { title: "Marktger√§usche", description: "Atmosph√§re des historischen Marktes", url: "", type: "file" },
                    { title: "H√§ndlerrufe", description: "Nachstellung mittelalterlicher Marktrufe", url: "", type: "file" }
                ]
            }
        ]
    };

    // Firebase Initialization
    let db = null;

    async function initFirebase() {
        try {
            updateConnectionStatus('connecting');
            
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            await db.enableNetwork();
            
            const testDoc = db.collection('tours').doc('test');
            await testDoc.set({ test: Date.now() }, { merge: true });
            
            tourApp.state.isFirebaseConnected = true;
            updateConnectionStatus('online');
            hideErrorPanel();
            
            console.log('‚úÖ Firebase connected successfully');
            
            enableRealtimeSync();
            
        } catch (error) {
            console.error('‚ùå Firebase connection failed:', error);
            tourApp.state.isFirebaseConnected = false;
            updateConnectionStatus('offline');
            showErrorPanel('Firebase-Verbindung fehlgeschlagen. App funktioniert nur lokal.', error.message);
            
            if (tourApp.state.connectionRetries < tourApp.state.maxRetries) {
                tourApp.state.connectionRetries++;
                setTimeout(() => {
                    console.log(`üîÑ Retrying Firebase connection (${tourApp.state.connectionRetries}/${tourApp.state.maxRetries})`);
                    initFirebase();
                }, 3000);
            }
        }
    }

    function updateConnectionStatus(status) {
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) {
            statusEl.className = `connection-status ${status}`;
            
            const titles = {
                'connecting': 'Verbindung wird aufgebaut...',
                'online': 'Online - Daten werden synchronisiert', 
                'offline': 'Offline - Nur lokale Daten'
            };
            statusEl.title = titles[status] || status;
        }
    }

    function showErrorPanel(message, details = '') {
        const panel = document.getElementById('errorPanel');
        const messageEl = document.getElementById('errorMessage');
        
        if (panel && messageEl) {
            messageEl.innerHTML = `${message}${details ? `<br><small>Details: ${details}</small>` : ''}`;
            panel.classList.remove('hidden');
        }
    }

    function hideErrorPanel() {
        const panel = document.getElementById('errorPanel');
        if (panel) {
            panel.classList.add('hidden');
        }
    }

    function retryConnection() {
        tourApp.state.connectionRetries = 0;
        initFirebase();
    }

    // Firebase Real-time Functions - FIXED with Station Sync
    function enableRealtimeSync() {
        if (!tourApp.state.isFirebaseConnected || !tourApp.state.tourId) return;

        try {
            // Listen to chat messages for current tour ID
            const chatRef = db.collection('tours').doc(tourApp.state.tourId).collection('chat');
            const chatUnsubscribe = chatRef.orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const messageData = change.doc.data();
                        // Only add messages from other users to avoid duplicates
                        if (messageData.userName !== tourApp.state.userName) {
                            addChatMessage(messageData.userName, messageData.message, false);
                        }
                    }
                });
            }, (error) => {
                console.error('Chat sync error:', error);
            });

            // Listen to scores for current tour ID
            const scoresRef = db.collection('tours').doc(tourApp.state.tourId).collection('scores');
            const scoresUnsubscribe = scoresRef.onSnapshot(() => {
                updateRanking();
            }, (error) => {
                console.error('Scores sync error:', error);
            });

            // Listen to station updates for current tour ID - NEW!
            const stationsRef = db.collection('tours').doc(tourApp.state.tourId).collection('stations');
            const stationsUnsubscribe = stationsRef.onSnapshot((snapshot) => {
                let hasChanges = false;
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const stationData = change.doc.data();
                        const stationIndex = tourApp.stations.findIndex(s => s.id === stationData.id);
                        
                        if (stationIndex >= 0) {
                            // Update existing station
                            tourApp.stations[stationIndex] = stationData;
                            hasChanges = true;
                        } else {
                            // Add new station
                            tourApp.stations.push(stationData);
                            tourApp.stations.sort((a, b) => a.id - b.id);
                            hasChanges = true;
                        }
                    } else if (change.type === 'removed') {
                        const stationData = change.doc.data();
                        const stationIndex = tourApp.stations.findIndex(s => s.id === stationData.id);
                        if (stationIndex >= 0) {
                            tourApp.stations.splice(stationIndex, 1);
                            hasChanges = true;
                        }
                    }
                });
                
                if (hasChanges && !tourApp.state.isAdmin) {
                    // Only non-admin users should auto-update from Firebase changes
                    generateStationsList();
                    updateProgress();
                    if (tourApp.state.map) {
                        updateMapMarkers();
                    }
                    showNotification('üîÑ Stationen wurden aktualisiert!');
                }
            }, (error) => {
                console.error('Stations sync error:', error);
            });

            tourApp.state.syncListeners.push(chatUnsubscribe, scoresUnsubscribe, stationsUnsubscribe);
        } catch (error) {
            console.error('Error setting up real-time sync:', error);
        }
    }

    // Firebase Data Functions - FIXED
    async function saveToFirebase(collection, docId, data) {
        if (!tourApp.state.isFirebaseConnected || !tourApp.state.tourId) return false;

        try {
            await db.collection('tours').doc(tourApp.state.tourId)
                .collection(collection).doc(docId).set(data, { merge: true });
            return true;
        } catch (error) {
            console.error('Firebase save error:', error);
            showNotification('Speichern fehlgeschlagen - nur lokal gespeichert', 'warning');
            return false;
        }
    }

    async function getFromFirebase(collection) {
        if (!tourApp.state.isFirebaseConnected || !tourApp.state.tourId) return [];

        try {
            const snapshot = await db.collection('tours').doc(tourApp.state.tourId)
                .collection(collection).get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error('Firebase get error:', error);
            return [];
        }
    }

    // App Initialization - Enhanced with Station Loading
    function initApp() {
        console.log('üöÄ Starting Tour App...');
        
        try {
            loadTourId();
            initFirebase();
            loadState();
            
            // Load stations from Firebase first, then generate UI
            setTimeout(async () => {
                await loadStationsFromFirebase();
                generateStationsList();
                updateUI();
            }, 1500);
            
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // Initialize username display
            const userNameDisplay = document.getElementById('currentUserName');
            if (userNameDisplay) {
                userNameDisplay.textContent = tourApp.state.userName;
            }
            
            console.log('‚úÖ Tour App initialized successfully');
            
            setTimeout(() => {
                initGeolocation();
                loadChatHistory();
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå Error initializing app:', error);
            showNotification('App-Start mit Fehlern. Basis-Funktionen verf√ºgbar.', 'error');
            
            if (!tourApp.state.tourId) {
                tourApp.state.tourId = 'koeln-emergency-' + Date.now();
                updateTourDisplay();
                generateShareUrl();
            }
        }
    }

    // Load Stations from Firebase - NEW!
    async function loadStationsFromFirebase() {
        if (!tourApp.state.isFirebaseConnected || !tourApp.state.tourId) return;
        
        try {
            const firebaseStations = await getFromFirebase('stations');
            if (firebaseStations && firebaseStations.length > 0) {
                // Update stations with Firebase data
                tourApp.stations = firebaseStations.sort((a, b) => a.id - b.id);
                console.log('‚úÖ Loaded stations from Firebase:', firebaseStations.length);
                showNotification('üîÑ Stationen von Server geladen!');
            } else {
                // Initialize Firebase with default stations if empty
                for (const station of tourApp.stations) {
                    await saveToFirebase('stations', station.id.toString(), station);
                }
                console.log('üì§ Initialized Firebase with default stations');
            }
        } catch (error) {
            console.error('Error loading stations from Firebase:', error);
        }
    }

    function loadTourId() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const urlTourId = urlParams.get('tour');
            
            console.log('üîç URL Tour ID from parameter:', urlTourId);
            console.log('üîç Full URL:', window.location.href);
            console.log('üîç Search params:', window.location.search);
            
            // URL-Parameter haben IMMER Vorrang √ºber Cache!
            if (urlTourId && urlTourId.trim().length > 0) {
                const cleanTourId = urlTourId.trim();
                const savedTourId = localStorage.getItem('tourId');
                
                // Nur aktualisieren wenn sich Tour-ID ge√§ndert hat
                if (savedTourId !== cleanTourId) {
                    console.log('üîÑ Tour-ID changed from', savedTourId, 'to', cleanTourId);
                    
                    // Clear old tour data to prevent cache conflicts
                    if (savedTourId) {
                        localStorage.removeItem(`chat_${savedTourId}`);
                        localStorage.removeItem(`tourState`);
                    }
                    
                    tourApp.state.tourId = cleanTourId;
                    localStorage.setItem('tourId', cleanTourId);
                    
                    // Reset app state for new tour
                    tourApp.state.completedStations = [];
                    tourApp.state.totalScore = 0;
                    tourApp.state.uploadedPhotos = [];
                    tourApp.state.selectedTeam = null;
                    tourApp.state.teamName = '';
                    
                    console.log('‚úÖ Switched to URL Tour ID:', cleanTourId);
                    setTimeout(() => addSystemMessage(`Der Tour "${cleanTourId}" beigetreten! üéâ`), 2000);
                } else {
                    tourApp.state.tourId = cleanTourId;
                    console.log('‚úÖ Using same URL Tour ID:', cleanTourId);
                }
            } else {
                // Kein URL-Parameter: verwende gespeicherte Tour-ID oder erstelle neue
                const savedTourId = localStorage.getItem('tourId');
                if (savedTourId) {
                    tourApp.state.tourId = savedTourId;
                    console.log('‚úÖ Using saved Tour ID:', tourApp.state.tourId);
                } else {
                    tourApp.state.tourId = generateTourId();
                    localStorage.setItem('tourId', tourApp.state.tourId);
                    console.log('‚úÖ Generated new Tour ID:', tourApp.state.tourId);
                }
            }
            
            updateTourDisplay();
            generateShareUrl();
            
            console.log('üéØ Final Tour ID set to:', tourApp.state.tourId);
        } catch (error) {
            console.error('‚ùå Error loading tour ID:', error);
            tourApp.state.tourId = 'koeln-tour-fallback';
            updateTourDisplay();
            generateShareUrl();
        }
    }

    function generateTourId() {
        try {
            const today = new Date().toISOString().split('T')[0];
            const random = Math.random().toString(36).substr(2, 5);
            return `koeln-${today}-${random}`;
        } catch (error) {
            return 'koeln-tour-' + Math.random().toString(36).substr(2, 8);
        }
    }

    function updateTourDisplay() {
        try {
            const el = document.getElementById('currentTourId');
            if (el && tourApp.state.tourId) {
                el.textContent = tourApp.state.tourId;
            }
        } catch (error) {
            console.error('Error updating tour display:', error);
        }
    }

    function generateShareUrl() {
        try {
            if (!tourApp.state.tourId) return;
            
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?tour=${tourApp.state.tourId}`;
            const el = document.getElementById('shareUrl');
            if (el) {
                el.textContent = shareUrl;
            }
        } catch (error) {
            console.error('Error generating share URL:', error);
            const el = document.getElementById('shareUrl');
            if (el) {
                el.textContent = 'Fehler beim Generieren der URL';
            }
        }
    }

    // Chat Functions - FIXED
    async function sendMessage() {
        try {
            const input = document.getElementById('chatInput');
            if (!input) return;
            
            const message = input.value.trim();
            if (message) {
                // Add to local chat immediately
                addChatMessage(tourApp.state.userName, message, true);
                
                if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                    // Save to Firebase with current tour ID
                    await saveToFirebase('chat', Date.now().toString(), {
                        userName: tourApp.state.userName,
                        message: message,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        tourId: tourApp.state.tourId // Add tour ID for verification
                    });
                } else {
                    // Fallback to localStorage with tour-specific key
                    const chatKey = `chat_${tourApp.state.tourId}`;
                    const chatMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
                    chatMessages.push({
                        userName: tourApp.state.userName,
                        message: message,
                        timestamp: Date.now(),
                        tourId: tourApp.state.tourId
                    });
                    if (chatMessages.length > 50) {
                        chatMessages.splice(0, chatMessages.length - 50);
                    }
                    localStorage.setItem(chatKey, JSON.stringify(chatMessages));
                }
                
                input.value = '';
            }
        } catch (error) {
            console.error('Error sending message:', error);
            showNotification('Fehler beim Senden der Nachricht', 'error');
        }
    }

    function addChatMessage(userName, message, isOwn = false) {
        try {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;
            
            const timeStr = new Date().toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <strong>${userName}:</strong> ${message}
                <span class="timestamp">${timeStr}</span>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            if (!isOwn && !document.getElementById('chat').classList.contains('active')) {
                showNotification(`üí¨ ${userName}: ${message.substring(0, 30)}${message.length > 30 ? '...' : ''}`);
            }
        } catch (error) {
            console.error('Error adding chat message:', error);
        }
    }

    function addSystemMessage(message) {
        try {
            setTimeout(() => {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message system';
                
                const timeStr = new Date().toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageDiv.innerHTML = `
                    <strong>System:</strong> ${message}
                    <span class="timestamp">${timeStr}</span>
                `;
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        } catch (error) {
            console.error('Error adding system message:', error);
        }
    }

    async function loadChatHistory() {
        try {
            if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                const messages = await getFromFirebase('chat');
                messages.forEach(msg => {
                    // Only load messages that don't match current user to avoid duplicates
                    if (msg.userName !== tourApp.state.userName) {
                        addChatMessage(msg.userName, msg.message, false);
                    }
                });
            } else {
                // Load from localStorage with tour-specific key
                const chatKey = `chat_${tourApp.state.tourId}`;
                const chatMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
                chatMessages.forEach(msg => {
                    addChatMessage(msg.userName, msg.message, msg.userName === tourApp.state.userName);
                });
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
    }

    // Ranking Functions - FIXED
    async function updateRanking() {
        try {
            const rankingList = document.getElementById('rankingList');
            if (!rankingList) return;
            
            let teams = [];
            
            if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                // Get real teams from Firebase
                teams = await getFromFirebase('scores');
                
                // Only add current user's team if it exists and isn't already in the list
                if (tourApp.state.selectedTeam && tourApp.state.teamName && 
                    !teams.find(t => t.teamId === tourApp.state.selectedTeam)) {
                    teams.push({
                        teamId: tourApp.state.selectedTeam,
                        teamName: tourApp.state.teamName,
                        score: tourApp.state.totalScore,
                        isUser: true
                    });
                }
            } else {
                // Offline mode - create mock teams with current user's real score
                const teamNames = {
                    'red': 'üî¥ Team R√∂mer',
                    'blue': 'üîµ Team Gaffeln', 
                    'green': 'üü¢ Team Hanseat',
                    'yellow': 'üü° Team Modern'
                };
                
                Object.keys(teamNames).forEach(teamId => {
                    teams.push({
                        teamId: teamId,
                        teamName: teamNames[teamId],
                        score: tourApp.state.selectedTeam === teamId ? 
                               tourApp.state.totalScore : 
                               Math.floor(Math.random() * 200) + 50,
                        isUser: tourApp.state.selectedTeam === teamId
                    });
                });
            }
            
            // Sort teams by score
            teams.sort((a, b) => b.score - a.score);
            
            rankingList.innerHTML = '';
            
            teams.forEach((team, index) => {
                const rankItem = document.createElement('div');
                const isUserTeam = team.isUser || (team.teamId === tourApp.state.selectedTeam);
                rankItem.className = `team-rank-item ${isUserTeam ? 'highlight' : ''}`;
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                rankItem.innerHTML = `
                    <div class="rank-position ${rankClass}">${index + 1}</div>
                    <div style="flex: 1;">
                        <strong>${team.teamName}</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">
                            ${team.score} Punkte
                        </div>
                    </div>
                    ${isUserTeam ? '<div style="color: #f59e0b;">üë§</div>' : ''}
                `;
                
                rankingList.appendChild(rankItem);
            });
        } catch (error) {
            console.error('Error updating ranking:', error);
        }
    }

    // Admin Functions - NEW
    function generateContentEditor() {
        try {
            const container = document.getElementById('adminContentEditor');
            if (!container) return;
            
            container.innerHTML = '';
            
            tourApp.stations.forEach(station => {
                const stationEditor = document.createElement('div');
                stationEditor.className = 'admin-station-editor';
                stationEditor.id = `admin-station-${station.id}`;
                
                stationEditor.innerHTML = `
                    <h5 style="color: #1f2937; margin-bottom: 1rem;">Station ${station.id}: ${station.title}</h5>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Titel:</label>
                        <input type="text" class="admin-input" id="edit-title-${station.id}" value="${station.title}">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Untertitel:</label>
                        <input type="text" class="admin-input" id="edit-subtitle-${station.id}" value="${station.subtitle}">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Haupttext:</label>
                        <textarea class="admin-textarea" id="edit-maintext-${station.id}">${station.mainText}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Foto-Challenge:</label>
                        <textarea class="admin-textarea" id="edit-challenge-${station.id}" style="min-height: 80px;">${station.photoChallenge}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Koordinaten:</label>
                        <div class="admin-lat-lng">
                            <input type="number" class="admin-input" id="edit-lat-${station.id}" value="${station.lat}" step="0.000001" placeholder="Breitengrad">
                            <input type="number" class="admin-input" id="edit-lng-${station.id}" value="${station.lng}" step="0.000001" placeholder="L√§ngengrad">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Bildergalerie bearbeiten:</label>
                        <div id="image-editor-${station.id}" style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: #f9fafb;">
                            ${generateImageEditor(station)}
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="addNewImage(${station.id})" style="margin-top: 0.5rem;">‚ûï Neues Bild hinzuf√ºgen</button>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Audio-Dateien bearbeiten:</label>
                        <div id="audio-editor-${station.id}" style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: #f0f9ff;">
                            ${generateAudioEditor(station)}
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="addNewAudio(${station.id})" style="margin-top: 0.5rem;">üéµ Neue Audio-Datei hinzuf√ºgen</button>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-admin btn-small" onclick="saveStationChanges(${station.id})">üíæ √Ñnderungen speichern</button>
                        <button class="btn btn-secondary btn-small" onclick="resetStationEditor(${station.id})">üîÑ Zur√ºcksetzen</button>
                        <button class="btn btn-secondary btn-small" onclick="deleteStation(${station.id})">üóëÔ∏è Station l√∂schen</button>
                    </div>
                `;
                
                container.appendChild(stationEditor);
            });
            
            // Add new station button
            const addButton = document.createElement('div');
            addButton.style.textAlign = 'center';
            addButton.style.marginTop = '2rem';
            addButton.innerHTML = `
                <button class="btn btn-admin" onclick="addNewStation()">‚ûï Neue Station hinzuf√ºgen</button>
            `;
            container.appendChild(addButton);
            
        } catch (error) {
            console.error('Error generating content editor:', error);
        }
    }

    function saveStationChanges(stationId) {
        try {
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station) return;
            
            station.title = document.getElementById(`edit-title-${stationId}`).value;
            station.subtitle = document.getElementById(`edit-subtitle-${stationId}`).value;
            station.mainText = document.getElementById(`edit-maintext-${stationId}`).value;
            station.photoChallenge = document.getElementById(`edit-challenge-${stationId}`).value;
            station.lat = parseFloat(document.getElementById(`edit-lat-${stationId}`).value);
            station.lng = parseFloat(document.getElementById(`edit-lng-${stationId}`).value);
            
            // Images and audio are already updated in station.images/audio through update functions
            
            // Save to Firebase if connected - THIS WILL SYNC TO ALL USERS!
            if (tourApp.state.isFirebaseConnected) {
                saveToFirebase('stations', stationId.toString(), station);
            }
            
            // Regenerate stations list to reflect changes locally
            generateStationsList();
            
            // Update map if it exists
            if (tourApp.state.map) {
                updateMapMarkers();
            }
            
            showNotification(`Station ${stationId} mit Bildern & Audio gespeichert! ‚úÖ`);
            addSystemMessage(`Admin hat Station "${station.title}" mit Medien aktualisiert! üìùüì∑üéµ`);
            
            saveState();
        } catch (error) {
            console.error('Error saving station changes:', error);
            showNotification('Fehler beim Speichern der √Ñnderungen', 'error');
        }
    }

    function resetStationEditor(stationId) {
        try {
            // Reload the original values
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station) return;
            
            document.getElementById(`edit-title-${stationId}`).value = station.title;
            document.getElementById(`edit-subtitle-${stationId}`).value = station.subtitle;
            document.getElementById(`edit-maintext-${stationId}`).value = station.mainText;
            document.getElementById(`edit-challenge-${stationId}`).value = station.photoChallenge;
            document.getElementById(`edit-lat-${stationId}`).value = station.lat;
            document.getElementById(`edit-lng-${stationId}`).value = station.lng;
            
            showNotification('Editor zur√ºckgesetzt! üîÑ');
        } catch (error) {
            console.error('Error resetting station editor:', error);
        }
    }

    // Audio Management Functions - NEW!
    function generateAudioEditor(station) {
        try {
            if (!station.audio || station.audio.length === 0) {
                return `
                    <p style="color: #6b7280; text-align: center; padding: 2rem;">
                        üéµ Noch keine Audio-Dateien vorhanden<br>
                        <small>Klicke auf "Neue Audio-Datei hinzuf√ºgen" um Audio zur Station hinzuzuf√ºgen</small>
                    </p>
                `;
            }
            
            return station.audio.map((audio, index) => `
                <div style="border: 1px solid #d1d5db; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: white;" id="audio-item-${station.id}-${index}">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: #374151;">üéµ Audio ${index + 1}</strong>
                        <button onclick="removeAudio(${station.id}, ${index})" style="background: #dc2626; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è L√∂schen</button>
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Titel:</label>
                        <input type="text" value="${audio.title || ''}" onchange="updateAudioData(${station.id}, ${index}, 'title', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Beschreibung:</label>
                        <input type="text" value="${audio.description || ''}" onchange="updateAudioData(${station.id}, ${index}, 'description', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Audio-Typ:</label>
                        <select onchange="updateAudioData(${station.id}, ${index}, 'type', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                            <option value="file" ${audio.type === 'file' ? 'selected' : ''}>üìÅ Audio-Datei (Upload)</option>
                            <option value="youtube" ${audio.type === 'youtube' ? 'selected' : ''}>üì∫ YouTube</option>
                            <option value="soundcloud" ${audio.type === 'soundcloud' ? 'selected' : ''}>‚òÅÔ∏è SoundCloud</option>
                            <option value="spotify" ${audio.type === 'spotify' ? 'selected' : ''}>üü¢ Spotify</option>
                            <option value="external" ${audio.type === 'external' ? 'selected' : ''}>üîó Externe URL</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">
                            ${audio.type === 'file' ? 'Audio-Datei hochladen:' : 
                              audio.type === 'youtube' ? 'YouTube-URL:' :
                              audio.type === 'soundcloud' ? 'SoundCloud-URL:' :
                              audio.type === 'spotify' ? 'Spotify-URL:' : 'Audio-URL:'}
                        </label>
                        ${audio.type === 'file' ? `
                            <input type="file" accept="audio/*" onchange="uploadAudioFile(${station.id}, ${index}, this)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        ` : `
                            <input type="url" value="${audio.url || ''}" onchange="updateAudioData(${station.id}, ${index}, 'url', this.value)" 
                                   placeholder="${audio.type === 'youtube' ? 'https://www.youtube.com/watch?v=...' :
                                                audio.type === 'soundcloud' ? 'https://soundcloud.com/...' :
                                                audio.type === 'spotify' ? 'https://open.spotify.com/...' : 'https://example.com/audio.mp3'}" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                        `}
                    </div>
                    
                    ${audio.url && audio.type === 'file' ? `
                        <div style="margin-top: 0.5rem;">
                            <audio controls style="width: 100%;">
                                <source src="${audio.url}" type="audio/mpeg">
                                Ihr Browser unterst√ºtzt das Audio-Element nicht.
                            </audio>
                        </div>
                    ` : audio.url && audio.type !== 'file' ? `
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #059669;">
                            ‚úÖ ${audio.type.charAt(0).toUpperCase() + audio.type.slice(1)}-Link gesetzt
                        </div>
                    ` : ''}
                </div>
            `).join('');
        } catch (error) {
            console.error('Error generating audio editor:', error);
            return '<p style="color: #dc2626;">Fehler beim Laden des Audio-Editors</p>';
        }
    }

    function addNewAudio(stationId) {
        try {
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station) return;
            
            if (!station.audio) {
                station.audio = [];
            }
            
            station.audio.push({
                title: `Neue Audio-Datei ${station.audio.length + 1}`,
                description: "Beschreibung der Audio-Datei",
                url: "",
                type: "file"
            });
            
            // Regenerate audio editor
            const editorContainer = document.getElementById(`audio-editor-${stationId}`);
            if (editorContainer) {
                editorContainer.innerHTML = generateAudioEditor(station);
            }
            
            showNotification('Neue Audio-Datei hinzugef√ºgt! üéµ');
        } catch (error) {
            console.error('Error adding new audio:', error);
        }
    }

    function removeAudio(stationId, audioIndex) {
        try {
            if (!confirm('Diese Audio-Datei wirklich l√∂schen?')) return;
            
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station || !station.audio) return;
            
            station.audio.splice(audioIndex, 1);
            
            // Regenerate audio editor
            const editorContainer = document.getElementById(`audio-editor-${stationId}`);
            if (editorContainer) {
                editorContainer.innerHTML = generateAudioEditor(station);
            }
            
            showNotification('Audio-Datei gel√∂scht! üóëÔ∏è');
        } catch (error) {
            console.error('Error removing audio:', error);
        }
    }

    function updateAudioData(stationId, audioIndex, field, value) {
        try {
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station || !station.audio || !station.audio[audioIndex]) return;
            
            station.audio[audioIndex][field] = value;
            
            // If type was updated, refresh the editor to show different input fields
            if (field === 'type' || field === 'url') {
                setTimeout(() => {
                    const editorContainer = document.getElementById(`audio-editor-${stationId}`);
                    if (editorContainer) {
                        editorContainer.innerHTML = generateAudioEditor(station);
                    }
                }, 100);
            }
        } catch (error) {
            console.error('Error updating audio data:', error);
        }
    }

    function uploadAudioFile(stationId, audioIndex, fileInput) {
        try {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                updateAudioData(stationId, audioIndex, 'url', dataUrl);
                showNotification('Audio-Datei hochgeladen! üéµ');
            };
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('Error uploading audio file:', error);
            showNotification('Fehler beim Hochladen der Audio-Datei', 'error');
        }
    }

    // Image Management Functions - NEW!
    function generateImageEditor(station) {
        try {
            if (!station.images || station.images.length === 0) {
                return `
                    <p style="color: #6b7280; text-align: center; padding: 2rem;">
                        üì∑ Noch keine Bilder vorhanden<br>
                        <small>Klicke auf "Neues Bild hinzuf√ºgen" um Bilder zur Galerie hinzuzuf√ºgen</small>
                    </p>
                `;
            }
            
            return station.images.map((image, index) => `
                <div style="border: 1px solid #d1d5db; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: white;" id="image-item-${station.id}-${index}">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: #374151;">Bild ${index + 1}</strong>
                        <button onclick="removeImage(${station.id}, ${index})" style="background: #dc2626; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è L√∂schen</button>
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Titel:</label>
                        <input type="text" value="${image.title || ''}" onchange="updateImageData(${station.id}, ${index}, 'title', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Beschreibung:</label>
                        <input type="text" value="${image.description || ''}" onchange="updateImageData(${station.id}, ${index}, 'description', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Bild-URL (optional):</label>
                        <input type="url" value="${image.url || ''}" onchange="updateImageData(${station.id}, ${index}, 'url', this.value)" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem;">Oder Bild hochladen:</label>
                        <input type="file" accept="image/*" onchange="uploadImageFile(${station.id}, ${index}, this)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                    
                    ${image.url ? `
                        <div style="margin-top: 0.5rem;">
                            <img src="${image.url}" alt="${image.title}" style="max-width: 150px; max-height: 100px; border-radius: 4px; object-fit: cover;">
                        </div>
                    ` : ''}
                </div>
            `).join('');
        } catch (error) {
            console.error('Error generating image editor:', error);
            return '<p style="color: #dc2626;">Fehler beim Laden des Bild-Editors</p>';
        }
    }

    function addNewImage(stationId) {
        try {
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station) return;
            
            if (!station.images) {
                station.images = [];
            }
            
            station.images.push({
                title: `Neues Bild ${station.images.length + 1}`,
                description: "Beschreibung des Bildes",
                url: ""
            });
            
            // Regenerate image editor
            const editorContainer = document.getElementById(`image-editor-${stationId}`);
            if (editorContainer) {
                editorContainer.innerHTML = generateImageEditor(station);
            }
            
            showNotification('Neues Bild hinzugef√ºgt! üì∑');
        } catch (error) {
            console.error('Error adding new image:', error);
        }
    }

    function removeImage(stationId, imageIndex) {
        try {
            if (!confirm('Dieses Bild wirklich l√∂schen?')) return;
            
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station || !station.images) return;
            
            station.images.splice(imageIndex, 1);
            
            // Regenerate image editor
            const editorContainer = document.getElementById(`image-editor-${stationId}`);
            if (editorContainer) {
                editorContainer.innerHTML = generateImageEditor(station);
            }
            
            showNotification('Bild gel√∂scht! üóëÔ∏è');
        } catch (error) {
            console.error('Error removing image:', error);
        }
    }

    function updateImageData(stationId, imageIndex, field, value) {
        try {
            const station = tourApp.stations.find(s => s.id === stationId);
            if (!station || !station.images || !station.images[imageIndex]) return;
            
            station.images[imageIndex][field] = value;
            
            // If URL was updated, refresh the preview
            if (field === 'url') {
                setTimeout(() => {
                    const editorContainer = document.getElementById(`image-editor-${stationId}`);
                    if (editorContainer) {
                        editorContainer.innerHTML = generateImageEditor(station);
                    }
                }, 100);
            }
        } catch (error) {
            console.error('Error updating image data:', error);
        }
    }

    function uploadImageFile(stationId, imageIndex, fileInput) {
        try {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                updateImageData(stationId, imageIndex, 'url', dataUrl);
                showNotification('Bild hochgeladen! üì∑');
            };
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('Error uploading image file:', error);
            showNotification('Fehler beim Hochladen des Bildes', 'error');
        }
    }

    function deleteStation(stationId) {
        try {
            if (confirm(`Station ${stationId} wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                const stationIndex = tourApp.stations.findIndex(s => s.id === stationId);
                if (stationIndex > -1) {
                    const station = tourApp.stations[stationIndex];
                    tourApp.stations.splice(stationIndex, 1);
                    
                    // Remove from completed stations
                    tourApp.state.completedStations = tourApp.state.completedStations.filter(id => id !== stationId);
                    
                    // Delete from Firebase to sync with all users
                    if (tourApp.state.isFirebaseConnected) {
                        db.collection('tours').doc(tourApp.state.tourId)
                            .collection('stations').doc(stationId.toString()).delete();
                    }
                    
                    // Regenerate content
                    generateContentEditor();
                    generateStationsList();
                    updateProgress();
                    
                    if (tourApp.state.map) {
                        updateMapMarkers();
                    }
                    
                    showNotification(`Station "${station.title}" gel√∂scht und synchronisiert! üóëÔ∏è`);
                    addSystemMessage(`Admin hat Station "${station.title}" entfernt! üóëÔ∏è`);
                    saveState();
                }
            }
        } catch (error) {
            console.error('Error deleting station:', error);
        }
    }

    function addNewStation() {
        try {
            const newId = Math.max(...tourApp.stations.map(s => s.id)) + 1;
            const newStation = {
                id: newId,
                title: `Neue Station ${newId}`,
                subtitle: "Beschreibung der neuen Station",
                lat: 50.9375, lng: 6.9597, // Default to Cologne center
                description: `Station ${newId} der Tour`,
                photoChallenge: "Macht ein kreatives Foto an dieser Station!",
                mainText: "Hier kommt der Haupttext der neuen Station. Erz√§hle die Geschichte dieses Ortes...",
                images: [
                    { title: "Bild 1", description: "Beschreibung des ersten Bildes", url: "" },
                    { title: "Bild 2", description: "Beschreibung des zweiten Bildes", url: "" }
                ],
                audio: [
                    { title: "Audio 1", description: "Beschreibung der ersten Audio-Datei", url: "", type: "file" }
                ]
            };
            
            tourApp.stations.push(newStation);
            tourApp.stations.sort((a, b) => a.id - b.id);
            
            // Save to Firebase to sync with all users
            if (tourApp.state.isFirebaseConnected) {
                saveToFirebase('stations', newId.toString(), newStation);
            }
            
            // Regenerate everything
            generateContentEditor();
            generateStationsList();
            
            if (tourApp.state.map) {
                updateMapMarkers();
            }
            
            showNotification(`Neue Station ${newId} hinzugef√ºgt und synchronisiert! ‚ûï`);
            addSystemMessage(`Admin hat neue Station "${newStation.title}" hinzugef√ºgt! ‚ûï`);
            saveState();
        } catch (error) {
            console.error('Error adding new station:', error);
        }
    }

    function updateMapMarkers() {
        try {
            if (!tourApp.state.map) return;
            
            // Clear existing markers
            tourApp.state.markers.forEach(marker => {
                tourApp.state.map.removeLayer(marker);
            });
            tourApp.state.markers = [];
            
            // Add updated markers
            tourApp.stations.forEach(station => {
                const isCompleted = tourApp.state.completedStations.includes(station.id);
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center; max-width: 200px;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}/${tourApp.stations.length}</strong></p>
                            ${isCompleted ? '<p style="color: green;">‚úÖ Abgeschlossen</p>' : '<p style="color: orange;">‚è≥ Ausstehend</p>'}
                        </div>
                    `)
                    .addTo(tourApp.state.map);
                
                tourApp.state.markers.push(marker);
            });
            
            // Update route
            const routeCoordinates = tourApp.stations.map(station => [station.lat, station.lng]);
            L.polyline(routeCoordinates, {
                color: '#dc2626',
                weight: 3,
                opacity: 0.7
            }).addTo(tourApp.state.map);
        } catch (error) {
            console.error('Error updating map markers:', error);
        }
    }

    function toggleChatModeration() {
        try {
            tourApp.state.chatModeration = !tourApp.state.chatModeration;
            const textEl = document.getElementById('chatModerationText');
            
            if (textEl) {
                textEl.textContent = tourApp.state.chatModeration ? 
                    'üõ°Ô∏è Moderation aktiv' : 
                    'üõ°Ô∏è Moderations-Modus aktivieren';
            }
            
            showNotification(tourApp.state.chatModeration ? 
                'Chat-Moderation aktiviert' : 
                'Chat-Moderation deaktiviert');
                
            addSystemMessage(tourApp.state.chatModeration ? 
                'Chat wird jetzt moderiert üõ°Ô∏è' : 
                'Chat-Moderation deaktiviert üì¢');
        } catch (error) {
            console.error('Error toggling chat moderation:', error);
        }
    }

    function clearAllChatMessages() {
        try {
            if (confirm('Alle Chat-Nachrichten l√∂schen?')) {
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.innerHTML = `
                        <div class="chat-message system">
                            <strong>Admin:</strong> Chat wurde geleert! üóëÔ∏è<br>
                            <small>Alle Nachrichten wurden entfernt</small>
                            <span class="timestamp">jetzt</span>
                        </div>
                    `;
                }
                
                // Clear from Firebase if connected
                if (tourApp.state.isFirebaseConnected && tourApp.state.tourId) {
                    // Note: In a real implementation, you'd want to delete all chat documents
                    // For now, we'll just clear locally
                }
                
                // Clear localStorage
                localStorage.removeItem(`chat_${tourApp.state.tourId}`);
                
                showNotification('Alle Chat-Nachrichten gel√∂scht! üóëÔ∏è');
            }
        } catch (error) {
            console.error('Error clearing chat messages:', error);
        }
    }

    function sendAdminAnnouncement() {
        try {
            const message = prompt('Admin-Ank√ºndigung eingeben:');
            if (message && message.trim()) {
                addChatMessage('üîä Admin', message.trim(), false);
                
                if (tourApp.state.isFirebaseConnected) {
                    saveToFirebase('chat', Date.now().toString(), {
                        userName: 'üîä Admin',
                        message: message.trim(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        isAnnouncement: true
                    });
                }
                
                showNotification('Admin-Ank√ºndigung gesendet! üì¢');
            }
        } catch (error) {
            console.error('Error sending admin announcement:', error);
        }
    }

    function refreshAdminStats() {
        try {
            const stats = {
                activeUsers: Object.keys(localStorage).filter(key => key.startsWith('user_')).length + 1,
                totalMessages: document.querySelectorAll('.chat-message:not(.system)').length,
                completedStations: tourApp.state.completedStations.length,
                uploadedPhotos: tourApp.state.uploadedPhotos.length
            };
            
            document.getElementById('activeUsers').textContent = stats.activeUsers;
            document.getElementById('totalMessages').textContent = stats.totalMessages;
            document.getElementById('completedStations').textContent = `${stats.completedStations}/${tourApp.stations.length}`;
            document.getElementById('uploadedPhotos').textContent = stats.uploadedPhotos;
            
            showNotification('Statistiken aktualisiert! üìä');
        } catch (error) {
            console.error('Error refreshing admin stats:', error);
        }
    }

    // UI Functions
    function showTab(tabName, tabElement) {
        try {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (tabElement) {
                tabElement.classList.add('active');
            }

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const targetTab = document.getElementById(tabName === 'map' ? 'map-tab' : tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            if (tabName === 'map') {
                setTimeout(() => initMap(), 100);
            } else if (tabName === 'ranking') {
                updateRanking();
            } else if (tabName === 'admin' && tourApp.state.isAdmin) {
                generateContentEditor();
                refreshAdminStats();
            }
        } catch (error) {
            console.error('Error showing tab:', error);
        }
    }

    function selectTeam(teamId, teamName, element) {
        try {
            tourApp.state.selectedTeam = teamId;
            tourApp.state.teamName = teamName;
            
            document.querySelectorAll('.team-option').forEach(option => {
                option.classList.remove('selected');
            });
            if (element) {
                element.classList.add('selected');
            }
            
            const selector = document.getElementById('teamSelector');
            if (selector) {
                selector.style.display = 'none';
            }
            
            showNotification('Team ausgew√§hlt! üéâ');
            saveState();
            addSystemMessage(`${tourApp.state.userName} ist ${teamName} beigetreten! üéä`);
        } catch (error) {
            console.error('Error selecting team:', error);
        }
    }

    function changeUserName() {
        try {
            const input = document.getElementById('userNameInput');
            const newName = input.value.trim();
            
            if (newName && newName.length >= 2) {
                const oldName = tourApp.state.userName;
                tourApp.state.userName = newName;
                
                const displayEl = document.getElementById('currentUserName');
                if (displayEl) {
                    displayEl.textContent = newName;
                }
                
                input.value = '';
                saveState();
                showNotification('Name ge√§ndert! üë§');
                addSystemMessage(`${oldName} hei√üt jetzt ${newName}! üë§`);
            } else {
                showNotification('Name muss mindestens 2 Zeichen haben!', 'error');
            }
        } catch (error) {
            console.error('Error changing user name:', error);
        }
    }

    function startTour() {
        try {
            if (!tourApp.state.selectedTeam) {
                showNotification('Bitte w√§hle zuerst ein Team aus!', 'error');
                return;
            }
            
            showTab('stations', document.querySelector('[onclick*="stations"]'));
            showNotification('Tour gestartet! Viel Erfolg! üöÄ');
        } catch (error) {
            console.error('Error starting tour:', error);
        }
    }

    function loginAdmin() {
        try {
            const password = document.getElementById('adminPassword').value;
            if (password === 'koeln2024') {
                tourApp.state.isAdmin = true;
                document.getElementById('adminTab').classList.remove('hidden');
                generateStationsList();
                showNotification('Admin-Modus aktiviert! ‚öôÔ∏è');
                showTab('admin', document.getElementById('adminTab'));
            } else {
                showNotification('Falsches Passwort!', 'error');
            }
        } catch (error) {
            console.error('Error logging in admin:', error);
        }
    }

    // Debug Functions
    function setManualTourId() {
        try {
            const input = document.getElementById('manualTourId');
            const newTourId = input.value.trim();
            
            if (newTourId && newTourId.length >= 3) {
                tourApp.state.tourId = newTourId;
                localStorage.setItem('tourId', newTourId);
                
                updateTourDisplay();
                generateShareUrl();
                
                showNotification(`Tour-ID ge√§ndert zu: ${newTourId} üéØ`);
                input.value = '';
                
                location.reload(); // Reload to reinitialize with new tour ID
            } else {
                showNotification('Bitte gib eine g√ºltige Tour-ID ein (mindestens 3 Zeichen)', 'error');
            }
        } catch (error) {
            console.error('Error setting manual tour ID:', error);
        }
    }

    function testChatSync() {
        try {
            loadChatHistory();
            showNotification('Chat neu geladen! üîÑ');
        } catch (error) {
            console.error('Error testing chat sync:', error);
        }
    }

    function clearChatHistory() {
        try {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.innerHTML = `
                    <div class="chat-message system">
                        <strong>System:</strong> Chat geleert! üóëÔ∏è<br>
                        <small>Neue Nachrichten werden wieder angezeigt</small>
                        <span class="timestamp">jetzt</span>
                    </div>
                `;
            }
            showNotification('Chat geleert! üóëÔ∏è');
        } catch (error) {
            console.error('Error clearing chat:', error);
        }
    }

    function showDebugInfo() {
        try {
            const debugInfo = {
                tourId: tourApp.state.tourId,
                userName: tourApp.state.userName,
                isFirebaseConnected: tourApp.state.isFirebaseConnected,
                selectedTeam: tourApp.state.selectedTeam,
                totalScore: tourApp.state.totalScore
            };
            
            alert(`üìä Debug Info:
Tour-ID: ${debugInfo.tourId}
Username: ${debugInfo.userName}
Firebase: ${debugInfo.isFirebaseConnected ? '‚úÖ Verbunden' : '‚ùå Nicht verbunden'}
Team: ${debugInfo.selectedTeam || 'Nicht ausgew√§hlt'}
Score: ${debugInfo.totalScore}

Siehe Console (F12) f√ºr mehr Details!`);
        } catch (error) {
            console.error('Error showing debug info:', error);
        }
    }

    // Utility Functions
    function copyShareUrl() {
        try {
            const shareUrl = document.getElementById('shareUrl').textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('URL kopiert! üìã');
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = shareUrl;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('URL kopiert! üìã');
            }
        } catch (error) {
            console.error('Error copying URL:', error);
        }
    }

    function shareViaWhatsApp() {
        try {
            const shareUrl = document.getElementById('shareUrl').textContent;
            const message = `üèõÔ∏è K√∂lner Abendspaziergang - Tour beitreten:\n${shareUrl}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        } catch (error) {
            console.error('Error sharing via WhatsApp:', error);
        }
    }

    async function addScore(points) {
        try {
            tourApp.state.totalScore += Math.round(points);
            updateUI();
            
            if (tourApp.state.selectedTeam) {
                await saveToFirebase('scores', tourApp.state.selectedTeam, {
                    teamId: tourApp.state.selectedTeam,
                    teamName: tourApp.state.teamName,
                    score: tourApp.state.totalScore,
                    lastUpdated: Date.now(),
                    userName: tourApp.state.userName
                });
            }
            
            saveState();
        } catch (error) {
            console.error('Error adding score:', error);
        }
    }

    function generateStationsList() {
        try {
            const container = document.getElementById('stationsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            tourApp.stations.forEach(station => {
                const isCompleted = tourApp.state.completedStations.includes(station.id);
                
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${isCompleted ? 'completed' : ''}`;
                stationCard.onclick = () => toggleStationDetails(station.id);
                
                const imagesHtml = station.images.map(img => `
                    <div class="gallery-item">
                        <div class="gallery-image" onclick="showImageModal('${img.url || 'placeholder'}', '${img.title}', '${img.description}')" 
                             style="${img.url ? `background-image: url('${img.url}'); background-size: cover; background-position: center;` : ''}">
                            ${img.url ? '' : 'üì∑'}
                        </div>
                        <small>${img.title}</small>
                    </div>
                `).join('');
                
                const audioHtml = station.audio && station.audio.length > 0 ? station.audio.map(audio => `
                    <div class="gallery-item">
                        <div class="gallery-image" onclick="playAudio('${audio.url}', '${audio.type}', '${audio.title}')" style="background: linear-gradient(135deg, #fef3c7 0%, #f59e0b 100%); color: white; font-size: 1.5rem;">
                            üéµ
                        </div>
                        <small>${audio.title}</small>
                    </div>
                `).join('') : '';
                
                stationCard.innerHTML = `
                    <div class="station-header">
                        <div class="station-number ${isCompleted ? 'completed' : ''}">${station.id}</div>
                        <div style="flex: 1;">
                            <div class="station-title">${station.title}</div>
                            <div class="station-subtitle">${station.subtitle}</div>
                        </div>
                    </div>
                    <div class="station-details" id="station-${station.id}">
                        <div class="detail-section">
                            <h4>üìñ Geschichte</h4>
                            <p>${station.mainText}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üñºÔ∏è Bildergalerie</h4>
                            <div class="image-gallery">
                                ${imagesHtml}
                            </div>
                        </div>
                        
                        ${audioHtml ? `
                        <div class="detail-section">
                            <h4>üéµ Audio-Dateien</h4>
                            <div class="image-gallery">
                                ${audioHtml}
                            </div>
                        </div>
                        ` : ''}

                        <div class="photo-challenge">
                            <h4>üì∏ KI-Foto-Challenge</h4>
                            <p>${station.photoChallenge}</p>
                            
                            <div class="photo-upload-area" onclick="selectPhoto(${station.id})" id="upload-area-${station.id}">
                                <div id="upload-content-${station.id}">
                                    üì∑ Hier klicken zum Foto machen/ausw√§hlen<br>
                                    <small>KI bewertet automatisch Qualit√§t, Komposition & Kreativit√§t</small>
                                </div>
                            </div>
                            
                            <input type="file" class="file-input" id="photo-input-${station.id}" accept="image/*" capture="environment" onchange="handlePhotoUpload(${station.id}, event)">
                            
                            <div class="ai-rating hidden" id="rating-${station.id}">
                                <div class="rating-score" id="score-${station.id}">0</div>
                                <div class="rating-text" id="rating-text-${station.id}">KI analysiert dein Foto...</div>
                                <div class="rating-details" id="rating-details-${station.id}"></div>
                            </div>
                        </div>

                        <button class="btn" onclick="completeStation(${station.id})" id="complete-btn-${station.id}" 
                                ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? '‚úÖ Station abgeschlossen' : 'üèÅ Station abschlie√üen'}
                        </button>
                    </div>
                `;
                
                container.appendChild(stationCard);
            });
        } catch (error) {
            console.error('Error generating stations list:', error);
        }
    }

    function toggleStationDetails(stationId) {
        try {
            const details = document.getElementById(`station-${stationId}`);
            if (details) {
                details.classList.toggle('active');
            }
        } catch (error) {
            console.error('Error toggling station details:', error);
        }
    }

    function selectPhoto(stationId) {
        try {
            const input = document.getElementById(`photo-input-${stationId}`);
            if (input) {
                input.click();
            }
        } catch (error) {
            console.error('Error selecting photo:', error);
        }
    }

    function handlePhotoUpload(stationId, event) {
        try {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                
                const uploadArea = document.getElementById(`upload-area-${stationId}`);
                if (uploadArea) {
                    uploadArea.classList.add('has-photo');
                    uploadArea.innerHTML = `
                        <img src="${imageUrl}" class="photo-preview" alt="Uploaded photo">
                        <p>üì∑ Foto erfolgreich hochgeladen!</p>
                        <small>KI analysiert...</small>
                    `;
                }

                const photoData = {
                    stationId: stationId,
                    imageUrl: imageUrl,
                    timestamp: Date.now(),
                    teamId: tourApp.state.selectedTeam
                };

                const existingIndex = tourApp.state.uploadedPhotos.findIndex(p => p.stationId === stationId);
                if (existingIndex >= 0) {
                    tourApp.state.uploadedPhotos[existingIndex] = photoData;
                } else {
                    tourApp.state.uploadedPhotos.push(photoData);
                }

                setTimeout(() => ratePhoto(stationId, imageUrl), 1000);
                saveState();
            };
            
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('Error handling photo upload:', error);
        }
    }

    function ratePhoto(stationId, imageUrl) {
        try {
            const ratingDiv = document.getElementById(`rating-${stationId}`);
            if (ratingDiv) {
                ratingDiv.classList.remove('hidden');
            }
            
            const baseScore = 50 + Math.random() * 40;
            const technicalScore = 70 + Math.random() * 25;
            const compositionScore = 60 + Math.random() * 30;
            const creativityScore = 55 + Math.random() * 35;
            
            const finalScore = Math.round(baseScore);
            
            animateScore(stationId, finalScore);
            
            const feedback = generatePhotoFeedback(technicalScore, compositionScore, creativityScore);
            
            setTimeout(() => {
                const ratingTextEl = document.getElementById(`rating-text-${stationId}`);
                const ratingDetailsEl = document.getElementById(`rating-details-${stationId}`);
                
                if (ratingTextEl) {
                    ratingTextEl.innerHTML = `
                        <strong>KI-Bewertung abgeschlossen!</strong><br>
                        Qualit√§t: ${Math.round(technicalScore)}% | 
                        Komposition: ${Math.round(compositionScore)}% | 
                        Kreativit√§t: ${Math.round(creativityScore)}%
                    `;
                }
                
                if (ratingDetailsEl) {
                    ratingDetailsEl.innerHTML = feedback.join('<br>');
                }
            }, 2000);
            
            addScore(finalScore);
            
            const photoData = tourApp.state.uploadedPhotos.find(p => p.stationId === stationId);
            if (photoData) {
                photoData.score = finalScore;
            }
            
            showNotification(`KI-Bewertung: ${finalScore} Punkte! ü§ñ`);
        } catch (error) {
            console.error('Error rating photo:', error);
        }
    }

    function animateScore(stationId, targetScore) {
        try {
            const scoreElement = document.getElementById(`score-${stationId}`);
            if (!scoreElement) return;
            
            let currentScore = 0;
            const increment = Math.ceil(targetScore / 30);
            
            const interval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(interval);
                }
                scoreElement.textContent = currentScore;
            }, 50);
        } catch (error) {
            console.error('Error animating score:', error);
        }
    }

    function generatePhotoFeedback(technical, composition, creativity) {
        const feedback = [];
        
        if (technical > 75) {
            feedback.push("üì∏ Sehr scharfes und gut belichtetes Bild!");
        } else if (technical < 50) {
            feedback.push("‚ö†Ô∏è Bild k√∂nnte sch√§rfer oder besser belichtet sein");
        }
        
        if (composition > 70) {
            feedback.push("üé® Tolle Bildkomposition!");
        } else {
            feedback.push("üí° Tipp: Achte auf die Bildaufteilung");
        }
        
        if (creativity > 75) {
            feedback.push("‚ú® Sehr kreative Aufnahme!");
        } else if (creativity > 60) {
            feedback.push("üé≠ Sch√∂ne kreative Elemente!");
        }
        
        feedback.push("üë• Toll, dass ihr als Team fotografiert!");
        
        return feedback;
    }

    function completeStation(stationId) {
        try {
            if (!tourApp.state.completedStations.includes(stationId)) {
                tourApp.state.completedStations.push(stationId);
                updateProgress();
                showNotification('Station abgeschlossen! üèÅ');
                
                const completeBtn = document.getElementById(`complete-btn-${stationId}`);
                if (completeBtn) {
                    const stationCard = completeBtn.closest('.station-card');
                    if (stationCard) {
                        stationCard.classList.add('completed');
                        const stationNumber = stationCard.querySelector('.station-number');
                        if (stationNumber) {
                            stationNumber.classList.add('completed');
                        }
                    }
                    
                    completeBtn.disabled = true;
                    completeBtn.textContent = '‚úÖ Station abgeschlossen';
                    completeBtn.style.background = '#6b7280';
                }

                if (tourApp.state.completedStations.length === tourApp.stations.length) {
                    showNotification('üéâ Herzlichen Gl√ºckwunsch! Tour abgeschlossen!');
                    setTimeout(() => {
                        showTab('ranking', document.querySelector('[onclick*="ranking"]'));
                    }, 2000);
                }

                saveState();
                addSystemMessage(`${tourApp.state.userName} hat "${tourApp.stations.find(s => s.id === stationId)?.title}" abgeschlossen! üèÅ`);
            }
        } catch (error) {
            console.error('Error completing station:', error);
        }
    }

    function updateUI() {
        try {
            const scoreElement = document.getElementById('totalScore');
            if (scoreElement) {
                scoreElement.textContent = tourApp.state.totalScore;
            }
            updateProgress();
        } catch (error) {
            console.error('Error updating UI:', error);
        }
    }

    function updateProgress() {
        try {
            const progress = (tourApp.state.completedStations.length / tourApp.stations.length) * 100;
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        } catch (error) {
            console.error('Error updating progress:', error);
        }
    }

    function resetTour() {
        try {
            if (confirm('Wirklich alle Daten zur√ºcksetzen?')) {
                localStorage.removeItem(`chat_${tourApp.state.tourId}`);
                
                tourApp.state.completedStations = [];
                tourApp.state.totalScore = 0;
                tourApp.state.uploadedPhotos = [];
                
                saveState();
                generateStationsList();
                updateUI();
                showNotification('Tour zur√ºckgesetzt! üîÑ');
                addSystemMessage('Admin hat die Tour zur√ºckgesetzt! üîÑ');
            }
        } catch (error) {
            console.error('Error resetting tour:', error);
        }
    }

    // Map Functions (simplified)
    function initMap() {
        try {
            if (tourApp.state.map || !document.getElementById('map')) return;
            
            if (typeof L === 'undefined') {
                loadLeaflet(() => createMap());
            } else {
                createMap();
            }
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    function loadLeaflet(callback) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
        script.onload = callback;
        script.onerror = () => showMapError();
        document.head.appendChild(script);
    }

    function createMap() {
        try {
            tourApp.state.map = L.map('map').setView([50.9375, 6.9597], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(tourApp.state.map);
            
            tourApp.stations.forEach(station => {
                const isCompleted = tourApp.state.completedStations.includes(station.id);
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="text-align: center; max-width: 200px;">
                            <h4>${station.title}</h4>
                            <p>${station.subtitle}</p>
                            <p><strong>Station ${station.id}/${tourApp.stations.length}</strong></p>
                            ${isCompleted ? '<p style="color: green;">‚úÖ Abgeschlossen</p>' : '<p style="color: orange;">‚è≥ Ausstehend</p>'}
                        </div>
                    `)
                    .addTo(tourApp.state.map);
                
                tourApp.state.markers.push(marker);
            });
            
            const routeCoordinates = tourApp.stations.map(station => [station.lat, station.lng]);
            L.polyline(routeCoordinates, {
                color: '#dc2626',
                weight: 3,
                opacity: 0.7
            }).addTo(tourApp.state.map);
            
            if (tourApp.state.userLocation) {
                addUserLocationToMap();
            }
        } catch (error) {
            console.error('Error creating map:', error);
        }
    }

    function showMapError() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
            mapEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 10px;"><p>üó∫Ô∏è Karte konnte nicht geladen werden</p></div>';
        }
    }

    function addUserLocationToMap() {
        try {
            if (!tourApp.state.map || !tourApp.state.userLocation) return;
            
            const userIcon = L.divIcon({
                html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                className: 'user-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            L.marker([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], {
                icon: userIcon
            })
            .bindPopup('üìç Dein Standort')
            .addTo(tourApp.state.map);
        } catch (error) {
            console.error('Error adding user location to map:', error);
        }
    }

    function centerOnUser() {
        try {
            if (tourApp.state.userLocation && tourApp.state.map) {
                tourApp.state.map.setView([tourApp.state.userLocation.lat, tourApp.state.userLocation.lng], 17);
            } else {
                showNotification('Standort nicht verf√ºgbar. Bitte erlaube Standortzugriff.', 'error');
            }
        } catch (error) {
            console.error('Error centering on user:', error);
        }
    }

    function initGeolocation() {
        try {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        tourApp.state.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateLocationInfo();
                        if (tourApp.state.map) {
                            addUserLocationToMap();
                        }
                    },
                    error => {
                        const distanceInfo = document.getElementById('distanceInfo');
                        if (distanceInfo) {
                            distanceInfo.textContent = 'üìç Standort nicht verf√ºgbar';
                        }
                    }
                );
            }
        } catch (error) {
            console.error('Error initializing geolocation:', error);
        }
    }

    function updateLocationInfo() {
        try {
            if (!tourApp.state.userLocation) return;
            
            let nearestStation = null;
            let minDistance = Infinity;
            
            tourApp.stations.forEach(station => {
                const distance = calculateDistance(
                    tourApp.state.userLocation.lat, tourApp.state.userLocation.lng,
                    station.lat, station.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            });
            
            if (nearestStation) {
                const distanceText = minDistance < 1 
                    ? `${Math.round(minDistance * 1000)}m` 
                    : `${minDistance.toFixed(1)}km`;
                
                const distanceInfo = document.getElementById('distanceInfo');
                if (distanceInfo) {
                    distanceInfo.textContent = `üìç N√§chste Station: ${nearestStation.title} (${distanceText})`;
                }
            }
        } catch (error) {
            console.error('Error updating location info:', error);
        }
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function playAudio(url, type, title) {
        try {
            if (!url || url.trim() === '') {
                showNotification('Audio-Datei noch nicht verf√ºgbar', 'warning');
                return;
            }
            
            // Create audio modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                flex-direction: column;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            let audioContent = '';
            
            switch(type) {
                case 'file':
                    audioContent = `
                        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 100%; text-align: center;">
                            <h3 style="color: #1f2937; margin-bottom: 1rem;">üéµ ${title}</h3>
                            <audio controls style="width: 100%; margin-bottom: 1rem;">
                                <source src="${url}" type="audio/mpeg">
                                Ihr Browser unterst√ºtzt das Audio-Element nicht.
                            </audio>
                        </div>
                    `;
                    break;
                    
                case 'youtube':
                    const youtubeId = extractYouTubeId(url);
                    if (youtubeId) {
                        audioContent = `
                            <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 100%; text-align: center;">
                                <h3 style="color: #1f2937; margin-bottom: 1rem;">üì∫ ${title}</h3>
                                <iframe width="100%" height="315" src="https://www.youtube.com/embed/${youtubeId}" 
                                        frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen style="border-radius: 8px;"></iframe>
                            </div>
                        `;
                    } else {
                        audioContent = `<div style="color: white; text-align: center;"><h3>‚ùå Ung√ºltige YouTube-URL</h3></div>`;
                    }
                    break;
                    
                case 'soundcloud':
                case 'spotify':
                case 'external':
                    audioContent = `
                        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 100%; text-align: center;">
                            <h3 style="color: #1f2937; margin-bottom: 1rem;">üéµ ${title}</h3>
                            <p style="color: #6b7280; margin-bottom: 1rem;">Link wird in neuem Fenster ge√∂ffnet:</p>
                            <a href="${url}" target="_blank" style="background: #059669; color: white; padding: 1rem 2rem; border-radius: 8px; text-decoration: none; display: inline-block;">
                                üîó ${type.charAt(0).toUpperCase() + type.slice(1)} √∂ffnen
                            </a>
                        </div>
                    `;
                    // Auto-open the link
                    setTimeout(() => window.open(url, '_blank'), 500);
                    break;
                    
                default:
                    audioContent = `<div style="color: white; text-align: center;"><h3>‚ùå Unbekannter Audio-Typ</h3></div>`;
            }
            
            modal.innerHTML = `
                ${audioContent}
                <button style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentElement.remove()">Schlie√üen</button>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
            
        } catch (error) {
            console.error('Error playing audio:', error);
            showNotification('Fehler beim Abspielen der Audio-Datei', 'error');
        }
    }

    function extractYouTubeId(url) {
        try {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        } catch (error) {
            return null;
        }
    }

    function showImageModal(url, title, description) {
        try {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                flex-direction: column;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            const imageContent = !url || url === 'placeholder' ? `
                <div style="width: 300px; height: 200px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 3rem;">üì∑</div>
            ` : `
                <img src="${url}" style="max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px;" alt="${title}">
            `;
            
            modal.innerHTML = `
                ${imageContent}
                <div style="color: white; text-align: center; margin-top: 20px; max-width: 600px;">
                    <h3>${title}</h3>
                    <p>${description}</p>
                    <button style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">Schlie√üen</button>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        } catch (error) {
            console.error('Error showing image modal:', error);
        }
    }

    function showNotification(message, type = 'success') {
        try {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        } catch (error) {
            console.error('Error showing notification:', error);
        }
    }

    function saveState() {
        try {
            const stateToSave = {
                ...tourApp.state,
                map: null,
                markers: [],
                syncListeners: []
            };
            localStorage.setItem('tourState', JSON.stringify(stateToSave));
        } catch (error) {
            console.error('Error saving state:', error);
        }
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('tourState');
            if (saved) {
                const savedState = JSON.parse(saved);
                tourApp.state = { ...tourApp.state, ...savedState };
                
                if (tourApp.state.selectedTeam) {
                    setTimeout(() => {
                        const teamOptions = document.querySelectorAll('.team-option');
                        teamOptions.forEach(option => {
                            if (option.textContent.includes(tourApp.state.teamName)) {
                                option.classList.add('selected');
                            }
                        });
                        const selector = document.getElementById('teamSelector');
                        if (selector) {
                            selector.style.display = 'none';
                        }
                    }, 100);
                }
            }
        } catch (error) {
            console.error('Error loading state:', error);
        }
    }

    // Initialize app when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initApp, 100);
        });
    } else {
        setTimeout(initApp, 100);
    }

    </script>
</body>
</html>
